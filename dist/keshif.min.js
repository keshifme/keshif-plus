import{_ as e,p as t,s as i,t as s,R as r,a,c as o,e as l,l as n,b as h,m as c,d,n as u,u as p,f as m,g,h as v,i as f,j as b,k as _,q as y,o as A,r as M,v as S,w as C,x as D,y as w,z as O,A as T,B as x,C as V,D as R,E as k,F as P,G as N,H as B,I,J as E,L as F,M as G,N as z,P as H,O as W,Q as K,S as $,T as U,U as Y,V as j,W as X,X as Z,Y as q,Z as J,$ as Q,a0 as ee,a1 as te,a2 as ie,a3 as se}from"./vendor.min.js";import{S as re}from"./vendor_mapping.min.js";var ae=new class{constructor(){this.browser=null,this.browsers={},this.gapi={gKey:null,clientId:null,scope:null},this.geoFileDir="",this.geoFileExt="topojson",this.maxVisibleItems_Default=100,this.autoDetect_RowCount=10,this.timeKeyHeight=35,this.recordRankWidth=45,this.maxRecordPointSize=30,this.defaultRecordPointSize=4.5,this.height_CatBottom=36,this.defaultBarHeight=32,this.width_CatLabelMin=110,this.width_scatter_margin_left=85,this.height_scatter_margin_bottom=95,this.width_HistBarGap=2,this.width_HistBinDefault=45,this.width_measureDescrLabel=20,this.height_MaxRatioDefault=.3,this.height_HistMin=40,this.height_HistBottomGap=12,this.height_Percentile=34,this.width_PanelGap=8,this.width_ScrollBar=19,this.width_AttribPanelDefault=250,this.percentDecimal=!0,this.defaultDOM="#kshfDashboard",this.Panel_List=["left","right","middle","bottom"],this.defaultMetricFuncs=["Sum","Avg"],this.Compare_List=["Compare_A","Compare_B","Compare_C","Compare_D","Compare_E"],this.maps=new Map,this.tables=new Map,this.map={tileTemplate:"",leafConfig:{maxBoundsViscosity:1,worldCopyJump:!1,zoomControl:!1,boxZoom:!1,doubleClickZoom:!1,touchZoom:!1,zoomSnap:.5,zoomDelta:.5,maxZoom:18,minZoom:1},tileConfig:{attribution:'&copy; <a href="https://openstreetmap.org/about/" target="_blank">OpenStreetMap</a><br><a href="https://www.mapbox.com/about/maps/" target="_blank">Mapbox</a> &amp; <a href="https://keshif.me" target="_blank">Keshif</a>',subdomains:"abcd",id:"mapbox.light"},flyConfig:{padding:[0,0],pan:{animate:!0,duration:1.2},zoom:{animate:!0}},pinGlyphPath:"M-0.025 -18 C-4.106 -18 -7.427 -14.751 -7.427 -10.757 -7.427 -5.8 \n      -0.803 1.476 -0.521 1.784 -0.256 2.072 0.207 2.072 0.471 1.784 0.753 1.476 7.377 -5.8 \n      7.377 -10.757 7.377 -14.751 4.057 -18 -0.025 -18 Z M-0.025 -7.112 C-2.078 -7.112 -3.749 \n      -8.747 -3.749 -10.757 -3.749 -12.766 -2.078 -14.401 -0.025 -14.401 2.029 -14.401 3.699 \n      -12.766 3.699 -10.757 3.699 -8.747 2.029 -7.112 -0.025 -7.112 Z"},this.DOM={},this.custom_icons={trails:'<svg class="custom_icon custom_icon_trails" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 600 500" xml:space="preserve">\n        <g>\n          <path d="M489.2,65.25c0-35.7-28.5-65.2-64.2-65.2s-64.2,29.6-64.2,65.2c0,28.1,17.7,52.3,42.6,61.4l-28.2,232.3\n            c-6.6,0.5-12.9,2-18.7,4.4l-97.1-99.6c1.6-5.8,2.5-11.8,2.5-18.1c0-35.7-28.5-65.2-64.2-65.2s-64.2,29.6-64.2,65.2\n            c0,15.6,5.4,29.9,14.5,41.2l-62.3,75.7c-6.7-2.4-14-3.8-21.5-3.8c-35.7,0-64.2,29.6-64.2,65.2c0,35.7,28.5,65.2,64.2,65.2\n            c36.7,0,64.2-29.6,64.2-65.2c0-13.3-4-25.8-10.9-36.2l64.8-78.8c4.9,1.2,10,1.9,15.3,1.9c14.5,0,27.8-4.9,38.5-13.1l89.4,91.8\n            c-6.2,10-9.7,21.8-9.7,34.4c0,35.7,28.5,65.2,64.2,65.2s64.2-29.6,64.2-65.2c0-23.1-12-43.6-30.1-55.2l29.5-241\n            C470.1,119.55,489.2,94.45,489.2,65.25z M425,40.85c12.2,0,23.4,11.2,23.4,24.5s-11.2,24.5-23.4,24.5s-23.4-11.2-23.4-24.5\n            S411.7,40.85,425,40.85z M64.2,448.45c-12.2,0-23.4-11.2-23.4-24.5c0-13.2,10.2-24.5,23.4-24.5s23.4,11.2,23.4,24.5\n            C87.7,437.25,76.4,448.45,64.2,448.45z M197.7,270.15c-12.2,0-23.4-11.2-23.4-24.5c0-13.2,10.2-24.5,23.4-24.5\n            s23.4,11.2,23.4,24.5C221.2,258.95,209.9,270.15,197.7,270.15z M380.1,448.45c-12.2,0-23.4-11.2-23.4-24.5\n            c0-13.2,10.2-24.5,23.4-24.5c13.2,0,23.4,11.2,23.4,24.5C403.6,437.25,392.4,448.45,380.1,448.45z"/>\n        </g>\n      </svg>'},this.WebFontConfig={google:{families:["Roboto:100,300,400,500,700:latin","Roboto+Slab:300,400,700","Roboto+Condensed:300,400"]}},this.loadResources=function(){return e(this,void 0,void 0,(function*(){if(!0!==this._resourcesLoaded)return window.WebFontConfig=this.WebFontConfig,yield import("https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"),window.addEventListener("resize",(()=>{for(var e in this.browsers)this.browsers[e].setNoAnim(!0),this.browsers[e].updateLayout();this._resizeTimeout&&window.clearTimeout(this._resizeTimeout),this._resizeTimeout=window.setTimeout((()=>{for(var e in this.browsers)this.browsers[e].setNoAnim(!1)}),500)}),!1),this._resourcesLoaded=!0,!0}))}}get Active_Compare_List(){return["Active"].concat(this.Compare_List)}get Total_Active_Compare_List(){return["Total","Active"].concat(this.Compare_List)}reloadWithNewConfig(e,t){return this.tables.delete(e.primaryTableName),new Qt(t)}};function oe(e){return e&&"object"==typeof e&&!Array.isArray(e)}function le(e,...t){if(!t.length)return e;const i=t.shift();if(oe(e)&&oe(i))for(const t in i)!oe(i[t])||i[t]instanceof HTMLElement?Object.assign(e,{[t]:i[t]}):(e[t]||Object.assign(e,{[t]:{}}),le(e[t],i[t]));return le(e,...t)}function ne(){this.innerHTML=""}function he(e){return function(){this.innerHTML=t.sanitize(e)}}function ce(e){return function(){var i=e.apply(this,arguments);this.innerHTML=null==i?"":t.sanitize(i)}}window.kshf=ae,t.setConfig({USE_PROFILES:{html:!0,svg:!0},ALLOWED_ATTR:["target"]}),t.addHook("afterSanitizeAttributes",(function(e){"target"in e&&e.setAttribute("target","_blank")})),i.tippyDefaultConfig={allowHTML:!0,animation:"scale",animateFill:!1,theme:"dark kshf-tooltip",arrow:r,delay:[500,50],duration:[350,250],maxWidth:350,placement:"auto",popperOptions:{modifiers:[{name:"flip",enabled:!0,options:{padding:10}}]}},i.prototype.tooltip=function(e,r){var a=r||("object"==typeof e?e:null),o=r?e:"object"==typeof e?null:e,l=ae.browser?ae.browser.DOM.root.node():document.body,n=Object.assign({appendTo:l},i.tippyDefaultConfig);return le(n,a),n.popperOptions.modifiers[0].options.boundariesElement=n.appendTo,o&&("string"==typeof o?o=t.sanitize(o):"function"==typeof o&&(n.onShow=e=>(e.reference.tippy.setContent(t.sanitize(o(e.reference.__data__))),!0))),this.each((function(){this.tippy&&this.tippy.destroy(),this.tippy=s(this,n),"string"==typeof o&&this.tippy.setContent(o)})),this},i.prototype.html=function(e){return arguments.length?this.each(null==e?ne:("function"==typeof e?ce:he)(e)):this.node().innerHTML};class de{constructor(){this.LANG_NAME="English",this.LoadingData="Loading data...",this.CreatingBrowser="Creating Dashboard...",this.Close="Close",this.Help="Help",this.RemoveFilter="Remove filter",this.RemoveHighlight="Remove highlight",this.RemoveAllFilters="Remove all filters",this.LockToCompare="Compare",this.Unlock="Remove comparison",this.CompareTopCategories="Compare top categories",this.Compare="Compare",this.LockCrumbMode=e=>`<b>${e?"Stacked":"Side-by-side"} charts</b><br> are used for comparison.<br><br>\n        Click to switch to ${e?"side-by-side":"stacked"} charts.`,this.SideBySide="Side-by-Side",this.Stacked="Stacked",this.GroupView="Group-View",this.CollapseSummary="Close",this.OpenSummary="Open",this.ExpandSummary="Maximize",this.RemoveSummary="Remove",this.Confirm="Confirm",this.Cancel="Cancel",this.OK="OK",this.Delete="Delete",this.NoAttribute="(None)",this["No [Record]"]="No",this["Absolute (Breakdown)"]="Absolute",this.SetPairTitle=e=>`${e}->Relations`,this.DialogSideBySideCharts="<u class='learnIcon' data-helparticle='5e88ff692c7d3a7e9aea6475'>Stacked charts</u>",this.DialogStackedCharts="<u class='learnIcon' data-helparticle='5e88ff692c7d3a7e9aea6475'>Stacked charts</u>",this.DialogComparisonSelection="<u class='learnIcon' data-helparticle='5e8905262c7d3a7e9aea6483'>Compare-selection</u>",this.DialogRelativeBreakdown="<u class='learnIcon' data-helparticle='5e8944932c7d3a7e9aea659c'>%-of-groups breakdown</u>",this.DialogDependentBreakdown="<u class='learnIcon' data-helparticle='5e8944812c7d3a7e9aea659b'>%-of-compared breakdown</u>",this.DialogEmptyResultSet="Removing this category will create an empty result list.",this.DialogChangeCompare=(e,t)=>`To compare by <i>${e}</i>,<br> we need to remove the current comparison on <i>${t}</i>.`,this.DialogStackedMultiValue=e=>this.DialogStackedCharts+` cannot be enabled while comparing on<br> multi-valued categorical attribute:<br><i>${e}</i>.`,this.DialogSideBySideSingleValue=e=>this.DialogSideBySideCharts+` cannot be enabled while comparing on<br> single-valued categorical attribute:<br><i>${e}</i><br>using ${this.DialogRelativeBreakdown}.`,this.DialogCompareForRelative=`Apply ${this.DialogComparisonSelection} first before switching to ${this.DialogRelativeBreakdown}.`,this.ComparedSelectionsLimit="You cannot compare across more than five data groups.",this.ZoomLevelWarning="Your current browser zoom level may not be optimal for charting.<br>For best results, <span class='link attemptToFix'><i class='fa fa-magic'></i>click here to fix and refresh</span>, or<br>if issue persists, manually reset your browser zoom and refresh the page.<br><a class='link' style='font-weight: 300' href='https://help.keshif.me/article/49-resolving-chart-display-issues'>More info</a>",this.MeasureDescrLabel=(e,t)=>{var i,s;const r=e.measureFunc_Count?"":`${e.measureFunc} of ${e.measureSummary.get().printName}`,a=null!==(s=null===(i=e.comparedAttrib)||void 0===i?void 0:i.printName)&&void 0!==s?s:null,o=e.breakdownMode.get();if("absolute"==o)return(r||e.recordName)+(a?` by ${a}`:"");const l=r||`${e.isFiltered()?"filtered":"all"} ${e.recordName}`;if(!a)return`% of ${l}`;switch(o){case"dependent":return`${t.printName} % , out of ${a} ${r}`;case"relative":return`${a} % , out of ${t.printName} ${r}`;case"total":return`Combined % , out of ${l}`}},this.measureText=e=>e.measureFunc_Count?e.recordName:`${e.measureFunc} of ${e.measureSummary.get().printName}`,this.measureText_2=e=>e.measureFunc_Count?"":`${e.measureFunc} of ${e.measureSummary.get().printName} of `,this.ListButton="List",this.MapButton="Map",this.NodeButton="Node-Link",this.TimeSeriesButton="Time",this.ScatterButton="Scatter",this.RecordViewTypeTooltip=e=>`View ${ae.browser.recordName} on <br><b>${e}</b> chart`,this.Boost_NoSuggestions="No suggested changes. Explore on!",this.TooltipOne=(e,t)=>`${t.getValueLabel(e,!1,1,!0)} of\n        ${t.isFiltered()?t.getFilteredSummaryText():"all"}\n        ${t.recordName}`,this.Tooltip_OutOf=(e,t)=>{var i,s="";return t.absoluteBreakdown?s:(s+="<div class='percentageExplainer'>",t.relativeBreakdown?s+="% out of <i>"+e+"</i>":t.dependentBreakdown?s+="% out of <i>"+(null===(i=t.comparedAttrib)||void 0===i?void 0:i.printName)+"</i>":s+="% out of all",s+="</div>")},this.Size="Size",this.Larger="Larger",this.Smaller="Smaller",this.Pairs="Pairs",this.Color="Color",this.InvertColorTheme="Invert color theme",this.ChangeColorTheme="Change color theme",this.ReverseOrder="Reverse order",this.Reorder="Reorder",this.SwapAxis="Swap axis",this.Percentiles="Percentiles",this.OpenDataSource="Open Data Source",this.ShowInfoCredits="Info",this.ShowFullscreen="Fullscreen",this.PrintButton="Click to activate print style<br><b>Shift+click</b> to print.",this.Search="Search",this.TextSearchForRecords='Type to search and highlight.<br><br>+\n        <b><u>Enter</u></b> to filter <i class="fa fa-filter"></i>',this.ClearTextSearch="Clear",this.Rows="Rows",this.More="More",this.ScrollToTop="Top",this.Percent="Percent",this.Absolute="Absolute",this.Relative="Relative",this.Dependent="Dependent",this.Breakdown="Breakdown",this.BreakdownBy="Breakdown by",this.Total="Prozentuale",this.SeeBreakdown=e=>`See <b>${this[e.charAt(0).toUpperCase()+e.slice(1)]}</b> Breakdown`,this.DragToFilter="Drag",this.And="And",this.Or="Or",this.Not="Not",this.NoData="Missing data",this.ValidData="Valid data",this.KeepNoData="Keep missing data",this.KeepValidData="Keep valid data",this.ZoomToFit="Zoom to fit",this.ZoomIn="Zoom In",this.ZoomOut="Zoom Out",this.MeasureScale="Scale",this.RowHeight="Bar Height",this.RowOrder="Order",this.Charts="Charts",this.Charts_Histogram="Histogram",this.Charts_Percentiles="Percentiles",this.BinScale="Value Axis Scale",this.BinWidth="Bin Width",this.BinWidth_Narrow="Narrow",this.BinWidth_Medium="Medium",this.BinWidth_Wide="Wide",this.BinHeight="Height",this.BinHeight_Compact="Compact",this.BinHeight_Short="Short",this.BinHeight_Medium="Medium",this.BinHeight_Tall="Tall",this.DashboardAnalyticsConfig="Dashboard Configuration",this.ViewAsMap="View as Map",this.ViewAsList="View as List",this.ViewSetMatrix="Show/Hide pair-wise relations",this.MissingLocations="Missing<br>Locations",this.Reset="Reset",this.measure_Sum="Sum",this.measure_Avg="Average",this.measure_Count="Count",this.Of_NumberRecord="of",this.AutoPlay="Autoplay",this.StopAutoPlay="Stop Autoplay",this.SaveSelection="Save selection",this.EditFormula="Edit formula",this.Attributes="Attributes",this.DatasetButton="Attributes",this.AdjustButton="Adjust",this.SaveShareButton="Save",this.CategoricalAttribute="Categorical",this.NumericAttribute="Numeric",this.TimestampAttribute="Timestamp",this.TimeseriesAttribute="Timeseries",this.LocationAttribute="Geographic",this.UnknownAttribute="Unknown",this.UniqueAttribute="Unique",this.MultiValuedAttribute="Multi-valued",this.FunctionAttribute="Uses Custom Function",this.ContentAttribute="Content",this.Configure="Configure",this.Derive="Derive",this.EditTitle="Rename",this.RemoveRecordPanel="Remove record panel",this.EmptyDashboardNotice="To add data into the dashboard : <br><br>\n          <i class='far fa-angle-double-down'></i> switch to <span style='font-weight: bolder'>Author</span> mode,<br>and <br>\n          <i class='far fa-angle-double-left'></i> double-click, or\n          click+drag an attribute into this canvas.\n          <br> <img class='kshfLogo_K'>",this.LinearSequence="<span style='font-size:0.8em; opacity: 0.75'>(1,2,3,4)</span>",this.Log2Sequence="<span style='font-size:0.8em; opacity: 0.75'>(1,2,4,8)</span>",this.Log10Sequence="<span style='font-size:0.8em; opacity: 0.75'>(1,10,100)</span>",this.Error_CannotFindMap=e=>`<i class='fal fa-frown'></i> We could not find the map [${e}].`,this.Error_CannotLoadMap=e=>`<i class='fal fa-frown'></i> We could not load the map [${e}].`,this.Error_CannotMatchMap=e=>`<i class='fal fa-frown'></i> We could not match any location name with the map [${e}].`,this.RemoveDataset="Remove Dataset",this.Bookmark="Bookmark<br><i>Shift+Click to delete</i>",this.Lookup_Months={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"},this.Lookup_DaysOfWeek={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"}}}let ue=null,pe=function(e){ue=new Proxy(e,{get:function(e,t){return t in e?e[t]:t}})};var me=new Proxy({},{get:function(e,t){return ue||pe(new de),ue[t]}});class ge{get isFiltered(){return this._isFiltered}constructor(e){this.breadcrumb=null,this._isFiltered=!1,this.how="All",this.browser=e,this.filterID=this.browser.filterCounter++,this.browser.records.forEach((e=>e.setFilterCache(this.filterID,!0))),this.browser.filters.push(this)}setFiltered(e=!0){if(!this.browser.singleFiltering&&(this._isFiltered=!0,e)){this.browser.refresh_filterClearAll(),this.applyFilter();var t=!1,i=0;"LessResults"===this.how&&(i=-1),"MoreResults"===this.how&&(i=1),this.browser.records.forEach((e=>{i<0&&e.filteredOut||i>0&&!e.filteredOut||(t=e.refreshFilterCache()||t)})),t&&(this.browser.updateRecordCount_Active(),this.browser.updateAfterFilter())}}applyFilter(){this.breadcrumb||(this.breadcrumb=this.browser.createNewCrumb()),this.onFilter(),this.breadcrumb.showCrumb("Filter",this)}getRichText(){return`${this.title}: ${this.filterView_Detail()}`}getRichText_flipped(){return`${this.filterView_Detail()} [${this.title}]`}clearFilter(e=!0){var t;return!!this._isFiltered&&(this._isFiltered=!1,this.browser.records.forEach((e=>e.setFilterCache(this.filterID,!0))),null===(t=this.breadcrumb)||void 0===t||t.removeCrumb(),this.breadcrumb=null,this.onClear(e),!1!==e&&(this.browser.records.forEach((e=>e.filteredOut&&e.refreshFilterCache())),this.browser.updateRecordCount_Active(),this.browser.updateAfterFilter(!0)),this.browser.isFiltered()||(this.browser.filters_wrap_letItWrap=!1,this.browser.DOM.breadCrumbs_Filter.classed("collapsed",!1)),!0)}}class ve extends ge{get noValueAggr(){return this.attrib.noValueAggr}constructor(e){super(e)}onFilter(){var e;null===(e=this.attrib.block)||void 0===e||e.refreshUIFiltered(!0),this.attrib.isComparedAttrib()&&ae.Compare_List.forEach((e=>{this.browser.selectedAggrs[e]&&this.browser.clearSelect_Compare(e,!0,!0)}))}onClear(e=!1){var t,i;null===(t=this.attrib.block)||void 0===t||t.refreshUIFiltered(!1),null===(i=this.attrib.block)||void 0===i||i.onClearFilter(e)}}class fe extends ge{constructor(e){super(e),this.removedRecords=[]}removeRecord(e){e.setFilterCache(this.filterID,!1),this.removedRecords.push(e),this.setFiltered()}get title(){return`<i class='far fa-times-circle></i> ${me.Removed}`}onClear(){this.removedRecords=[]}filterView_Detail(){return this.removedRecords.length+" "+this.browser.recordName}onFilter(){}exportFilter(){return this.removedRecords.map((e=>e.id))}importFilter(e){var t=ae.tables.get(this.browser.primaryTableName);t&&(this.removedRecords=[],e.forEach((e=>{var i=t[e];i&&(this.removedRecords.push(i),i.setFilterCache(this.filterID,!1))})),this.removedRecords.length>0&&(this.setFiltered(!1),this.applyFilter()))}}class be extends ge{constructor(e){super(e),this.multiMode="and",this._queryString=null,this._queryString=null}get title(){return this.browser.recordDisplay.textAttrib_Brief.attribName}filterView_Detail(){return this._queryString}onClear(){this.browser.recordDisplay.DOM.recordTextSearch.classed("showClear",!1),this.browser.recordDisplay.DOM.recordTextSearch.select("input").node().value=""}onFilter(){this.browser.recordDisplay.DOM.recordTextSearch.classed("showClear",!0);var e=this.browser.recordDisplay.textAttrib_Brief;this.browser.records.forEach((t=>{var i=e.getRecordValue(t),s=!1;if(i){let e=i.join(" ").toLowerCase();"or"===this.multiMode?s=!this.filterQuery.every((t=>-1===e.indexOf(t))):"and"===this.multiMode&&(s=this.filterQuery.every((t=>-1!==e.indexOf(t))))}t.setFilterCache(this.filterID,s)}))}set queryString(e){this._queryString=e.toLowerCase(),this.filterQuery=[],""!==this._queryString&&(this._queryString.split('"').forEach(((e,t)=>{t%2==0?e.split(/\s+/).forEach((e=>this.filterQuery.push(e))):this.filterQuery.push(e)})),this.filterQuery=this.filterQuery.filter((e=>""!==e)))}get queryString(){return this._queryString}importFilter(e){"string"==typeof e&&(e={query:e}),e.query&&(this.queryString=e.query,e.multiMode&&(this.multiMode=e.multiMode),this.isFiltered&&(this.browser.recordDisplay.DOM.recordTextSearch.select(".textSearchInput").node().value=e.query,this.applyFilter()))}exportFilter(){return{query:this._queryString,multiMode:this.multiMode}}}const _e={select:a};class ye{static alert(e,t=""){return new Promise(((i,s)=>{var r;ae.browser?r=ae.browser.DOM.overlay_wrapper:(ae.DOM.Modal=_e.select("body").append("div").attr("class","kshf kshf_Modal"),r=ae.DOM.Modal.append("div").attr("class","overlay_wrapper"));var a=r.append("div").attr("class","overlay_content overlay_modal").html(`<div class='overlay_Header'>${t}<i class='fa fa-warning'></i></div>\n          <div class='overlay_Content'>${e}</div>\n          <div class='ModalButtons'>\n            <div class='modalButton confirmButton'>${me.OK}</div>\n          </div>`);ye.createHelpScoutLinks(a,!0),r.attr("show","modal"),a.select(".confirmButton").on("click",(e=>{ye._removeModal(r),i&&i(!0)}))}))}static confirm(e,t,i=null){return new Promise(((s,r)=>{var a;ae.browser?a=ae.browser.DOM.overlay_wrapper:(ae.DOM.Modal=_e.select("body").append("div").attr("class","kshf kshf_Modal"),a=ae.DOM.Modal.append("div").attr("class","overlay_wrapper")),a.attr("show","modal");var o=a.append("div").attr("class","overlay_content overlay_modal").html(`<div class='overlay_Header'><i class='fa fa-question-circle'></i></div>\n          <div class='overlay_Content'>${e}</div>\n          <div class='ModalButtons'>\n            <div class='modalButton confirmButton'>${t||me.OK}</div>\n            <div class='modalButton rejectButton'>${i||me.Cancel}</div>\n          </div>\n          `);o.select(".confirmButton").on("click",(e=>{ye._removeModal(a),s(new MouseEvent(e.type,e))})),o.select(".rejectButton").on("click",(()=>{ye._removeModal(a),r&&r(!1)}))}))}static prompt(e,t){return window.prompt(e,t)}static autoChanges(e){return new Promise((function(t,i){var s;ae.browser?(s=ae.browser.DOM.overlay_wrapper).selectAll(".overlay_modal").remove():(ae.DOM.Modal=_e.select("body").append("div").attr("class","kshf kshf_Modal"),s=ae.DOM.Modal.append("div").attr("class","overlay_wrapper"));var r=s.append("div").attr("class","overlay_content overlay_modal").html("\n          <div class='overlay_Header'>Review Changes <i class='fa fa-question-circle'></i></div>\n          <div class='overlay_Content'></div>\n          <div class='ModalButtons'>\n            <div class='modalButton confirmButton'>OK</div>\n            <div class='modalButton rejectButton'>Cancel</div>\n          </div>\n          ");s.attr("show","modal");var a=r.select(".overlay_Content");a.html("").style("text-align","left"),a.append("div").html("We identified the following potential changes: ");var o=a.append("table").attr("class","changeList").selectAll(".changeRow").data(e).enter().append("tr").attr("class","changeRow");o.append("td").attr("class","changeIcon").html((e=>e.i)),o.append("td").attr("class","changeText").html((e=>e.q));var l=o.append("td").attr("class","changeToggle");l.append("input").attr("class","theToggleInput").attr("type","checkbox").attr("checked",(e=>!!e.change||null)).attr("id",((e,t)=>"toggle_"+t)).on("change",((e,t)=>{t.change=!t.change})),l.append("label").attr("class","theToggleLabel").attr("for",((e,t)=>"toggle_"+t)),r.select(".confirmButton").on("click",(()=>{s.attr("show","none"),r.classed("modalAlert",!1),ae.DOM.Modal&&ae.DOM.Modal.remove(),t&&t(e)})),r.select(".rejectButton").on("click",(()=>{s.attr("show","none"),r.remove(),ae.DOM.Modal&&ae.DOM.Modal.remove(),i&&i(!1)}))}))}static _removeModal(e){var t;e.select(".overlay_modal").remove(),0===e.selectAll(".overlay_modal").nodes().length&&e.attr("show","none"),null===(t=ae.DOM.Modal)||void 0===t||t.remove()}static popupMenu(e,t,i,s=null){var r,a=ae.browser.DOM.root;if(!ae.popupInstance||ae.popupInstance.state.elements.reference!==e.target){a.select(".contextMenu")&&a.select(".contextMenu").remove();var l=a.append("div").attr("class","contextMenu"),n=l.append("div").attr("class","popperArrow"),h=()=>{if(l.remove(),ae.popupInstance)for(var e=ae.popupInstance.state.elements.reference;e&&e.classList;)e.classList.remove("popupVisible"),e=e.parentNode;ae.popupInstance=null};ae.popupInstance=o(e.currentTarget,l.node(),{placement:null!==(r=null==s?void 0:s.placement)&&void 0!==r?r:"right-start",strategy:"absolute",modifiers:[{name:"flip",enabled:!0},{name:"offset",options:{offset:[0,8]}},{name:"arrow",options:{element:n.node(),padding:4}}]}),l.append("div").attr("class","popupMenu_Close").tooltip(me.Close).html("<i class='fa fa-window-close'></i>").on("click",(()=>h())),l.append("div").attr("class","contextMenu_Header").html(me[t.name]);var c=l.append("div").attr("class","contextMenu_Items");c.selectAll(".popupMenuItem").remove();var d=e=>!e.when||e.when(i),u=e=>{if(e.when&&!e.when(i))return!1;if(!e.options)return d(e);var t=e.options;if("function"==typeof e.options){if(!d(e))return!1;t=e.options(i)}return t.some(u)&&d(e)},p=e=>{e.filter((e=>e.iconClass)).append("span").attr("class","popupMenuItem_Header_Icon").append("span").attr("class",(e=>e.iconClass)),e.filter((e=>e.iconXML)).append("span").attr("class","popupMenuItem_Header_Icon").html((e=>e.iconXML)),e.append("span").attr("class","popupMenuItem_Header_Text").call((e=>{e.append("div").attr("class","mainText").html((e=>me[e.name])),e.filter((e=>e.sampleValue)).append("div").attr("class","sampleValue").html((e=>me[e.sampleValue]))})),e.filter((e=>e.helparticle)).append("span").attr("class","helparticle fal fa-question-circle").attr("data-helparticle",(e=>e.helparticle)).tooltip(me["Learn more"],{placement:"bottom"}).on("click",((e,t)=>{ye.attachHelpScout().then((()=>window.Beacon("article",t.helparticle,{type:"modal"}))),e.stopPropagation(),e.preventDefault()})),e.filter((e=>e.options)).append("i").attr("class","expandCollapseIcon fa fa-caret-down"),e.each(((e,t,i)=>{e.onName&&e.onName(i[t])}))};m(c,t.items),ae.popupInstance.update(),setTimeout((()=>l.classed("visible",!0)),10)}function m(e,t,s=null){e.selectAll(".popupMenuItem").data(t.filter(u)).enter().append("div").attr("class","popupMenuItem").classed("expanded",(e=>e.expanded)).attr("data-itemID",(e=>e.id||null)).call((e=>{e.append("div").attr("class","popupMenuItem_Header").classed("active",(e=>{if(e.active)return"function"==typeof e.active?e.active(i):!!e.active})).each((e=>{e.parentD=s})).on("click",g).call(p),e.append("div").attr("class","popupMenuItem_Children").each(((e,t,s)=>{if(e.expanded){var r=e.options;"function"==typeof e.options&&d(e)&&(r=e.options(i)),m(_e.select(s[t]),r,e)}}))}))}function g(e,t){var s,r=[];for(s=t.parentD;s;s=s.parentD)r=[s.name].concat(r);if(t.options){if(r.push(t.name),this.parentNode.classList.toggle("expanded"),_e.select(this.parentNode).classed("expanded")){var a=_e.select(this.parentNode.childNodes[1]);a.selectAll(".popupMenuItem").remove();var o=t.options;"function"==typeof t.options&&d(t)&&(o=t.options(i)),m(a,o,t)}ae.popupInstance.update()}else{for(var l=t;l;l=l.parentD)if(l.do){l.do(i,t.value,r);break}h()}}}static helpUI(){return ye.attachHelpScout().then((()=>window.Beacon("open")))}static createHelpScoutLinks(e,t=!1){(e=e.selectAll("[data-helparticle]")).on("click",(e=>{var t=e.currentTarget.dataset.helparticle;t&&ye.attachHelpScout().then((()=>window.Beacon("article",t,{type:"modal"})))})),t&&e.tooltip(me["Learn more"])}static attachHelpScout(){return window.Beacon||(window.Beacon=function(e,t,i){window.Beacon.readyQueue.push({method:e,options:t,data:i})},window.Beacon.readyQueue=[]),import("https://beacon-v2.helpscout.net/").then((()=>{if(window.Beacon.readyQueue&&(window.Beacon("init",ae.helpscoutBeacon),window.firebase&&window.firebase.auth)){var e=window.firebase.auth().currentUser;e&&window.Beacon("identify",{name:e.displayName||e.email,email:e.email,avatar:e.photoURL,uid:e.uid,portal_name:"TODO"})}})).catch((()=>{throw ye.alert("Script blocking extensions (Adblock, NoScript, uBlock, ...)<br>may be blocking our embedded help system. <a href='https://docs.helpscout.net/article/911-beacon-ad-blockers' target='_blank'>Learn more</a>","<i class='fal fa-frown'></i> Cannot display the help."),new Error}))}}class Ae{constructor(e){this.records=[],this._locked=!1,this.usedAggr=!0,this.DOM={aggrGlyph:void 0},this.attrib=e,this.resetAggregateMeasures()}get label(){return""}get compared(){return this._compared}get locked(){return this._locked}setAggrGlyph(e){this.DOM.aggrGlyph=e}measure(e){if(ae.browser.measureFunc.is("Avg")){var t=this[e].recCnt;return 0===t?0:this[e].measure/t}return this[e].measure}recCnt(e){return this[e].recCnt}scale(e){return this[e].scale}offset(e){return this[e].offset}ratioToActive(e){return this.Active.measure?this[e].measure/this.Active.measure:0}sumOffsetScale(e){return this[e].offset+this[e].scale}setOffset(e,t){this[e].offset=t}setScale(e,t){this[e].scale=t}addRecord(e){this.records.push(e),e._aggrCache.push(this),this._processRecord(e)}_processRecord(e){null!=e.measure_Self&&["Total"].concat(e.filteredOut?[]:["Active"].concat(ae.Compare_List.filter((t=>e.isSelected(t))))).forEach((t=>{this[t].measure+=e.measure_Self,this[t].recCnt++}))}clearRecords(){this.records.forEach((e=>{e.removeAggrFromCache(this)})),this.records=[],this.resetAggregateMeasures()}removeRecord(e){this.records.splice(this.records.indexOf(e),1),e.removeAggrFromCache(this),null!=e.measure_Self&&["Total"].concat(e.filteredOut?[]:["Active"]).concat(ae.Compare_List.filter((t=>e.isSelected(t)))).forEach((t=>{this[t].measure-=e.measure_Self,this[t].recCnt--}))}resetMeasure(e){this[e]={measure:0,recCnt:0}}resetAggregateMeasures(){ae.Total_Active_Compare_List.forEach((e=>this.resetMeasure(e))),this.records.forEach((e=>this._processRecord(e)))}addToActive(e,t){this.Active.measure+=e,this.Active.recCnt+=t}unselectAggregate(){var e;this._locked||null===(e=this.DOM.aggrGlyph)||void 0===e||e.classList.remove("showLock")}selectCompare(e){var t,i;this._compared=e,this.records.forEach((t=>t.setCompared(e))),null===(t=this.DOM.aggrGlyph)||void 0===t||t.classList.add("showLock"),null===(i=this.DOM.aggrGlyph)||void 0===i||i.classList.add(this._compared)}clearCompare(e){var t,i;null===(t=this.DOM.aggrGlyph)||void 0===t||t.classList.remove("showLock"),null===(i=this.DOM.aggrGlyph)||void 0===i||i.classList.remove(this._compared),this._locked&&this.unlockSelection(),this._compared=null,this.records.forEach((t=>t.unsetCompared(e)))}lockSelection(){var e;this._locked=!0,null===(e=this.DOM.aggrGlyph)||void 0===e||e.classList.add("locked")}unlockSelection(){var e;this._locked=!1,null===(e=this.DOM.aggrGlyph)||void 0===e||e.classList.remove("locked")}exportAggregateInfo(){return null}get tooltipTitle(){return""}get tooltipSkip1(){return!1}printCompared(e,t){return`<tr><td class='measureDetail'>${t}</td><td><span class='colorBox bg_${e}'></span></td> <td class='measureValue'>${ae.browser.getMeasureFormattedValue(this.measure(e).toLocaleString())}</td>`+(ae.browser.absoluteBreakdown?"":`<td class='percentValue'>(${ae.browser.getValueLabel(ae.browser.getChartValue(this,e))})</td>`)+"</tr>"}getTooltipHTML(){var e="",i=ae.browser,s=!0;if(e+=`<div class='tooltipSummaryName'>${this.tooltipTitle}</div>`,this.label&&(e+=`<span class='mapItemName ${this._compared?"bg_"+this._compared:""}'>${this.label}</span>`),e+="<div class='aggrTooltip'>",e+="<div class='aggrRecordCount'>",i.measureFunc.is("Sum")&&(s=!1,e+=i.getValueLabel(i.getMeasureValue(this,"Active","absolute"),!1,1,!1)+" "+me.measureText(i),e+=`<span class='percentBlock percentage_metricSumOutOf'> (${me.TooltipOne(i.getMeasureValue(this,"Active","dependent"),i)}) </span>`,e+="<div style='font-size: 0.8em;' class='tooltipAmong'>among</div>"),e+=`<span class="recordNumberInfo">${this.recCnt("Active").toLocaleString()} ${i.recordName}`,this.recCnt("Active")>0&&(this.recCnt("Active")!=i.allRecordsAggr.recCnt("Active")||this.tooltipSkip1)&&(e+=`${s?"<br>":""}\n          <span class='percentBlock percentage_recordOutOf'> \n          (${me.TooltipOne(100*this.recCnt("Active")/i.allRecordsAggr.recCnt("Active"),i)})\n        </span>`),e+="</span>",e+="</div>",i.isCompared()&&this.attrib&&this.recCnt("Active")>0&&(!this.attrib.isComparedAttrib()||this.attrib.isMultiValued&&i.activeComparisonsCount>1)){e+=`<div class='tooltipBreakdownHeader'> \n            <span class='BreakdownText'>${me.BreakdownBy}</span>\n            ${i.comparedAttrib.attribNameHTML}\n          </div>`,this.Other={measure:this.measure("Active"),recCnt:this.recCnt("Active")},i.activeComparisons.forEach((e=>{this.Other.measure-=this.measure(e),this.Other.recCnt-=this.recCnt(e)})),e+="<table class='tooltipBreakdownTable'>",i.activeComparisons.slice().sort(((e,t)=>this[t].measure-this[e].measure)).forEach((t=>{var s,r=i.selectedAggrs[t].label;(null===(s=this.attrib)||void 0===s?void 0:s.attribID)===i.comparedAttrib.attribID&&r===this.label||(e+=this.printCompared(t,r))}));let t=i.comparedAttrib;this.Other.measure&&!t.isMultiValued&&"dependent"!==this.attrib.browser.breakdownMode.get()&&(e+=this.printCompared("Other",`(${i.otherNameInCompare})`)),e+="</table>",e+=me.Tooltip_OutOf(this.label,i)}return e+="</div>",t.sanitize(e)}}class Me extends Ae{constructor(e){super(e),this.filterSelection=!1}get label(){return me.NoData}get filtered(){return this.filterSelection}set filtered(e){var t,i;this.filterSelection=e,0!==this.records.length&&(!1===this.filterSelection?null===(t=this.DOM.aggrGlyph)||void 0===t||t.classList.remove("filtered"):null===(i=this.DOM.aggrGlyph)||void 0===i||i.classList.add("filtered"))}exportAggregateInfo(){return{}}}const Se={extent:l};class Ce{constructor(){this._keyIndex={},this._timeseries_=[],this.extent_Time=null,this.extent_Value=null,this.extent_Value_raw=null}addTimeData(e){this._keyIndex[e._time_src]=e,this._timeseries_.push(e)}isEmpty(){return 0===this._timeseries_.length}hasTimeData(){return this._timeseries_.length>0}computeCaches(){this.extent_Time=Se.extent(this._timeseries_,(e=>e._time)),this.extent_Value=Se.extent(this._timeseries_,(e=>e._value)),this.extent_Value_raw=[...this.extent_Value]}sortTimeseries(){this._timeseries_.sort(((e,t)=>e._time.getTime()-t._time.getTime()))}}class De{toString(){return this.str}get pathStr(){return this.path.join("->")}constructor(e,t){var i;if(this.str=null,this.func=null,this.path=[],this.special=null,this.parent=null,this.blockType=null,this.lastKey=null,"function"==typeof e)return this.func=e,void(this.str=""+this.func);this.str=e;var s=e.split("->");if(this.lastKey=s[s.length-1],this.path=s.slice(0,-1),this.parent=t.attribWithName(this.path.join("->"))||null,0===this.path.length)this.func=function(){return this[e]};else{var r=e=>e[this.lastKey];switch(this.lastKey){case"Degree()":r=e=>e.length,this.special="Degree",this.blockType="numeric";break;case"Year()":r=e=>e&&!isNaN(e.getTime())?e.getUTCFullYear():null,this.special="Year",this.blockType="categorical";break;case"Month()":r=e=>e&&!isNaN(e.getTime())?e.getUTCMonth():null,this.special="Month",this.blockType="categorical";break;case"DayOfMonth()":r=e=>e&&!isNaN(e.getTime())?e.getUTCDate():null,this.special="DayOfMonth",this.blockType="numeric";break;case"WeekDay()":r=e=>e&&!isNaN(e.getTime())?e.getUTCDay():null,this.special="WeekDay",this.blockType="categorical";break;case"Hour()":r=e=>e&&!isNaN(e.getTime())?e.getUTCHours():null,this.special="Hour",this.blockType="numeric";break;case"Change(#)":r=e=>{let t=new Ce;return e._timeseries_.forEach(((i,s)=>{if(0!=s){var r=e._timeseries_[s],a=e._timeseries_[s-1];r&&a&&t.addTimeData({_time:i._time,_time_src:i._time_src,_value:r._value-a._value})}})),t},this.special="TimeseriesChange-#",this.blockType="timeseries";break;case"Change(%)":r=e=>{let t=new Ce;return e._timeseries_.forEach(((i,s)=>{if(0!=s){var r=e._timeseries_[s],a=e._timeseries_[s-1];r&&a&&t.addTimeData({_time:i._time,_time_src:i._time_src,_value:100*(r._value-a._value)/(a._value||1)})}})),t},this.special="TimeseriesChange-%",this.blockType="timeseries"}if(!this.special&&"timeseries"===(null===(i=this.parent)||void 0===i?void 0:i.type)){if(this.special="TimePoint",this.blockType="numeric",["TimeseriesChange-%","TimeseriesChange-#"].includes(this.parent.template.special))return void(this.func=e=>{var t=this.parent.getRecordValue(e);return t&&null==t.length&&0!==t.length?(t&&(t=r.call(this,t._keyIndex)),t?t._value:t):null});r=e=>e._keyIndex[this.lastKey]._value}this.func=function(){for(var e=this,t=0;t<s.length-1;t++)if(null==(e=e[s[t]]))return null;return e?r.call(this,e):e}}}}const we={scaleLinear:n,scaleLog:h,min:c,max:d};class Oe{get block(){return this._block}applyTemplateSpecial(){}isEmpty(){return 0===this._aggrs.length}isFiltered(){var e,t;return null!==(t=null===(e=this.summaryFilter)||void 0===e?void 0:e.isFiltered)&&void 0!==t&&t}createSummaryFilter(){}get parent(){var e;return this._parent||(null===(e=this.template)||void 0===e?void 0:e.parent)}hasTimeSeriesParent(){return!1}createDerivedAttrib(e,t=null){this.derivatives[e]||(this.derivatives[e]=this.browser.createAttrib(t||`${this.attribName}->${e.replace("()","")}`,`${this.template}->${e}`),this.browser.refreshAttribList())}get attribName(){return this._attribName}get printName(){return this._attribName.split("->").pop()}get pathName(){return this._attribName.split("->").slice(0,-1)}get groupPath(){return this.pathName}get attribNameHTML(){return`<span class='blockName_Path ${this.pathName.length?"visible":""}'>${this.pathName.map((e=>`<span class='groupName'>${e}</span><span class='fa fa-caret-right'></span>`)).join("")}</span><span class='blockName_Print'>${this.printName}</span>`}set attribName(e){var t,i,s;this._attribName!==e&&(this.browser.attribWithName(e)||(this.browser.removeAttribFromGroupIndex(this),this._attribName=e,this.browser.insertAttribIntoGroupIndex(this),this.browser.refreshAttribList(),null===(t=this.block)||void 0===t||t.refreshSummaryName_DOM(),(null===(s=null===(i=this.summaryFilter)||void 0===i?void 0:i.breadcrumb)||void 0===s?void 0:s.DOM)&&this.addDOMBlockName(this.summaryFilter.breadcrumb.DOM.select(".crumbHeader"))))}get description(){return!this._description&&this._parent?this._parent.description:this._description}set description(e){var i;this._description=t.sanitize(e,{})||null,null===(i=this.block)||void 0===i||i.updateDescription()}refreshConfigs(){Object.values(this.configs).forEach((e=>e.refresh()))}isIDAttrib(){return this.browser.idSummaryName===this.attribName}isComparedAttrib(){return this===this.browser.comparedAttrib}autoCompare(){}get canHaveMetricFuncs(){return!1}get supportedMetricFuncs(){return[]}addSupportedMetricFunc(e){this._metricFuncs.includes(e)||(this._metricFuncs.push(e),this.browser.measureSummary.refresh())}removeSupportedMetricFunc(e){var t;this._metricFuncs.includes(e)&&(this._metricFuncs=this._metricFuncs.filter((t=>t!=e)),this.attribID===(null===(t=this.measureSummary)||void 0===t?void 0:t.attribID)&&this.browser.measureFunc.is(e)?(this.browser.measureFunc.set("Count"),this.browser.measureFunc.refresh()):this.browser.measureSummary.refresh())}supportsRecordEncoding(e){return!1}getRecordValue(e){return e.getValue(this)}setRecordValueCacheToMissing(e){e.setValue(this,null),this.noValueAggr.addRecord(e)}getFormattedValue(e,t){return""}renderRecordValue(e,t){return""}constructor(e,t,i=null,s,r="",a=""){this._block=null,this.template=null,this._aggrs=[],this.aggr_initialized=!1,this.summaryFilter=null,this.derivatives={},this._parent=null,this._attribName=null,this._description="",this.configs={},this._metricFuncs=ae.defaultMetricFuncs,this.measureLogBase=10,this.measurable=null,this.browser=e,this._attribName=t,this.type=s,this.attribID=this.browser.attribCounter++,this.blockClassName=r,this.nuggetClassName=a,this.browser.attribs.push(this),this.template=i instanceof De?i:new De(t,this.browser),this.noValueAggr=new Me(this),this.browser.allAggregates.push(this.noValueAggr),this.isComparable=new xe({parent:this,cfgClass:"isComparable",cfgTitle:"Select-Compare",UI:{disabled:!0},default:!0,itemOptions:[{name:"Enabled",value:!0},{name:"Disabled",value:!1}],onSet:e=>{var t,i;e||(this._metricFuncs=[]),!e&&this.isComparedAttrib()&&this.browser.clearSelect_Compare(this.browser.activeComparisons),null===(i=null===(t=this.block)||void 0===t?void 0:t.DOM.root)||void 0===i||i.classed("disableCompareLock",!e)}}),this.measureScaleType=new xe({cfgClass:"measureScaleType",cfgTitle:"Axis Scale",parent:this,UISeperator:{title:"Axis"},default:"linear",iconClass:"fa fa-chart-line",helparticle:"5e88d63f04286364bc97d40b",itemOptions:[{name:me.Linear+" "+me.LinearSequence,value:"linear"},{name:me.Log+" "+me.Log10Sequence,value:"log"}],forcedValue:()=>this.stackedCompare||this.percentBreakdown||this.browser.measureSumWithNegativeValues()?"linear":void 0,onSet:e=>{var t;this.refreshChartScale_Measure(e),null===(t=this.block)||void 0===t||t.refreshViz_All()}}),this.axisScaleType=new xe({cfgClass:"axisScaleType",cfgTitle:"Axis Extent",default:"fit",parent:this,iconClass:"fa fa-chart-line",helparticle:"5e893b562c7d3a7e9aea656e",itemOptions:[{name:"Fit",value:"fit"},{name:"Sync",value:"sync"},{name:"Full",value:"full"}],forcedValue:()=>this.percentBreakdown&&!this.browser.isCompared()||this.browser.measureFunc_Avg&&"full"===this.axisScaleType._value?"fit":void 0,onSet:()=>{var e;this.aggr_initialized&&(this.updateChartScale_Measure(!0),null===(e=this.block)||void 0===e||e.refreshViz_All())}})}finishTemplateSpecial(){this.template.special&&(this.template.parent&&(this.template.parent.derivatives[this.template.special]=this),this.applyTemplateSpecial())}destroy(){this.browser.destroyAttrib(this)}addDOMBlockName(e){e.html(this.attribNameHTML),e.select(".blockName_Path").tooltip(me["Show/Hide Path"]).on("click",(e=>{e.currentTarget.classList.toggle("visible"),e.stopPropagation()}))}get records(){return this.browser.records}get breakdownMode(){return this.browser.breakdownMode.get()}get relativeBreakdown(){return this.browser.relativeBreakdown}get absoluteBreakdown(){return this.browser.absoluteBreakdown}get dependentBreakdown(){return this.browser.dependentBreakdown}get totalBreakdown(){return this.browser.totalBreakdown}get percentBreakdown(){return this.browser.percentBreakdown}get stackedCompare(){return this.browser.stackedCompare.is(!0)}vizActive(e){return this.browser.vizActive(e)}get measureFunc(){return this.browser.measureFunc.get()}get activeComparisons(){return this.browser.activeComparisons}get activeComparisonsCount(){return this.browser.activeComparisonsCount}get measureSummary(){return this.browser.measureSummary.get()}get measureScale_Log(){return this.measureScaleType.is("log")}get measureScale_Linear(){return this.measureScaleType.is("linear")}get measureExtent_Self(){var e=this.getPeakAggr(we.max),t=0;return this.absoluteBreakdown&&this.browser.measureSumWithNegativeValues()&&(t=Math.min(this.getPeakAggr(we.min),0)),this.measureScale_Log&&t<=0&&(t=Math.max(1,t)),0===e&&0===t&&(e=.001),[t,e]}get measureDomain_Final(){var e,t;return(null===(e=this.block)||void 0===e?void 0:e.panel)?this.axisScaleType.is("fit")?this.measureExtent_Self:this.axisScaleType.is("full")?this.absoluteBreakdown?[0,this.browser.allRecordsAggr.measure("Active")]:[0,100]:this.axisScaleType.is("sync")?null===(t=this.block)||void 0===t?void 0:t.panel.syncedMeasureExtent:this.measureExtent_Self:this.measureExtent_Self}refreshChartScale_Measure(e=null){var t,i;if(null!=e||(e=this.measureScaleType.get()),this.chartScale_Measure_prev=null!==(i=null===(t=this.chartScale_Measure)||void 0===t?void 0:t.copy().clamp(!1))&&void 0!==i?i:null,this.measureLogBase=10,this.chartScale_Measure="log"===e?we.scaleLog().base(this.measureLogBase):we.scaleLinear(),this.chartScale_Measure.clamp(!0),this.chartScale_Measure_prev){var s=this.chartScale_Measure_prev.domain();this.measureScale_Log?0===s[0]&&(s[0]=1):s[0]=Math.min(0,s[0]),this.chartScale_Measure.domain(s).range(this.chartScale_Measure_prev.range())}}updateChartScale_Measure(e=!1){var t,i,s,r,a;if(this.aggr_initialized&&!this.isEmpty()){this.chartScale_Measure_prev=null!==(i=null===(t=this.chartScale_Measure)||void 0===t?void 0:t.copy().clamp(!1))&&void 0!==i?i:null;var o=this.measureDomain_Final;this.measureScale_Log&&0===o[0]&&(o[0]=1);var l=!1;if(this.relativeBreakdown&&this.browser.activeComparisonsCount>0&&(l=100!==o[1]),null===(r=null===(s=this.block)||void 0===s?void 0:s.DOM.root)||void 0===r||r.classed("hideActive",l),this.chartScale_Measure.domain(o).range([0,this.measureRangeMax]),!e&&this.chartScale_Measure_prev){var n=this.chartScale_Measure_prev.domain();o[0]===n[0]&&o[1]===n[1]&&this.measureRangeMax===this.chartScale_Measure_prev.range()[1]||null===(a=this.block)||void 0===a||a.refreshViz_All()}}}getPeakAggr(e,t=null){if(this.isEmpty())return 0;if("string"==typeof t)return e(this._aggrs,(e=>e.usedAggr?this.browser.getChartValue(e,t):null));if(0===this.activeComparisonsCount)return this.getPeakAggr(e,"Active");if((this.absoluteBreakdown||this.totalBreakdown)&&this.browser.showWholeAggr.is(!0)&&this.browser.measureWithPositiveValues())return this.getPeakAggr(e,"Active");var i=this.activeComparisons;return this.browser.stackedChart?e(this._aggrs,(e=>e.usedAggr?i.reduce(((t,i)=>t+this.browser.getChartValue(e,i)),0):null)):e(i.map((t=>this.getPeakAggr(e,t))))}set unitName(e){var t;this.measurable&&(this.measurable.unitName=e,null===(t=this.browser.recordDisplay.View)||void 0===t||t.refreshAttribUnitName(this))}get unitName(){var e;return(null===(e=this.measurable)||void 0===e?void 0:e.unitName)||""}get valueDomain(){var e;return(null===(e=this.measurable)||void 0===e?void 0:e.valueDomain)||null}get metricFuncs(){var e;return(null===(e=this.measurable)||void 0===e?void 0:e.metricFuncs)||ae.defaultMetricFuncs}get isMultiValued(){return!1}applyConfig(t){var i;return e(this,void 0,void 0,(function*(){t.noNugget&&this.browser.removeAttribFromGroupIndex(this),!1===t.isComparable&&(yield this.isComparable.set(!1)),t.metricFuncs&&(this._metricFuncs=t.metricFuncs),yield this.axisScaleType.set(t.axisScaleType),null===(i=this.block)||void 0===i||i.setCollapsed(!0===t.collapsed),this.description=t.description,this.initializeAggregates()}))}isExportable(){return!0}exportConfig(){var e,t,i,s={name:this._attribName,panel:(null===(t=null===(e=this.block)||void 0===e?void 0:e.panel)||void 0===t?void 0:t.name)||"none",description:this.description||void 0,collapsed:null===(i=this.block)||void 0===i?void 0:i.collapsed,type:this.type},r=Object.assign({value:this.template.str!==s.name?this.template.str:void 0,axisScaleType:this.axisScaleType.exportValue(),measureScaleType:this.measureScaleType.exportValue(),isComparable:this.isComparable.exportValue()},this.measurable);return Object.assign({},s,r)}}class Te{}class xe{constructor(e){var t,i,s,r,a;this.noExport=!1,this.lookup=new Map,Object.assign(this,e),null!==(t=this.UI)&&void 0!==t||(this.UI={disabled:!1}),null!==(i=this.isActive)&&void 0!==i||(this.isActive=e=>"_range_"===e._type?this.get()>0:this.is(e.value)),null===(s=this.itemOptions)||void 0===s||s.filter((e=>null!==e.value)).forEach((e=>this.lookup.set(e.value,e.name))),(null===(r=null==this?void 0:this.parent)||void 0===r?void 0:r.configs)&&(this.parent.configs[this.cfgClass]=this),this._prevValue=e.default,this._value=e.default,null===(a=this.onSet)||void 0===a||a.call(this,this.get(),this)}toString(){let e=this.get();return me[this.lookup.get(e)||e]}get(){var e,t,i,s;return null!==(s=null!==(t=null===(e=this.forcedValue)||void 0===e?void 0:e.call(this,this))&&void 0!==t?t:null===(i=this.onRead)||void 0===i?void 0:i.call(this,this._value))&&void 0!==s?s:this._value}is(e){return this.get()===e}set(t){var i,s,r,a;return e(this,void 0,void 0,(function*(){if(null==t)return;if(this.preSet)try{t=yield this.preSet(t,this)}catch(e){return void((null===(i=this.parent)||void 0===i?void 0:i.finalized)&&ye.alert(e))}if(null==t)return;if(this._value===t)return;this._prevValue=this._value,this._value=t;(null===(s=this.forcedValue)||void 0===s?void 0:s.call(this,this))!==t&&(yield null===(r=this.onSet)||void 0===r?void 0:r.call(this,this.get(),this),(null===(a=this.parent)||void 0===a?void 0:a.refreshConfigs)?this.parent.refreshConfigs():this.refresh())}))}undoChange(){return e(this,void 0,void 0,(function*(){yield this.set(this._prevValue)}))}refresh(){var t,i,s,r;return e(this,void 0,void 0,(function*(){if(null===(t=this.onRefreshDOM)||void 0===t||t.call(this,this),this.DOM){if(this.forcedValue){var e=this.forcedValue(this);this.DOM.root.classed("forced",null!=e),null!=e&&(yield null===(i=this.onSet)||void 0===i?void 0:i.call(this,e,this))}this.isActive&&this.DOM.configOptions.classed("active",this.isActive),null===(s=this.DOM.noUiSlider)||void 0===s||s.setHandle(0,this._value,!1),null===(r=this.itemOptions)||void 0===r||r.filter((e=>e.DOM&&e.activeWhen)).forEach((e=>{e.DOM.classList[e.activeWhen()?"remove":"add"]("disabled")}))}}))}reset(){var t,i;return e(this,void 0,void 0,(function*(){yield null===(t=this.onSet)||void 0===t?void 0:t.call(this,this.get(),this),(null===(i=this.parent)||void 0===i?void 0:i.refreshConfigs)?this.parent.refreshConfigs():yield this.refresh()}))}addUISeperator(e){var t;this.UISeperator&&e.append("tr").attr("class",null!==(t="configItemGroup "+this.UISeperator.className)&&void 0!==t?t:"").append("td").attr("class","groupName").html(me[this.UISeperator.title])}insertControl(t){var i,s;if(null===(i=this.UI)||void 0===i?void 0:i.disabled)return;this.addUISeperator(t),this.DOM={},this.DOM.root=t.append("tr").attr("class","configItem configItem_"+this.cfgClass),this.DOM.root.append("td").attr("class","configItem_Header").append("span").html(me[this.cfgTitle]);let r=this.DOM.root.append("td").attr("class","configItem_Icon").append("span");this.iconClass?r.attr("class","icon "+this.iconClass):r.attr("class","icon").append("span").html(this.iconXML);var a=this.DOM.root.append("td").attr("class","configItem_Options_td").append("div").attr("class","configItem_Options");this.DOM.configOptions=a.selectAll(".configOption").data(this.itemOptions||[]).enter().append("span").attr("class",(e=>"configOption pos_"+(e._type||e.value||e.name))).each(((e,t,i)=>{e.DOM=i[t]})),this.DOM.configOptions.filter((e=>void 0!==e.value)).html((e=>me[e.name])).on("click",((t,i)=>e(this,void 0,void 0,(function*(){return yield this.set(i.value)})))),this.DOM.configOptions.filter((e=>"_range_"===e._type)).append("span").attr("class","configOptionRange").each(((t,i,s)=>{this.DOM.noUiSlider=u.create(s[i],{connect:"lower",step:1,behaviour:"tap-drag",range:{min:t.minValue,max:t.maxValue},start:this.default}),s[i].noUiSlider.on("set",(t=>e(this,void 0,void 0,(function*(){return yield this.set(t)}))))})),this.DOM.root.append("td").attr("class","configItem_Info").append("span").attr("class","fal fa-question-circle").attr("data-helparticle",this.helparticle).tooltip((this.tooltip?this.tooltip+"<br><br>":"")+"Learn more",{placement:"bottom"}),ye.createHelpScoutLinks(this.DOM.root),null===(s=this.onDOM)||void 0===s||s.call(this,this.DOM),this.refresh()}exportValue(){if(!this.noExport&&this._value!==this.default){var e=this._value;return e instanceof Oe&&(e=e.attribName),e._time_src&&(e=e._time_src),e}}exportConfigTo(e){e[this.cfgClass]=this.exportValue()}}const Ve={utcParse:p,format:m,easeCubicOut:g,scaleLog:h,scaleLinear:n,arc:v,line:f,curveMonotoneX:b};var Re={mergeConfig:(e,t={})=>Re._mergeLevel(JSON.parse(JSON.stringify(e)),JSON.parse(JSON.stringify(t)),e,t),_mergeLevel(e,t,i,s){for(var r in s){var a=s[r];if(null!=e[r])if(null!==a)switch(typeof a){case"object":if("object"==typeof e[r]){if("summaries"===r){if(!Array.isArray(t.summaries)||!Array.isArray(e.summaries)){console.log("Merge error: summaries property is not array");continue}var o=[];s.summaries.forEach((e=>{e.skipConfig||(e.skipConfig=!1);var t=i.summaries.find((t=>t.name===e.name));t&&((e=Re._mergeLevel(JSON.parse(JSON.stringify(t)),JSON.parse(JSON.stringify(e)),t,e)).skipConfig||delete e.skipConfig),o.push(e)})),i.summaries.forEach((e=>{o.find((t=>t.name===e.name))||o.push(e)})),e.summaries=o}else Re._mergeLevel(e[r],t[r],i[r],s[r]);break}default:e[r]=a}else delete e[r];else e[r]=a}for(var r in i)void 0===s[r]&&(e[r]=i[r]);for(var r in s)e[r]=e[r]||s[r];return e},strCollate:new Intl.Collator(void 0,{ignorePunctuation:!0,sensitivity:"base",numeric:!0}),sortFunc_List_String:(e,t)=>Re.strCollate.compare(""+e,""+t),sortFunc_List_Date:(e,t)=>null==e?1:null==t?-1:t.getTime()-e.getTime(),sortFunc_List_Number:(e,t)=>t-e,toProperCase:e=>e.toLowerCase().replace(/\b[a-z]/g,(e=>e.toUpperCase())),addUnitName(e,t,i=!1){if(!t)return(e+"").replace("G","B");var s=i?t:"<span class='unitName'>"+t+"</span>";return((Re.isCurrency(t)?s+e:e+s)+"").replace("G","B")},isCurrency(e){switch(e){case"$":case"€":case"₺":case"¥":case"£":case"₼":case"؋":case"ƒ":case"¢":case"﷼":case"₪":case"₣":case"₩":case"₦":case"₲":case"฿":case"₴":case"₡":case"₱":case"₫":case"₽":case"₹":case"៛":case"лв":case"zł":case"Br":case"Lek":return!0;default:return!1}},getTimeParseFunc:e=>"%EPOCH"===e?e=>new Date(Math.floor(1e3*e)):"%sn"!==e&&"%SN"!==e?Ve.utcParse(e):function(e){if(null!==e){var t=86400*Math.floor(e-25569),i=e-Math.floor(e);if(0===i)return new Date(1e3*t);var s=Math.floor(86400*i);return new Date(1e3*t+1e3*s)}},baseMeasureFormat:Ve.format(".2s"),formatForItemCount(e,t=""){let i;return(e=Math.round(e))<1e3&&e>-1e3?i=e.toString():(i=Re.baseMeasureFormat(e),3===i.replace(/\D/g,"").length&&(i=Ve.format(".3s")(e))),Re.addUnitName(i,t,!1)},isStepTicks:e=>e.length>=2&&e.every(((t,i)=>0===i||1===Math.abs(e[i]-e[i-1]))),insertMinorTicks(e,t,i,s=4){e[0]>e[e.length-1]&&(e=e.reverse());for(var r=1;r<e.length;r++){let a=e[r-1];const o=e[r],l=(o-a)/s;let n=t(a);const h=t(o);for(let c=1;c<s;c++)if(4===s){let e=(n+h)/2;const s=(a+o)/2;i.push({tickValue:t.invert(e),major:!1,tickUnique:s}),n=e,a=s}else{let t=e[r-1]+c*l;i.push({tickValue:t,major:!1,tickUnique:t})}}},ignoreScrollEvents:!1,scrollToPos_do(e,t){e=e.node(),Re.ignoreScrollEvents=!0;var i=null,s=e.scrollTop,r=Ve.easeCubicOut,a=function(o){null==i&&(i=o);var l=r((o-i)/500);e.scrollTop=(1-l)*s+l*t,e.scrollTop>=t||e.offsetHeight+e.scrollTop>=e.scrollHeight?Re.ignoreScrollEvents=!1:window.requestAnimationFrame(a)};window.requestAnimationFrame(a)},removeEmptyKeys(e){Object.keys(e).forEach((t=>void 0===e[t]&&delete e[t]))},ordinal_suffix_of(e){const t=e%10,i=e%100;return 1==t&&11!=i?`${e}st`:2==t&&12!=i?`${e}nd`:3==t&&13!=i?`${e}rd`:`${e}th`},addMarginToBounds(e){if(!e.isValid())return e;const t=e.getNorthWest(),i=e.getSouthEast(),s=t.distanceTo(i);return e.extend(t.toBounds(s/10)).extend(i.toBounds(s/10))},getAttribTypeOrder(e){switch(e){case"categorical":return 1;case"numeric":return 2;case"timestamp":return 3;case"timeseries":return 4;case"recordGeo":return 5;case"content":return 6;case"recordGeo":return 7;default:return 20}},intersects:(e,t)=>!(e[0][0]>t._northEast.lng)&&(!(e[0][1]>t._northEast.lat)&&(!(e[1][0]<t._southWest.lng)&&!(e[1][1]<t._southWest.lat))),intersectsDOMRect:(e,t)=>!(!e||!t)&&(!(e.left>t.right)&&(!(e.right<t.left)&&(!(e.top>t.bottom)&&!(e.bottom<t.top)))),getD3Scale:e=>e?Ve.scaleLog().base(2):Ve.scaleLinear(),getLineGenerator:(e,t)=>Ve.line().curve(Ve.curveMonotoneX).x((t=>e(t._time))).y((e=>t(e._value))).defined((e=>null!=e._value)),getPieSVGPath(e,t,i,s){const r=Math.min(e+t,.999999),a=Math.PI*(360*e-90)/180,o=Math.PI*(360*r-90)/180,l=t>.5?1:0;return"M "+Math.cos(a)*i+","+Math.sin(a)*i+" A "+i+","+i+" "+l+" "+l+" 1 "+Math.cos(o)*i+","+Math.sin(o)*i+" "+(s?"":"L0,0")},getCirclePath:()=>Ve.arc().innerRadius(0).outerRadius(.001).startAngle(0).endAngle(2*Math.PI)(null)};class ke extends Ae{get minV(){return this._minV}get maxV(){return this._maxV}get tooltipTitle(){return this.attrib.attribNameHTML}validateMinMax(){if(this.minV<=this.maxV)return;let e=this.minV;this._minV=this.maxV,this._maxV=e}isMinLarger(){return this.minV>this.attrib.rangeOrg[0]}isMaxSmaller(){return this.maxV<this.attrib.rangeOrg[1]}updateRecords(){this.records=this.attrib.sortedRecords.filter((e=>this.isRecordWithin(e)))}constructor(e,t,i){super(e),this._minV=null,this._maxV=null,this.isMaxIncluded=!1,this.setRange(t,i)}setRange(e,t){this._minV=e,this._maxV=t}isRecordWithin(e){let t=this.attrib.getRecordValue(e);return!(t<this.minV)&&(!(t>this.maxV)&&(t!==this.maxV||this.isMaxIncluded))}exportAggregateInfo(){return{min:this.minV,max:this.maxV}}}class Le extends ke{constructor(){super(...arguments),this.hasFloat=!0}get label(){if(null==this.minV||null==this.maxV)return"-";if(this.maxV===this.minV+1&&!this.hasFloat)return this.attrib.getFormattedValue(this.minV,!1);var e=this.attrib.getFormattedValue(this.minV,!1),t=this.attrib.getFormattedValue(this.maxV,!1);return this.isMinLarger()&&this.isMaxSmaller()?this.isMaxIncluded?`${e} &mdash; ${t}`:`${e} up to ${t}`:this.isMinLarger()?`Min ${e}`:this.isMaxIncluded?`Max ${t}`:`Up to ${t}`}validateMinMax(){super.validateMinMax(),this.hasFloat||(this._minV=Math.floor(this.minV),this._maxV=Math.ceil(this.maxV)),this._minV=Math.max(this.minV,this.attrib.rangeOrg[0]),this._maxV=Math.min(this.maxV,this.attrib.rangeOrg[1])}}class Pe extends ve{constructor(e,t){super(e),this.attrib=t}get title(){return this.attrib.attribName}exportFilter(){var e={};return this.noValueAggr.filtered?e.missing=this.noValueAggr.filtered:this.active&&(e.min=this.active.minV,e.max=this.active.maxV),e}importFilter(e){e.missing?this.noValueAggr.filtered=e.missing:this.active=this.attrib.createAggregate(e.min,e.max),this.setFiltered(!1),this.applyFilter()}onClear(){var e;super.onClear(),this.active=null,null===(e=this.browser.recordDisplay)||void 0===e||e.filterStatusUpdated(this.attrib)}onFilter(){var e,t;if(null===(e=this.browser.recordDisplay)||void 0===e||e.filterStatusUpdated(this.attrib),this.noValueAggr.filtered){var i="in"===this.noValueAggr.filtered?e=>null===this.attrib.getRecordValue(e):e=>null!==this.attrib.getRecordValue(e);this.attrib.records.forEach((e=>{e.setFilterCache(this.filterID,i(e))}))}else{var s;s=this.active.isMinLarger()&&this.active.isMaxSmaller()?this.active.isMaxIncluded?e=>e>=this.active.minV&&e<=this.active.maxV:e=>e>=this.active.minV&&e<this.active.maxV:this.active.isMinLarger()?e=>e>=this.active.minV:this.active.isMaxIncluded?e=>e<=this.active.maxV:e=>e<this.active.maxV,this.attrib.records.forEach((e=>{var t=this.attrib.getRecordValue(e);e.setFilterCache(this.filterID,null!==t&&s(t))})),null===(t=this.attrib.block.DOM.zoomControl)||void 0===t||t.attr("sign",this.attrib.block.zoomableStatus()),this.attrib.block.refreshIntervalSlider(),super.onFilter()}}filterView_Detail(){return"in"===this.noValueAggr.filtered?`(${me.NoData})`:"out"===this.noValueAggr.filtered?`(${me.ValidData})`:this.active.label}}class Ne extends Pe{}class Be extends Pe{importFilter(e){e.missing?this.noValueAggr.filtered=e.missing:this.active=this.active=this.attrib.createAggregate(e.min,e.max),this.setFiltered(!1),this.applyFilter()}}class Ie{constructor(e,t){this.measure_Self=1,this._aggrCache=[],this._valueCache=[],this._filterCache=[],this._filteredOut=!1,this._filterCacheIsDirty=!0,this.selected={Compare_A:!1,Compare_B:!1,Compare_C:!1,Compare_D:!1,Compare_E:!1},this.recordRank=0,this.recordOrder=0,this.recordRank_Unique=0,this._view={},this.data=e,this._id=e[t],this.DOM={record:void 0}}get id(){return this._id}get label(){return this._id}setValue(e,t){this._valueCache[e.attribID]=t}getValue(e){return this._valueCache[e.attribID]}get filteredOut(){return this._filteredOut}get isIncluded(){return!this._filteredOut}setFilterCache(e,t){this._filterCache[e]!==t&&(this._filterCache[e]=t,this._filterCacheIsDirty=!0)}refreshFilterCache(){var e;if(!this._filterCacheIsDirty)return!1;var t=this.isIncluded;if(this._filteredOut=this._filterCache.some((e=>!e)),this._filterCacheIsDirty=!1,this.isIncluded===t)return!1;if(null!=this.measure_Self){var i=this.isIncluded?1:-1,s=i*this.measure_Self;this._aggrCache.forEach((e=>{e.addToActive(s,i)}))}return null===(e=this.DOM.record)||void 0===e||e.classList.toggle("isExcluded"),!0}isSelected(e=null){return e?this.selected[e]:ae.Compare_List.some((e=>this.selected[e]))}get activeComparisons(){return ae.Compare_List.filter((e=>this.selected[e]))}assignDOM(e){this.DOM.record=e,e&&(this.DOM.record.classList[this.isIncluded?"remove":"add"]("isExcluded"),ae.Compare_List.forEach((e=>{this.DOM.record.classList[this.selected[e]?"add":"remove"]("rec-selected-"+e)})))}removeAggrFromCache(e){this._aggrCache.splice(this._aggrCache.indexOf(e),1)}moveDOMtoTop(){this.DOM.record&&navigator.userAgent.indexOf("Edge")<=0&&this.DOM.record.parentNode.appendChild(this.DOM.record)}highlightRecord(){var e;null===(e=this.DOM.record)||void 0===e||e.classList.add("rec-selected-onRecord"),this._aggrCache.forEach((e=>{var t;null===(t=e.DOM.aggrGlyph)||void 0===t||t.classList.add("withRecordHighlight"),e instanceof ke&&e.attrib.block.showRecordValue(this)}))}unhighlightRecord(){var e;null===(e=this.DOM.record)||void 0===e||e.classList.remove("rec-selected-onRecord"),this._aggrCache.forEach((e=>{var t,i,s;null===(t=e.DOM.aggrGlyph)||void 0===t||t.classList.remove("withRecordHighlight"),e instanceof ke&&(null===(s=(i=e.attrib.block).hideRecordValue)||void 0===s||s.call(i))}))}flipSelected(e,t){var i;null===(i=this.DOM.record)||void 0===i||i.classList[this.selected[t]===e?"remove":"add"]("rec-selected-"+t)}addToAggrMeasure(e){this.filteredOut||this._aggrCache.forEach((t=>{0!==this.measure_Self&&(t[e].measure+=this.measure_Self,t[e].recCnt++)}))}removeFromAggrMeasure(e){this.filteredOut||this._aggrCache.forEach((t=>{0!==this.measure_Self&&(t[e].measure-=this.measure_Self,t[e].recCnt--)}))}setCompared(e){this.selected[e]||(this.selected[e]=!0,this.DOM.record&&(this.DOM.record.classList.add("rec-selected-"+e),"path"===this.DOM.record.nodeName&&this.DOM.record.parentNode.appendChild(this.DOM.record)),this.addToAggrMeasure(e))}unsetCompared(e){var t;this.selected[e]&&(this.selected[e]=!1,null===(t=this.DOM.record)||void 0===t||t.classList.remove("rec-selected-"+e),this.removeFromAggrMeasure(e))}getTimeKeys(){return this._valueCache.filter((e=>e instanceof Ce)).map((e=>Object.values(e._keyIndex))).flat().filter(((e,t,i)=>i.findIndex((t=>t._time.getTime()===e._time.getTime()))===t)).sort(((e,t)=>t._time.getTime()-e._time.getTime()))}}const Ee={extent:l};class Fe extends Oe{get block(){return this._block}get attribName(){return super.attribName}set attribName(e){super.attribName=e,this.attribName===e&&this.browser.recordDisplay.refreshAttribOptions("sort")}binMatch(e,t){return+e[0]-+t.minV==0&&+e[1]-+t.maxV==0}refreshValueScale(){var e=this.block.getScaleNicing();this.valueScale=this.getValueScaleObj().domain(this.rangeActive).range([0,this.block.width_histogram]).nice(e),this.intervalTicks=this.valueScale.ticks(e),this.updateTickPrintFunc()}updateScaleAndBins(e=!1){if(!this.isEmpty()&&this.aggr_initialized){this.valueScale_prev=this.valueScale.copy();var t=this.block.height_Ticklabels;this.refreshValueScale();var i=this.intervalTicks;if(0!==i.length){this.block.aggrWidth=this.valueScale(i[1])-this.valueScale(i[0]);var s=this.intervalTicks.reduce(((e,t,i,s)=>(i<s.length-1&&e.push([t,s[i+1],null]),e)),[]);this._aggrs=this._aggrs.filter((e=>!!s.some((t=>this.binMatch(t,e)))||(e.clearRecords(),this.browser.allAggregates.splice(this.browser.allAggregates.indexOf(e),1),!1))),(s=s.filter((e=>!this._aggrs.some((t=>this.binMatch(e,t)))))).length>0&&(s.forEach(((e,t)=>{let i=this.getAggregate(e[0],e[1]);t===s.length-1&&(i.isMaxIncluded=!0),e[2]=i})),this._aggrs=this._aggrs.sort(((e,t)=>+t.minV-+e.minV)),this.records.forEach((e=>{var t=this.getRecordValue(e);null!=t&&s.forEach((i=>{if(!(t<i[0])){var s=i[2];(t<i[1]||t==i[1]&&s.isMaxIncluded)&&s.addRecord(e)}}))}))),this.block.DOM.inited&&(this.block.refreshIntervalSlider(),(s.length>0||e)&&(this.block.insertVizDOM(),t!==this.block.height_Ticklabels&&this.block.setHeight(this.block.getHeight()),this.updateChartScale_Measure(),this.block.refreshViz_All(!1)))}}}get stepTicks(){return this._stepTicks}setStepTicks(e){this._stepTicks=e}initializeAggregates(){this.aggr_initialized||(this.noValueAggr.records.length>0&&(this.noValueAggr.records=[],this.noValueAggr.resetAggregateMeasures()),this.fillValueCache(),this.sortedRecords=this.records.filter((e=>null!=this.getRecordValue(e))),this.sortedRecords.sort(((e,t)=>+this.getRecordValue(e)-+this.getRecordValue(t))),this.updatedRangeOrg(),this.refreshValueScale(),this.pofffff(),this.aggr_initialized=!0)}getAggregate(e,t){var i=this.createAggregate(e,t);return this._aggrs.push(i),this.browser.allAggregates.push(i),i}createSummaryFilter(){this.summaryFilter=new Pe(this.browser,this)}updatedRangeOrg(){this.rangeOrg=this.getRecordValueExtent()}get rangeActive(){return this.summaryFilter.isFiltered&&this.block.zoomed.is(!0)?[this.summaryFilter.active.minV,this.summaryFilter.active.maxV]:this.rangeOrg}getRecordValueExtent(){return Ee.extent(this.sortedRecords,(e=>this.getRecordValue(e)))}getVizDomain(){return this.initializeAggregates(),this.valueScale.domain()}setRangeFilter_Custom(e,t){var i=this.createAggregate(e,t);i.validateMinMax(),this.setRangeFilter(i,!0)}setRangeFilter(e,t=!1){e.validateMinMax(),this.summaryFilter.active=e,this.summaryFilter.noValueAggr.filtered=!1,this.block.refreshIntervalSlider(),this.rangeFilterTimer&&window.clearTimeout(this.rangeFilterTimer),this.rangeFilterTimer=window.setTimeout((()=>{this.summaryFilter.setFiltered(),this.rangeFilterTimer=0}),t?250:0)}get sortLabel(){return this._sortLabel?e=>this._sortLabel.call(e.data,e):e=>{var t=this.getRecordValue(e);return null==t?"":this.getFormattedValue(t,!1)}}set sortLabel(e){this._sortLabel=e}getRecordValue(e){return e.getValue(this)}constructor(e,t,i,s,r,a){super(e,t,i,s,"kshfSummary_Interval "+r,a),this._aggrs=[],this.sortedRecords=[],this.intervalTicks=[],this.valueScale=null,this.valueScale_prev=null,this.intervalTickPrint=null,this._stepTicks=!1,this.rangeFilterTimer=0,this._sortLabel=null,this.createSummaryFilter()}updateChartScale_Measure(e=!1){this.block.isVisible()&&(super.updateChartScale_Measure(e),this.block.refreshViz_Bins(),this.block.refreshViz_All(!1))}get measureRangeMax(){return this.block.height_hist}sanitizeRange(e,t){var i=this.activeComparisons.filter((e=>this.browser.Compare_Highlight!==e&&null!=this.browser.selectedAggrs[e].minV)).map((e=>this.browser.selectedAggrs[e])).map((e=>({minV:e.minV,maxV:e.maxV}))).reduce(((i,s)=>i.minV===i.maxV?i:s.minV<=i.minV&&i.maxV<=s.maxV||i.minV<=s.minV&&s.maxV<=i.maxV?{minV:e,maxV:t}:s.minV>i.maxV||s.maxV<i.minV?i:s.maxV>i.minV&&s.minV<i.minV?{minV:s.maxV,maxV:i.maxV}:s.minV<i.maxV&&s.minV>i.maxV?{minV:i.minV,maxV:s.minV}:i),{minV:e,maxV:t});return[i.minV,i.maxV]}renderRecordValue(e,t){e instanceof Ie&&(e=this.getRecordValue(e)),null==e?e="-":"timestamp"!==this.type&&(e=e.toLocaleString());let i=this.getFormattedValue(e,!1);if(!t)return i;t.html(i)}printAbbr(e,t=!1){return null==e?"-":(this.initializeAggregates(),this.getFormattedValue(this.intervalTickPrint(e),t))}isEmpty(){return!this.aggr_initialized}applyConfig(t){const i=Object.create(null,{applyConfig:{get:()=>super.applyConfig}});return e(this,void 0,void 0,(function*(){i.applyConfig.call(this,t),yield this.block.showHistogram.set(t.showHistogram),yield this.block.optimumBinWidth.set(t.optimumBinWidth),yield this.block.maxHeightRatio.set(t.maxHeightRatio),yield this.measureScaleType.set(t.measureScaleType),yield this.block.zoomed.set(t.zoomed),t.filter?this.summaryFilter.importFilter(t.filter):this.isFiltered()&&this.summaryFilter.clearFilter()}))}}const Ge={select:a,pointer:_};class ze{get browser(){return this.attrib.browser}get _aggrs(){return this.attrib._aggrs}get collapsed(){return this._collapsed}constructor(e){this.DOM={inited:!1},this.panel=null,this._collapsed=!1,this._height_header=0,this.noRefreshVizAxis=!1,this.attrib=e}get inDashboard(){return null!==this.panel}isVisible(){return!this.attrib.isEmpty()&&this.inDashboard&&!this.collapsed&&this.DOM.inited}onClearFilter(e=!1){}getWidth(){return this.panel?this.panel.width_Real-2:0}getHeight(){return this.height_Header+this.height_Content}get height_withMargin(){return this.getHeight()+8}get height_Header(){if(!this.DOM.inited)return 0;if(!this._height_header){if(this.panel.isCollapsed())return 0;this._height_header=29}return this._height_header}refreshHeight(){!this.attrib.isEmpty()&&this.inDashboard&&this.DOM.inited&&this.DOM.root.style("flex-basis",this.getHeight()+"px")}insertRoot(e){this.DOM.root=this.panel.DOM.root.insert("div",(()=>e)),this.DOM.root.attr("class","kshfSummary "+this.attrib.blockClassName).attr("summary_id",this.attrib.attribID).classed("disableCompareLock",!this.attrib.isComparable.is(!0)).classed("filtered",this.attrib.isFiltered()).datum(this),this.insertHeader(),Object.values(this.attrib.configs).forEach((e=>e.insertControl(this.DOM.summaryConfig)))}updateDescription(){var e,t;null===(e=this.DOM.nugget)||void 0===e||e.select(".summaryDescription").classed("active",!!this.attrib.description||null).node().tippy.setContent(this.attrib.description),null===(t=this.DOM.summaryIcons)||void 0===t||t.select(".summaryDescription").classed("active",!!this.attrib.description||null)}addToPanel(e,t=null,i=!1){var s;if(e){null===t&&(t=e.attribs.length);var r=!1;if(null===this.panel)r=!0;else if(this.panel&&this.panel!==e)this.panel.removeBlock(this),r=!0;else{if(this.orderInPanel===t)return;var a=this.panel.DOM.root.selectAll(".dropZone").nodes()[this.orderInPanel];a.parentNode.removeChild(a),this.orderInPanel<t&&t--}e.addBlock(this,t),null===(s=this.DOM.nugget)||void 0===s||s.classed("inDashboard",(e=>this.inDashboard)),r&&(this.refreshWidth(),this.refreshViz_Axis()),this.browser.refreshIsEmpty()}}removeFromPanel(){var e;if(this.panel){if(this.panel.removeBlock(this),this.DOM.root){let e=this.DOM.root.node();e.parentNode.removeChild(e)}this.panel=null,null===(e=this.DOM.nugget)||void 0===e||e.classed("inDashboard",(e=>this.inDashboard)),this.browser.refreshIsEmpty()}}insertHeader(){var e=this,t=!1;this.DOM.headerGroup=this.DOM.root.append("div").attr("class","headerGroup").on("mousedown",(function(i){if(e.browser.authorMode){var s=this,r=!1;t=!1,Ge.select("body").style("cursor","move").on("keydown.layout",(function(){27===i.keyCode&&(s.style.opacity=null,e.browser.clearDropZones())})).on("mousemove.layout",(function(i){t=!0,r||(s.nextSibling&&(s.nextSibling.style.display="none"),s.previousSibling&&(s.previousSibling.style.display="none"),s.parentNode.style.opacity=.5,e.browser.prepareDropZones(e.attrib,"browser"),r=!0);var a=Ge.pointer(i,e.browser.DOM.root.node());e.browser.DOM.attribDragBox.style("transform","translate("+(a[0]-20)+"px,"+(a[1]+5)+"px)"),i.stopPropagation(),i.preventDefault()})).on("mouseup.layout",(function(t){Ge.select("body").style("cursor",null),e.browser.clearDropZones(),e.panel,s.parentNode.style.opacity=null,s.nextSibling&&(s.nextSibling.style.display=""),s.previousSibling&&(s.previousSibling.style.display=""),t.preventDefault()})),i.preventDefault()}else i.preventDefault()})).on("mouseup",(()=>{t||(Ge.select("body").style("cursor",null),this.browser.clearDropZones(),this.browser.unregisterBodyCallbacks())})),this.DOM.headerGroup.append("span").attr("class","header_display_control iconGroup").on("mousedown",(e=>e.stopPropagation())).selectAll("span").data([["Remove","far fa-times-circle",()=>{this.removeFromPanel(),this.browser.updateLayout()}],["Collapse","far fa-compress-alt",()=>this.setCollapsedAndLayout(!0)],["Open","far fa-expand-alt",()=>this.setCollapsedAndLayout(!1)]]).enter().append("span").attr("class",(e=>"buttonSummary"+e[0]+" "+e[1])).tooltip((e=>me[e[0]+"Summary"]),{placement:"bottom"}).on("click",((e,t)=>t[2]())),this.DOM.summaryNameWrapper=this.DOM.headerGroup.append("span").attr("class","summaryNameWrapper"),this.DOM.blockName=this.DOM.summaryNameWrapper.append("span").attr("class","blockName summaryName").on("click",(()=>{this.collapsed&&this.setCollapsedAndLayout(!1)})),this.attrib.addDOMBlockName(this.DOM.blockName),this.DOM.summaryIcons=this.DOM.headerGroup.append("span").attr("class","summaryIcons iconGroup").on("mousedown",(e=>e.stopPropagation())),this.DOM.summaryConfigControl=this.DOM.summaryIcons.append("span").attr("class","summaryConfigControl fal fa-cog").tooltip(me.Configure,{placement:"bottom"}).on("click",(()=>{var e=!this.DOM.root.classed("showConfig");this.browser.closeConfigPanels(),e&&(this.browser.blockWithOpenConfig=this),this.DOM.root.classed("showConfig",e)})),this.DOM.summaryIcons.append("span").attr("class","summaryDescription fa fa-info").tooltip("",{placement:"bottom",onShow:e=>{e.reference.tippy.setContent(this.attrib.description)}}),this.updateDescription(),this.DOM.headerGroup.append("div").attr("class","configPanel summaryConfig").on("mousedown",(e=>e.stopPropagation())).call((e=>{e.append("div").attr("class","configClose fa fa-window-close").tooltip(me.Close).on("click",(()=>{this.browser.closeConfigPanels(),this.DOM.root.classed("showConfig",!1)})),e.append("div").attr("class","compactSizeControl far fa-angle-double-up").on("click",(e=>e.target.parentNode.classList.toggle("compact"))),this.DOM.summaryConfig=e.append("table").attr("class","configTable")})),this.DOM.wrapper=this.DOM.root.append("div").attr("class","wrapper"),this.refreshSummaryName_DOM(),this.insertDOM_EmptyAggr(),this.DOM.summaryNameWrapper.insert("div",":first-child").attr("class","summaryHeaderButton clearFilterButton fa").tooltip(me.RemoveFilter,{placement:"bottom"}).on("mousedown",(e=>e.stopPropagation())).on("click",(e=>{var t;null===(t=this.attrib.summaryFilter)||void 0===t||t.clearFilter(),e.stopPropagation()})),this.DOM.summaryNameWrapper.append("div").attr("class","summaryHeaderButton summaryLockButton far fa-clone").tooltip("",{onTrigger:e=>{e.reference.tippy.setContent(me[this.browser.comparedAttrib===this.attrib?"Unlock":"CompareTopCategories"])}}).on("mousedown",(e=>e.stopPropagation())).on("click",(e=>{this.attrib.isComparedAttrib()?this.browser.clearSelect_Compare(this.browser.activeComparisons,!0,!0):this.attrib.autoCompare(),e.stopPropagation()}))}refreshSummaryName_DOM(){var e;this.DOM.blockName&&this.attrib.addDOMBlockName(this.DOM.blockName),null===(e=this.DOM.nugget)||void 0===e||e.select(".summaryName").html(this.attrib.printName)}get hasNugget(){return!!this.DOM.nugget}refreshNugget(e){var t=this;let i;this.DOM.nugget=e,this.DOM.nugget.on("dblclick",((e,t)=>{1===e.which&&(this.inDashboard?this.removeFromPanel():this.browser.autoAddAttib(t.item),this.browser.updateLayout())})).on("mousedown",(function(e){if(1===e.which){var s=this;i=!1,Ge.select("body").on("keydown.layout",(e=>{27===e.keyCode&&(s.removeAttribute("moved"),t.browser.clearDropZones())})).on("mousemove.layout",(e=>{i||(s.setAttribute("moved",""),t.browser.prepareDropZones(t.attrib,"authoringPanel"),i=!0);var r=Ge.pointer(e,t.browser.DOM.root.node());t.browser.DOM.attribDragBox.style("transform",`translate(${r[0]-20}px,${r[1]+5}px)`),e.stopPropagation(),e.preventDefault()})).on("mouseup.layout",(e=>{i&&(s.removeAttribute("moved"),t.browser.DOM.root.attr("drag_cursor",null),t.browser.clearDropZones(),e.preventDefault())})),e.preventDefault()}})).on("mouseup",(()=>{i||this.browser.unregisterBodyCallbacks()}))}setCollapsedAndLayout(e){this.setCollapsed(e),this.browser.updateLayout_Height(),this.DOM.root&&!this.collapsed&&this.DOM.inited&&(this.refreshViz_All(),this.refreshMeasureLabelText("Active"))}setCollapsed(e){var t,i;this._collapsed=e,null===(t=this.panel)||void 0===t||t.refreshCollapsed(),this.height_Header,null===(i=this.DOM.root)||void 0===i||i.classed("collapsed",this.collapsed).classed("showConfig",!1),this.onCollapse()}onCollapse(){}get measureLineZero(){return this.attrib.chartScale_Measure(0)}refreshViz_Cache(e,t=null){if(this.DOM.inited&&"setpair"!==this.attrib.type){var i=this.measureLineZero,s=this.browser.stackedChart?t||this.browser.activeComparisons:[],r=(e,t)=>this.attrib.chartScale_Measure(this.browser.getChartValue(e,t))-i;this._aggrs.forEach((t=>{t.setScale(e,r(t,e)),t.setOffset(e,s.reduce(((e,i)=>e+r(t,i)),0))})),"Active"===e&&s.length>0&&this.browser.stackedChart&&this._aggrs.forEach((t=>{t.setScale(e,t.scale("Active")-t.offset(e))}))}}refreshViz_All(e=!0){this.isVisible()&&this.attrib.chartScale_Measure&&(this.refreshViz_Active(),this.refreshViz_Compare_All(),this.refreshViz_NoValueAggr(),e&&this.refreshViz_Axis())}refreshViz(e){if("content"!==this.attrib.type)return"Active"===e?this.refreshViz_Active():this.refreshViz_Compare(e,0,0,null)}refreshViz_Compare_All(){if("content"!==this.attrib.type){var e=this.browser.activeComparisons,t=this.browser.activeComparisonsCount;e.forEach(((i,s)=>this.refreshViz_Compare(i,s,t,e.slice(0,s))))}}refreshViz_Axis(){if(this.isVisible()&&!this.noRefreshVizAxis){var e=this.attrib.chartScale_Measure.copy().clamp(!1),t=e.ticks(Math.min(10,this.chartAxis_Measure_TickSkip()));this.browser.hasIntOnlyMeasure()&&(t=t.filter((e=>Number.isInteger(e))));var i=t.map((e=>({tickValue:e,major:!0})));if(this.attrib.measureScale_Log)if(2===this.attrib.measureLogBase)Re.insertMinorTicks(t,this.attrib.chartScale_Measure,i);else{var s=e.domain()[1];if(s>this.attrib.measureLogBase){i=[],t=[];var r=1;for(s*=this.attrib.measureLogBase;r<s;)i.push({tickValue:r,major:!0}),t.push(r),r*=this.attrib.measureLogBase}Re.insertMinorTicks(t,this.attrib.chartScale_Measure,i,this.attrib.measureLogBase-1),s=e.domain()[1],i=i.filter((e=>e.tickValue<s))}var a="categorical"===this.attrib.type?(e,t)=>`translateX(${t(e.tickValue)-.5}px)`:(e,t)=>`translateY(${-t(e.tickValue)}px)`,o=t=>t.style("transform",(t=>a(t,e))).style("opacity",1),l=this.DOM.chartAxis_Measure_TickGroup.selectAll("span.tick").data(i,(e=>e.tickValue));l.enter().append("span").attr("class","tick").call((e=>{e.append("span").attr("class","line"),e.append("span").attr("class","text measureAxis_1"),e.append("span").attr("class","text measureAxis_2"),this.browser.chartsLoaded&&this.attrib.chartScale_Measure_prev&&!this.browser.preventAxisScaleTransition&&(e=e.style("opacity",0).classed("noAnim",!0).style("transform",(e=>a(e,this.attrib.chartScale_Measure_prev))).classed("noAnim",!1).transition().duration(0).delay(10)),o(e)})).merge(l).classed("major",(e=>e.major)).classed("minor",(e=>!e.major)).call((e=>e.selectAll(".text").html((e=>this.browser.getValueLabel(e.tickValue,!1))))),o(l),l.exit().call((t=>(this.browser.chartsLoaded&&this.attrib.chartScale_Measure_prev&&!this.browser.preventAxisScaleTransition&&(t=t.style("transform",(t=>a(t,e)))),t.style("opacity",0).transition().duration(0).delay(500).remove())))}}refreshViz_NoValueAggr(){var e;0!==this.attrib.noValueAggr.records.length&&(null===(e=this.DOM.noValueAggr)||void 0===e||e.classed("visible",this.attrib.noValueAggr.recCnt("Active")>0))}refreshMeasureLabelPos_All(){this.refreshMeasureLabelPos("Active"),this.browser.activeComparisons.forEach(((e,t)=>this.refreshMeasureLabelPos(e,t)))}refreshMeasureLabelPos(e="Active",t=0){}refreshMeasureLabelText(e){var t;if(this.isVisible()){var i=this.DOM["measureLabel_"+e];if(i){var s=this.browser.stackedChart&&"Active"===e?this.browser.activeComparisons:[],r=t=>{var i,r,a=this.browser.getMeasureValue(t,e,null,s),o="g"===(null===(r=null===(i=t.DOM)||void 0===i?void 0:i.aggrGlyph)||void 0===r?void 0:r.nodeName);return this.browser.getValueLabel(a,o,ae.percentDecimal?1:0)};i.html(r),this.attrib.noValueAggr.records.length>0&&"Active"===e&&(s=[],null===(t=this.DOM.noValueAggr)||void 0===t||t.select(".measureLabel_Active").html(r))}}}insertDOM_EmptyAggr(){this.DOM.noValueAggr=this.DOM.wrapper.append("span").attr("class","noValueAggr aggrGlyph").classed("filtered",this.attrib.noValueAggr.filtered).datum(this.attrib.noValueAggr).tooltip((e=>this.attrib.noValueAggr.getTooltipHTML()),{theme:"dark kshf-tooltip kshf-record"}).each(((e,t,i)=>{this.attrib.noValueAggr.setAggrGlyph(i[t])})).on("mouseover",(()=>{this.browser.adjustMode||this.browser.mouseOverCompare.is(!1)||this.browser.setSelect_Compare(this.attrib.noValueAggr)})).on("mouseout",(()=>{this.browser.clearSelect_Compare()})).on("click",(e=>{if(e.shiftKey)this.browser.lockSelect_Compare();else{var t=this.attrib.noValueAggr,i={name:"Filter",items:[]};t.filtered&&i.items.push({id:"filterOption_Remove",name:`<span class='filterContextOpt'>${me.Clear}</span>`,do:()=>{t.filtered=!1,this.attrib.summaryFilter.how="All",this.attrib.summaryFilter.clearFilter()}}),"in"!==t.filtered&&i.items.push({id:"filterOption_Only",iconXML:"✗",name:me.KeepNoData,helparticle:"5e88e95e04286364bc97d43f",do:()=>{this.attrib.summaryFilter.clearFilter(),t.filtered="in",this.attrib.summaryFilter.how="All",this.attrib.summaryFilter.setFiltered()}}),"out"!==t.filtered&&i.items.push({id:"filterOption_Not",iconXML:"✓",name:me.KeepValidData,helparticle:"5e88e95e04286364bc97d43f",do:()=>{t.filtered="out",this.attrib.summaryFilter.setFiltered()}}),ye.popupMenu(e,i,t)}})),this.DOM.noValueAggr.append("div").attr("class","noValueIcon").text("∅"),this.DOM.noValueAggr.append("div").attr("class","measureLabel measureLabel_Active"),this.refreshViz_NoValueAggr()}refreshUIFiltered(e){var t;null===(t=this.DOM.root)||void 0===t||t.classed("filtered",e).classed("filtered_missing",!!e&&!1!==this.attrib.noValueAggr.filtered)}insertChartAxis_Measure(e){this.DOM.chartAxis_Measure=e.append("div").attr("class","chartAxis_Measure"),this.DOM.chartAxis_Measure.append("div").attr("class","measureDescrLabel"),this.refreshMeasureDescrLabel(),this.DOM.chartAxis_Measure_TickGroup=this.DOM.chartAxis_Measure.append("div").attr("class","tickGroup")}refreshMeasureDescrLabel(){var e;null===(e=this.DOM.root)||void 0===e||e.selectAll(".measureDescrLabel").html(me.MeasureDescrLabel(this.browser,this.attrib))}insertAggrLockButton(e,t){var i=e=>{e.compared&&e.locked?this.browser.clearSelect_Compare(e.compared,!0,!0):this.browser.setSelect_Compare(e,null,!1)&&this.browser.lockSelect_Compare()};e.append("span").attr("class","lockButton far fa-clone").tooltip((e=>me[e.locked?"Unlock":"LockToCompare"]),{placement:t}).on("click",((e,t)=>{this.browser.comparedAttrib&&!this.attrib.isComparedAttrib()?ye.confirm(me.DialogChangeCompare(this.attrib.attribNameHTML,this.browser.comparedAttrib.attribNameHTML),me.Confirm).then((()=>{this.browser.clearSelect_Compare(this.browser.activeComparisons,!1,!0),i(t)}),(()=>{})):this.browser.Compare_Highlight||t.locked?i(t):ye.alert(me.ComparedSelectionsLimit),e.preventDefault(),e.stopPropagation()}))}showRecordValue(e){}hideRecordValue(){}}const He={select:a,pointer:_,min:c,max:d,extent:l};class We extends ze{get valueScale(){return this.attrib.valueScale}constructor(t){super(t),this.height_hist=1,this.height_Ticklabels=13,this.width_measureAxisLabel=35,this.highlightRangeLimits_Active=!1,this.aggrWidth=0,this._initPos=null,this.zoomed=new xe({parent:this,cfgClass:"zoomed",cfgTitle:"ValueAxisZoom",default:!1,UI:{disabled:!0},iconClass:"far fa-search",helparticle:"5e87ea002c7d3a7e9aea606c",itemOptions:[{name:"Zoomed",value:!0},{name:"Full",value:!1}],forcedValue:()=>{if(!this.attrib.isFiltered())return!1},onSet:t=>e(this,void 0,void 0,(function*(){var e;if(this.attrib.aggr_initialized){this.attrib.refreshValueScale(),this.DOM.inited&&(this.DOM.summaryInterval.classed("zoomed",t),this.DOM.zoomControl.attr("sign",t?"minus":"plus")),this.noRefreshVizAxis=!0;var i=this.attrib.chartScale_Measure.copy().clamp(!1);"timestamp"!==this.attrib.type&&this.attrib.refreshScaleType(),this.attrib.updateScaleAndBins(),this.refreshHeight(),this.noRefreshVizAxis=!1,this.attrib.chartScale_Measure_prev=i,this.refreshViz_Axis(),yield null===(e=this.browser.recordDisplay)||void 0===e?void 0:e.refreshAttribScaleType(this),this.attrib.updateScaleAndBins()}}))}),this.optimumBinWidth=new xe({parent:this,cfgClass:"optimumBinWidth",cfgTitle:"BinWidth",UISeperator:{title:"Binning"},default:ae.width_HistBinDefault,iconClass:"fa fa-arrows-h",helparticle:"5e87e8952c7d3a7e9aea6065",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{name:"1x",value:45,max:90},{name:"2x",value:90,max:135},{name:"3x",value:135,max:180},{name:"4x",value:180,max:1e5},{name:"<i class='fa fa-plus'></i>",value:-199,_type:"plus"}],isActive:e=>e.value<=this.optimumBinWidth.get()&&e.max>this.optimumBinWidth.get(),preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-5:-199===t&&(t=i._value+5),Math.max(45,Math.min(180,t))})),onSet:()=>this.attrib.updateScaleAndBins()}),this.maxHeightRatio=new xe({parent:this,cfgClass:"maxHeightRatio",cfgTitle:"BinHeight",default:ae.height_MaxRatioDefault,UISeperator:{title:"Size"},iconClass:"fa fa-arrows-v",helparticle:"5e87e7502c7d3a7e9aea6060",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{name:"1x",value:.15,max:.3},{name:"2x",value:.3,max:.6},{name:"4x",value:.6,max:1.2},{name:"8x",value:1.2,max:1.5},{name:"10x",value:1.5,max:2},{name:"<i class='fa fa-plus'></i>",value:-199,_type:"plus"}],isActive:e=>{var t=this.maxHeightRatio.get();return"timestamp"===this.attrib.type&&(t*=3),e.value<=t&&e.max>t},onRead:e=>"timestamp"===this.attrib.type?e/3:e,preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-.05:-199===t&&(t=i._value+.05),Math.max(.08,Math.min(1.5,t))})),onSet:()=>{this.attrib.aggr_initialized&&this.browser.updateLayout_Height()}}),this.showHistogram=new xe({parent:this,cfgClass:"showHistogram",cfgTitle:"Histogram",iconClass:"fa fa-chart-bar",UISeperator:{title:"Charts"},default:!0,itemOptions:[{name:"Show",value:!0},{name:"Hide",value:!1}],onSet:e=>{t.aggr_initialized&&(e||(this.height_hist=0),this.refreshChartsVisibleOption(),this.browser.updateLayout_Height())}}),this.attrib.configs.zoomed=this.zoomed,this.attrib.configs.optimumBinWidth=this.optimumBinWidth,this.attrib.configs.maxHeightRatio=this.maxHeightRatio,this.attrib.configs.showHistogram=this.showHistogram}get _aggrs(){return this.attrib._aggrs}refreshIntervalSlider(e=void 0){this.DOM.intervalSlider&&(e||ae.Active_Compare_List).forEach((e=>{var t,i,s,r,a,o,l;if("Active"===e)l=this.attrib.isFiltered(),a=null!==(i=null===(t=this.attrib.summaryFilter.active)||void 0===t?void 0:t.minV)&&void 0!==i?i:this.attrib.rangeOrg[0],o=null!==(r=null===(s=this.attrib.summaryFilter.active)||void 0===s?void 0:s.maxV)&&void 0!==r?r:this.attrib.rangeOrg[1];else{l=this.browser.vizActive(e)&&this.attrib.isComparedAttrib();var n=this.browser.selectedAggrs[e];l&&(a=n.minV,o=n.maxV)}a=Math.max(this.valueScale.range()[0],this.valueScale(a)),o=Math.min(this.valueScale.range()[1],this.valueScale(o)),this.DOM.intervalSlider.select(".base_"+e).classed("visible",l).style("left",a+"px").style("width",o-a+"px"),"Active"===e&&this.DOM.rangeHandle.style("transform",(e=>`translateX(${"min"===e?a:o}px)`))}))}get height_hist_max(){return Math.max(ae.height_HistMin,this.width_histogram*this.maxHeightRatio.get())}get height_RangeMax(){return this.attrib.isEmpty()?this.height_Header:this.height_Header+this.height_Extra_max+(this.showHistogram.get()?this.height_hist_max:0)}get height_RangeMin(){return this.attrib.isEmpty()?this.height_Header:0+this.height_Header+this.height_Extra_max}get height_slider(){return 12}get height_padding(){return 7}get height_Extra_base(){return this.height_padding+this.height_slider+this.height_Ticklabels}get height_Extra(){return this.height_Extra_base+(this.showHistogram.get()?ae.height_HistBottomGap:0)+4}get height_Extra_max(){return this.height_Extra_base+ae.height_HistBottomGap}get height_Content(){return this.isVisible()?(this.showHistogram.get()?this.height_hist:0)+this.height_Extra:0}chartAxis_Measure_TickSkip(){return this.height_hist/30}setHeight(e){if(this._aggrs){var t=Math.min(this.height_hist_max,e-this.height_Header-this.height_Extra);this.height_hist!==t&&(this.height_hist=t,this.attrib.updateChartScale_Measure(!0))}}refreshHeight(){if(super.refreshHeight(),!this.attrib.isEmpty()&&this.inDashboard&&this.DOM.inited){var e=this.showHistogram.get()?this.height_hist+23:10;this.DOM.valueTickGroup.style("height",this.height_Ticklabels+"px"),this.DOM.rangeHandle.style("height",e+"px").style("top",10-e+"px"),this.DOM.highlightRangeLimits.style("height",this.height_hist+"px"),this.DOM.histogram.style("height",this.height_hist+"px"),this.DOM.root.select(".chartAxis_Measure > .measureDescrLabel").style("width",this.height_hist+"px").style("left",-this.height_hist/2+"px"),this.refreshViz_Bins(),this.updateValueTicks(),this.refreshViz_All()}}get width_marginLeft(){return this.width_measureAxisLabel+ae.width_measureDescrLabel}get width_marginRight(){return this.width_measureAxisLabel*(this.isWideChart()?1:.5)+8}get width_histogram(){return this.inDashboard?Math.max(2,this.getWidth()-this.width_marginLeft-this.width_marginRight):30}get width_Bin(){return this.aggrWidth-2*ae.width_HistBarGap}isWideChart(){return this.getWidth()>500}refreshWidth(){this.attrib.updateScaleAndBins(!0),!1!==this.DOM.inited&&(this.DOM.wrapper.classed("showMeasureAxis_2",this.isWideChart()),this.DOM.summaryInterval.style("padding-left",this.width_marginLeft+"px").style("padding-right",this.width_marginRight+"px"),this.DOM.blockName.style("max-width",this.collapsed?null:this.getWidth()-40+"px"))}insertVizDOM(){this.refreshViz_Bins(),this.refreshViz_Axis(),this.refreshMeasureLabelText("Active"),this.updateValueTicks()}refreshViz_Bins(){if(this.DOM.inited){var e=this,t=this.measureLineZero,i=e=>this.valueScale(e.maxV)-this.valueScale(e.minV)-2*ae.width_HistBarGap,s=e=>`translateX(${this.valueScale(e.minV)+ae.width_HistBarGap}px)`,r=e=>{ae.Total_Active_Compare_List.forEach((s=>{e.selectAll(".measure_"+s).style("transform",(e=>`translateY(${this.height_hist-t}px) scale(${i(e)},0)`))}))};this.DOM.aggrGlyphs=this.DOM.histogram_bins.selectAll(".aggrGlyph").data(this._aggrs,(e=>[e.maxV,e.minV])).join((t=>t.append("span").attr("class","aggrGlyph rangeGlyph").tooltip((e=>e.getTooltipHTML()),{theme:"dark kshf-tooltip kshf-record",placement:"bottom",animation:"fade",trigger:"manual"}).on("mouseenter",(function(t,i){0!==i.Active.recCnt&&(e.highlightRangeLimits_Active||(this.highlightTimeout=window.setTimeout((()=>{e.onAggrHighlight(i),this.tippy.show()}),e.browser.movingMouseDelay)))})).on("mouseleave",(function(t,i){this.tippy.hide(),0!==i.Active.recCnt&&(e.highlightRangeLimits_Active||(this.highlightTimeout&&window.clearTimeout(this.highlightTimeout),e.onAggrLeave(i)))})).on("click",((e,t)=>this.onAggrClick(e,t))).call((e=>{e.transition().duration(0).delay(10).style("opacity",null).style("pointer-events",null);var t=e.append("div").attr("class","measureGroup");ae.Total_Active_Compare_List.forEach((e=>{this.DOM["measure_"+e]=t.append("span").attr("class",`measure_${e} bg_${e}`).on("mouseenter",((t,i)=>{i.DOM.aggrGlyph.querySelector(".measureLabel_"+e).classList.add("forceShow"),ae.Compare_List.find((t=>t===e))&&this.browser.refreshAllMeasureLabels(e)})).on("mouseleave",((t,i)=>{var s=i.DOM.aggrGlyph.querySelector(".measureLabel_"+e);s&&s.classList.remove("forceShow"),ae.Compare_List.find((t=>t===e))&&this.browser.refreshAllMeasureLabels("Active")}))})),r(e),this.insertAggrLockButton(e,"top"),e.append("span").attr("class","measureLabelGroup").call((e=>{ae.Active_Compare_List.forEach((t=>{e.append("span").attr("class","measureLabel measureLabel_"+t)}))}))}))),(e=>e.style("width",(e=>i(e)+"px")).style("transform",s).call((e=>r(e)))),(e=>(this.noRefreshVizAxis&&this.browser.finalized?(e.style("width",(e=>i(e)+"px")).style("transform",s).style("opacity",0).style("pointer-events","none").transition().duration(0).delay(700).remove(),r(e)):e.remove(),e))).call((e=>{e.style("width",(e=>i(e)+"px")).style("transform",s),e.each((function(e){e.isVisible=!0,e.setAggrGlyph(this)})),ae.Total_Active_Compare_List.forEach((t=>{this.DOM["measure_"+t]=e.selectAll(".measure_"+t)})),this.DOM.lockButton=e.selectAll(".lockButton"),this.DOM.measureLabelGroup=e.selectAll(".measureLabelGroup"),ae.Active_Compare_List.forEach((t=>{this.DOM["measureLabel_"+t]=e.selectAll(".measureLabel_"+t)}))}))}}refreshViz_Active(){if(!this.isVisible()||!this.DOM.aggrGlyphs||!this.valueScale)return;var e=this.measureLineZero;this.DOM.aggrGlyphs.classed("NoActiveRecords",(e=>0===e.measure("Active"))),this.refreshViz_Cache("Active"),this.DOM.lockButton.style("transform",(t=>`translateY(${this.height_hist-e-t.sumOffsetScale("Active")-10}px)`)).classed("inside",(e=>this.browser.relativeBreakdown||Math.abs(this.height_hist-e.offset("Active")-e.scale("Active"))<6));var t=this.attrib.isFiltered()&&!this.attrib.stepTicks&&this.attrib.summaryFilter.active&&"timestamp"!==this.attrib.type;let i,s,r,a;t&&(i=this.attrib.summaryFilter.active.minV,s=this.attrib.summaryFilter.active.maxV,r=this.valueScale(i),a=this.valueScale(s)),this.DOM.measure_Active.style("transform",(o=>{var l=0,n=this.width_Bin;if(t){var h=o.minV,c=o.maxV;if(c>i&&h<s){if(h<i){var d=r-this.valueScale(h);l=d,n-=d}c>s&&(n-=this.valueScale(c)-a-2*ae.width_HistBarGap)}else o.setScale("Active",0)}return`translate(${l}px, ${this.height_hist-e-o.offset("Active")}px) scale(${n},${o.scale("Active")})`})),this.refreshMeasureLabelText("Active"),this.refreshMeasureLabelPos("Active")}refreshViz_Compare(e,t,i,s=[]){this.isVisible()&&this.DOM.aggrGlyphs&&this.valueScale&&(this.refreshViz_Cache(e,s),this.refreshMeasureLabelText(e),this.refreshMeasureLabelPos(e,t))}refreshMeasureLabelPos(e="Active",t=0){if(this.isVisible()&&this.DOM.aggrGlyphs&&this.valueScale&&"Other"!==e)if(this.browser.stackedChart)this.DOM["measureLabel_"+e].classed("hidden",(t=>t.scale(e)<16||0==this.browser.getMeasureValue(t,e))).style("width","100%").style("transform",((t,i,s)=>(s[i].setAttribute("labelAlign","middle"),`translate(0px, ${-t[e].offset-t[e].scale/2}px)`)));else if("timestamp"===this.attrib.type&&("Active"!==e||this.browser.activeComparisonsCount>0)){this._aggrs.forEach((e=>{e._spacer=e._spacer||{}}));var i=["Active"].concat(this.browser.activeComparisons).filter((t=>t!==e));this.DOM["measureLabel_"+e].style("transform",((t,s,r)=>{var a=t.offset(e)+t.scale(e);"Active"===e&&(a+=20),a=5-Math.min(a,this.height_hist),t._spacer[e]={min:a-5,max:a+20};var o=i.some((e=>{var i=t._spacer[e];return!!i&&(i.min<=a&&i.max>=a)}));return r[s].classList[o?"add":"remove"]("hidden"),`translate(0px, ${a}px)`}))}else{var s=this.browser.activeComparisonsCount,r=100,a=0,o=!1;if("Active"!==e&&"Total"!==e&&s>1&&this.browser.vizActive(e)){var l=this.width_Bin/s;a=l*t,r=100/s,o=l<this.panel.width_CatMeasureLabel}this.DOM["measureLabel_"+e].classed("hidden","timestamp"!==this.attrib.type&&o).style("transform",`translate(${a}px, 2px)`).style("width",`${r}%`)}}updateAfterFilter(){this.isVisible()&&(this.attrib.updateChartScale_Measure(),this.refreshMeasureLabelText("Active"),this.refreshViz_NoValueAggr())}showRecordValue(e){if(this.inDashboard&&this.DOM.inited&&this.valueScale){var t=this.attrib.getRecordValue(e);null!=t&&(t<this.valueScale.domain()[0]||t>this.valueScale.domain()[1]||(this.DOM.recordValue.style("transform","translateX("+this.attrib.getValuePosX(t)+"px)").style("display","block"),this.DOM.recordValueText.html(this.attrib.getFormattedValue(t,!1))))}}hideRecordValue(){this.DOM.inited&&this.DOM.recordValue&&this.DOM.recordValue.style("display",null)}initDOM(e){if(this.attrib.initializeAggregates(),this.attrib.isEmpty())return!1;if(this.DOM.inited)return!0;this.insertRoot(e),this.DOM.summaryInterval=this.DOM.wrapper.append("div").attr("class","summaryInterval").on("mousedown",(e=>{e.stopPropagation(),e.preventDefault()}));var t=e=>{this._initPos=void 0,this.highlightRangeLimits_Active=!1,e.preventDefault(),e.stopPropagation()};return this.DOM.histogram=this.DOM.summaryInterval.append("div").attr("class","histogram"),this.DOM.histogram_bins=this.DOM.histogram.append("div").attr("class","aggrGroup").on("mousemove",(e=>{if(e.shiftKey){var i=this.valueScale.invert(He.pointer(e)[0]);null==this._initPos&&(this._initPos=i);var[s,r]=He.extent([this._initPos,i]);if([s,r]=this.attrib.sanitizeRange(s,r),s!==r){this.highlightRangeLimits_Active=!0,this.browser.vizActive(this.browser.Compare_Highlight)&&this.browser.clearSelect_Compare(this.browser.Compare_Highlight,!1);var a=this.attrib.createAggregate(s,r);a.updateRecords(),this.browser.allRecordsAggr.clearCompare(this.browser.Compare_Highlight),this.browser.setSelect_Compare(a),e.preventDefault(),e.stopPropagation()}}else this.highlightRangeLimits_Active&&(this.browser.clearSelect_Compare(),t(e))})).on("click",(e=>{e.shiftKey&&this.highlightRangeLimits_Active&&(this.browser.lockSelect_Compare(),t(e))})),this.DOM.highlightRangeLimits=this.DOM.histogram_bins.selectAll(".highlightRangeLimits").data([0,1]).enter().append("div").attr("class","highlightRangeLimits"),this.insertChartAxis_Measure(this.DOM.histogram),this.initDOM_Slider(),this.insertVizDOM(),this.setCollapsed(this.collapsed),this.DOM.inited=!0,this.refreshChartsVisibleOption(),!0}initDOM_Slider(){var t=this;this.DOM.intervalSlider=this.DOM.summaryInterval.append("div").attr("class","intervalSlider"),this.DOM.zoomControl=this.DOM.intervalSlider.append("span").attr("class","zoomControl far").tooltip("",{onTrigger:e=>{var t="plus"===e.reference.getAttribute("sign");e.reference.tippy.setContent(t?"Zoom into filtered range":"Zoom out")}}).attr("sign",this.zoomed.is(!0)?"minus":"plus").on("click",(t=>e(this,void 0,void 0,(function*(){yield this.zoomed.set("plus"===t.currentTarget.getAttribute("sign"))}))));var i=this.DOM.intervalSlider.append("div").attr("class","controlLine").on("mousedown",(function(e){if(1===e.which){t.browser.DOM.root.classed("adjustingWidth",!0).classed("noPointerEvents",!0);var i=this.parentNode,s=t.valueScale.invert(He.pointer(e,i)[0]);He.select("body").on("mousemove",(function(e){var r=t.valueScale.invert(He.pointer(e,i)[0]);t.browser.preventAxisScaleTransition=!0,t.attrib.setRangeFilter_Custom(He.min([s,r]),He.max([s,r]))})).on("mouseup",(function(){t.browser.preventAxisScaleTransition=!1,t.browser.DOM.root.classed("adjustingWidth",!1).classed("noPointerEvents",!1),He.select("body").on("mousemove",null).on("mouseup",null)})),e.preventDefault()}}));this.DOM.activeTotalRange=i.append("span").attr("class","base base_Total"),i.append("span").attr("class","base base_Active").tooltip(me.DragToFilter,{placement:"bottom"}).on("mousedown",(function(e){if(1===e.which&&"timestamp"!==t.attrib.type){t.browser.DOM.root.classed("noPointerEvents",!0);var i=this.parentNode,s=t.attrib.summaryFilter.active.minV,r=t.attrib.summaryFilter.active.maxV,a=He.pointer(e,i)[0];He.select("body").on("mousemove",(()=>{t.browser.preventAxisScaleTransition=!0,t.dragRange(a,He.pointer(e,i)[0],s,r)})).on("mouseup",(()=>{t.browser.preventAxisScaleTransition=!1,t.browser.DOM.root.classed("noPointerEvents",!1),He.select("body").on("mousemove",null).on("mouseup",null)})),e.preventDefault(),e.stopPropagation()}})),ae.Compare_List.forEach((e=>{i.append("span").attr("class","base base_Compare bg_"+e).tooltip(me.DragToFilter,{placement:"bottom"})})),this.DOM.rangeHandle=i.selectAll(".rangeHandle").data(["min","max"]).enter().append("span").attr("class",(e=>"rangeHandle "+e)).tooltip(me.DragToFilter).on("mouseenter",(function(){this.dragging||(this.tippy.show(),this.classList.add("dragging"))})).on("mouseleave",(function(){this.dragging||(this.tippy.hide(),this.classList.remove("dragging"))})).on("dblclick",(function(e,i){t.showValuePicker(this,i)})).on("mousedown",(function(e,i){if(1===e.which){t.browser.DOM.root.classed("adjustingWidth",!0).classed("noPointerEvents",!0),this.classList.add("dragging");var s=this;s.dragging=!0;var r=this.parentNode;t.attrib.summaryFilter.active.minV,t.attrib.summaryFilter.active.maxV,He.select("body").on("mousemove.range",(function(e){t.valueScale.invert(He.pointer(e,r)[0]),t.browser.preventAxisScaleTransition=!0})).on("mouseup.range",(function(){delete t.browser.preventAxisScaleTransition,s.dragging=!1,s.classList.remove("dragging"),t.browser.DOM.root.classed("adjustingWidth",null).classed("noPointerEvents",!1),He.select("body").style("cursor","auto").on("mousemove.range",null).on("mouseup.range",null)})),e.stopPropagation()}})),this.DOM.recordValue=i.append("div").attr("class","recordValue"),this.DOM.recordValue.append("span").attr("class","valueScaleMark"),this.DOM.recordValueText=this.DOM.recordValue.append("span").attr("class","recordValueText").append("span").attr("class","recordValueText-v"),this.DOM.valueTickGroup=this.DOM.intervalSlider.append("div").attr("class","valueTickGroup")}onAggrHighlight(e){var t;if(!this.browser.adjustMode&&!this.browser.mouseOverCompare.is(!1)&&this.browser.can_setSelect_Compare(e)){var[i,s]=this.attrib.sanitizeRange(e.minV,e.maxV);i!==s&&(this.attrib.binMatch([i,s,null],e)||e.updateRecords(),null===(t=e.DOM.aggrGlyph)||void 0===t||t.setAttribute("selection","selected"),this.browser.setSelect_Compare(e))}}onAggrLeave(e){this.browser.adjustMode||(e.unselectAggregate(),this.browser.clearSelect_Compare())}onAggrClick(e,t){this.highlightRangeLimits_Active||(e&&e.shiftKey?this.browser.lockSelect_Compare():this.attrib.setRangeFilter(t))}refreshValueTickLabels(){var e;null===(e=this.DOM.valueTickGroup)||void 0===e||e.selectAll(".valueTick > .text").html((e=>this.attrib.printAbbr(e.tickValue,!1)))}refreshChartsVisibleOption(){this.DOM.inited&&this.DOM.root.classed("chartVisibleHistogram",this.showHistogram.is(!0))}onClearFilter(){this.attrib.noValueAggr.filtered=!1,this.attrib.summaryFilter.active=null,this.zoomed.set(!1),this.refreshIntervalSlider()}insertMinorTicks(e){}updateValueTicks(){var e=this,t=this.attrib.intervalTicks.slice();this.attrib.stepTicks&&t.pop();let i=t.map((e=>({tickValue:e,major:!0})));this.insertMinorTicks(i);var s=e=>this.valueScale(e.tickValue)+"px";this.browser.chartsLoaded,this.DOM.valueTickGroup.selectAll(".valueTick").data(i,(e=>e.tickValue)).join((t=>t.append("span").attr("class","valueTick").style("opacity",1).style("left",s).style("top","20px").call((t=>{t.append("span").attr("class","line"),t.append("span").attr("class","text").on("mouseover",(function(){this.bin&&e.onAggrHighlight(this.bin)})).on("mouseleave",(function(){this.bin&&e.onAggrLeave(this.bin)})).on("click",(function(t){this.bin&&e.onAggrClick(t,this.bin)}))}))),(e=>e),(e=>{this.browser.chartsLoaded?e.style("left",s).style("opacity",0).transition().duration(0).delay(600).remove():e.remove()})).classed("major",(e=>e.major)).style("left",s).call((t=>{t.transition().duration(500).delay(5).style("top","0px"),t.selectAll(".text").each((function(t){this.bin=null;var i=+t.tickValue;e._aggrs.some((e=>!(+e.minV-i)&&(this.bin=e,!0)))}))})),this.refreshValueTickLabels(),this.DOM.valueTickGroup.style("left",(this.attrib.stepTicks?this.aggrWidth/2:0)+"px")}}const Ke={select:a,quantile:y};class $e extends We{constructor(e){super(e),this.quantile_val={},this.showPercentiles=new xe({cfgClass:"showPercentiles",cfgTitle:"Percentiles",iconClass:"percentileBlocks",default:!1,parent:this,itemOptions:[{name:"Show",value:!0},{name:"Hide",value:!1}],onDOM:e=>{e.root.select(".percentileBlocks").classed("percentileChart_Active",!0).selectAll(".block").data([1,4,4,3,2,1]).enter().append("i").attr("class",(e=>"percentileBlock qG"+e))},onSet:()=>{if(this.DOM.inited){var e=this.getHeight();this.refreshChartsVisibleOption(),this.updatePercentiles(),this.setHeight(e),this.browser.updateLayout_Height()}}}),this.attrib.configs.showPercentiles=this.showPercentiles}get height_Percentile(){return this.showPercentiles.is(!0)?ae.height_Percentile:0}get height_Extra_base(){return super.height_Extra_base+this.height_Percentile}refreshWidth(){this.attrib.refreshScaleType(),super.refreshWidth()}getScaleNicing(){if(!this.inDashboard)return this.width_histogram/10;var e=this.optimumBinWidth.get();return this.attrib.unitName&&(e+=e*(2+8*this.attrib.unitName.length)/45),this.width_histogram/e}dragRange(e,t,i,s){var r,a={min:void 0,max:void 0};if(this.attrib.isValueScale_Log)r=t-e,a.min=this.valueScale.invert(this.valueScale(i)+r),a.max=this.valueScale.invert(this.valueScale(s)+r);else if(this.attrib.isValueScale_Linear){r=this.valueScale.invert(t)-this.valueScale.invert(e),this.attrib.hasFloat||(r=Math.round(r)),a.min=i+r,a.max=s+r;var o=s-i,l=this.attrib.valueScale.domain();a.min<l[0]&&(a.min=l[0],a.max=l[0]+o),a.max>l[1]&&(a.max=l[1],a.min=l[1]-o)}this.attrib.setRangeFilter_Custom(a.min,a.max)}showValuePicker(e,t){var i=e.pikanum;i||(e.pikanum=i=Ke.select(e).append("input").attr("class","rangeInput").attr("type","number").attr("min",this.attrib.rangeOrg[0]).attr("max",this.attrib.rangeOrg[1]).on("blur",(function(){i.style("display","none")})).on("focusout",(function(){i.style("display","none")})).on("keydown",(function(e){27===e.keyCode&&i.node().blur()})).on("change",(()=>{var e=1*i.node().value,s=this.attrib.summaryFilter.active.minV,r=this.attrib.summaryFilter.active.minV;"min"===t&&(s=e),"max"===t&&(r=e),this.attrib.setRangeFilter_Custom(s,r),i.node().blur()}))),i.attr("step",1).style("display","block"),i.node().focus(),i.node().value=this.attrib.summaryFilter.active[t]}zoomableStatus(){return this.attrib.stepTicks?this.zoomed.is(!0)?"minus":"":"plus"}hasStaticHeight(){return this.showHistogram.is(!1)}initDOM(e){return!!super.initDOM(e)&&(this.initDOM_Percentile(),!0)}refreshChartsVisibleOption(){this.DOM.inited&&(super.refreshChartsVisibleOption(),this.DOM.root.classed("chartVisiblePercentile",this.showPercentiles.is(!0)))}insertMinorTicks(e){this.attrib.isValueScale_Log&&Re.insertMinorTicks(this.attrib.intervalTicks,this.valueScale,e)}updateAfterFilter(){this.isVisible()&&(super.updateAfterFilter(),this.updatePercentiles())}refreshViz_Active(){super.refreshViz_Active(),this.updatePercentiles("Active")}refreshViz_Compare(e,t,i,s=[]){if(!this.isVisible()||!this.DOM.aggrGlyphs)return;super.refreshViz_Compare(e,t,i,s);var r=this.measureLineZero,a=this.attrib.isFiltered()&&this.attrib.summaryFilter.active&&!this.attrib.stepTicks;let o,l,n,h;a&&(o=this.attrib.summaryFilter.active.minV,l=this.attrib.summaryFilter.active.maxV,n=this.valueScale(o),h=this.valueScale(l));var c=s=>{this.DOM["measure_"+e].style("transform",(c=>{let d=this.width_Bin,u=0;if(a)if(c.maxV>o&&c.minV<l){if(c.minV<o){var p=n-this.valueScale(c.minV);u=p,d-=p}c.maxV>l&&(d-=this.valueScale(c.maxV)-h-2*ae.width_HistBarGap)}else c.setScale(e,0);return this.attrib.stackedCompare||(d/=i,u=d*t),`translate(${u}px, ${this.height_hist-r-c.offset(e)}px) scale(${d}, ${s?c.scale(e):0})`}))};t===i-1&&this.browser.addedCompare&&c(!1),c(!0),this.updatePercentiles(e)}initDOM_Percentile(){if(this.DOM.summaryInterval&&!this.DOM.percentileGroup){var e=this;this.DOM.percentileGroup=this.DOM.summaryInterval.append("div").attr("class","percentileGroup"),this.DOM.percentileGroup.append("span").attr("class","percentileTitle").html(me.Percentiles),ae.Compare_List.concat("Active").forEach((t=>{var i=e.DOM.percentileGroup.append("div").attr("class","percentileChart_"+t);i.selectAll(".aggrGlyph").data([[10,20,1],[20,30,2],[30,40,3],[40,50,4],[50,60,4],[60,70,3],[70,80,2],[80,90,1]]).enter().append("span").attr("class",(e=>"quantile aggrGlyph q_range qG"+e[2])).each((function(){this.__data__.summary=e})).tooltip((i=>`<div><span style='font-weight:400'>${i[0]}% - ${i[1]}%</span> Percentile:</div><div style='font-weight: 500'>${e.attrib.printAbbr(e.quantile_val[t+i[0]])} - ${e.attrib.printAbbr(e.quantile_val[t+i[1]])}</div>`),{placement:"top"}).on("mouseover",((e,i)=>{if((!this.browser.comparedAttrib||this.attrib.isComparedAttrib())&&!this.browser.mouseOverCompare.is(!1)){this.highlightRangeLimits_Active=!0;var s=this.attrib.createAggregate(this.quantile_val[t+i[0]],this.quantile_val[t+i[1]]);s.updateRecords(),this.browser.allRecordsAggr.clearCompare(this.browser.Compare_Highlight),this.browser.setSelect_Compare(s)}})).on("mouseout",(()=>{this.browser.comparedAttrib&&!this.attrib.isComparedAttrib()||(this.browser.clearSelect_Compare(),this.highlightRangeLimits_Active=!1)})).on("click",((e,i)=>{if(e.shiftKey)return this.browser.clearSelect_Compare(null,!0,!0),void(this.highlightRangeLimits_Active=!1);this.attrib.summaryFilter.active=this.attrib.createAggregate(this.quantile_val[t+i[0]],this.quantile_val[t+i[1]]),this.attrib.summaryFilter.setFiltered()})),i.selectAll(".q_pos").data([50]).enter().append("span").attr("class",(e=>"quantile q_pos q_"+e)).tooltip((i=>`<u>Median</u><br><b>${e.attrib.getFormattedValue(e.quantile_val[t+i])}</b>`),{placement:"top"})})),this.refreshChartsVisibleOption()}}refreshViz_Percentiles(e){if(this.DOM.percentileGroup&&this.valueScale&&!this.showPercentiles.is(!1)){var t=this.DOM.percentileGroup.select(".percentileChart_"+e);t.style("margin-left","0px").style("opacity",(t=>null==this.quantile_val[e+"10"]?0:1)).style("transform",this.attrib.stepTicks?"translateX("+this.aggrWidth/2+"px)":null),t.selectAll(".q_pos").style("transform",(t=>"translateX("+this.valueScale(this.quantile_val[e+t])+"px)")),t.selectAll(".quantile.aggrGlyph").style("transform",(t=>{var i=this.valueScale(this.quantile_val[e+t[0]]);return`translateX(${i}px) scaleX(${this.valueScale(this.quantile_val[e+t[1]])-i})`}))}}updatePercentiles(e=null){if("Other"!==e&&!this.showPercentiles.is(!1)){if(!e)return this.browser.activeComparisons.forEach((e=>this.updatePercentiles(e))),void this.updatePercentiles("Active");if("Total"!==e&&("Active"===e||this.attrib.vizActive(e))){var t=this.attrib.sortedRecords.filter("Active"===e?e=>e.isIncluded:t=>t.isIncluded&&t.isSelected(e)).map((e=>this.attrib.getRecordValue(e)));[10,20,30,40,50,60,70,80,90].forEach((i=>{this.quantile_val[e+i]=Ke.quantile(t,i/100)})),this.refreshViz_Percentiles(e)}}}}const Ue={format:m,deviation:A};class Ye extends Fe{get block(){return this._block}hasTimeSeriesParent(){var e;return"timeseries"===(null===(e=this.parent)||void 0===e?void 0:e.type)}get timeseriesParent(){var e;return"timeseries"===(null===(e=this.parent)||void 0===e?void 0:e.type)?this.parent:null}get groupPath(){var e;return(null===(e=this.timeseriesParent)||void 0===e?void 0:e.attribName.split("->"))||this.pathName}constructor(t,i,s){super(t,i,s,"numeric","kshfSummary_Numeric","far fa-hashtag"),this.tickPrecision=3,this.autoScaleType=null,this.timeKey=null,this.skipZero=!1,this._block=new $e(this),this.measurable={metricFuncs:ae.defaultMetricFuncs},this.valueScaleType=new xe({cfgClass:"valueScaleType",cfgTitle:"BinScale",iconClass:"fa fa-arrows-h",parent:this,default:"auto",helparticle:"5e87eabc04286364bc97d0cf",itemOptions:[{name:"Auto",value:"auto"},{name:me.Linear+" "+me.LinearSequence,value:"linear"},{name:me.Log+" "+me.Log2Sequence,value:"log"}],forcedValue:()=>this.timeseriesParent?this.timeseriesParent.valueScaleType.get():this.stepTicks?"linear":this.supportsLogScale()?"auto"===this.valueScaleType._value?this.autoScaleType:void 0:"linear",onSet:()=>e(this,void 0,void 0,(function*(){var e;this.aggr_initialized&&(this.block.noRefreshVizAxis=!0,yield this.applyScaleType(),this.block.noRefreshVizAxis=!1,yield null===(e=this.browser.recordDisplay)||void 0===e?void 0:e.refreshAttribScaleType(this))}))}),this.finishTemplateSpecial()}createAggregate(e,t){return new Le(this,e,t)}get isValueScale_Log(){return this.valueScaleType.is("log")}get isValueScale_Linear(){return this.valueScaleType.is("linear")}supportsLogScale(){return!this.hasNegativeValues()}sanitizeRange(e,t){return this.hasFloat||(t=Math.round(t),e=Math.round(e)),super.sanitizeRange(e,t)}getRecordValueExtent(){var e;return this.valueDomain?[...this.valueDomain]:(null===(e=this.timeseriesParent)||void 0===e?void 0:e.valueDomain)?[...this.timeseriesParent.valueDomain]:super.getRecordValueExtent()}get hasFloat(){return this._hasFloat}fillValueCache(){this._hasFloat=!1,this.records.forEach((e=>{var t=this.template.func.call(e.data,e);void 0===t&&(t=null),isNaN(t)&&(t=null),0===t&&this.skipZero&&(t=null),null!==t&&("number"!=typeof t?t=null:this._hasFloat=this._hasFloat||t%1!=0),e.setValue(this,t),null==t&&this.noValueAggr.addRecord(e)}))}pofffff(){this.refreshScaleType()}hasNegativeValues(){return!this.aggr_initialized||this.rangeOrg[0]<0}supportsRecordEncoding(e){return!this.isEmpty()&&(!!["text","textBrief"].includes(e)||(this.initializeAggregates(),!!this.isComparable.get()&&(!!["sort","scatterX","scatterY","color"].includes(e)||"size"===e&&!this.hasNegativeValues())))}get canHaveMetricFuncs(){return!this.isIDAttrib()&&!!this.aggr_initialized}get supportedMetricFuncs(){return this.canHaveMetricFuncs?this._metricFuncs:[]}getTickPrecision(){var e,t;return null!==(t=null===(e=this.timeseriesParent)||void 0===e?void 0:e.tickPrecision)&&void 0!==t?t:this.tickPrecision}updateTickPrintFunc(){var e=Ue.format("."+this.getTickPrecision()+"~s");0===this.getTickPrecision()&&(e=Ue.format("~s")),this.intervalTickPrint=t=>{this.hasFloat||(t=Math.round(t));let i=e(t),s=t.toLocaleString();if(s.length<=i.length)return s;if("m"===i.substr(-1)){let e=parseFloat(i)/1e3;e=Math.round(1e3*(e+1e-6))/1e3,i=e.toString()}return i},this.stepTicks&&(this.intervalTickPrint=Ue.format("d"))}refreshValueScale(){super.refreshValueScale(),this.hasFloat||(this.intervalTicks=this.intervalTicks.filter((e=>e%1==0)))}isPercentageUnit(){return"%"===this.unitName&&(!this.hasNegativeValues()&&!(this.rangeOrg[1]>100))}refreshScaleType(){if(!this.isEmpty())if(this.setStepTicks(!1),this.timeseriesParent)this.timeseriesParent.initializeAggregates();else{var e=this.valueScale.domain(),t=Ue.deviation(this.sortedRecords,(t=>{var i=this.getRecordValue(t);if(null!=i)return i>=e[0]&&i<=e[1]?i:void 0})),i=this.valueScale.domain(),s=i[1]-i[0],r=this.block.getScaleNicing();if(!this.hasFloat&&r>=s)this.setStepTicks(!0);else{if(t/s<.12&&this.rangeOrg[0]>0)return void(this.autoScaleType="log");!this.hasFloat&&r>=s&&this.setStepTicks(!0)}this.autoScaleType="linear"}}getFormattedValue(e,t=!1){return null==e?e="-":"number"==typeof e&&(this.intervalTickPrint||this.refreshValueScale(),e=this.intervalTickPrint(e)),Re.addUnitName(e,this.unitName,t)}keepOnlyPositiveRecords(){this.sortedRecords=this.records.filter((e=>{var t=this.getRecordValue(e)>0;return t||this.setRecordValueCacheToMissing(e),t})),this.updatedRangeOrg()}applyScaleType(){var t;return e(this,void 0,void 0,(function*(){this.sortedRecords&&(this.initializeAggregates(),this.isValueScale_Log&&this.rangeOrg[0]<=0&&this.keepOnlyPositiveRecords(),this.updateScaleAndBins(),yield null===(t=this.browser.recordDisplay)||void 0===t?void 0:t.refreshAttribScaleType(this))}))}getValueScaleObj(){return Re.getD3Scale(this.isValueScale_Log)}getValuePosX(e){return this.valueScale(e)+(this.stepTicks?this.block.aggrWidth/2:0)}getVizDomain(){return this.timeseriesParent?(this.timeseriesParent.initializeAggregates(),this.timeseriesParent.timeSeriesScale_Value.domain()):super.getVizDomain()}applyTemplateSpecial(){"TimePoint"===this.template.special&&this.template.parent?this.timeseriesParent.setTimepointAttrib(this.template.lastKey,this):"Hour"===this.template.special&&(this.unitName=":00")}setSkipZero(){this.aggr_initialized&&(this.rangeOrg[0]>0||this.skipZero||(this.skipZero=!0,this.keepOnlyPositiveRecords(),this.refreshScaleType()))}get unitName(){var e,t,i,s;return null!==(s=null!==(t=null===(e=this.timeseriesParent)||void 0===e?void 0:e.unitName)&&void 0!==t?t:null===(i=this.measurable)||void 0===i?void 0:i.unitName)&&void 0!==s?s:""}set unitName(e){var t;e||(e=""),this.unitName!==e&&(this.timeseriesParent?this.timeseriesParent.unitName=e:(super.unitName=e,this.block.refreshValueTickLabels(),null===(t=this.browser.recordDisplay.View)||void 0===t||t.refreshAttribUnitName(this),this.measureSummary===this&&(this.browser.blocks.forEach((e=>e.refreshMeasureLabelText("Active"))),this.browser.DOM.activeRecordMeasure.html(this.browser.getGlobalActiveMeasure()))))}applyConfig(t){const i=Object.create(null,{applyConfig:{get:()=>super.applyConfig}});return e(this,void 0,void 0,(function*(){i.applyConfig.call(this,t),this.measurable.valueDomain=t.valueDomain,yield this.block.showPercentiles.set(t.showPercentiles),yield this.valueScaleType.set(t.valueScaleType),t.unitName&&(this.unitName=t.unitName),t.skipZero&&this.setSkipZero()}))}isExportable(){return null===this.timeseriesParent}exportConfig(){var e=super.exportConfig(),t={unitName:this.unitName,skipZero:this.skipZero,filter:this.summaryFilter.exportFilter()};return Object.assign(e,t)}}function je(e){var t={};for(const s of e)if(null!=s){var i=t;s.pathName.forEach((e=>{i[e]=i[e]||{item:e,name:e,sub:{}},i=i[e].sub})),i[s.printName]=i[s.printName]||{name:s.printName,item:s,sub:{}},i[s.printName].item=s}else t[""]={item:null,name:me["(None)"],sub:{}};return t}class Xe{constructor(e,t){this.recordDisplay=t,this._type=e,this._element=this.recordDisplay.DOM[e+"ControlGroup"].append("span").attr("class","summaryGroup"),this._button=this._element.append("div").attr("class","selectButton").on("click",(()=>this.toggle())),this._button.append("div").attr("class","text"),this._button.append("div").attr("class","caret far fa-angle-down"),this._popup=this._element.append("div").attr("class","selectOptions"),this._element.append("span").attr("class","summaryDescription fa fa-info").tooltip(""),this._popper=null}get browser(){return this.recordDisplay.browser}get activeAttrib(){var e=this.recordDisplay.codeBy[this._type];return e instanceof Ye&&e.hasTimeSeriesParent()?e.timeseriesParent:e}refresh(){var e,t=this.activeAttrib;e=null==t?me.NoAttribute:"_measure_"===t?this.browser.measureFunc.is("Count")?this.browser.recordName:this.browser.measureSummary.get().printName:t.printName,this._button.select(".text").html(e),this._button.classed("none",null==t);var i="_measure_"===t?this.browser.measureSummary:t;if(i instanceof Oe){let e=i?i.description:null;this._element.select(".summaryDescription").style("display",e?null:"none").tooltip(e,{placement:"bottom"})}}toggle(){this._popper?this.hide():this.show()}show(){if(!this._popper){var t,i=("size"===this._type||"color"===this._type)&&this.recordDisplay.hasAggregates();i?((t={})[""]={item:null,name:me.NoAttribute,sub:{}},t.Count={item:null,measureType:"Count",name:`${me.measure_Count}: ${this.browser.recordName}`,sub:{}},t.Sum={item:null,name:"Sum",measureType:"Sum",sub:je(this.browser.getMeasurableSummaries("Sum"))}):t=je(this.recordDisplay.getAttribOptions_UI(this._type)),this._popup.selectAll("div").remove();var s=(t,r,o=0)=>{var l=Object.values(r);l=l.sort(((e,t)=>null===e.item?1:null===t.item?-1:Object.entries(t.sub).length-Object.entries(e.sub).length||e.name.localeCompare(t.name)));var n=t.selectAll("div").data(l).enter().append("div").attr("class","option").classed("active",(e=>{if(i){if("Count"===e.measureType)return"_measure_"===this.activeAttrib;if("Sum"===e.measureType)return"_measure_"===this.activeAttrib}return e.item==this.activeAttrib||"Count"===e.item&&"_measure_"===this.activeAttrib&&this.browser.measureFunc.is("Count")})).classed("collapsed",!0).attr("data-id",(e=>null===e.item?"none":"string"==typeof e.item?"_measure_":e.item.attribID)).classed("isSelectable",(e=>e.item instanceof Oe)).classed("hasSubItems",(e=>Object.entries(e.sub).length>0));n.append("div").attr("class","optionItem").call((e=>{e.append("div").attr("class","groupControl").tooltip(me["Open/Close"]).on("click",(e=>{e.stopPropagation(),e.preventDefault(),e.currentTarget.parentNode.parentNode.classList.toggle("collapsed")})).append("div").attr("class","fa fa-caret-down"),e.append("div").attr("class","optionName").html((e=>e.name))})).on("click",((t,s)=>e(this,void 0,void 0,(function*(){if(i)return s.measureType?(yield this.browser.measureFunc.set(s.measureType),this.recordDisplay.setAttrib(this._type,"_measure_",!0)):this.recordDisplay.setAttrib(this._type,null,!0),void this.hide();"string"!=typeof s.item?(this.recordDisplay.setAttrib(this._type,s.item,!0),this.hide()):t.currentTarget.parentNode.classList.toggle("collapsed")})))),n.append("div").attr("class","subItems").each(((e,t,i)=>{s(a(i[t]),e.sub,o+1)}))};s(this._popup,t,0),this._popup.style("min-width",this._button.node().offsetWidth+"px"),this._popper=o(this._button.node(),this._popup.node(),{placement:"timeSeries"==this._type||"scatterY"==this._type?"right-start":"bottom-start",strategy:"absolute",modifiers:[{name:"flip",enabled:!0,boundary:this.browser.DOM.root.node()}]}),setTimeout((()=>this._element.classed("dropdownOpen",!0)),10)}}hide(){this._element.classed("dropdownOpen",!1),setTimeout((()=>{this._popper&&(this._popper.destroy(),this._popper=null)}),350)}}const Ze={select:a,pointer:_};class qe{constructor(e,t,i,s,r,a){this.browser=r,this.DOM={root:e.append("div").attr("class","configPanel "+i).classed("active",!1),configTable:null},this.controlButton=a,this.DOM.root.append("div").attr("class","configClose fa fa-window-close").tooltip(me.Close).on("click",(()=>this.hide())),this.DOM.root.append("div").attr("class","popupPanel_Header").html(me[t]).on("mousedown",(e=>{r.DOM.root.classed("noPointerEvents",!0).attr("drag_cursor","grabbing");var t=Ze.select("body").node(),i=Ze.pointer(e,t),s=this.DOM.root.node(),a=parseInt(s.offsetLeft),o=parseInt(s.offsetTop);Ze.select("body").on("mousemove",(e=>{var s=Ze.pointer(e,t);this.checkPositionSanity(a-i[0]+s[0],o-i[1]+s[1])})).on("mouseup",(()=>{r.DOM.root.classed("noPointerEvents",!1).attr("drag_cursor",null),Ze.select("body").on("mousemove",null).on("mouseup",null)})),e.preventDefault()})),this.DOM.root.append("div").attr("class","compactSizeControl far fa-angle-double-up").on("click",(()=>this.DOM.root.node().classList.toggle("compact"))),this.DOM.configTable=this.DOM.root.append("div").attr("class","popupPanel_Content").append("table").attr("class","configTable"),s.forEach((e=>this.insertConfigUI(e)))}insertConfigUI(e){e.insertControl(this.DOM.configTable)}showAtPos(e,t){this.DOM.root.classed("active")?this.hide():(this.browser.closeConfigPanels(),this.DOM.root.classed("active",!0),this.controlButton.classed("fa-spin",!0),this.checkPositionSanity(e,t))}hide(){this.DOM.root.classed("active",!1),this.controlButton.classed("fa-spin",!1)}checkPositionSanity(e=null,t=null){if(ae.browser){var i=this.DOM.root.node(),s=i.offsetWidth+8,r=i.offsetHeight+8;null==e&&(e=parseFloat(i.style.left)),null==t&&(t=parseFloat(i.style.top));var a=i.offsetParent.getBoundingClientRect().width,o=i.offsetParent.getBoundingClientRect().height;i.style.left=Math.max(8,Math.min(a-s,e))+"px",i.style.top=Math.max(8,Math.min(o-r,t))+"px"}}}class Je extends ve{constructor(e,t){super(e),this.bounds=null}get title(){return me.Spatial}exportFilter(){return{bounds:this.bounds}}importFilter(e){this.bounds=e,this.setFiltered(!1),this.applyFilter()}onClear(){this.browser.recordDisplay.DOM.recordBase_Map.select(".spatialQueryBox_Filter").classed("active",null)}filterView_Detail(){return"<i class='fa fa-square-o'></i> (Area)"}onFilter(){this.browser.recordDisplay.DOM.recordBase_Map.select(".spatialQueryBox_Filter").classed("active",!0),this.browser.records.forEach((e=>{var t=this.attrib.getRecordValue(e)._bounds;e.setFilterCache(this.filterID,!!t&&Re.intersects(t,this.bounds))}),this)}}const Qe={geoBounds:M};class et extends Ae{constructor(e,t){super(e),this.cluster=t}get tooltipTitle(){return me.Cluster}get label(){return""}}class tt extends Oe{constructor(e,t,i){super(e,t,i,"recordGeo","","far fa-map-marker"),this._aggrs=[],this.summaryFilter=null,this.maxNodeRecordSize=1e3,this._pointClusterRadius=50,this.createSummaryFilter()}getRecordValue(e){return e.getValue(this)}supportsRecordEncoding(e){return"geo"===e}get measureRangeMax(){return"Point"===this.geoType?this._pointClusterRadius:1}createSummaryFilter(){this.summaryFilter=new Je(this.browser,this)}loadGeo(){return e(this,void 0,void 0,(function*(){this.recordGeoMap&&(yield this.recordGeoMap.loadGeo()),this.browser.records.forEach((e=>{var t=this.template.func.call(e.data,e);if("string"==typeof t&&this.recordGeoMap&&(t=this.recordGeoMap.getFeature(t.toUpperCase())),t){var i={geoFeat:t,_bounds:Qe.geoBounds(t)};this.geoType=t.type,e.setValue(this,i)}else e.setValue(this,null),this.noValueAggr.addRecord(e)}))}))}initializeAggregates(){this.aggr_initialized||(this.aggr_initialized=!0)}applyConfig(t){const i=Object.create(null,{applyConfig:{get:()=>super.applyConfig}});return e(this,void 0,void 0,(function*(){i.applyConfig.call(this,t),t.recordGeo&&(this.recordGeoMap=ae.maps.get(t.recordGeo),this.recordGeoMap||(this.recordGeoMap=null))}))}getRecordBounds(e){let t=[];return this.browser.records.forEach((i=>{if(e&&i.filteredOut)return;let s=this.getRecordValue(i);if(!s)return;if(!s._bounds)return;let r=s._bounds;if(isNaN(r[0][0]))return;let a=L.latLng(r[0][1],r[0][0]),o=L.latLng(r[1][1],r[1][0]);t.push(a),t.push(o)})),new L.latLngBounds(t)}prepPointCluster(t){return e(this,void 0,void 0,(function*(){if(0===this.pointClusterRadius)return;this.PointCluster=new re({radius:this.pointClusterRadius,maxZoom:t.getMaxZoom()-1,minZoom:t.getMinZoom()});let e=[];this.records.forEach((t=>{let i=this.getRecordValue(t);i&&e.push({type:"Feature",properties:t,geometry:i.geoFeat})})),this.PointCluster.load(e)}))}updateClusters(e,t){this.deletePointClusters(),this.PointCluster.getClusters([e.getWest(),e.getSouth(),e.getEast(),e.getNorth()],Math.floor(t)).forEach((e=>{if(e.id){let t=this.PointCluster.getLeaves(e.id,this.maxNodeRecordSize),i=new et(this,e);if(t.forEach((e=>{let t=e.properties;t._view.inCluster=!0,t.isIncluded&&i.addRecord(t)})),0===i.records.length)return;if(1===i.records.length){return i.records[0]._view.inCluster=!1,void i.clearRecords()}this._aggrs.push(i),this.browser.allAggregates.push(i)}else{e.properties._view.inCluster=!1}})),this._aggrs.sort(((e,t)=>t.measure("Active")-e.measure("Active")))}deletePointClusters(){this._aggrs.forEach((e=>{e.clearRecords(),e.DOM.aggrGlyph.remove(),this.browser.allAggregates.splice(this.browser.allAggregates.indexOf(e),1)})),this.records.forEach((e=>{e._view.inCluster=!1})),this._aggrs=[]}get pointClusterRadius(){return this._pointClusterRadius}setPointClusterRadius(t,i){return e(this,void 0,void 0,(function*(){if(this._pointClusterRadius=Math.round(Math.max(0,t)),0!==this.pointClusterRadius)return yield this.prepPointCluster(i);this.deletePointClusters()}))}exportConfig(){return{pointClusterRadius:this._pointClusterRadius}}}const it={scaleTime:S,scaleLinear:n,min:c,max:d,extent:l,format:m,deviation:A,easePolyInOut:C};var st;class rt extends Oe{get measureRangeMax(){throw new Error("Not applicable.")}constructor(t,i,s){super(t,i,s,"timeseries","","far fa-chart-line"),this.tickPrecision=3,this.timeKeys=[],this.timeKeyAttribs=[],this.measurable={metricFuncs:ae.defaultMetricFuncs},this.valueScaleType=new xe({cfgClass:"valueScaleType",cfgTitle:"BinScale",iconClass:"fa fa-arrows-h",parent:this,default:"linear",helparticle:"5e87eabc04286364bc97d0cf",itemOptions:[{name:`${me.Linear} ${me.LinearSequence}`,value:"linear"},{name:`${me.Log} ${me.Log2Sequence}`,value:"log"}],forcedValue:()=>{if(!this.supportsLogScale())return"linear"},preSet:t=>e(this,void 0,void 0,(function*(){if("log"===t||"linear"===t)return t})),onSet:t=>e(this,void 0,void 0,(function*(){if(this.timeSeriesScale_Value){for(var e in this.timeKeyAttribs){var i=this.timeKeyAttribs[e];i.timeKey&&(yield i.applyScaleType())}this.timeSeriesScale_Value=Re.getD3Scale("log"===t).domain(this.getExtent_Value()),yield this.browser.recordDisplay.refreshAttribScaleType(this)}}))}),this.numberFormat=e=>this.hasFloat&&e<1e3?it.format(",.3~f")(e):it.format(".3~s")(e).replace(".0",""),this.finishTemplateSpecial()}getRecordValue(e){return e.getValue(this)}supportsRecordEncoding(e){return!this.isEmpty()&&(this.initializeAggregates(),!this.isComparable.is(!1)&&("timeSeries"===e||("sort"===e||("scatterX"===e||("scatterY"===e||("color"===e||"size"===e&&!this.hasNegativeValues()))))))}isEmpty(){return!this.timeKeys||0===this.timeKeys.length}get canHaveMetricFuncs(){return!0}get supportedMetricFuncs(){return this._metricFuncs}supportsLogScale(){return!this.timeSeriesScale_Value||this.timeSeriesScale_Value&&this.timeSeriesScale_Value.domain().every((e=>e>0))}hasNonNegativeValueDomain(){return this.timeSeriesScale_Value.domain().every((e=>e>=0))}get attribName(){return super.attribName}set attribName(e){if(super.attribName=e,this.attribName===e){for(var t in this.timeKeyAttribs){var i=this.timeKeyAttribs[t];i.attribName=`${this.attribName} <i class="far fa-calendar-day"></i> ${i.timeKey._time_src}`}this.browser.recordChartType.is("timeseries")&&this.browser.recordDisplay.refreshAttribOptions("timeSeries"),this.browser.recordDisplay.refreshAttribOptions("sort")}}updateChartScale_Measure(){}applyTemplateSpecial(){"TimeseriesChange-%"===this.template.special&&(this.unitName="%")}initializeAggregates(){if(!this.aggr_initialized){var e={},t=[],i=[],s=[];if(this.browser.records.forEach((r=>{var a=this.template.func.call(r.data,r);if(null!=a){var o=a;r.setValue(this,o),o.sortTimeseries(),o.computeCaches(),o._timeseries_.forEach((t=>{e[t._time.getTime()]=t._time_src,s.push(t._value)})),t.push(o.extent_Time),i.push(o.extent_Value)}else r.setValue(this,null)})),0!==t.length){var r=this.valueDomain||[it.min(i,(e=>e[0])),it.max(i,(e=>e[1]))],a=[it.min(t,(e=>e[0])),it.max(t,(e=>e[1]))];this.hasFloat=s.some((e=>e%1!=0)),this.hasFloat||(this.tickPrecision=r[1].toLocaleString().length>5?3:0);var o=it.deviation(s),l=r[1]-r[0];for(var n in this.valueScaleType.set(o/l<.12&&r[0]>0?"log":"linear"),this.timeSeriesScale_Time=it.scaleTime().domain(a),this.timeSeriesScale_Value=Re.getD3Scale(this.isValueScale_Log),this.timeSeriesScale_Value.domain(r),e)this.timeKeys.push({_time:new Date(Number(n)),_time_src:e[n]});this.timeKeys.sort(((e,t)=>e._time.getTime()-t._time.getTime())),this.timeKeys.forEach(((e,t)=>{e._index=t})),this.browser.records.forEach((e=>{var t=this.getRecordValue(e);if(t){var i=!1;this.timeKeys.forEach((e=>{t._keyIndex[e._time_src]||(t.addTimeData({_time:e._time,_time_src:e._time_src,_value:void 0}),i=!0)})),i&&t.sortTimeseries()}})),this.aggr_initialized=!0}else this.aggr_initialized=!0}}getExtent_Value(e=!1,t=null){if(!e&&this.valueDomain)return this.valueDomain;var i=e=>!0;t&&(i=e=>e._time>=t[0]&&e._time<=t[1]);var s=[],r=e=>i(e)?e._value:null;return this.isValueScale_Log&&(r=e=>i(e)&&e._value>0?e._value:null),this.browser.records.forEach((t=>{if(!e||!t.filteredOut){var i=this.getRecordValue(t);i&&(i.extent_Value=it.extent(i._timeseries_,r),"number"==typeof i.extent_Value[0]&&s.push(i.extent_Value))}})),[it.min(s,(e=>e[0])),it.max(s,(e=>e[1]))]}hasNegativeValues(){return it.min(this.timeSeriesScale_Value.domain())<0}hasFlippedDomain(){var e=this.timeSeriesScale_Value.domain();return e[0]>e[1]}computeRecordRanks(){this.timeKeys.forEach((e=>{var t=this.hasFlippedDomain()?(e,t)=>e._value-t._value:(e,t)=>t._value-e._value,i=(e,t)=>{var i=this.getRecordValue(e);if(!i||i.isEmpty())return null;let s=i._keyIndex[t];return null==s?null:s};Array.from(this.browser.records).sort(((s,r)=>{if(s.filteredOut)return 1;if(r.filteredOut)return-1;var a=i(s,e._time_src);if(null==a)return 1;var o=i(r,e._time_src);return null==o?-1:t(a,o)})).forEach(((t,s)=>{var r=i(t,e._time_src);null!=r&&(r._rank=s+1)}))}))}get isValueScale_Log(){return this.valueScaleType.is("log")}get isValueScale_Linear(){return this.valueScaleType.is("linear")}createSummaryFilter(){}refreshViz_Compare(){}setTimepointAttrib(e,t){("string"!=typeof e&&e._time||(e=this.timeKeys.filter((t=>t._time_src===e))[0]))&&(t.timeKey=e,this.timeKeyAttribs[e._time_src]=t)}getTimepointSummary_Next(e,t=1){if(this.initializeAggregates(),this.isEmpty())return null;var i=e.timeKey._time_src;if(!i)return null;var s=-1;if(this.timeKeys.some(((e,t)=>{if(e._time_src===i)return s=t,!0})),t>0&&s===this.timeKeys.length-1)return null;if(t<0&&0===s)return null;var r=Math.min(this.timeKeys.length-1,Math.max(0,s+t));return this.getTimepointSummary(this.timeKeys[r])}getTimepointSummary(e){this.initializeAggregates();var t=this.timeKeyAttribs[e._time_src];return t||(t=this.browser.createAttrib(`${this.attribName} <i class="far fa-calendar-day"></i> ${e._time_src}`,`${this.template}->${e._time_src}`,"numeric"),this.setTimepointAttrib(e,t),t.initializeAggregates()),t}printAbbr(e,t=!1){return this.getTimepointSummary(this.timeKeys[0]).printAbbr(e._value,t)}getFormattedValue(e,t=!1){var i=this.numberFormat(e);return null==e?"-":Re.addUnitName(i,this.unitName,t)}applyConfig(t){const i=Object.create(null,{applyConfig:{get:()=>super.applyConfig}});return e(this,void 0,void 0,(function*(){i.applyConfig.call(this,t),this.measurable.valueDomain=t.valueDomain,t.valueScaleType&&(yield this.valueScaleType.set(t.valueScaleType)),t.unitName&&(this.unitName=t.unitName)}))}exportConfig(){return Object.assign(super.exportConfig(),{unitName:this.unitName,valueScaleType:this.valueScaleType.get()})}renderRecordValue(e,t,i=null){if(e instanceof Ie&&(e=this.getRecordValue(e)),!t||!e)return;if(!(e instanceof Ce))return;this.initializeAggregates();var s=this.browser.recordDisplay.config.timeseriesWidth,r=it.scaleTime().domain(it.extent(i,(e=>e._time))).rangeRound([5,s-5]);let a=e._timeseries_;var[o,l]=it.extent(a,(e=>e._value));let n;o===l?(n=l,o-=1e-5,l+=1e-5):this.hasFlippedDomain()&&([o,l]=[l,o]);var h=it.scaleLinear().domain([o,l]).rangeRound([40,0]);st++;var c=this.browser.colorTheme.getContinuous(),d=this.timeSeriesScale_Value.copy().range([0,1]),u=t.append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("class","recordDetailTimeseries").style("width",s+"px"),p=u.append("defs");p.append("clipPath").attr("id","RecordTimeseriesClip_"+st).append("rect").attr("class","recordTimeseriesClipPath").attr("x",0).attr("y",-10).attr("height",70).attr("width",1).transition().duration(1500).delay(0).ease(it.easePolyInOut).attr("width",s+10);var m=p.append("linearGradient").attr("id","GradientPath_"+st).attr("x1","0").attr("x2","0").attr("y1","0").attr("y2","1");m.append("stop").attr("stop-color",c(d(l))).attr("offset","0%"),m.append("stop").attr("stop-color",c(d(o))).attr("offset","100%"),u.selectAll(".extentValueGroup").data(null!=n?[n]:[o,l]).enter().append("g").attr("class","extentValueGroup").attr("transform",(e=>`translate(0,${h(e)})`)).call((e=>{e.append("text").attr("class","extentText").html((e=>this.printAbbr(e,!0))).attr("x",s+6),e.append("line").attr("class","extentLine").attr("x1",0).attr("x2",s).attr("y1",0).attr("y2",0)}));var g=7*i.reduce(((e,t)=>Math.max(e,t._time_src.length)),0),v=3e4;u.append("g").attr("class","extentYearGroup").selectAll(".extentYear").data(i).enter().append("text").attr("class","extentYear").attr("y",53).attr("x",(e=>r(e._time))).html((e=>e._time_src)).style("opacity",(e=>{var t=r(e._time);return v-t<g?0:(v=t,.8)})),u.append("g").attr("clip-path",'url("#RecordTimeseriesClip_'+st+'")').call((e=>{e.append("path").attr("class","recordTimeseriesLine").datum(a).attr("d",Re.getLineGenerator(r,h)).attr("stroke",null!=n?c(d(l)):"url(#GradientPath_"+st+")"),e.selectAll(".recordTimeseriesDot").data(a.filter((e=>!!e._value))).enter().append("circle").attr("class","recordTimeseriesDot").attr("r",3).attr("cx",(e=>r(e._time))).attr("cy",(e=>h(e._value))).attr("fill",(e=>c(d(e._value)))).tooltip((e=>"<div class='recordColorInfo'><span class='mapTooltipLabel'><i class='far fa-calendar'></i> "+e._time_src+"</span><br> <b><span class='mapTooltipValue'>"+this.getFormattedValue(e._value)+"</span></b></div>"),{theme:"dark timeseriesRecordDot",placement:"top"}).on("click",((e,t)=>this.browser.recordDetailsPopup.updateFocusedTimeKey(t)))}))}}const at={select:a,pointer:_,max:d,format:m,hsl:D,geoBounds:M,geoPath:w,geoTransform:O,scaleQuantize:T};class ot extends ze{constructor(e){super(e),this.viewType="list",this._height_Categories=0,this.heightRow_category_dirty=!1,this.skipTextSearchClear=!1,this.catCount_InDisplay=0,this.firstCatIndexInView=0,this.show_set_matrix=!1,this.splitOnSelfCompare=!0,this.leafletAttrMap=null,this.scrollTop_cache=0,this.dropdown_type="SingleSelect"}get _aggrs(){return this.attrib._aggrs}get setAttrib(){return this.attrib.setAttrib}setCollapsed(e){super.setCollapsed(e),this.leafletAttrMap&&!this.collapsed&&setTimeout((()=>{this.leafletAttrMap.invalidateSize(),this.catMap_zoomToActive()}),500),this.collapsed&&this.setAttrib&&this.showSetMatrix(!1)}onCollapse(){!this.collapsed&&this.DOM.root&&this.isView_List&&(this.attrib.dirtySort&&(this.updateCatSorting_now(),this.refreshViz_All()),this.refreshLabelWidth(),this.catList_cullCategories())}addToPanel(t,i,s=!1){var r=()=>{super.addToPanel(t,i),this.setAttrib&&("left"===this.panel.name||"right"===this.panel.name?this.setAttrib.block.refreshPopupSide():this.hideSetMatrix()),this.browser.updateLayout()};this._aggrs.length>500&&1===this.attrib.minAggrSize.get()&&!s?ye.confirm("<div style='text-align:center'>There are many ("+this._aggrs.length.toLocaleString()+") categories in "+this.attrib.attribName+".<br>Adding all can make your dashboard slower.<br><br>Would you like to hide categories with 5 or less records?</div>","Hide small categories","Show all categories").then((()=>e(this,void 0,void 0,(function*(){return yield this.attrib.minAggrSize.set(5)})))).finally((()=>r())):r()}get isView_Dropdown(){return"dropdown"===this.viewType}get isView_List(){return"list"===this.viewType}get isView_Map(){return"map"===this.viewType}catViewAs(t){return e(this,void 0,void 0,(function*(){if("map"===t)try{if(!this.attrib.catGeo)throw new Error("No mapping specified");window.L||(yield import("./vendor_mapping.min.js").then((function(e){return e.l}))),yield this.attrib.loadMap(),this.mapIsReady=!1}catch(e){return console.log(e),ye.alert(e.message),void this.catViewAs("list")}this.viewType=t,this.noRefreshVizAxis=this.isView_Dropdown,this.DOM.inited&&(this.DOM.root.attr("viewType",this.viewType),this.DOM.root.selectAll(".summaryViewAs").classed("active",!1),this.DOM.root.selectAll(".summaryViewAs_"+this.viewType).classed("active",!0),"list"===this.viewType?this.list_prepView():"map"===this.viewType?this.catMap_prepView():"dropdown"===this.viewType&&this.dropdown_prepView())}))}get height_Categories(){return this._height_Categories}get height_Content(){return this.isVisible()?this.isView_Dropdown?this.height_Dropdown:this._height_Categories+this.height_Config+this.height_Bottom+1:0}get height_RangeMin(){return this.attrib.isEmpty()?this.height_Header:this.isView_Dropdown?this.height_Dropdown:this.isView_Map?.2*this.getWidth():this.height_ListWithoutCats+1.5*this.heightCat}get height_RangeMax(){return this.attrib.isEmpty()?this.height_Header:this.isView_Dropdown?this.height_Dropdown:this.isView_Map?1.5*this.getWidth():this.height_ListWithoutCats+this._aggrs.length*this.heightCat}get heightCat(){return this.attrib.barHeight.get()}get height_Dropdown(){return 42}get height_ListWithoutCats(){return this.height_Header+this.height_Config+this.height_Bottom}get height_VisibleAttrib(){return this.catCount_Active*this.heightCat}get height_Config(){return 18*(this.hasTextSearch()?1:0)}get height_bar_topGap(){return this.heightCat>20?4:2}get barHeight_Full(){return this.heightCat-2*this.height_bar_topGap}get height_Bottom(){var e,t;return!this.areAllCatsInDisplay()||!this.panel.hiddenCatBars()||this._aggrs.length>4?(null===(e=this.DOM.summaryCategorical)||void 0===e||e.classed("nobottoms",!1),ae.height_CatBottom):(null===(t=this.DOM.summaryCategorical)||void 0===t||t.classed("nobottoms",!0),0)}get catLabelFontSize(){return this.heightCat>35?19:this.heightCat>30?17:this.heightCat>25?15:this.heightCat>15?13:this.heightCat-2}hasStaticHeight(){return this.isView_Dropdown}setHeight(e){if(!this.attrib.isEmpty()){if(e-=this.height_Header+this.height_Config+this.height_Bottom,this.isView_Map)return this._height_Categories=e,void setTimeout((()=>{this.leafletAttrMap&&this.leafletAttrMap.invalidateSize()}),700);this._height_Categories=Math.min(e,this.heightCat*this.catCount_Active-1)}}refreshHeight_Category(){this.DOM.inited&&this.isView_List&&(this.heightRow_category_dirty=!1,this.browser.updateLayout(),this.DOM.aggrGlyphs.style("transform",(e=>e.transformPos)),this.refreshHeight_Category_do())}refreshHeight_Category_do(){this.DOM.aggrGlyphs.style("height",this.heightCat+"px"),this.DOM.root.selectAll(".catLabel").style("font-size",this.catLabelFontSize+"px"),this.DOM.chartBackground.style("height",this.height_VisibleAttrib+"px"),this.DOM.catChart.classed("multiLine",this.heightCat>=56&&void 0!==this.DOM.root.node().style.webkitLineClamp),this.refreshViz_All()}refreshHeight(){var e;if(super.refreshHeight(),this.attrib.isEmpty()||!this.inDashboard||!this.DOM.inited)return;if(this.isView_Dropdown)return;if(this.collapsed)return void(this.isView_Map&&this.DOM.catMap_Base.style("height","0px"));let t=Math.floor(this._height_Categories/this.heightCat);t<0&&(t=1),t>this.catCount_Active&&(t=this.catCount_Active),t=this.catCount_Active<=2?this.catCount_Active:Math.max(t,2),this.catCount_InDisplay=t+1,this.catCount_InDisplay=Math.min(this.catCount_InDisplay,this.catCount_Active),this.refreshScrollDisplayMore(this.firstCatIndexInView+this.catCount_InDisplay),this.updateCats_IsVisible(),this.catList_cullCategories(),this.DOM.headerGroup.attr("allCatsInDisplay",this.areAllCatsInDisplay()),this.isView_Map&&(this.DOM.catMap_Base.style("height",null),null===(e=this.leafletAttrMap)||void 0===e||e.invalidateSize())}catList_cullCategories(){this.isView_List&&this.DOM.aggrGlyphs&&(this.DOM.aggrGlyphs.style("display",(e=>e.isVisible?null:"none")).style("opacity",(e=>e.isVisible?1:0)).style("transform",(e=>e.isVisible?`translate(0px,${e.posY}px)`:null)),this.setAttrib&&!this.setAttrib.block.pausePanning&&this.setAttrib.block.refreshSVGViewBox())}refreshConfigRowCount(){var e,t,i;null===(e=this.DOM.summaryControls)||void 0===e||e.style("display",this.hasTextSearch()?"block":null),null===(t=this.DOM.wrapper)||void 0===t||t.classed("showMeasureAxis_2",this.hasTextSearch()),null===(i=this.DOM.catTextSearch)||void 0===i||i.classed("active",this.hasTextSearch())}get width_CatLabel(){return this.isVisible()?this.panel.width_CatLabel:0}get width_CatMeasureLabel(){return this.isVisible()?this.panel.width_CatMeasureLabel:0}get width_CatText(){return this.isVisible()?this.panel.width_CatText:0}get width_CatBars(){return this.isVisible()?this.panel.width_CatBars:0}refreshWidth(){this.DOM.summaryCategorical&&(this.attrib.updateChartScale_Measure(),this.isView_List&&this.DOM.chartAxis_Measure.style("width",`${this.width_CatBars+5}px`),this.isView_Map&&this.mapIsReady&&this.leafletAttrMap.invalidateSize())}hasTextSearch(){return this._aggrs.length>=15}initDOM_CatTextSearch(){var e=this;this.DOM.catTextSearch=this.DOM.summaryControls.append("div").attr("class","textSearchBox catTextSearch hasLabelWidth"),this.DOM.catTextSearch.append("span").attr("class","far fa-search"),this.DOM.catTextSearch.append("span").attr("class","fa fa-times-circle").tooltip(me.ClearTextSearch).on("click",(()=>this.attrib.summaryFilter.clearFilter())),this.DOM.catTextSearchInput=this.DOM.catTextSearch.append("input").attr("class","textSearchInput").attr("type","text").attr("placeholder","...").tooltip(me.Search).on("keydown",(e=>e.stopPropagation())).on("keypress",(e=>e.stopPropagation())).on("keyup",(e=>e.stopPropagation())).on("input",(function(){this.tippy.hide(),this.timer&&clearTimeout(this.timer);var t=this;this.timer=setTimeout((function(){e.attrib.unselectAllCategories();var i=[];t.value.toLowerCase().split('"').forEach(((e,t)=>{t%2==0?e.split(/\s+/).forEach((e=>i.push(e))):i.push(e)})),(i=i.filter((e=>""!==e))).length>0?(e.DOM.catTextSearch.classed("showClear",!0),e._aggrs.forEach((t=>{var s=t.label.toString().toLowerCase();i.every((e=>-1!==s.indexOf(e)))?t.set_OR(e.attrib.summaryFilter.selected_OR):t.set_NONE()})),0===e.attrib.summaryFilter.selectedCount_Total()?(e.skipTextSearchClear=!0,e.attrib.summaryFilter.clearFilter(),e.skipTextSearchClear=!1):(e.attrib.summaryFilter.how="All",e.attrib.noValueAggr.filtered=!1,e.attrib.summaryFilter.setFiltered())):e.attrib.summaryFilter.clearFilter()}),750)}))}clearCatTextSearch(){this.hasTextSearch()&&(this.skipTextSearchClear||this.DOM.catTextSearch&&(this.DOM.catTextSearch.classed("showClear",!1),this.DOM.catTextSearchInput.node().value=""))}isCatActive(e){return!!e.usedAggr&&(!!e.isFiltered()||(0!==e.recCnt("Active")||(this.attrib.isFiltered()&&"map"!==this.viewType||0!==e.recCnt("Active"))))}areAllCatsInDisplay(){return this.catCount_Active===this.catCount_InDisplay}updateCats_IsActive(){this.catCount_Active=0,this._aggrs.forEach((e=>{e.isActiveBefore=e.isActive,e.isActive=this.isCatActive(e),e.isActive&&this.catCount_Active++})),this.attrib.catOrder_Fixed&&(this.catCount_Active=this._aggrs.length)}updateCats_IsVisible(){var e=Math.ceil((this.scrollTop_cache+this._height_Categories)/this.heightCat);this._aggrs.forEach((t=>{t.isVisibleBefore=t.isVisible,t.isVisible="map"===this.viewType||t.isActive&&t.orderIndex>=this.firstCatIndexInView&&t.orderIndex<e}))}vizSideBySide(){return!this.browser.stackedChart&&(!(this.browser.activeComparisonsCount<2)&&(!this.attrib.isComparedAttrib()||this.attrib.isMultiValued&&this.splitOnSelfCompare))}refreshViz_Active(){if(this.isVisible()&&!this.isView_Dropdown&&this.attrib.chartScale_Measure)if(this.isView_Map&&this.mapIsReady)this.catMap_refreshVis("Active");else if(this.isView_List){var e=this.measureLineZero;this.refreshViz_Cache("Active",null),this.DOM.aggrGlyphs.classed("NoActiveRecords",(e=>0===e.Active.measure)),this.DOM.measure_Active.style("transform",(t=>`translate(${e+t.offset("Active")}px, ${this.height_bar_topGap}px) scale(${t.scale("Active")}, ${this.barHeight_Full})`)),this.refreshMeasureLabelText("Active"),this.refreshMeasureLabelPos("Active",-1)}}refreshViz_Compare(e,t,i,s=[]){if(this.isVisible())if(this.isView_Dropdown)this.dropdown_refreshCategories();else{if(this.refreshMeasureLabelText(e),"Compare_A"===e&&this.refreshViz_NoValueAggr(),this.isView_List){var r=this.measureLineZero,a=this.height_bar_topGap,o=this.barHeight_Full;this.vizSideBySide()&&(a+=(o/=i)*t),this.refreshViz_Cache(e,s),this.refreshMeasureLabelPos(e,t);var l=!this.browser.stackedChart&&this.attrib.isComparedAttrib()&&this.attrib.isMultiValued&&!this.splitOnSelfCompare,n=t=>{this.DOM["measure_"+e].style("transform",(i=>(l&&(t=i.compared===e),`translate(${r+i.offset(e)}px, ${a}px) scale(${t?i.scale(e):0}, ${o})`)))};t===i-1&&this.browser.addedCompare&&n(!1),n(!0)}if(this.isView_Map&&this.mapIsReady&&this.attrib.vizActive(e)){if(this.attrib.isComparedAttrib()&&!this.attrib.isMultiValued)return;this.catMap_refreshVis(e)}}}chartAxis_Measure_TickSkip(){var e,t=this.width_CatBars,i=35;if(this.attrib.getPeakAggr(at.max,"Active")>1e5&&(i+=12),this.browser.percentBreakdown)i+=11;else if("Count"!==this.browser.measureFunc.get()){var s=null===(e=this.browser.measureSummary.get())||void 0===e?void 0:e.unitName;s&&(i+=2+9*s.length)}return t/i}showSetMatrix(e){(this.isView_List||!0!==e)&&(this.show_set_matrix=e,this.refreshShowSetMatrix())}hideSetMatrix(){this.showSetMatrix(!1)}refreshShowSetMatrix(){var e;null===(e=this.DOM.root)||void 0===e||e.classed("show_set_matrix",this.show_set_matrix),this.show_set_matrix?this.attrib.showSetSummary():this.setAttrib&&(this.attrib.setSortingOption("Active"),this.updateCatSorting(0))}initDOM(e){return this.attrib.initializeAggregates(),!this.attrib.isEmpty()&&(this.DOM.inited||(this.insertRoot(e),this.DOM.root.attr("viewType",this.viewType).classed("hasMultiAnd",this.attrib.summaryFilter.selected_AND.length>1).classed("isMultiValued",this.attrib.isMultiValued).classed("supportsSetMatrix",this.attrib.supportsSetMatrix).attr("hasMap",null!==this.attrib.catGeo),this.DOM.summaryCategorical=this.DOM.wrapper.append("div").attr("class","summaryCategorical"),this.isView_Dropdown||this.init_DOM_Cat(),this.setCollapsed(this.collapsed),this.DOM.inited=!0,this.catViewAs(this.viewType),this.refreshShowSetMatrix()),!0)}insertHeader(){super.insertHeader(),[["summaryViewAs setMatrixButton","ViewSetMatrix","far fa-tags",()=>this.showSetMatrix(!this.show_set_matrix)],["summaryViewAs summaryViewAs_list","ViewAsList","far fa-list-ul",()=>this.catViewAs("list")],["summaryViewAs summaryViewAs_map","ViewAsMap","fal fa-globe",()=>this.catViewAs("map")]].forEach((e=>{this.DOM.summaryIcons.append("span").attr("class",e[0]).tooltip(me[e[1]],{placement:"bottom"}).on("click",e[3]).append("div").attr("class",e[2])}))}onClearFilter(e){var t;this.attrib.noValueAggr.filtered=!1,this.attrib.unselectAllCategories(),this.clearCatTextSearch(),e&&this.isView_Dropdown&&this.dropdown_refreshCategories(),null===(t=this.DOM.root)||void 0===t||t.classed("hasMultiAnd",!1)}updateAfterFilter(e=!0){if(this.isVisible()){if(this.isView_Dropdown)return this.attrib.dirtySort||this.updateCatSorting_now(),void this.dropdown_refreshCategories();if(this.refreshViz_NoValueAggr(),this.refreshMeasureLabelText("Active"),this.isView_Map)return this.attrib.updateChartScale_Measure(!0),this.updateCats_IsActive(),void this.refreshViz_Active();this.show_set_matrix&&(this.attrib.dirtySort=!0),this.attrib.dirtySort||this.updateCatSorting(),e&&(this.attrib.updateChartScale_Measure(!0),this.refreshViz_All())}else this.attrib.dirtySort=!0}refreshLabelWidth(){this.isVisible()&&this.DOM.summaryCategorical&&this.isView_List&&(this.DOM.chartCatLabelResize.style("left",`${this.width_CatLabel}px`),this.DOM.summaryCategorical.selectAll(".hasLabelWidth").style("width",`${this.width_CatLabel}px`),this.DOM.measureLabelGroup.style("width",`${this.width_CatMeasureLabel}px`),this.DOM.chartAxis_Measure.style("transform",`translateX(${this.width_CatText}px)`))}refreshScrollDisplayMore(e){if(this.isView_List)if(this.DOM.catSortButton.style("display",1===this._aggrs.length?"none":null),this.catCount_Active<=4)this.DOM.scroll_display_more.style("display","none");else{var t=this.catCount_Active-e,i=`<span class='rowCount ${t?" hasMore":""}'>${this.catCount_Active} ${me.Rows}</span>`;t>0&&(i+=` <span class='belowCount'>${t} ${me.More} <span class='far fa-angle-double-down'></span></span>`),this.DOM.scroll_display_more.html(i)}}removeCatGeo(){var e,t;"map"===this.viewType&&this.catViewAs("list"),null===(e=this.DOM.root)||void 0===e||e.attr("hasMap",!1),null===(t=this.leafletAttrMap)||void 0===t||t.remove(),this.leafletAttrMap=null}catMap_projectCategories(){if(this.panel){var e=[];this.DOM.measure_Active.attr("d",((t,i,s)=>t._geo_?this.geoPath(t._geo_):(e.push(t.label),void(s[i].parentNode.style.display="none")))),this.DOM.root.select(".mapView-UnmatchedData").classed("active",e.length>0),this.DOM.measureLabel.attr("transform",(e=>{const t=this.geoPath.centroid(e._geo_);return`translate(${t[0]},${t[1]})`})).style("display",(e=>{const t=this.geoPath.bounds(e._geo_);return Math.abs(t[0][0]-t[1][0])<this.width_CatMeasureLabel?"none":"block"}))}}catMap_refreshBounds_Active(){this.mapBounds_Active=this.catMap_getBounds(!0)}catMap_zoomToActive(e=!1){if(this.attrib.mapInitView)return this.leafletAttrMap.setView(L.latLng(this.attrib.mapInitView[0],this.attrib.mapInitView[1]),this.attrib.mapInitView[2]),void(this.attrib.mapInitView=null);e?this.leafletAttrMap.flyToBounds(this.mapBounds_Active,this.mapConfig.flyConfig):this.leafletAttrMap.fitBounds(this.mapBounds_Active)}catMap_setMaxBounds(){this.leafletAttrMap.setMaxBounds(this.catMap_getBounds())}catMap_getBounds(e=!1){const t=[];return this._aggrs.forEach((i=>{if(!i._geo_)return;if(e&&!i.isActive)return;let s=i._geo_._bounds;if(void 0===s&&(s=at.geoBounds(i._geo_),isNaN(s[0][0])&&(s=null),i._geo_._bounds=s),null===s)return;const r=L.latLng(s[0][1],s[0][0]),a=L.latLng(s[1][1],s[1][0]);t.push(r),t.push(a)})),0===t.length?this.catMap_getBounds(!1):Re.addMarginToBounds(new L.latLngBounds(t))}catMap_invertColorTheme(e){null==e&&(e=!this.invertedColorTheme),this.invertedColorTheme=e,this.mapColorScale&&(this.mapColorScale.range(this.invertedColorTheme?[9,0]:[0,9]),this.catMap_refreshColorScale(),this.refreshViz_All(),this.DOM.root.select(".editColorTheme.fa-adjust").classed("rotatedY",this.invertedColorTheme))}catMap_refreshColorScale(){if(!this.DOM.mapColorBlocks)return;let e=this.browser.colorTheme.getDiscrete(9);this.invertedColorTheme&&(e=e.reverse()),this.DOM.mapColorBlocks.style("background-color",(t=>e[t])).style("transform",(e=>{var t=100*e/9,i=100*(e+1)/9;return"translateX("+t+"%) scaleX("+Math.abs(i-t)/100+")"}))}catMap_prepView(){if(this.setAttrib&&this.showSetMatrix(!1),this.leafletAttrMap)return this.leafletAttrMap.invalidateSize(),this.DOM.aggrGroup=this.DOM.summaryCategorical.select(".catMap_SVG > .aggrGroup"),this.refreshDOMcats(),this.mapIsReady=!0,this.catMap_projectCategories(),this.refreshViz_Active(),void this.refreshViz_All();this.mapConfig=Re.mergeConfig(ae.map,this.attrib.mapConfig||{});var e,t=this;this.leafletAttrMap=L.map(this.DOM.catMap_Base.node(),this.mapConfig.leafConfig).addLayer(new L.TileLayer(this.mapConfig.tileTemplate,this.mapConfig.tileConfig)).on("viewreset",(()=>this.catMap_projectCategories())).on("movestart",(function(){t.browser.DOM.root.classed("noPointerEvents",!0),this._zoomInit_=this.getZoom(),t.DOM.catMap_SVG.style("opacity",.3)})).on("moveend",(function(){t.browser.DOM.root.classed("noPointerEvents",!1),t.DOM.catMap_SVG.style("opacity",null),this._zoomInit_!==this.getZoom()&&t.catMap_projectCategories()})),this.leafletAttrMap.attributionControl.setPosition("topright"),this.geoPath=at.geoPath().projection(at.geoTransform({point:function(e,i){var s=t.leafletAttrMap.latLngToLayerPoint(L.latLng(i,e));this.stream.point(s.x,s.y)}})),this.DOM.catMap_SVG=at.select(this.leafletAttrMap.getPanes().overlayPane).append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("class","catMap_SVG"),this.DOM.catMap_SVG.append("defs").append("pattern").attr("id","diagonalHatch").attr("patternUnits","userSpaceOnUse").attr("width",4).attr("height",4).append("path").attr("d","M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2").attr("stroke","gray").attr("stroke-width",1),(e=this.DOM.summaryCategorical.append("div").attr("class","visViewControl ViewControlGroup")).append("div").attr("class","visViewControlButton far fa-plus").tooltip(me.ZoomIn).on("click",(()=>this.leafletAttrMap.zoomIn())),e.append("div").attr("class","visViewControlButton far fa-minus").tooltip(me.ZoomOut).on("click",(()=>this.leafletAttrMap.zoomOut())),e.append("div").attr("class","visViewControlButton viewFit far fa-expand-arrows-alt").tooltip(me.ZoomToFit).on("click",(e=>{this.catMap_refreshBounds_Active(),this.catMap_zoomToActive(!0),e.preventDefault(),e.stopPropagation()})),e.append("div").attr("class","visViewControlButton mapView-UnmatchedData fa fa-exclamation").tooltip(me.MissingLocations).on("click",(()=>{var e=[];this._aggrs.forEach((t=>{void 0===t._geo_&&e.push(t.label+` <span style='color: gray; font-weight:300; font-size: 0.9em;'>[${t.recCnt("Total")} ${this.browser.recordName}"]</span>`)})),ye.alert("The following regions do not appear on the map.<br><br>"+e.join(", ")+"<br><br><span style='font-size: 0.9em; color: gray; font-weight: 300'>Please see the list of standard region names <a style='color: gray; text-decoration: underline;' href='https://docs.google.com/spreadsheets/d/1DKNXwsJy6_Mdy3ofwbBIZeBGrxSItYOJXNZgLyu0IM4' target='_blank'>here</a>.<br>If the place names above are misspelled, please update your data source.<span>").then((()=>{this.DOM.root.select(".mapView-UnmatchedData").classed("active",!1)}))}));var i=(e=this.DOM.summaryCategorical.append("div").attr("class","mapGlyphColorSetting")).append("div").attr("class","colorOptions").classed("active",!0);this.DOM.aggrGroup=this.DOM.catMap_SVG.append("g").attr("class","leaflet-zoom-hide aggrGroup"),this.insertCategoryGlyphs(),this.DOM.mapColorScaleGroup=i.append("div").attr("class","mapColorScaleGroup"),this.DOM.mapColorHighlightedValue=this.DOM.mapColorScaleGroup.append("span").attr("class","mapColorHighlightedValue fa fa-caret-down"),this.DOM.mapColorBlocks=this.DOM.mapColorScaleGroup.append("div").attr("class","mapColorScaleBins").selectAll(".mapColorThemeBin").data([0,1,2,3,4,5,6,7,8]).enter().append("div").attr("class","mapColorThemeBin").tooltip("",{placement:"bottom"}).on("mouseenter",((e,t)=>{var i=Math.round(this.mapColorScale.invert(t)),s=Math.round(this.mapColorScale.invert(t+1));e.currentTarget.tippy.setContent(Math.round(i)+" &mdash; "+Math.round(s))})),this.DOM.mapColorScaleGroup.append("div").attr("class","mapColorScaleLabels").call((e=>{e.selectAll(".asdsd").data([0,3,6,9]).enter().append("div").attr("class","mapColorScaleLabel").style("left",(e=>100*e/9+"%")).call((e=>{e.append("div").attr("class","tickLine"),e.append("div").attr("class","tickLabel")}))})),this.DOM.mapColorScaleGroup.append("div").attr("class","measureDescrLabel"),this.refreshMeasureDescrLabel(),i.append("div").attr("class","colorThemeOptions").append("div").attr("class","editColorTheme far fa-adjust").tooltip(me.InvertColorTheme).on("click",(()=>this.catMap_invertColorTheme())),this.mapIsReady=!0,this.leafletAttrMap.invalidateSize(),this.catMap_refreshBounds_Active(),this.catMap_zoomToActive(),this.catMap_setMaxBounds(),this.catMap_projectCategories(),this.refreshMeasureLabelText("Active"),this.refreshMapColorScaleBounds(),this.refreshViz_Active(),this.catMap_refreshColorScale(),this.refreshHeight()}refreshMapColorScaleBounds(e="Active"){this.mapColorScale=this.attrib.chartScale_Measure.copy().range(this.invertedColorTheme?[9,0]:[0,9]),this.DOM.mapColorScaleGroup.selectAll(".mapColorScaleLabels > .mapColorScaleLabel > .tickLabel").html(((e,t)=>this.browser.getValueLabel(this.mapColorScale.invert(3*(this.invertedColorTheme?3-t:t)))))}catMap_refreshVis(e){this.DOM.root.select(".editColorTheme").attr("data-color",e),this.refreshMapColorScaleBounds(e);var t=at.scaleQuantize().domain([0,9]).range(this.browser.colorTheme.getDiscrete(9));this.DOM.measure_Active.each(((i,s,r)=>{var a=this.browser.getChartValue(i,e);0===i[e].recCnt&&(a=null);var o=r[s],l="url(#diagonalHatch)",n="#111111";null!=a&&(l=t(this.mapColorScale(a)).toString(),n=at.hsl(l).l>.5?"#111111":"#EEEEEE"),o.style.fill=l,o.style.stroke=n,o.classList[null==a?"add":"remove"]("noData")}))}list_prepView(){this.DOM.aggrGroup=this.DOM.aggrGroup_list,this.attrib.updateChartScale_Measure(!0),this.insertCategoryGlyphs(),this.heightRow_category_dirty&&this.refreshHeight_Category(),this.updateCats_IsActive(),this.updateCatSorting_now(),this.refreshLabelWidth(),this.refreshViz_All(),this.refreshHeight(),this.refreshLabelWidth(),this.DOM.measureLabel.style("display",null)}init_DOM_Cat(){this.DOM.summaryControls=this.DOM.summaryCategorical.append("div").attr("class","summaryControls"),this.initDOM_CatTextSearch(),this.refreshConfigRowCount(),this.DOM.catChart=this.DOM.summaryCategorical.append("div").attr("class","catChart"),this.DOM.aggrGroup=this.DOM.catChart.append("div").attr("class","aggrGroup").on("mousedown",(e=>{e.stopPropagation(),e.preventDefault()})).on("scroll",(()=>{!0!==Re.ignoreScrollEvents&&(this.scrollTop_cache=this.DOM.aggrGroup.node().scrollTop,this.DOM.chartCatLabelResize.style("top","0px"),this.firstCatIndexInView=Math.floor(this.scrollTop_cache/this.heightCat),this.refreshScrollDisplayMore(this.firstCatIndexInView+this.catCount_InDisplay),this.updateCats_IsVisible(),this.catList_cullCategories(),this.refreshMeasureLabelText("Active"))})),this.DOM.aggrGroup_list=this.DOM.aggrGroup,this.DOM.catMap_Base=this.DOM.catChart.append("div").attr("class","catMap_Base"),this.DOM.chartBackground=this.DOM.aggrGroup.append("span").attr("class","chartBackground"),this.DOM.chartCatLabelResize=this.DOM.catChart.append("span").attr("class","chartCatLabelResize dragWidthHandle").tooltip(me["Adjust Label Width"]).on("mousedown",(e=>{var t=this.width_CatLabel-at.pointer(e,at.select("body").node())[0];this.browser.activateWidthDrag(this.panel.DOM.root.node(),e,(e=>{this.panel.width_CatText=t+at.pointer(e,at.select("body").node())[0]+this.width_CatMeasureLabel}))})),this.insertChartAxis_Measure(this.DOM.catChart),this.DOM.belowCatChart=this.DOM.summaryCategorical.append("div").attr("class","belowCatChart catSummary_ListOnly hasLabelWidth").style("height",ae.height_CatBottom-1+"px"),this.initDOM_CatSortButton(),this.DOM.scroll_display_more=this.DOM.belowCatChart.append("div").attr("class","scroll_display_more").on("click",(()=>Re.scrollToPos_do(this.DOM.aggrGroup,this.DOM.aggrGroup.node().scrollTop+this.heightCat))),this.DOM.belowCatChart.append("div").attr("class","gap"),this.DOM.belowCatChart.node().appendChild(this.DOM.noValueAggr.node())}initDOM_CatSortButton(){this.DOM.catSortButton=this.DOM.belowCatChart.append("span").attr("class","catSortButton fa fa-sort catSummary_ListOnly").tooltip(me.Sorting).on("click",(e=>ye.popupMenu(e,this.attrib.getSortMenuOpts(),this,{placement:"top-start"})))}insertCategoryGlyphs(){var e=this;if(this.isView_Dropdown)this.dropdown_refreshCategories();else if(this.DOM.aggrGroup){var i=this.DOM.aggrGroup.selectAll(".aggrGlyph").data(this._aggrs,(e=>e.id)).enter().append("list"==this.viewType?"span":"g").attr("class","aggrGlyph "+("list"==this.viewType?"cat":"map")+"Glyph").tooltip((e=>e.getTooltipHTML()),{theme:"dark kshf-tooltip kshf-record",placement:"right",animation:"fade",followCursor:this.isView_Map,offset:[0,this.isView_Map?15:0],trigger:"manual",onShow:()=>!this.attrib.uniqueCategories()}).on("mouseenter",(function(t,i){e.browser.adjustMode||(this.highlightTimeout=window.setTimeout((()=>{this.highlightTimeout=null,this.classList.add("catMouseOver"),e.attrib.onAggrHighlight(i),this.tippy.show()}),e.browser.movingMouseDelay))})).on("mouseleave",(function(t,i){this.tippy&&this.tippy.hide(),e.browser.adjustMode||(this.classList.remove("catMouseOver"),this.highlightTimeout&&window.clearTimeout(this.highlightTimeout),e.attrib.onAggrLeave(i))})).on("click",((e,t)=>{this.browser.adjustMode||this.attrib.onAggrClick(e,t)}));if(this.updateCats_IsVisible(),this.isView_List){i.style("height",this.heightCat+"px").style("transform","translateY(0px)"),i.append("span").attr("class","catLabelGroup_BG hasLabelWidth");var s=i.append("span").attr("class","catLabelGroup hasLabelWidth");s.append("span").attr("class","filterButton far fa-filter").tooltip(me.Filter).on("click",((e,t)=>{const i={name:"Filter",items:[]};let s=!0,r=!t.filtered_AND(),a=!t.filtered_OR(),o=!t.filtered_NOT(),l=t.isFiltered();const n=this.attrib.summaryFilter.selected_OR.length>0||this.attrib.summaryFilter.selected_AND.length>0;this.attrib.isMultiValued?(s=!0,r=r&&n,a=a&&n):(s=!t.filtered_AND(),r=!1,a=a&&n&&!t.filtered_AND(),o=o&&(!n||t.filtered_AND()));const h=`<span class='filterContextLabel'>${t.label}</span>`;l&&i.items.push({id:"filterOption_Remove",name:"<span class='filterContextOpt'>"+me.Clear+"</span>",helparticle:"5e88e80a2c7d3a7e9aea63ed",do:e=>this.attrib.filterCategory(e,"NONE")}),s&&i.items.push({id:"filterOption_Only",name:`<span class='filterContextOpt'>${me.Only}</span> ${h}`,helparticle:"5e88e7bc2c7d3a7e9aea63e9",do:e=>{this.attrib.noValueAggr.filtered=null,this.attrib.summaryFilter.selected_AndOrNot().forEach((e=>e.set_NONE())),this.attrib.filterCategory(e,"AND","All")}}),r&&i.items.push({id:"filterOption_And",name:`<span class='filterContextOpt'>${me.And}</span> ${h} <span class='filterContextMultiple'>[${me.Multiple}]</span>`,helparticle:"5e88e81a2c7d3a7e9aea63ee",do:e=>this.attrib.filterCategory(e,"AND")}),a&&i.items.push({id:"filterOption_Or",name:`<span class='filterContextOpt'>${me.Or}</span> ${h} <span class='filterContextMultiple'>[${me.Multiple}]</span>`,helparticle:"5e88e7e22c7d3a7e9aea63ec",do:e=>this.attrib.filterCategory(e,"OR")}),o&&i.items.push({id:"filterOption_Not",name:"<span class='filterContextOpt'>"+me.Not+"</span> "+h,helparticle:"5e88e7cf2c7d3a7e9aea63ea",do:e=>this.attrib.filterCategory(e,"NOT")}),ye.popupMenu(e,i,t,{placement:"bottom-start"}),e.stopPropagation(),e.preventDefault()})),this.insertAggrLockButton(s,"bottom"),s.append("span").attr("class","catLabelGap"),s.append("span").attr("class","AndOrNot AndOrNot_And").text(me.And),s.append("span").attr("class","AndOrNot AndOrNot_Or").text(me.Or),s.append("span").attr("class","AndOrNot AndOrNot_Not").text(me.Not),s.append("span").attr("class","catLabelOrder fa fa-bars").tooltip(me.Reorder).on("mousedown",((t,i)=>{var s=t.currentTarget.parentNode.parentNode,r=t.currentTarget.parentNode.parentNode.parentNode;e.browser.DOM.root.classed("noPointerEvents",!0);var a=i.orderIndex;at.select("body").on("mousemove.reordercat",(function(t){s.classList.add("draggedCategory");var i=Math.min(Math.max(at.pointer(t,r)[1],0),e.heightCat*(e.catCount_Active-1)),o=Math.min(Math.max(Math.round(i/e.heightCat),0),e.catCount_Active-1),l={from:a,to:o};e.updateCatSorting(0,!0,l),s.style.transform=`translate(0px, ${i}px)`})).on("mouseup.reordercat",(function(t){s.classList.remove("draggedCategory");var o=Math.min(Math.max(at.pointer(t,r)[1],0),e.heightCat*(e.catCount_Active-1)),l=Math.min(Math.max(Math.round(o/e.heightCat),0),e.catCount_Active-1),n={from:a,to:l,mult:void 0};if(n.from>n.to){var h=n.to;n.to=n.from,n.from=h,n.mult=1}else n.mult=-1;i.orderIndex=l,e.DOM.aggrGlyphs.filter((e=>e.label!==i.label)).each((e=>{e.orderIndex>=n.from&&e.orderIndex<=n.to&&(e.orderIndex+=n.mult)})),e.attrib.pleaseSort=!0,e.attrib.setFixedCatOrder(),e.browser.DOM.root.classed("noPointerEvents",!1),at.select("body").on("mousemove.reordercat",null).on("mouseup.reordercat",null)}))})),s.append("span").attr("class","catLabelEdit fa fa-pencil").tooltip("").on("mouseenter",((t,i)=>{var s="";e.attrib.catLabel_attr[i.id]&&(s=` <span>(${i.id})</span>`,t.shiftKey)?t.currentTarget.tippy.setContent("+Shift : "+me.Reset+s):t.currentTarget.tippy.setContent(me.EditTitle+s)})).on("click",(function(i,s){if(this.tippy.hide(),i.shiftKey)return delete e.attrib.catLabel_attr[s.id],void(this.nextSibling.innerHTML=t.sanitize(s.id));this.style.display="none",this.previousSibling.style.display="none",this.nextSibling.setAttribute("contenteditable",!0),this.nextSibling.focus()})),s.append("span").attr("class","catLabel").html((e=>e.label)).on("focus",(function(){this._initValue=t.sanitize(this.innerHTML),document.execCommand("selectAll",!1,null)})).on("blur",(function(){this.removeAttribute("contenteditable"),this.blur(),this.previousSibling.style.display="",this.previousSibling.previousSibling.style.display=""})).on("keydown",(function(i,s){if(27===i.keyCode)return this.blur(),void(this.innerHTML=t.sanitize(this._initValue));if("Enter"===i.key){i.stopPropagation(),i.preventDefault();var r=t.sanitize(this.innerHTML);if(""===r)return this.innerHTML=t.sanitize(this._initValue),void this.blur();s.label=r,e.attrib.catLabel_attr[s.id]=r,this.blur()}}));var r=i.append("div").attr("class","measureLabelGroup");ae.Active_Compare_List.forEach((e=>{r.append("span").attr("class","measureLabel measureLabel_"+e)}));var a=i.append("div").attr("class","measureGroup");ae.Total_Active_Compare_List.forEach((e=>{a.append("span").attr("class",`measure_${e} bg_${e}`).on("mouseenter",((t,i)=>{i.DOM.aggrGlyph.querySelector(".measureLabel_"+e).classList.add("forceShow"),ae.Compare_List.find((t=>t===e))&&this.browser.refreshAllMeasureLabels(e),t.preventDefault(),t.stopPropagation()})).on("mouseleave",((t,i)=>{var s=i.DOM.aggrGlyph.querySelector(".measureLabel_"+e);s&&s.classList.remove("forceShow"),ae.Compare_List.find((t=>t===e))&&this.browser.refreshAllMeasureLabels("Active")}))})),a.append("div").attr("class","setMatrixLine")}else this.isView_Map&&i.append("g").attr("class","measureGroup").append("path").attr("class","measure_Active");this.refreshDOMcats()}}refreshMeasureLabelPos(e="Active",t=0){if(!this.isVisible())return;if(!this.isView_List)return;if("Other"===e)return;var i=this.height_bar_topGap,s=this.barHeight_Full;let r=this.DOM["measureLabel_"+e];if(this.attrib.stackedCompare&&!this.panel.hiddenCatBars()){const t=this.measureLineZero,s=this.width_CatBars,a=!this.browser.isCompared();r.each(((r,o,l)=>{let n=r.scale(e),h=t+r.offset(e),c=h+n,d=0==this.browser.getMeasureValue(r,e);!d&&this.browser.isCompared()&&(d=r.scale(e)<this.width_CatMeasureLabel-4);let u=Math.abs(h-t)<2?"left":Math.abs(c-s)<2&&this.browser.relativeBreakdown?"right":"middle";a&&(n=this.width_CatMeasureLabel,h=Math.min(t+r.sumOffsetScale(e),s-n),c=h+n,u=c+10<s?"left":"right",d=0===r.recCnt(e)),l[o].classList[d?"add":"remove"]("hidden"),l[o].setAttribute("labelAlign",u),l[o].style.width=n+"px",l[o].style.transform=`translate(${h}px, ${i}px)`}))}else{this.vizSideBySide()&&(s/=this.browser.activeComparisonsCount,i+=s*t);const a=!this.browser.stackedChart&&this.attrib.isComparedAttrib()&&this.attrib.isMultiValued&&!this.splitOnSelfCompare;r.attr("labelAlign",null).classed("hidden",(t=>a?t.compared!==e:s<12||this.attrib.isComparedAttrib()&&!this.attrib.isMultiValued&&(e!==t.compared||this.browser.relativeBreakdown))).style("transform",`translateY(${i}px)`).style("width",null)}r.style("line-height",s+"px")}refreshDOMcats(){this.DOM.aggrGlyphs=this.DOM.aggrGroup.selectAll(".aggrGlyph").each(((e,t,i)=>{e.setAggrGlyph(i[t])})),this.DOM.measureLabelGroup=this.DOM.aggrGlyphs.selectAll(".measureLabelGroup"),this.DOM.measureLabel=this.DOM.aggrGlyphs.selectAll(".measureLabel"),ae.Active_Compare_List.forEach((e=>{this.DOM["measureLabel_"+e]=this.DOM.aggrGlyphs.selectAll(".measureLabel_"+e)})),ae.Total_Active_Compare_List.forEach((e=>{this.DOM["measure_"+e]=this.DOM.aggrGlyphs.selectAll(".measure_"+e)})),this.isView_List&&(this.DOM.catLabel=this.DOM.aggrGlyphs.selectAll(".catLabel"),this.DOM.lockButton=this.DOM.aggrGlyphs.selectAll(".lockButton"),this.refreshHeight_Category_do())}updateCatSorting_now(){this.updateCatSorting(0,!1)}updateCatSorting(e=1e3,t=!0,i=!1){if(0!==this._aggrs.length&&(!this.attrib.uniqueCategories()||this.panel)){if(this.browser.finalized||(t=!1),this.updateCats_IsActive(),!i&&(0===e||!this.attrib.catOrder_Fixed||this.attrib.pleaseSort)){this.attrib._sortCategories();var s=0;this._aggrs.forEach((e=>{e.orderIndex=e.isActive?s++:-s-1}))}if(this.updateCats_IsVisible(),this.panel&&this.DOM.aggrGlyphs&&this.isView_List){if(this.DOM.catChart.classed("catOrder_Fixed",this.attrib.catOrder_Fixed),!i&&this.setAttrib){var r=this.setAttrib;r.block.refreshRow(),r.block.DOM.setPairGroup.attr("animate_position",!1),r.block.refreshSetPair_Position(),setTimeout((()=>r.block.DOM.setPairGroup.attr("animate_position",!0)),1e3)}if(this.DOM.chartBackground.style("height",this.height_VisibleAttrib+"px"),0!==this.scrollTop_cache&&Re.scrollToPos_do(this.DOM.aggrGroup,0),this.refreshScrollDisplayMore(this.firstCatIndexInView+this.catCount_InDisplay),!t)return this.DOM.aggrGlyphs.each((e=>{e.posX=0})).style("opacity",1).style("transform",(e=>e.transformPos)),void this.catList_cullCategories();if(i){var a=i.from;if(i.from>i.to){var o=i.to;i.to=i.from,i.from=o,i.mult=1}else i.mult=-1;this.DOM.aggrGlyphs.filter((e=>e.orderIndex!==a)).transition().duration(e).style("transform",(e=>{var t=e.orderIndex>=i.from&&e.orderIndex<=i.to?this.heightCat*i.mult:0;return`translate(${e.posX}px, ${e.posY+t}px)`}))}else{var l=this.DOM.aggrGlyphs.filter((e=>!e.isActiveBefore&&!e.isActive)),n=this.DOM.aggrGlyphs.filter((e=>e.isActiveBefore&&!e.isActive)),h=this.DOM.aggrGlyphs.filter((e=>!e.isActiveBefore&&e.isActive)),c=this.DOM.aggrGlyphs.filter((e=>e.isActive));l.style("display","none");n.transition().duration(e).on("end",(function(e){this.style.opacity=0,e.posX=-100,this.style.transform=e.transformPos})).transition().duration(1e3).on("end",(function(){this.style.display="none"})),h.transition().duration(e).on("end",((e,t,i)=>{var s=i[t];s.style.opacity=0,s.style.display=null,e.posX=-100,s.style.transform=e.transformPos}));c.style("display",null).transition().duration((t=>{if(t.isVisibleBefore&&!t.isVisible)return e;var i=t.isActiveBefore?0:30*(this.catCount_InDisplay-5);return 100+e+i+30*Math.min(t.orderIndex,this.catCount_InDisplay+2)})).on("end",((e,t,i)=>{e.posX=0,i[t].style.opacity=1,i[t].style.transform=e.transformPos})).transition().duration(250).on("end",((e,t,i)=>{e.isVisible||e.isVisibleBefore||(i[t].style.display="none")}))}}}}dropdown_prepView(){this.insertCategoryGlyphs()}dropdown_refreshCategories(){this.DOM&&this.DOM.summaryCategorical&&this.inDashboard&&this.isVisible()&&import("./vendor.min.js").then((function(e){return e.a4})).then((e=>{var t=this,i={searchEnabled:this._aggrs.length>15,searchResultLimit:20,searchPlaceholderValue:me.Search,shouldSort:!1,shouldSortItems:!1,duplicateItemsAllowed:!1,paste:!1,removeItemButton:"MultiSelect"===this.dropdown_type,placeholder:"MultiSelect"===this.dropdown_type||"",placeholderValue:me.All,callbackOnCreateTemplates:()=>({choice(i,s){const r=e.defaults.templates.choice.call(this,i,s),a=t.attrib.catTable_id[s.label];return(null==a?void 0:a.compared)&&r.classList.add(a.compared),r},item(i,s){const r=e.defaults.templates.item.call(this,i,s,"MultiSelect"===t.dropdown_type),a=t.attrib.catTable_id[s.label];return(null==a?void 0:a.compared)&&r.classList.add("bg_"+a.compared),r}})};this.choicesUI&&(this.choicesUI.destroy(),this.DOM.ChoicesSelectDOM.remove()),this.DOM.ChoicesSelectDOM=this.DOM.summaryCategorical.append("select").attr("multiple","MultiSelect"===this.dropdown_type||null),this.DOM.ChoicesSelectDOM.node().addEventListener("removeItem",(e=>{if("MultiSelect"===this.dropdown_type){var t=e.detail.customProperties;t||(t=this.attrib.catTable_id[e.detail.label]),t&&this.attrib.onAggrClick(e,t)}})),this.DOM.ChoicesSelectDOM.node().addEventListener("choice",(e=>{var t=this.attrib.summaryFilter.selected_AND[0],i=e.detail.choice.customProperties;i&&t&&t.label===i.label||(!i||0!==i.recCnt("Active")||this.attrib.isFiltered()?window.setTimeout((()=>{"MultiSelect"!==this.dropdown_type?(this.attrib.summaryFilter.clearFilter(!i),i&&this.attrib.filterCategory(i,"AND","All")):i?this.attrib.isFiltered()?this.attrib.filterCategory(i,this.attrib.isMultiValued?"AND":"OR","All"):this.attrib.filterCategory(i,"AND","All"):this.attrib.summaryFilter.clearFilter(!i)}),10):ye.alert(me["Cannot select an option with no data in current filtered dashboard."]))})),this.choicesUI=new e(this.DOM.ChoicesSelectDOM.node(),i),this.choicesUI.setChoices([{value:"-",label:me.All,selected:!this.attrib.isFiltered()||null}].concat(this._aggrs.map((e=>({value:e.label,label:e.label,selected:!!e.isFiltered()||null,disabled:0===e.recCnt("Active")&&!this.attrib.isFiltered()||null,customProperties:e})))),"value","label",!0)}))}}class lt extends Ae{constructor(e,t){super(e),this.DOM={},this._label=null,this.catFiltering=null,this.orderIndex=0,this.posX=0,this._geo_=null,this._id=t}get id(){return this._id}set label(e){this._label=e}get label(){return this._label||this._id}get tooltipTitle(){return this.attrib.attribNameHTML}get tooltipSkip1(){return!this.filtered_AND()}setAggrGlyph(e){super.setAggrGlyph(e),this.refreshCatDOMSelected()}isFiltered(){return null!==this.catFiltering}filtered_NOT(){return"NOT"===this.catFiltering}filtered_AND(){return"AND"===this.catFiltering}filtered_OR(){return"OR"===this.catFiltering}set_NONE(){this.inList&&this.inList.splice(this.inList.indexOf(this),1),this.catFiltering=null,this.refreshCatDOMSelected()}set_NOT(e){this.filtered_NOT()||(this.catFiltering="NOT",this.insertToList(e))}set_AND(e){this.filtered_AND()||(this.catFiltering="AND",this.insertToList(e))}set_OR(e){this.filtered_OR()||(this.catFiltering="OR",this.insertToList(e))}unselectAggregate(){var e;super.unselectAggregate(),this.locked||null===(e=this.DOM.matrixRow)||void 0===e||e.removeAttribute("selection")}exportAggregateInfo(){return{id:this.id}}get posY(){return this.orderIndex*this.attrib.barHeight.get()}get transformPos(){return`translate(${this.posX}px, ${this.posY}px)`}insertToList(e){this.inList&&this.inList.splice(this.inList.indexOf(this),1),this.inList=e,e.push(this),this.refreshCatDOMSelected()}refreshCatDOMSelected(){var e,t;this.catFiltering?null===(t=this.DOM.aggrGlyph)||void 0===t||t.setAttribute("catFiltered",this.catFiltering):null===(e=this.DOM.aggrGlyph)||void 0===e||e.removeAttribute("catFiltered")}}class nt extends Ae{constructor(e,t,i){super(e),this.mst_distance=0,this.set_1=t,this.set_2=i}similarityScore(){var e=this.measure("Active");if(0===e)return 0;var t=this.set_1.measure("Active"),i=this.set_2.measure("Active");return e/Math.min(t,i)}get label(){return`${this.set_1.label}<br> &amp; ${this.set_2.label}`}exportAggregateInfo(){return{}}}const ht={select:a,pointer:_,max:d,format:m,easeLinear:x,interpolate:V,interpolateHsl:R,rgb:k};class ct extends ze{constructor(e){super(e),this.setPairDiameter=0,this._maxSetPairAggr_Active=0,this.gridPan_x=0,this.pausePanning=!1,this.panel=e.setListAttrib.block.panel}get setPairs(){return this.attrib.setPairs}get setListSummary(){return this.attrib.parent}get rowHeight(){return this.setListSummary.barHeight.get()}get setPairCount_Total(){return this.attrib.sets.length*(this.attrib.sets.length-1)/2}get popupSide(){return"left"===this.setListSummary.block.panel.name?"right":"left"}updateSetPairDiameter(){this.setPairDiameter=this.rowHeight-2}get setPairRadius(){return this.setPairDiameter/2}updateMaxAggr_Active(){this._maxSetPairAggr_Active=ht.max(this.setPairs,(e=>e.measure("Active")))}getCliqueSizeRatio(e){return 0===this._maxSetPairAggr_Active?0:Math.sqrt(e.measure("Active")/this._maxSetPairAggr_Active)}usingFullSizeGlyph(){return this.browser.relativeBreakdown||this.browser.dependentBreakdown}setCollapsed(e){this.setListSummary.block.showSetMatrix(!0!==e)}hasStaticHeight(){return!0}get height_Content(){return this.setListSummary.block.height_Content}get height_RangeMin(){return this.setListSummary.block.height_RangeMin}get height_RangeMax(){return this.setListSummary.block.height_RangeMax}getHeight(){return this.setListSummary.block.height_Categories}setHeight(e){this.setListSummary.block.setHeight(e)}refreshHeight(){this.isVisible()&&(this.updateSetPairDiameter(),this.DOM.chartRoot.attr("show_gridlines",this.rowHeight>15),this.DOM.setPairGroup.attr("animate_position",!1),this.refreshRow(),this.refreshSetPair_Background(),this.refreshSetPair_Position(),this.refreshViz_All(),this.refreshSetPair_Strength(),setTimeout((()=>this.DOM.setPairGroup.attr("animate_position",!0)),1e3))}getWidth(){return this.browser.panels.middle.width_Real+ae.width_PanelGap}refreshWidth(){this.refreshWindowSize(),"left"===this.popupSide&&(this.refreshRow_LineWidths(),this.refreshSetPair_Position())}initDOM(e=null){return this.DOM.root=this.setListSummary.block.DOM.root.insert("div",":first-child").attr("class","kshfSummary setPairSummary").attr("data-popupSide",this.popupSide),this.insertHeader(),this.DOM.chartRoot=this.DOM.wrapper.append("span").attr("class","Summary_Set").attr("show_gridlines",!0),this.insertSummaryControls(),this.DOM.setMatrixSVG=this.DOM.chartRoot.append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("class","setMatrix"),this.DOM.belowMatrix=this.DOM.chartRoot.append("div").attr("class","belowMatrix"),this.DOM.pairCount=this.DOM.belowMatrix.append("span").attr("class","pairCount matrixInfo"),this.DOM.pairCount_Text=this.DOM.pairCount.append("span").attr("class","pairCount_Text").html(`<i class='fa fa-circle' style='color: #b1bdc5;'></i> \n      ${this.setPairs.length} ${me.Pairs} (${Math.round(100*this.setPairs.length/this.setPairCount_Total)}%)`),this.DOM.subsetCount=this.DOM.belowMatrix.append("span").attr("class","subsetCount matrixInfo"),this.DOM.subsetCount.append("span").attr("class","circleeee borrderr"),this.DOM.subsetCount_Text=this.DOM.subsetCount.append("span").attr("class","subsetCount_Text"),this.DOM.strengthControl=this.DOM.belowMatrix.append("span").attr("class","strengthControl matrixInfo").tooltip("Cell color shows strength (ratio of shared elements) between categories."),this.DOM.strengthControl.append("span").attr("class","strengthLabel").text(me.Weak),this.DOM.strengthControl.append("span").attr("class","strengthText").text(me.Strength),this.DOM.strengthControl.append("span").attr("class","strengthLabel").text(me.Strong),this.DOM.setMatrixBackground=this.DOM.setMatrixSVG.append("rect").attr("class","setMatrixBackground").attr("x",0).attr("y",0).style("fill-opacity","0").on("mousedown",(e=>{this.browser.DOM.pointerBlock.attr("active",""),this.browser.DOM.root.attr("pointerEvents",!1);var t=ht.pointer(e,this.browser.DOM.root.node()),i=this.gridPan_x,s=this.setListSummary.block.DOM.aggrGroup.node(),r=s.scrollTop;this.getWidth(),this.getHeight();var a=this.setListSummary.block.scrollTop_cache;Math.min(-a-this.gridPan_x,0),this.pausePanning=!0,ht.select("body").on("mousemove",(e=>{var a=ht.pointer(e,this.browser.DOM.root.node()),o=a[0]-t[0],l=a[1]-t[1];"right"===this.popupSide&&(o*=-1),this.gridPan_x=i+o+l,this.refreshSVGViewBox(),s.scrollTop=Math.max(0,r-l),e.preventDefault(),e.stopPropagation()})).on("mouseup",(e=>{this.pausePanning=!1,this.browser.DOM.root.attr("pointerEvents",null),this.browser.DOM.pointerBlock.attr("active",null),this.refreshLabel_Vert_Show(),ht.select("body").on("mousemove",null).on("mouseup",null),e.preventDefault(),e.stopPropagation()})),e.preventDefault(),e.stopPropagation()})),this.DOM.setMatrixSVG.append("g").attr("class","rows").style("transform","translateY(0.5px)"),this.DOM.setPairGroup=this.DOM.setMatrixSVG.append("g").attr("class","aggrGroup setPairGroup").attr("animate_position",!0),this.insertRows(),this.insertSetPairs(),this.updateSetPairDiameter(),this.refreshRow(),this.refreshSetPair_Background(),this.refreshSetPair_Position(),this.refreshSetPair_Containment(),this.refreshViz_Axis(),this.refreshViz_Active(),this.refreshViz_Compare_All(),this.DOM.inited=!0,!0}insertSummaryControls(){this.DOM.summaryControls=this.DOM.chartRoot.append("div").attr("class","summaryControls").style("height",this.setListSummary.block.height_Config+1+"px"),this.DOM.scaleLegend_SVG=this.DOM.summaryControls.append("svg").attr("class","sizeLegend").attr("xmlns","http://www.w3.org/2000/svg"),this.DOM.legendHeader=this.DOM.scaleLegend_SVG.append("text").attr("class","legendHeader").text("#"),this.DOM.legend_Group=this.DOM.scaleLegend_SVG.append("g")}insertRows(){var e=this.DOM.setMatrixSVG.select("g.rows").selectAll("g.row").data(this.attrib.sets,(e=>e.id)).enter().append("g").attr("class","row").each(((e,t,i)=>{e.DOM.matrixRow=i[t]})).on("mouseenter",((e,t)=>this.setListSummary.onAggrHighlight(t))).on("mouseleave",((e,t)=>this.setListSummary.onAggrLeave(t))),t=document.createElement("div");e.append("line").attr("class","line line_vert").attr("x1",0).attr("y1",0).attr("y1",0).attr("y2",0),e.append("text").attr("class","catLabel label_horz").style("font-size",this.setListSummary.block.catLabelFontSize+"px").text((e=>(t.innerHTML=e.label,t.textContent||t.innerText||""))).on("click",((e,t)=>{this.setListSummary.filterCategory(t,"AND")})),e.append("line").attr("class","line line_horz").attr("x1",0).attr("y1",0).attr("y2",0),e.append("text").attr("class","catLabel label_vert").style("font-size",this.setListSummary.block.catLabelFontSize+"px").text((e=>(t.innerHTML=e.label,t.textContent||t.innerText||""))).attr("y",-4),t.remove(),this.DOM.setRows=this.DOM.setMatrixSVG.selectAll("g.rows > g.row"),this.DOM.line_vert=this.DOM.setMatrixSVG.selectAll("g.rows > g.row > line.line_vert"),this.DOM.line_horz=this.DOM.setMatrixSVG.selectAll("g.rows > g.row > line.line_horz"),this.DOM.line_horz_label=this.DOM.setMatrixSVG.selectAll("g.rows > g.row > text.label_horz"),this.DOM.line_vert_label=this.DOM.setMatrixSVG.selectAll("g.rows > g.row > text.label_vert")}refreshViz_Active(){this.DOM.aggrGlyphs.attr("activesize",(e=>e.measure("Active"))),this.DOM.measure_Active.transition().ease(ht.easeLinear).duration(500).attr("r",this.usingFullSizeGlyph()?e=>this.setPairRadius+(e.subt?-1:0):e=>this.getCliqueSizeRatio(e)*this.setPairRadius)}refreshViz_Compare(e,t,i,s){var r=e=>0,a=(e,t)=>e.ratioToActive(t),o=this.usingFullSizeGlyph();this.attrib.stackedCompare||(r=e=>this.setPairRadius/i*(o?1:this.getCliqueSizeRatio(e)),s=[]),this.browser.dependentBreakdown&&(a=(t,i)=>t[i].measure/(this.browser.allRecordsAggr[e].measure||1e13)),this.DOM["measure_"+e].style("stroke-width",r).transition().ease(ht.easeLinear).duration(t===i-1&&this.browser.addedCompare?500:0).attrTween("d",((i,l,n)=>{const h=n[l],c=s.reduce(((e,t)=>e+a(i,t)),0),d=ht.interpolate(h._currentPreviewAngle,a(i,e)),u=this.setPairRadius*(o?1:this.getCliqueSizeRatio(i))-(this.attrib.stackedCompare?0:(t+.5)*r(i));return e=>{const t=d(e);return h._currentPreviewAngle=t,Re.getPieSVGPath(c,t,u,!this.attrib.stackedCompare)}}))}chartAxis_Measure_TickSkip(){throw new Error("Method not implemented.")}updateAfterFilter(e){this.isVisible()&&(this.updateMaxAggr_Active(),this.refreshViz_All(),this.refreshViz_NoValueAggr(),this.DOM.setRows.style("opacity",(e=>e.Active.measure>0?1:.3)),this.refreshSetPair_Containment())}refreshSetPair_Containment(){var e=0;this.DOM.aggrGlyphs.each((t=>{var i=t.Active.measure,s=t.set_1.Active.measure,r=t.set_2.Active.measure;i===s||i===r?(e++,t.subset=s===r?"equal":"proper"):t.subset=""})).classed("isSubset",(e=>""!==e.subset)),this.DOM.subsetCount.style("display",0===e?"none":null),this.DOM.subsetCount_Text.text(e),this.refreshSetPair_Strength()}onSetPairEnter(e){var t,i;null===(t=e.set_1.DOM.matrixRow)||void 0===t||t.setAttribute("selection","selected"),null===(i=e.set_2.DOM.matrixRow)||void 0===i||i.setAttribute("selection","selected"),this.browser.setSelect_Compare(e)}onSetPairLeave(e){var t,i;null===(t=e.set_1.DOM.matrixRow)||void 0===t||t.removeAttribute("selection"),null===(i=e.set_2.DOM.matrixRow)||void 0===i||i.removeAttribute("selection"),this.browser.clearSelect_Compare(),this.browser.refreshAllMeasureLabels("Active")}refreshSetPair_Strength(){var e=ht.interpolateHsl(ht.rgb(169,181,190),ht.rgb(232,235,238));let t=ht.max(this.setPairs,(e=>e.similarityScore()));this.DOM.setPairBackground.style("fill",(i=>e(i.similarityScore()/t))).each(((e,t,i)=>{var s=i[t];if(""!==e.subset){if("equal"===e.subset)return s.style.strokeDasharray="",void(s.style.strokeDashoffset="");var r=(this.setPairRadius-1)*Math.PI;s.style.strokeDasharray=r+"px";var a=e.set_1.orderIndex,o=e.set_2.orderIndex,l=e.set_1.Active.measure,n=e.set_2.Active.measure;(a<o&&l<n||a>o&&l>n)&&(r/=2),s.style.strokeDashoffset=r+"px"}}))}insertSetPairs(){var e=this,t=this.DOM.setMatrixSVG.select("g.setPairGroup").selectAll("g.setPairGlyph").data(this.setPairs,((e,t)=>t)).enter().append("g").attr("class","aggrGlyph setPairGlyph").each(((e,t,i)=>{e.setAggrGlyph(i[t])})).tooltip((e=>e.getTooltipHTML()),{theme:"dark kshf-tooltip kshf-record",placement:"right",animation:"fade",boundary:"window",trigger:"manual"}).on("mouseenter",((t,i)=>{if(!e.browser.adjustMode){var s=t.currentTarget;s.highlightTimeout&&window.clearTimeout(s.highlightTimeout),s.highlightTimeout=window.setTimeout((()=>{s.tippy.show(),this.onSetPairEnter(i)}),e.browser.movingMouseDelay)}})).on("mouseleave",((e,t)=>{var i=e.currentTarget;i.highlightTimeout&&window.clearTimeout(i.highlightTimeout),i.tippy.hide(),this.onSetPairLeave(t)})).on("click",((e,t)=>{this.setListSummary.filterCategory(t.set_1,"AND"),this.setListSummary.filterCategory(t.set_2,"AND")}));t.append("rect").attr("class","setPairBackground").attr("rx",3).attr("ry",3);var i=t.append("g").attr("class","measureGroup");i.append("circle").attr("class","measure_Active").attr("cx",0).attr("cy",0).attr("r",0),ae.Compare_List.forEach((e=>{this.DOM["measure_"+e]=i.append("path").attr("class","measure_"+e).each(((e,t,i)=>{i[t]._currentPreviewAngle=0}))})),this.DOM.aggrGlyphs=this.DOM.setPairGroup.selectAll(".setPairGlyph"),this.DOM.setPairBackground=this.DOM.aggrGlyphs.selectAll(".setPairBackground"),["Active"].concat(ae.Compare_List).forEach((e=>{this.DOM["measure_"+e]=this.DOM.aggrGlyphs.selectAll(".measure_"+e)}))}refreshViz_Axis(){if(this.refreshSetPair_Strength(),this.usingFullSizeGlyph())this.DOM.scaleLegend_SVG.style("dislay","none");else{this.DOM.scaleLegend_SVG.style("display","block"),this.DOM.scaleLegend_SVG.attr("width",this.setPairDiameter+50).attr("height",this.setPairDiameter+10).attr("viewBox","0 0 "+(this.setPairDiameter+35)+" "+(this.setPairDiameter+10)),this.DOM.legend_Group.attr("transform",`translate(${this.setPairRadius},${this.setPairRadius+18})`),this.DOM.legendHeader.attr("transform",`translate(${this.setPairDiameter+3},6)`);var e=this._maxSetPairAggr_Active,t=[e];this.setPairRadius>8&&t.push(Math.round(e/4)),this.DOM.legend_Group.selectAll("g.legendMark").remove();var i=this.DOM.legend_Group.selectAll("g.legendMark").data(t,(e=>e));this.DOM.legendCircleMarks=i.enter().append("g").attr("class","legendMark"),this.DOM.legendCircleMarks.append("circle").attr("class","legendCircle").attr("cx",0).attr("cy",0).attr("r",(t=>this.setPairRadius*Math.sqrt(t/e))),this.DOM.legendCircleMarks.append("line").attr("class","legendLine").each(((t,i,s)=>{var r,a,o=this.setPairRadius+3,l=this.setPairRadius*Math.sqrt(t/e);switch(i%4){case 0:r=o,a=-l;break;case 1:case 2:r=o,a=l;break;case 3:r=-o,a=l}s[i].setAttribute("x1",0),s[i].setAttribute("x2",r),s[i].setAttribute("y1",a),s[i].setAttribute("y2",a)})),this.DOM.legendText=this.DOM.legendCircleMarks.append("text").attr("class","legendLabel"),this.DOM.legendText.each(((t,i,s)=>{var r,a,o=this.setPairRadius+3,l=this.setPairRadius*Math.sqrt(t/e);switch(i%4){case 0:r=o,a=-l;break;case 1:case 2:r=o,a=l;break;case 3:r=-o,a=l}s[i].setAttribute("transform",`translate(${r},${a})`),s[i].style.textAnchor="start"})),this.DOM.legendText.text((e=>ht.format("0.1s")(e)))}}refreshWindowSize(){var e=this.getWidth(),t=this.getHeight();this.DOM.wrapper.style("height",this.setListSummary.block.getHeight()-this.setListSummary.block.height_Header+"px"),this.DOM.setMatrixBackground.attr("x",24*-e).attr("y",24*-t).attr("width",50*e).attr("height",50*t),this.DOM.root.style(this.popupSide,-e+"px").style("width",e+"px").style("left"===this.popupSide?"right":"left","initial"),this.pausePanning||this.refreshSVGViewBox()}refreshPopupSide(){this.DOM.root.attr("data-popupSide",this.popupSide),this.refreshRow(),this.refreshSetPair_Position(),this.refreshSVGViewBox()}refreshSVGViewBox(){var e=this.getWidth(),t=this.getHeight(),i=this.setListSummary.block.scrollTop_cache,s=Math.max(i+this.gridPan_x,0)*("left"===this.popupSide?-1:1);this.DOM.setMatrixSVG.attr("width",e).attr("height",t).attr("viewBox",s+" "+i+" "+e+" "+t),this.refreshLabel_Vert_Show()}refreshSetPair_Background(){this.DOM.setPairBackground.attr("x",-this.setPairRadius).attr("y",-this.setPairRadius).attr("width",this.setPairDiameter).attr("height",this.setPairDiameter)}refreshLabel_Vert_Show(){var e=this.getWidth(),t=this.getHeight();this.setListSummary.block.scrollTop_cache,this.DOM.line_vert_label.attr("show",(e=>!e.isVisible)).attr("transform",(i=>{var s=i.orderIndex,r=e-(s+.5)*this.rowHeight-2;return"right"===this.popupSide&&(r=e-r-4),`translate(${r} ${(this.setListSummary.block.catCount_Active-s-1)*this.rowHeight-this.setListSummary.block.height_VisibleAttrib+this.setListSummary.block.scrollTop_cache+t}) rotate(-90)`}))}refreshRow(){this.refreshWindowSize(),this.DOM.setRows.attr("transform",(e=>`translate(0,${(e.orderIndex+.5)*this.rowHeight})`)),this.refreshRow_LineWidths()}refreshSetPair_Position(){var e=this.getWidth();this.DOM.aggrGlyphs.style("transform",(t=>{var i=t.set_1.orderIndex,s=t.set_2.orderIndex,r=(Math.min(i,s)+.5)*this.rowHeight;return"left"===this.popupSide&&(r=e-r),`translate(${r}px,${(Math.max(i,s)+.5)*this.rowHeight}px)`}))}refreshRow_LineWidths(){var e=this.rowHeight,t=this.getWidth();this.DOM.line_vert.each(((i,s,r)=>{var a=r[s],o=(s=i.orderIndex,(this.setListSummary.block.catCount_Active-s-1)*e),l=(s+.5)*e,n="left"===this.popupSide?t-l:l;a.setAttribute("x1",n),a.setAttribute("x2",n),a.setAttribute("y2",o)})),this.DOM.line_horz.attr("x2","left"===this.popupSide?t:0).attr("x1",(i=>{var s=(i.orderIndex+.5)*e;return"left"===this.popupSide?t-s:s})),this.DOM.line_horz_label.attr("transform",(i=>{var s=(i.orderIndex+.5)*e+2;return"left"===this.popupSide&&(s=t-s),`translate(${s} 0)`}))}}class dt extends Oe{get parent(){return this._parent}get setListAttrib(){return this._parent}get block(){return this._block}get setPairs(){return this._aggrs}get sets(){return this.setListAttrib._aggrs}constructor(e,t){super(e,me.SetPairTitle(t.attribName),null,"setpair","setPairSummary",""),this._aggrs=[],this._setPairs_ID={},this._parent=t,this._block=new ct(this)}initializeAggregates(){this.aggr_initialized||(this.createSetPairs(),this.block.initDOM(),this.aggr_initialized=!0)}getAggregate(e,t){var i=this._setPairs_ID[e.id][t.id];return i||(i=new nt(this.setListAttrib,e,t),e.setPairs.push(i),t.setPairs.push(i),this.setPairs.push(i),this._setPairs_ID[e.id][t.id]=i,this.browser.allAggregates.push(i)),i}createSetPairs(){this.sets.forEach((e=>{e.setPairs=[]}));var e=(e,t,i)=>{t.id<=e.id||(void 0===this._setPairs_ID[e.id]&&(this._setPairs_ID[e.id]={}),this.getAggregate(e,t).addRecord(i))},t=e=>this.setListAttrib.getAggrWithLabel(e);this.setListAttrib.records.forEach((i=>{var s=i.getValue(this.setListAttrib);null!==s&&(s.length<2||s.forEach((r=>{var a=t(r);a.setPairs&&s.forEach((s=>{var r=t(s);r.setPairs&&e(a,r,i)}))})))})),this.block.updateMaxAggr_Active()}updatePerceptualOrder(){var e=this.setPairs.filter((e=>e.measure("Active")>0)),t=this.sets;t.forEach((e=>{e.MST={tree:new Object,childNodes:[],parentNode:null}})),e.forEach((e=>{var t=e.set_1,i=e.set_2;e.mst_distance=0,t.setPairs.forEach((s=>{if(s!==e){var r=s.set_1===t?s.set_2:s.set_1,a=null;i.id>r.id?this._setPairs_ID[r.id]&&(a=this._setPairs_ID[r.id][i.id]):this._setPairs_ID[i.id]&&(a=this._setPairs_ID[i.id][r.id]),e.mst_distance+=a?Math.abs(s.measure("Active")-a.measure("Active")):s.measure("Active")}})),i.setPairs.forEach((s=>{if(s!==e){var r=s.set_1===i?s.set_2:s.set_1,a=void 0;t.id>r.id?this._setPairs_ID[r.id]&&(a=this._setPairs_ID[r.id][t.id]):this._setPairs_ID[t.id]&&(a=this._setPairs_ID[t.id][r.id]),void 0!==a||(e.mst_distance+=s.measure("Active"))}}))})),e.sort(((e,t)=>e.mst_distance-t.mst_distance)),e.forEach((e=>{var t,i,s=e.set_1,r=e.set_2;s.MST.tree!==r.MST.tree&&(s.setPairs.length<r.setPairs.length?(t=s,i=r):(t=r,i=s),i.MST.tree=t.MST.tree,i.MST.parentNode=t,t.MST.childNodes.push(i))}));var i=t.filter((e=>null===e.MST.parentNode)),s=e=>(e.MST.treeSize=1,e.MST.childNodes.forEach((t=>{e.MST.treeSize+=s(t)})),e.MST.treeSize);i.forEach((e=>{s(e)})),i.sort(((e,t)=>e.MST.treeSize-t.MST.treeSize));var r=0,a=e=>{e.MST.childNodes.forEach((e=>{e.MST.order=r++})),e.MST.childNodes.forEach((e=>{a(e)}))};i.forEach((e=>{e.MST.order=r++,a(e)}))}isExportable(){return!1}createSummaryFilter(){}applyTemplateSpecial(){}get measureRangeMax(){return this.block.setPairRadius}updateChartScale_Measure(){var e;this.block.isVisible()&&(null===(e=this.block)||void 0===e||e.refreshViz_All())}chartAxis_Measure_TickSkip(){throw new Error("Not applicable.")}isEmpty(){return!1}isFiltered(){return this.setListAttrib.isFiltered()}}class ut extends ve{constructor(e,t){super(e),this.selected_AND=[],this.selected_OR=[],this.selected_NOT=[],this.attrib=t}get title(){return this.attrib.attribName}selectedCount_Total(){return this.selected_AND.length+this.selected_OR.length+this.selected_NOT.length}selected_Any(){return this.selected_AND.length>0||this.selected_OR.length>0||this.selected_NOT.length>0}selected_None(){return 0===this.selected_AND.length&&0===this.selected_OR.length&&0===this.selected_NOT.length}selected_AndOrNot(){return this.selected_AND.concat(this.selected_OR).concat(this.selected_NOT)}selected_All_clear(){this.selected_AND=[],this.selected_OR=[],this.selected_NOT=[]}setRecordCache(e,t){e.setFilterCache(this.filterID,t)}onFilter(){var e="out"===this.noValueAggr.filtered,t="in"===this.noValueAggr.filtered;this.attrib.records.forEach((i=>{var s=i.getValue(this.attrib);if(t)return this.setRecordCache(i,null==s);if(null==s)return e?this.setRecordCache(i,!1):void this.setRecordCache(i,0===this.selected_AND.length&&0===this.selected_OR.length);var r=e=>this.attrib.catTable_id[e];if(this.selected_NOT.length>0&&!s.every((e=>!r(e).filtered_NOT())))return this.setRecordCache(i,!1);if(this.selected_AND.length>0){var a=0;if(s.forEach((e=>{r(e).filtered_AND()&&a++})),a!==this.selected_AND.length)return this.setRecordCache(i,!1)}if(this.selected_OR.length>0)return this.setRecordCache(i,s.some((e=>r(e).filtered_OR())));i.setFilterCache(this.filterID,!0)})),super.onFilter()}filterView_Detail(){if("in"===this.noValueAggr.filtered)return me.NoData;var e="";"out"===this.noValueAggr.filtered&&(e=`(${me.ValidData})`);var t=e=>` <span class='AndOrNot AndOrNot_${e}'>"${me[e]}</span> `;if(this.selectedCount_Total()>4)e=`<b>${this.selectedCount_Total()}</b> selected`;else{var i=0;if(this.selected_OR.length>0){var s=this.selected_AND.length>0||this.selected_NOT.length>0;s&&(e+="["),this.selected_OR.forEach(((s,r)=>{e+=(0!==r||i>0?t("Or"):"")+`<span class='optionName'>${s.label}</span>`,i++})),s&&(e+="]")}this.selected_AND.forEach((s=>{e+=(""!==e?t("And"):"")+`<span class='optionName'>${s.label}</span>`,i++})),this.selected_NOT.forEach((s=>{e+=`${t("Not")}<span class='optionName'>${s.label}</span>`,i++}))}return e}exportFilter(){var e={};return this.noValueAggr.filtered?e.missing=this.noValueAggr.filtered:["AND","OR","NOT"].forEach((t=>{var i=this["selected_"+t];i.length>0&&(e[t]=[],i.forEach((i=>{e[t].push(i.label)})))})),e}importFilter(e){e.missing?(this.noValueAggr.filtered=e.missing,this.setFiltered(!1)):(this.selected_All_clear(),["AND","OR","NOT"].forEach((t=>{if(!e[t])return;e[t].forEach((e=>{var i=this.attrib.catTable_id[e];i&&this.attrib.filterCategory(i,t,"All",!1)}))}))),this.isFiltered&&this.applyFilter()}}const pt={max:d};class mt extends Oe{get block(){return this._block}get measureRangeMax(){return this.block.width_CatBars}applyTemplateSpecial(){"Year"===this.template.special?this.setSortingOption("id"):"Month"===this.template.special?(this.setSortingOption("id"),this.setCatLabel(me.Lookup_Months)):"WeekDay"===this.template.special&&(this.setSortingOption("id"),this.setCatLabel(me.Lookup_DaysOfWeek))}supportsRecordEncoding(e){return!this.isEmpty()&&("text"===e||"textBrief"===e)}constructor(t,i,s){let r;super(t,i,s,"categorical","kshfSummary_Categorical","far fa-font"),this._aggrs=[],this.catTable_id={},this.removedAggrs=[],this.setAttrib=null,this._maxValueDegree=1,this.summaryFilter=null,this.catSortBy="Active",this.catSortInverse=!1,this.pleaseSort=!1,this._dirtySort=!0,this.dblClickTimer=0,this.catGeo=null,this.mapTable=null,this.mapInitView=null,this.catLabel_attr={},this.createSummaryFilter(),this._block=new ot(this),this.barHeight=new xe({parent:this,cfgClass:"barHeight",cfgTitle:"RowHeight",iconClass:"fa fa-arrows-v",UISeperator:{title:"Size",className:"catSummary_ListOnly"},default:ae.defaultBarHeight,helparticle:"5e87d6d004286364bc97d079",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{name:"1x",value:18,max:32},{name:"2x",value:32,max:44},{name:"3x",value:44,max:56},{name:"4x",value:56,max:68},{name:"5x",value:68,max:80},{name:"6x",value:80,max:120},{name:"<i class='fa fa-plus'></i>",value:-100,_type:"plus"}],isActive:e=>e.value&&e.value<=this.barHeight.get()&&e.max>this.barHeight.get(),onDOM:e=>{e.root.classed("catSummary_ListOnly",!0)},preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-1:-100===t&&(t=i._value+1),Math.min(85,Math.max(10,t))})),onSet:()=>{this.block.isView_List?this.block.refreshHeight_Category():this.block.heightRow_category_dirty=!0}}),this.minAggrSize=new xe({parent:this,cfgClass:"minAggrSize",cfgTitle:"Show",iconClass:"fa fa-eye-slash",default:1,itemOptions:[{name:"All",value:1},{name:"More than one",value:10}],UI:{disabled:!0},isActive:e=>e.value?this.minAggrSize.get()>1:1===this.minAggrSize.get(),onDOM:t=>{t.root.select(".minAggrSizeInput").attr("value",this.minAggrSize.get()).attr("max",pt.max(this._aggrs,(e=>e.records.length))).on("input",(t=>{r&&window.clearTimeout(r),r=window.setTimeout((()=>e(this,void 0,void 0,(function*(){yield this.minAggrSize.set(Math.max(2,1*t.currentTarget.value))}))),500)}))},preSet:t=>e(this,void 0,void 0,(function*(){return Math.max(1,t)})),onSet:e=>this.setMinAggrSize(e)}),this.setSortingOption(),this.finishTemplateSpecial()}getAggrWithLabel(e){return this.catTable_id[e]}getAggregate(e){let t=this.catTable_id[e];return t||(t=new lt(this,e),this.catLabel_attr[e]&&(t.label=this.catLabel_attr[e]),this.catTable_id[e]=t,this._aggrs.push(t),this.browser.allAggregates.push(t)),t}initializeAggregates(){if(!this.aggr_initialized){this.catTable_id={},this._aggrs=[],this.removedAggrs=[];var e=0;this.records.forEach((t=>{var i=this.template.func.call(t.data,t);if(Array.isArray(i)||(i=[i]),i=i.map((e=>e&&e.trim?e.trim():e)).filter((e=>null!=e&&""!==e)).map((e=>""+e)),0===(i=new Set(i)).size)return void this.setRecordValueCacheToMissing(t);let s=[];i.forEach((e=>{s.push(e),this.getAggregate(e).addRecord(t)})),t.setValue(this,s),e=Math.max(e,i.size)})),this.maxValueDegree=e,this.aggr_initialized=!0}}setMinAggrSize(e){if(this.aggr_initialized){var t=0;this.removedAggrs=this.removedAggrs.filter((i=>!(i.records.length>=e)||(this._aggrs.push(i),i.usedAggr=!0,t++,!1))),this._aggrs=this._aggrs.filter((t=>t.records.length>=e||(this.removedAggrs.push(t),t.usedAggr=!1,t.isActiveBefore=!1,t.isActive=!1,t.isVisibleBefore=!1,t.isVisible=!1,delete t.orderIndex,t.DOM.aggrGlyph&&(t.DOM.aggrGlyph.remove(),delete t.DOM.aggrGlyph),!1))),this.block.DOM.inited&&(t&&(this.block.insertCategoryGlyphs(),this.block.refreshLabelWidth()),this.block.updateCats_IsActive(),this.block.refreshHeight_Category(),this.block.refreshConfigRowCount(),this.block.updateCatSorting_now())}}get maxValueDegree(){return this._maxValueDegree}get isMultiValued(){return this.maxValueDegree>1}set maxValueDegree(e){var t,i,s=this.maxValueDegree||1;this._maxValueDegree=e,this._maxValueDegree!==s&&(null===(t=this.block.DOM.root)||void 0===t||t.classed("isMultiValued",this.isMultiValued).classed("supportsSetMatrix",this.supportsSetMatrix),null===(i=this.block.DOM.nugget)||void 0===i||i.select(".fa-tags").classed("active",this.isMultiValued))}get supportsSetMatrix(){return this.isMultiValued&&this._aggrs.length>=5}showSetSummary(){this.setAttrib?this.setAttrib.block.refreshPopupSide():(this.setAttrib=new dt(this.browser,this),this.setAttrib.initializeAggregates())}onAggrClick(e,t){this.browser.adjustMode||this.isCatSelectable(t)&&(e&&e.altKey?this.filterCategory(t,"NOT"):e&&e.shiftKey?(this.browser.setSelect_Compare(t,null,!1),this.browser.lockSelect_Compare()):this.dblClickTimer?(this.unselectAllCategories(),this.filterCategory(t,"AND","All")):t.isFiltered()?this.filterCategory(t,"NONE"):this.isMultiValued||this.summaryFilter.selected_None()?this.filterCategory(t,"AND"):(this.summaryFilter.selected_AndOrNot().forEach((e=>e.set_NONE())),this.filterCategory(t,"AND","All")),this.isMultiValued&&(this.dblClickTimer=window.setTimeout((()=>{this.dblClickTimer=null}),500)))}onAggrHighlight(e){var t;this.browser.adjustMode||this.isCatSelectable(e)&&(this.browser.mouseOverCompare.is(!1)||(null===(t=e.DOM.matrixRow)||void 0===t||t.setAttribute("selection","selected"),(this.isMultiValued||0===this.summaryFilter.selected_AND.length)&&(e.filtered_NOT()||(this.isMultiValued||0===this.summaryFilter.selected_AND.length)&&this.browser.setSelect_Compare(e))))}onAggrLeave(e){this.browser.adjustMode||e.locked||(e.unselectAggregate(),this.isCatSelectable(e)&&this.browser.clearSelect_Compare())}createSummaryFilter(){this.summaryFilter=new ut(this.browser,this)}set dirtySort(e){var t;this._dirtySort=e,null===(t=this.block.DOM.catSortButton)||void 0===t||t.classed("resort",e)}get dirtySort(){return this._dirtySort||!1}setSortingOption(e="Active"){this.catSortBy=e}get catOrder_Dynamic(){return"string"==typeof this.catSortBy&&("alphanumeric"!==this.catSortBy&&"id"!==this.catSortBy)}get catOrder_Fixed(){return!this.catOrder_Dynamic}setFixedCatOrder(){var e=this._aggrs.reduce(((e,t)=>(e[t.orderIndex]=t.label,e)),[]);this.setSortingOption(e),this.block.updateCatSorting_now()}_sortCategories(){var e=(e,t)=>e-t,t=(e,t)=>Re.sortFunc_List_String(e,t),i=i=>"string"==typeof i?t:e,s=null,r=null;if("string"==typeof this.catSortBy)if("alphanumeric"===this.catSortBy)r=e=>e.label;else if("id"===this.catSortBy)r=e=>e.id;else{let e=e=>this.browser.getChartValue(e,this.catSortBy);s=(t,i)=>{if(!t.isFiltered()&&i.isFiltered())return 1;if(t.isFiltered()&&!i.isFiltered())return-1;if(!t.usedAggr&&i.usedAggr)return 1;if(t.usedAggr&&!i.usedAggr)return-1;var s=e(i)-e(t);return 0===s&&(s=i.measure("Total")-t.measure("Total")),s}}else if(Array.isArray(this.catSortBy)){var a={};this.catSortBy.forEach(((e,t)=>{a[e]=t+1})),r=e=>a[e.id]||99999}else r=this.catSortBy.valueFunc,this.catSortBy.preSort&&this.catSortBy.preSort.call(this);if(r){let e=e=>r(e);var o=i(e(this._aggrs[0]));s=(t,i)=>o(e(t),e(i))}var l=i(this._aggrs[0].label);this._aggrs.sort(((e,t)=>{var i=s(e,t);return 0===i&&(i=l(e.label,t.label)),this.catSortInverse?-i:i})),this.dirtySort=!1,this.pleaseSort=!1}doSortInverse(){this.dirtySort?this.dirtySort=!1:this.catSortInverse=!this.catSortInverse,this.pleaseSort=!0,this.block.updateCatSorting(0)}getSortMenuOpts(){return{name:"Sorting",items:[{id:"DynamicSort",name:"Active",iconClass:"fal fa-sort-amount-down",active:"Active"===this.catSortBy,helparticle:"5e87dcde04286364bc97d08e",do:(e,t)=>{this.setSortingOption(),this.pleaseSort=!0,this.block.updateCatSorting(0,!0)}},{id:"DynamicSort",name:me.Compared+": "+(this.browser.comparedAttrib?`<span class='comparedSummaryName'>${this.browser.comparedAttrib.attribName}</span>`:""),iconClass:"fal fa-sort-numeric-down",active:"string"==typeof this.catSortBy&&this.catSortBy.startsWith("Compare"),helparticle:"5e87e12704286364bc97d09e",when:e=>e.browser.activeComparisonsCount>0&&(e.attrib!==e.browser.comparedSummary||e.attrib.isMultiValued),do:(e,t)=>{this.setSortingOption(t),this.pleaseSort=!0,this.block.updateCatSorting(0,!0)},options:e=>this.browser.activeComparisons.map((e=>({name:this.browser.selectedAggrs[e].label,iconClass:"colorBox bg_"+e,active:this.catSortBy===e,value:e})))},{id:"AlphaNumSort",name:"Alphabetical",iconClass:"fal fa-sort-alpha-down",active:"alphanumeric"===this.catSortBy,helparticle:"5e87df292c7d3a7e9aea6032",do:()=>{this.setSortingOption("alphanumeric"),this.pleaseSort=!0,this.block.updateCatSorting(0,!0)}},{id:"CustomSort",name:"Custom",active:Array.isArray(this.catSortBy),iconClass:"fal fa-sort-shapes-down",helparticle:"5e87ddbf2c7d3a7e9aea602e",do:()=>{this.setFixedCatOrder()}},{id:"SetMatrixSort",name:"Relatedness",iconClass:"fa fa-th",when:e=>e.setSummary&&e.show_set_matrix,do:()=>{this.setSortingOption({valueFunc:e=>{var t;return-(null===(t=e.MST)||void 0===t?void 0:t.order)},preSort:()=>this.setAttrib.updatePerceptualOrder()}),this.pleaseSort=!0,this.block.updateCatSorting_now()}},{id:"reverseSort",name:"Inverse",iconClass:"fal fa-exchange reverseSortIcon",active:this.catSortInverse,helparticle:"5e87e22904286364bc97d0a9",do:()=>this.doSortInverse()}]}}unselectAllCategories(){var e;this._aggrs.forEach((e=>e.set_NONE())),this.summaryFilter.selected_All_clear(),null===(e=this.block.DOM.noValueAggr)||void 0===e||e.classed("filtered",!1)}filterCategory(e,t,i=null,s=!0){var r;if(e){if(this.browser.skipSortingSummary&&(this.browser.skipSortingSummary.dirtySort=!1),this.browser.skipSortingSummary=this,this.dirtySort=!0,this.summaryFilter.selected_OR.length>0&&(this.summaryFilter.selected_AND.length>0||this.summaryFilter.selected_NOT.length>0)&&(i="All"),"NOT"===t&&e.filtered_NOT()&&(t="NONE"),"AND"===t&&e.filtered_AND()&&(t="NONE"),"OR"===t&&e.filtered_OR()&&(t="NONE"),"NONE"===t)(e.filtered_AND()||e.filtered_NOT())&&(i=null!=i?i:"MoreResults"),e.filtered_OR()&&(i=(null!=i?i:0===this.summaryFilter.selected_OR.length)?"MoreResults":"LessResults"),e.set_NONE(),1===this.summaryFilter.selected_OR.length&&0===this.summaryFilter.selected_AND.length&&this.summaryFilter.selected_OR.forEach((e=>{e.set_NONE(),e.set_AND(this.summaryFilter.selected_AND)})),this.summaryFilter.selected_Any()||(this.dirtySort=!1);else if("NOT"===t){if(e.isFiltered())i=null!=i?i:"All";else{if(e.recCnt("Active")===this.browser.allRecordsAggr.recCnt("Active"))return void ye.alert(me.DialogEmptyResultSet);i=null!=i?i:"LessResults"}e.set_NOT(this.summaryFilter.selected_NOT)}else if("AND"===t)i=e.filtered_NOT()||e.filtered_OR()?null!=i?i:"All":null!=i?i:"LessResults",e.set_AND(this.summaryFilter.selected_AND);else if("OR"===t){if(!this.isMultiValued&&this.summaryFilter.selected_NOT.length>0){var a=[];this.summaryFilter.selected_NOT.forEach((e=>a.push(e))),a.forEach((e=>e.set_NONE()))}0===this.summaryFilter.selected_OR.length&&1===this.summaryFilter.selected_AND.length&&this.summaryFilter.selected_AND.forEach((e=>{e.set_NONE(),e.set_OR(this.summaryFilter.selected_OR)})),e.set_OR(this.summaryFilter.selected_OR),i=null!=i?i:"MoreResults"}this.summaryFilter.selected_OR.length>0&&(this.summaryFilter.selected_AND.length>0||this.summaryFilter.selected_NOT.length>0)&&(i="All"),"in"===this.noValueAggr.filtered&&(i="All"),this.summaryFilter.how=i,0!==this.summaryFilter.selectedCount_Total()?(this.block.clearCatTextSearch(),"in"===this.noValueAggr.filtered&&(this.noValueAggr.filtered=!1),null===(r=this.block.DOM.root)||void 0===r||r.classed("hasMultiAnd",this.summaryFilter.selected_AND.length>1),this.summaryFilter.setFiltered(s)):this.summaryFilter.clearFilter()}}isCatSelectable(e){return!!e.isFiltered()||(0!==e.recCnt("Active")||!(!this.isFiltered()||this.isMultiValued))}autoCompare(){var e=()=>{var e=0;ae.Compare_List.forEach((t=>{if(!this.browser.vizActive(t)){for(var i;;){if(!(i=this._aggrs[e]))return;if(!i.locked&&i.Active.measure>0)break;e++}this.browser.setSelect_Compare(i,t,!1),this.browser.lockSelect_Compare(!1)}})),this.browser.refreshConfigs()};this.browser.comparedAttrib&&!this.isComparedAttrib()?ye.confirm(me.DialogChangeCompare(this.attribNameHTML,this.browser.comparedAttrib.attribNameHTML),me.Confirm).then((()=>{this.browser.clearSelect_Compare(this.browser.activeComparisons,!1,!0),e()}),(()=>{})):e()}loadMap(){return e(this,void 0,void 0,(function*(){if(!this.mapTable){if(this.mapTable=ae.maps.get(this.catGeo),!this.mapTable)throw new Error(me.Error_CannotFindMap(this.catGeo));if(yield this.mapTable.loadGeo(),this.catMap_storeCatGeo(),this._aggrs.length>0&&this._aggrs.every((e=>!e._geo_)))throw this.removeCatGeo(),new Error(me.Error_CannotMatchMap(this.catGeo))}}))}hasMap(){return null!==this.catGeo}catMap_storeCatGeo(){this._aggrs.forEach((e=>{e._geo_=this.mapTable.getFeature(e.id.toUpperCase())||this.mapTable.getFeature(e.label.toUpperCase()),e._geo_&&"object"==typeof e._geo_&&void 0!==typeof e._geo_.type||(e._geo_=null)}))}setCatGeo(e){var t;this.catGeo=e,null===(t=this.block.DOM.root)||void 0===t||t.attr("hasMap",!0)}removeCatGeo(){this.catGeo=null,this._aggrs.forEach((e=>{e._geo_=null})),this.block.removeCatGeo(),this.mapTable=null}uniqueCategories(){return!this.isEmpty()&&this._aggrs.length===this.browser.records.length&&!this.isMultiValued}setCatGeo_(t){return e(this,void 0,void 0,(function*(){this.uniqueCategories()?(this.browser.recordDisplay.setAttrib("geo",this.browser.createAttrib("_REGION",t.replace("[*]","[*."+this.template+"]").replace("[UPPERCASE(*)]","[UPPERCASE(*."+this.template+")]"),"recordGeo")),this.browser.recordChartType.is("none")&&(yield this.browser.recordChartType.set("map")),this.browser.refreshAttribList()):(this.setCatGeo(t),this.block.catViewAs("map"))}))}setCatLabel(e={}){var t,i;this.catLabel_attr=e,this._aggrs.forEach((e=>{e.label=this.catLabel_attr[e.id]||""})),null===(i=null===(t=this.block)||void 0===t?void 0:t.DOM.catLabel)||void 0===i||i.html((e=>e.label))}getRecordValue(e){var t=e.getValue(this);return null==t?t:t.map((e=>this.catLabel_attr[e]||e))}getFormattedValue(e,t){return this.renderRecordValue(e)}renderRecordValue(e,t=null){e instanceof Ie&&(e=this.getRecordValue(e));var i=e=>{var t=e.href;return"http:"===e.protocol||"https:"===e.protocol?/\.(gif|jpg|jpeg|tiff|png|svg)$/i.test(e.pathname)?`<img src='${t}' class='autoDetectedImg'>`:`<a class='linkInData' href='${t}' rel='noopener noreferrer' target='_blank'>" ${t}</a>`:t},s=e=>{if(!t)return e;t.html(e)},r=e.map((e=>this.catTable_id[e]?this.catTable_id[e].label:null==e?"-":e+"")).map((e=>{try{var t=new URL(e);if("gs:"===t.protocol&&window.firebase)return window.firebase.storage().refFromURL(t.href).getDownloadURL().then((t=>{var r=new URL(t);return this.catTable_id[e]&&(this.catTable_id[e].label=r.href),s(i(r))}));e=i(t)}catch(e){}finally{return e}})).join("<br>");return s(r)}applyConfig(t){const i=Object.create(null,{applyConfig:{get:()=>super.applyConfig}});return e(this,void 0,void 0,(function*(){i.applyConfig.call(this,t),t.mapInitView&&(this.mapInitView=t.mapInitView),t.mapConfig&&(this.mapConfig=t.mapConfig),yield this.measureScaleType.set(t.measureScaleType),yield this.barHeight.set(t.barHeight),yield this.minAggrSize.set(t.minAggrSize),t.catLabel&&this.setCatLabel(t.catLabel),t.catGeo&&this.setCatGeo(t.catGeo),t.invertedColorTheme&&this.block.catMap_invertColorTheme(t.invertedColorTheme),!1===t.splitOnSelfCompare&&(this.block.splitOnSelfCompare=!1),["SingleSelect","MultiSelect"].includes(t.dropdown_type)&&(this.block.dropdown_type=t.dropdown_type),t.filter?this.summaryFilter.importFilter(t.filter):this.isFiltered()&&this.summaryFilter.clearFilter(),t.catSortInverse&&(this.catSortInverse=!0),t.catSortBy&&this.setSortingOption(t.catSortBy),t.viewAs&&this.block.catViewAs(t.viewAs),t.showSetMatrix&&this.block.showSetMatrix(t.showSetMatrix)}))}exportConfig(){var e=super.exportConfig(),t={viewAs:this.block.viewType,catGeo:this.catGeo,catLabel:this.catLabel_attr,catSortBy:this.catSortBy,catSortInverse:this.catSortInverse,invertedColorTheme:this.block.invertedColorTheme,barHeight:this.barHeight.exportValue(),splitOnSelfCompare:this.block.splitOnSelfCompare,dropdown_type:this.block.isView_Dropdown?this.block.dropdown_type:void 0,filter:this.summaryFilter.exportFilter()};return Object.assign({},e,t)}}const gt={select:a,easePoly:C};class vt{get browser(){return this.rd.browser}get textAttrib(){return this.rd.codeBy.text}get textBriefAttrib(){return this.rd.codeBy.textBrief||this.rd.codeBy.text}get sortAttrib(){return this.rd.codeBy.sort}get scatterXAttrib(){return this.rd.codeBy.scatterX}get scatterYAttrib(){return this.rd.codeBy.scatterY}get colorAttrib(){return this.rd.codeBy.color}get sizeAttrib(){return this.rd.codeBy.size}get geoAttrib(){return this.rd.codeBy.geo}get DOM(){return this.rd.DOM}constructor(e){this.initialized=!1,this.animStepDelayMs=1e3,this.rd=e}refreshRecordSizes(){}refreshRecordColors(){}refreshLabelOverlaps(){}refreshAttribScaleType(t){return e(this,void 0,void 0,(function*(){}))}onRecordMouseOver(e){}onRecordMouseLeave(e){}refreshQueryBox_Filter(e){}zoomIn(){}zoomOut(){}zoomToFit(){}updateRecordVisibility(){}getRecordsForDOM(){return this.browser.records}isComparable(){var e;return 0!==this.browser.activeComparisonsCount&&(!!this.browser.comparedAttrib&&(!!this.DOM.kshfRecords&&("map"!==this.rd.viewRecAs||"Point"===(null===(e=this.rd.codeBy.geo)||void 0===e?void 0:e.geoType))))}stepTimeAnimation(e){if(null==this.rd.currentTimeKey.get())return!1;["sort","scatter","color","size"].some((t=>{var i=this.rd.codeBy[t];if(!i)return!1;if(!(i instanceof Ye))return!1;if(!i.hasTimeSeriesParent())return!1;var s=i.timeseriesParent;return this.rd.timeseriesAnimInterval=window.setInterval((()=>{let t=s.getTimepointSummary_Next(i,e);null===i?this.rd.stopTimeseriesAnimation():(this.rd.currentTimeKey.set(i.timeKey),i=t)}),this.animStepDelayMs),!0}))}stopTimeAnimation(){}refreshSelect_Compare(e=null,t=!1){if(!this.isComparable())return;if(!this.rd.recordDrawArc)return;var i=i=>!!i.isIncluded&&(!!i.DOM.record&&((!e||i.isSelected(e)===t)&&!("map"===this.rd.viewRecAs&&!this.rd.codeBy.geo.getRecordValue(i))));let s=(e,t,i)=>{e.select(".glyph_"+t).transition().ease(gt.easePoly.exponent(3)).duration(700).attr("d",i)};this.browser.isComparedSummaryMultiValued()?this.DOM.kshfRecords.each((e=>{if(i(e)){var t=e.activeComparisons.length;if(0!==t){var r=this.rd.recordDrawArc(e),a=2*Math.PI/t,o=gt.select(e.DOM.record);e.activeComparisons.forEach(((e,t)=>{r.startAngle(a*t).endAngle(a*(t+1)),s(o,e,r())}))}}})):this.DOM.kshfRecords.each((e=>{if(i(e)){var t=gt.select(e.DOM.record);e.activeComparisons.forEach((e=>s(t,e,(e=>this.rd.recordDrawArc(e)()))))}})),this.rd.refreshCompareLegend()}extendRecordDOM_Point(e){e.classed("pointGeo",!0),["Main"].concat(ae.Compare_List).forEach((t=>e.append("path").attr("class","glyph_"+t))),e.append("text").attr("class","sizeValueText"),e.selectAll("path").attr("d",Re.getCirclePath())}insertQueryBoxes(e,t,i,s){var r=e.selectAll(".spatialQueryBox").data(["Filter"].concat(ae.Compare_List)).enter().append("div").attr("class",(e=>`spatialQueryBox spatialQueryBox_${e} leaflet-zoom-hide`));r.selectAll(".setSize").data(["l","r","t","b"]).enter().append("div").attr("class",(e=>"setSize-"+e)).on("mousedown",t),r.append("div").attr("class","dragSelection fa fa-arrows").tooltip("Drag").on("mousedown",i),r.append("div").attr("class","clearFilterButton fa").tooltip((e=>me["Filter"===e?"RemoveFilter":"Unlock"])).on("mouseup",(e=>{e.stopPropagation(),e.preventDefault()})).on("mousedown",(e=>{e.stopPropagation(),e.preventDefault()})).on("click",s)}}const ft={select:a,selection:i,pointer:_,min:c,max:d,extent:l,line:f,curveMonotoneX:b,curveLinear:P,scaleLinear:n,easePoly:C,schemeCategory10:N,format:m};class bt{constructor(){this.clear()}clear(){this.usedList=[]}isEmpty(e){return!this.isUsed(e)}isUsed(e){return this.usedList.some((t=>e<t._max&&e>t._min))}intersectsWith(e){return this.usedList.find((t=>e<t._max&&e>t._min))}insertUsed(e,t,i){this.usedList.push({_min:e-t,_max:e+t,_entity:i})}}function _t(){[].slice.call(document.querySelectorAll("[data-tippy-root]")).forEach((function(e){var t=e._tippy;t&&(t.hide(),t.reference.classList.remove("visible"))}))}class yt extends vt{get timeseriesAttrib(){return this.rd.codeBy.timeSeries}prepareAttribs(){return e(this,void 0,void 0,(function*(){return this.timeseriesAttrib||(yield this.rd.setAttrib("timeSeries",this.rd.config.timeSeriesBy||0)),Promise.resolve(!0)}))}constructor(t,i){super(t),this.timeKeys_Active=[],this.scale_Value=null,this.scale_Time=null,this.scale_Time_prev=null,this.timeseriesRange_noUpdate=!1,this.marginLeft=85,this.wideTimeScale=!1,this.ts_Type=new xe({cfgClass:"ts_Type",cfgTitle:"Timeseries Plot",iconClass:"far fa-chart-line",default:"Value",parent:this,helparticle:"5eaf64de042863474d1a0efc",tooltip:"Timeseries plot chart type",itemOptions:[{name:"# Value",value:"Value"},{name:"⩔ Rank",value:"Rank"},{name:"#-Change",value:"ChangeAbs"},{name:"%-Change",value:"ChangePct"}],preSet:t=>e(this,void 0,void 0,(function*(){return"Change"===t?"ChangePct":t})),onSet:()=>this.refreshTimeSeriesPlotType()}),this.timeSeriesChangeVsTimeKey=new xe({parent:this,cfgClass:"ts_ChangeVsTimeKey",cfgTitle:"Change vs.",iconClass:"far fa-calendar",default:null,helparticle:"5e87f81e2c7d3a7e9aea60a4",onDOM:t=>{var i=t.root.select(".configItem_Options");t.keySelect=i.append("select").attr("class","keySelect").on("change",(t=>e(this,void 0,void 0,(function*(){yield this.timeSeriesChangeVsTimeKey.set(t.currentTarget.selectedOptions[0].__data__._time_src)}))))},onRefreshDOM:e=>{e.get()&&(e.DOM.root.classed("hidden",!this.isTimeseriesChange()),e.DOM.keySelect.selectAll("option").data(this.timeKeys_Active||[],(e=>e._time_src)).join((e=>e.append("option").text((e=>e._time_src))),(e=>e),(e=>e.remove())).attr("selected",(t=>t._time_src===e.get()._time_src||null)))},preSet:(t,i)=>e(this,void 0,void 0,(function*(){if(this.timeseriesAttrib)return"string"==typeof t&&(t=this.timeseriesAttrib.timeKeys.find((e=>e._time_src===t))),t||this.timeseriesAttrib.timeKeys[0]})),onSet:(e,t)=>{this.refreshScaleValue(),this.refreshKeyLine()}}),this.ts_timeKeysStep=new xe({parent:this,cfgClass:"ts_timeKeysStep",cfgTitle:"Time Keys",iconClass:"far fa-calendar",UISeperator:{title:"Axis",className:"ts_only"},default:"all",helparticle:"5e891b8504286364bc97d544",itemOptions:[{name:"All",value:"all"},{name:"1st &amp; Last (Slope)",value:"limits"}],forcedValue:()=>{if(this.timeseriesAttrib)return this.timeseriesAttrib.timeKeys.length<3?"limits":void 0},onSet:()=>this.refreshTimeRange()}),this.ts_valueAxisScale=new xe({cfgClass:"ts_valueAxisScale",cfgTitle:"Value Axis Scale",iconClass:"fa fa-arrows-v",default:i.ts_valueAxisScale||"linear",parent:this,helparticle:"5f137b5304286306f8070db3",itemOptions:[{name:me.Linear+" "+me.LinearSequence,value:"linear"},{name:me.Log+" "+me.Log10Sequence,value:"log"}],noExport:!0,forcedValue:()=>"Value"!==this.ts_Type.get()||this.timeseriesAttrib&&!this.timeseriesAttrib.supportsLogScale()?"linear":void 0,onSet:t=>e(this,void 0,void 0,(function*(){this.timeseriesAttrib&&(yield this.timeseriesAttrib.valueScaleType.set(t))}))}),this.fitValueAxis=new xe({cfgClass:"fitValueAxis",cfgTitle:"Fit Value Axis",iconClass:"fa fa-arrows-v",default:!1,parent:this,helparticle:"5e891b992c7d3a7e9aea64fb",itemOptions:[{name:"Static",value:!1},{name:"Dynamic",value:!0}],forcedValue:()=>!!this.browser.isFiltered()&&(!this.ts_Type.is("Rank")&&(!!this.isTimeseriesChange()||void 0)),onSet:()=>{this.refreshScaleValue()}}),this.timeSeriesSelectMode=new xe({cfgClass:"timeSeriesSelectMode",cfgTitle:"Mouse Select",iconClass:"fa fa-hand-pointer",UISeperator:{title:"Control",className:"ts_only"},default:"record",parent:this,helparticle:"5e88c11004286364bc97d3c0",itemOptions:[{name:"Nearest Record",value:"record"},{name:"Nearest Time-Key",value:"time"}],onSet:e=>{}}),["ts_Type","timeSeriesChangeVsTimeKey","timeSeriesSelectMode","ts_timeKeysStep","fitValueAxis","ts_valueAxisScale"].forEach((e=>{this[e].val=i[e],this.rd.configs[e]=this[e],this.rd.recordConfigPanel.insertConfigUI(this[e])}));var s=this;this.timeRange={_src:{},get min(){return this.val("min")},get max(){return this.val("max")},set min(e){this._src.min=e?e._time_src:null},set max(e){this._src.max=e?e._time_src:null},val:function(e){var t=this._src[e];return t&&s.timeseriesAttrib&&s.timeseriesAttrib.timeKeys?s.timeseriesAttrib.timeKeys.find((e=>e._time_src===t)):null},minActive(){return this.min._index>0},maxActive(){return this.max._index<s.timeseriesAttrib.timeKeys.length-1},isActive(e){return"min"===e?this.minActive():"max"===e?this.maxActive():this.minActive()||this.maxActive()},exportConfig(){var e={};return this._src.min&&(e.min=this._src.min),this._src.max&&(e.max=this._src.max),e},importConfig(e){e&&["min","max"].forEach((t=>{e[t]&&(this._src[t]=e[t])}))}},this.timeRange.importConfig(i.timeRange)}initView(){this.recordInView=e=>{var t=this.timeseriesAttrib.getRecordValue(e);if(!t||t.isEmpty())return!1;if(this.isTimeseriesChange()){var i=this.timeSeriesChangeVsTimeKey.get()._time_src,s=t._keyIndex[i];return null!=s&&null!=s._value}return!0},this.refreshTimeSeriesPlotType(),this.refreshScaleTime(),this.rd.refreshRecordDOM(),this.rd.refreshRecordVis(),this.refreshTimeseriesTicks(),this.refreshTicks_AxisY(),this.updateDotVisibility(),this.refreshFilterRanges()}initView_DOM(){return e(this,void 0,void 0,(function*(){if(this.DOM.recordBase_Timeseries)return this.DOM.recordGroup=this.DOM.recordBase_Timeseries.select(".recordGroup"),void(this.DOM.kshfRecords=this.DOM.recordGroup.selectAll(".kshfRecord"));var e=this;let i=null,r=null;var a=ft.format("+.2");var o=new bt,l=new bt;function n(i,r,o="right"){i.DOM&&(i.DOM.tippy=s(i.DOM,Object.assign({},ft.selection.tippyDefaultConfig,{theme:"dark kshf-tooltip kshf-record",placement:o,animation:"fade",trigger:"manual",delay:0,duration:[500,100],appendTo:ae.browser.DOM.root.node()})),function(i){var s,r,o,l=i.DOM.parentNode.__data__,n=e.textBriefAttrib.getRecordValue(l)||"",h=e.timeseriesAttrib.getFormattedValue(i._value),c=e.ts_Type.is("Rank")?` <span class='extraInfo'>(#${i._rank})</span>`:"",d="";if(e.isTimeseriesChange()){var u=e.timeSeriesChangeVsTimeKey.get()._time_src,p=null===(r=null===(s=e.timeseriesAttrib.getRecordValue(l))||void 0===s?void 0:s._keyIndex[u])||void 0===r?void 0:r._value,m=a(100*(i._value-p)/(p||1))+"%";e.ts_Type.is("ChangeAbs")&&(m=e.timeseriesAttrib.getFormattedValue(i._value-p)),d=` <span class='extraInfo'>(${m} vs. ${u})</span>`}var g=h+c+d;o=e.timeSeriesSelectMode.is("time")?`<span class='asdsdadsada'>${n}: <b>${g}</b></span>`:`<span class='mapItemName'>${n}</span><div class='recordColorInfo'><div class='mapTooltipLabel'><b>${e.timeseriesAttrib.attribName}</b> <i class='fal fa-calendar'></i> ${i._time_src}</div><br><span class='mapTooltipValue'>${g}</span></div>`,i.DOM.tippy.popper.children[0].children[0].innerHTML=t.sanitize(o)}(i),i.DOM.tippy.show())}this.DOM.recordBase_Timeseries=this.DOM.recordDisplayWrapper.append("div").attr("class","recordBase_Timeseries"),this.refreshTimeSeriesChartWidth(),["Y","X"].forEach((e=>{var t=this.DOM.recordBase_Timeseries.append("div").attr("class","recordAxis recordAxis_"+e);t.append("div").attr("class","tickGroup"),t.append("div").attr("class","keyLine").style("display",this.isTimeseriesChange()?"block":null)})),["min","max"].forEach((e=>{var t=this.DOM.recordBase_Timeseries.append("span").attr("class","timeLimit timeLimit-"+e);t.append("select").on("change",(t=>{this.setTimeRange({[e]:t.currentTarget.selectedOptions[0].__data__._index})})),t.append("span").attr("class","min"===e?"far fa-angle-double-right":"far fa-angle-double-left")})),this.refreshTimeSeriesRangeOpts(),this.DOM.recordGroup=this.DOM.recordBase_Timeseries.append("svg").attr("class","recordGroup recordGroup_Timeseries").attr("xmlns","http://www.w3.org/2000/svg").on("click",(()=>{"filter"!==this.rd.visMouseMode&&(i&&(_t(),this.browser.recordDetailsPopup.updateRecordDetailPanel(i),this.browser.recordDetailsPopup.updateFocusedTimeKey(r)),this.rd.setDimmed(!1))})).on("mouseleave",(()=>{"filter"!==this.rd.visMouseMode&&(this.timeSeriesSelectMode.is("time")&&(_t(),this.browser.records.forEach((e=>{var t,i,s;e.filteredOut||r&&(null===(s=null===(i=null===(t=this.timeseriesAttrib.getRecordValue(e))||void 0===t?void 0:t._keyIndex[r._time_src])||void 0===i?void 0:i.DOM)||void 0===s||s.classList.remove("visible"))})),r=null),this.rd.onRecordMouseLeave(i),i=null)})).on("mousemove",(e=>{var t,s,a;if("filter"!==this.rd.visMouseMode){var h=ft.pointer(e);if(h[1]>e.currentTarget.offsetHeight||h[1]<0)return this.timeSeriesSelectMode.is("record")&&(this.rd.onRecordMouseLeave(i),i=null),void(this.timeSeriesSelectMode.is("time")&&r&&(_t(),this.browser.records.forEach((e=>{var t,i,s;e.filteredOut||r&&(null===(s=null===(i=null===(t=this.timeseriesAttrib.getRecordValue(e))||void 0===t?void 0:t._keyIndex[r._time_src])||void 0===i?void 0:i.DOM)||void 0===s||s.classList.remove("visible"))}))));var c=this.scale_Time.invert(h[0]),d=(null===(t=this.timeSeriesChangeVsTimeKey.get())||void 0===t?void 0:t._time_src)||null,u=null;if(c.getTime()<=this.scale_Time.domain()[1].getTime()&&c.getTime()>=this.scale_Time.domain()[0].getTime()){var p=999999999999999;this.timeKeys_Active.every((e=>{var t=Math.abs(e._time.getTime()-c.getTime());return t<p&&(u=e,p=t,!0)}))}if(this.timeSeriesSelectMode.is("time")){if(u===r)return;return r&&(_t(),this.browser.records.forEach((e=>{var t,i,s;e.filteredOut||null===(s=null===(i=null===(t=this.timeseriesAttrib.getRecordValue(e))||void 0===t?void 0:t._keyIndex[r._time_src])||void 0===i?void 0:i.DOM)||void 0===s||s.classList.remove("visible")}))),u&&(l.clear(),o.clear(),this.browser.records.forEach((e=>{var t,i;if(this.recordInView(e)&&!e.filteredOut){var s=null===(t=this.timeseriesAttrib.getRecordValue(e))||void 0===t?void 0:t._keyIndex[u._time_src];if(s){var r;s.DOM.classList.add("visible");var a=this.isTimeseriesChange()?null===(i=this.timeseriesAttrib.getRecordValue(e))||void 0===i?void 0:i._keyIndex[d]._value:0,h=this.y_Generator(s,a);if(l.isEmpty(h))r="right",l.insertUsed(h,30,e);else{if(!o.isEmpty(h))return;r="left",o.insertUsed(h,30,e)}n(s,0,r)}}}))),void(r=u)}var m=null;if(!u)return this.rd.onRecordMouseLeave(i),void(i=null);var g=999999999999999;if(this.browser.records.forEach((e=>{var t,i;if(this.recordInView(e)&&!e.filteredOut){var s=null===(t=this.timeseriesAttrib.getRecordValue(e))||void 0===t?void 0:t._keyIndex[u._time_src];if(s){var r=this.isTimeseriesChange()?null===(i=this.timeseriesAttrib.getRecordValue(e))||void 0===i?void 0:i._keyIndex[d]._value:0,a=this.y_Generator(s,r),o=Math.abs(a-h[1]);o<50&&o<g&&(m=e,g=o)}}})),i!==m){if(this.rd.onRecordMouseLeave(i),i=null,m)this.rd.onRecordMouseOver(m),(v=null===(s=this.timeseriesAttrib.getRecordValue(m))||void 0===s?void 0:s._keyIndex[u._time_src])&&n(v);i=m}else if(m){var v;if(r!==u)_t(),(v=null===(a=this.timeseriesAttrib.getRecordValue(m))||void 0===a?void 0:a._keyIndex[u._time_src])&&n(v)}r=u,this.rd.setDimmed(!!i)}})),this.DOM.recordLineClippath=this.DOM.recordGroup.append("clipPath").attr("id","recordLineClippath").append("rect").attr("x",0).attr("y",0).attr("height",4e3),this.DOM.ts_annotations=this.DOM.recordBase_Timeseries.append("span").attr("class","ts_annotations"),this.DOM.recordBase_Timeseries.append("div").attr("class","TimeseriesColorInfo").html(me["Line colors are random"]),this.DOM.timeSeriesControlGroup=this.DOM.recordBase_Timeseries.append("div").attr("class","timeSeriesControlGroup attribControlGroup"),this.rd.initDOM_AttribSelect("timeSeries"),this.DOM.timeAnimationClearRange.on("click",(()=>this.setTimeRange({min:0,max:1e4}))),u.create(this.DOM.timeseriesRange.node(),{start:[50,50],connect:!0,step:1,behaviour:"tap-drag",margin:1,range:{min:0,max:100}}),this.timeseriesRange=this.DOM.timeseriesRange.node().noUiSlider;this.timeseriesRange.on("set",((e,t,i)=>{this.timeseriesRange_noUpdate||(i=i.map((e=>Math.round(e))),this.timeseriesRange_noUpdate=!0,this.setTimeRange({min:i[0],max:i[1]}),delete this.timeseriesRange_noUpdate)}))}))}isTimeseriesChange(){return this.ts_Type.is("ChangePct")||this.ts_Type.is("ChangeAbs")}extendRecordDOM(e){e.append("path"),e.append("g").attr("class","dotGroup"),e.append("foreignObject").attr("width","120").attr("height","1").call((e=>{e.append("xhtml:div").attr("xmlns","http://www.w3.org/1999/xhtml").attr("class","recordText_side").html((e=>{var t;return null===(t=this.textBriefAttrib)||void 0===t?void 0:t.renderRecordValue(e)})),e.append("xhtml:div").attr("xmlns","http://www.w3.org/1999/xhtml").attr("class","recordText_Dot")}))}setTimeRange({min:e=-1,max:t=-1}={}){e>=0&&(this.timeRange.min=this.timeseriesAttrib.timeKeys[e]),t>=0&&(t=Math.min(t,this.timeseriesAttrib.timeKeys.length-1),this.timeRange.max=this.timeseriesAttrib.timeKeys[t]),this.refreshTimeRange()}refreshTimeRange(){var e,t;this.refreshScaleTime(),this.refreshTimeseriesTicks(),this.timeRange.min._time>(null===(e=this.timeSeriesChangeVsTimeKey.get())||void 0===e?void 0:e._time)?(this.timeSeriesChangeVsTimeKey.set(this.timeRange.min),this.refreshTimeSeriesRangeOpts()):this.timeRange.max._time<(null===(t=this.timeSeriesChangeVsTimeKey.get())||void 0===t?void 0:t._time)?(this.timeSeriesChangeVsTimeKey.set(this.timeRange.max),this.refreshTimeSeriesRangeOpts()):this.refreshScaleValue()}refreshTimeSeriesRangeOpts(){["min","max"].forEach((e=>{this.DOM.root.select(".timeLimit-"+e).classed("filtered",this.timeRange.isActive(e)),this.DOM.root.select(".timeLimit-"+e+" > select").selectAll("option").data(this.timeseriesAttrib.timeKeys.filter("min"===e?e=>e._time<this.timeRange.max._time:e=>e._time>this.timeRange.min._time),(e=>e._time_src)).join((e=>e.append("option").text((e=>e._time_src))),(e=>e),(e=>e.remove())).attr("selected",(t=>t._time_src===this.timeRange[e]._time_src||null))}))}refreshAttribScaleType(t){return e(this,void 0,void 0,(function*(){t instanceof rt&&this.timeseriesAttrib===t&&(yield this.ts_valueAxisScale.set(t.valueScaleType.get()),this.ts_Type.is("Value")&&this.refreshScaleValue())}))}finishSetAttrib(t){return e(this,void 0,void 0,(function*(){"textBrief"===t?this.DOM.kshfRecords.selectAll("foreignObject > .recordText_side").html((e=>this.textBriefAttrib.renderRecordValue(e))):"timeSeries"===t&&(this.scale_Time=this.timeseriesAttrib.timeSeriesScale_Time.copy(),this.timeRange.min&&this.timeseriesAttrib.timeKeys.some((e=>e._time_src===this.timeRange.min._time_src))&&this.timeRange.max&&this.timeseriesAttrib.timeKeys.some((e=>e._time_src===this.timeRange.max._time_src))||this.setTimeRange({min:0,max:1e4}),yield this.ts_valueAxisScale.set(this.timeseriesAttrib.valueScaleType.get()),this.ts_Type.is("Rank")&&this.timeseriesAttrib.computeRecordRanks(),this.timeSeriesChangeVsTimeKey.get()||(yield this.timeSeriesChangeVsTimeKey.set(this.rd.config.timeSeriesChangeVsTimeKey)),this.refreshScaleTime(),this.refreshScaleValue(),this.refreshFilterRanges())}))}refreshViewSize(e=0){this.refreshScaleTime(),this.refreshRecordVis(),this.refreshTimeseriesTicks(),this.refreshTicks_AxisY(),this.updateDotVisibility()}refreshScaleTime(){if(this.timeseriesAttrib&&this.timeseriesRange){this.scale_Time_prev=this.scale_Time.copy(),this.scale_Time.domain([this.timeRange.min._time,this.timeRange.max._time]);var e=this.timeseriesAttrib.timeKeys;this.timeKeys_Active=e.filter((e=>e._time>=this.timeRange.min._time&&e._time<=this.timeRange.max._time)),this.ts_timeKeysStep.is("limits")&&(this.timeKeys_Active=[this.timeKeys_Active[0],this.timeKeys_Active[this.timeKeys_Active.length-1]],this.isTimeseriesChange()&&this.timeKeys_Active.splice(1,0,this.timeSeriesChangeVsTimeKey.get())),this.timeSeriesChangeVsTimeKey.refresh(),this.marginLeft=85,this.chartWidth=this.rd.curWidth-this.marginTotal,this.expandMargin(),this.scale_Time.range([0,this.chartWidth]),this.scale_Time_prev||(this.scale_Time_prev=this.scale_Time.copy()),this.refreshTimeSeriesChartWidth(),this.refreshTimeSeriesRangeOpts(),this.timeseriesRange_noUpdate=!0,this.timeseriesRange.updateOptions({range:{min:0,max:e.length-1}}),delete this.timeseriesRange_noUpdate,this.timeseriesRange.setHandle(0,this.timeRange.min._index,!1),this.timeseriesRange.setHandle(1,this.timeRange.max._index,!1),this.DOM.timeAnimation.select(".rangeTick-min").html(e[0]._time_src),this.DOM.timeAnimation.select(".rangeTick-max").html(e[e.length-1]._time_src),this.DOM.timeAnimation.select(".clearRange").classed("active",this.timeRange.isActive()),this.addAnnotations()}}refreshScaleValue(){if(this.ts_Type&&this.timeseriesAttrib){if(this.ts_Type.is("Rank")){var e=this.scale_Time.domain(),t=e=>!0;e&&(t=t=>t._time>=e[0]&&t._time<=e[1]);var i=this.browser.records.reduce(((e,i)=>{if(i.filteredOut)return e;var s=this.timeseriesAttrib.getRecordValue(i);return s?0===s._timeseries_.filter(t).length?e:e+1:e}),0);this.scale_Value=ft.scaleLinear().domain([i,1])}if(this.ts_Type.is("Value")){this.scale_Value=this.timeseriesAttrib.timeSeriesScale_Value.copy().nice();var s=this.timeseriesAttrib.getExtent_Value(this.fitValueAxis.get(),this.scale_Time.domain()),r=this.scale_Value.domain();r[0]>r[1]&&(s=[s[1],s[0]]),this.scale_Value.domain(s)}if(this.isTimeseriesChange()){this.timeSeriesChangeVsTimeKey.get()||this.timeSeriesChangeVsTimeKey.set(this.timeKeys_Active[0]);var a,o=this.timeSeriesChangeVsTimeKey.get()._time_src;e=this.scale_Time.domain(),t=t=>t._time>=e[0]&&t._time<=e[1];this.ts_Type.is("ChangeAbs")?a=(e,t)=>e._value-t:this.ts_Type.is("ChangePct")&&(a=(e,t)=>(e._value-t)/t*100);var l=this.browser.records.map((e=>{if(!this.recordInView(e)||e.filteredOut)return[0,0];var i=this.timeseriesAttrib.getRecordValue(e),s=i._keyIndex[o]._value;return s?ft.extent(i._timeseries_,(e=>t(e)?a(e,s):null)):[0,0]}));this.scale_Value=ft.scaleLinear().domain([ft.min(l,(e=>e[0])),ft.max(l,(e=>e[1]))]).nice()}this.refreshRecordVis(),this.refreshTicks_AxisY(),this.refreshFilterRanges()}}refreshYGenerator(){this.y_Generator={Value:e=>this.scale_Value(e._value),ChangePct:(e,t)=>this.scale_Value(t?100*(e._value-t)/t:0),ChangeAbs:(e,t)=>this.scale_Value(e._value-t),Rank:e=>this.scale_Value(e._rank)}[this.ts_Type.get()]}refreshTicks_AxisY(){var e=Math.abs(this.scale_Value.range()[1]-this.scale_Value.range()[0]),t=Math.floor(e/40),i=this.scale_Value.copy();i.base&&i.base(10);var s=i.ticks(t);this.timeseriesAttrib.hasFloat&&!this.ts_Type.is("Rank")||(s=s.filter((e=>e%1==0))),this.ts_Type.is("Rank")&&(s.unshift(1),s=s.sort(((e,t)=>t-e)).reduce(((e,t)=>(e[e.length-1]!==t&&e.push(t),e)),[]));var r={Rank:e=>"# "+ft.format("d")(e),ChangePct:e=>(e>0?"+":"")+ft.format(".3s")(e)+"%",ChangeAbs:e=>(e>0?"+":"")+this.timeseriesAttrib.printAbbr(e,!0),Value:e=>this.timeseriesAttrib.getFormattedValue(e,!0)}[this.ts_Type.get()],a=this.DOM.root.select(".recordBase_Timeseries .recordAxis_Y > .tickGroup"),o=0;a.selectAll(".hmTicks").data(s.reverse(),(e=>e)).join((e=>e.append("div").attr("class","hmTicks").classed("zero",(e=>0===e)).style("opacity",0).call((e=>{e.append("div").attr("class","tickLine"),e.append("div").attr("class","tickText tickText_1"),e.transition().delay(500).duration(0).style("opacity",1)}))),(e=>e),(e=>{e.style("transform",(e=>"translateY("+this.scale_Value(e)+"px) translateZ(0)")).style("opacity",0).transition().duration(0).delay(500).remove()})).style("transform",(e=>"translateY("+this.scale_Value(e)+"px) translateZ(0)")).classed("hideLabel",(e=>{var t=this.scale_Value(e);return!(t>=o)||(o=t+20,!1)})).call((e=>{e.selectAll(".tickText").html(r)}))}refreshFilterRanges(){this.DOM.root.selectAll(".recordBase_Timeseries .recordAxis_X > .tickGroup > .hmTicks").each((e=>{e._histogram=this.timeseriesAttrib.timeKeyAttribs[e._time_src]})).classed("isFiltered",(e=>{var t;return(null===(t=e._histogram)||void 0===t?void 0:t.isFiltered())&&this.ts_Type.is("Value")})).filter((e=>{var t;return(null===(t=e._histogram)||void 0===t?void 0:t.isFiltered())&&this.ts_Type.is("Value")})).selectAll(".filterArea").style("height",(e=>{var t=i.parentNode.__data__,i=e.currentTarget,s=t._histogram,r=this.scale_Value(s.summaryFilter.active.minV),a=this.scale_Value(s.summaryFilter.active.maxV),o=this.scale_Value.domain(),l=o[0]>o[1];return i._minn=l?a:r,i._maxx=l?r:a,ft.select(i.childNodes[l?1:0]).html(s.printAbbr(s.summaryFilter.active.minV)),ft.select(i.childNodes[l?0:1]).html(s.printAbbr(s.summaryFilter.active.maxV)),Math.abs(i._maxx-i._minn)+14+"px"})).style("top",(e=>{var t=this.scale_Value.domain();return t[0]>t[1]?e.currentTarget._minn-5+"px":e.currentTarget._maxx-5+"px"}))}get marginRight(){return 150}get marginTotal(){return this.marginLeft+this.marginRight}isMarginExpandable(){return 200*(this.timeKeys_Active.length-1)<this.rd.curWidth-this.marginTotal}expandMargin(){if(!this.wideTimeScale){var e=200*(this.timeKeys_Active.length-1);e<this.chartWidth&&(this.marginLeft+=(this.chartWidth-e)/2,this.chartWidth=e)}}refreshTimeSeriesChartWidth(){var e,t;null===(e=this.DOM.recordBase_Timeseries)||void 0===e||e.style("width",this.chartWidth+"px").style("left",this.marginLeft+"px"),null===(t=this.DOM.recordLineClippath)||void 0===t||t.attr("width",this.chartWidth)}updateRecordVisibility(){this.refreshLabelOverlaps()}refreshKeyLine(){this.timeseriesAttrib&&this.timeSeriesChangeVsTimeKey.get()&&this.DOM.root.select(".recordAxis_X > .keyLine").style("transform",`translateX(${this.scale_Time(this.timeSeriesChangeVsTimeKey.get()._time)})`)}onRecordMouseLeave(){_t()}onRecordMouseOver(e){e.moveDOMtoTop()}refreshTimeseriesTicks(){if(this.timeseriesAttrib){var e=this,t=this.DOM.root.select(".recordBase_Timeseries .recordAxis_X > .tickGroup"),i=-300,s=9*this.timeseriesAttrib.timeKeys.reduce(((e,t)=>Math.max(e,t._time_src.length)),0);t.selectAll(".hmTicks").data(this.timeKeys_Active,(e=>e._time_src)).join((t=>{var i=t.append("div").attr("class","hmTicks").style("opacity",1).style("transform",(e=>`translateX(${this.scale_Time_prev(e._time)}px) translateZ(0)`)).call((e=>e.transition().delay(0).duration(0).style("transform",(e=>`translateX(${this.scale_Time(e._time)}px) translateZ(0)`)))),s=i.append("div").attr("class","tickText");i.append("div").attr("class","tickLine"),i.append("div").attr("class","timeSelectArea").on("mousedown",((t,i)=>{if(1===t.which){e.browser.DOM.root.classed("noPointerEvents",!0);var s=t.currentTarget,r=e.scale_Value.invert(ft.pointer(t)[1]),a=e.timeseriesAttrib.getTimepointSummary(i);ft.select("body").on("mousemove.test",(()=>{var o=e.scale_Value.invert(ft.pointer(t,s)[1]),l=r>o?o:r,n=r>o?r:o;if(e.ts_Type.is("Rank")){var h=Math.floor(l),c=Math.ceil(n);e.browser.records.forEach((e=>{var t=e.getValue(this.timeseriesAttrib)._keyIndex;if(t){var s=t[i._time_src];s&&(s._rank===h&&(l=s._value),s._rank===c&&(n=s._value))}}))}a.setRangeFilter_Custom(l,n),e.refreshFilterRanges()})).on("mouseup.test",(()=>{e.browser.DOM.root.classed("noPointerEvents",!1),ft.select("body").on("mousemove.test",null).on("mouseup.test",null)})),t.preventDefault()}}));var r=i.append("div").attr("class","filterArea").on("mousedown",((t,i)=>{if(1===t.which){e.browser.DOM.root.classed("noPointerEvents",!0);var s=t.currentTarget.parentNode.childNodes[2],r=t.currentTarget;r.classList.add("dragging");var a=e.timeseriesAttrib.getTimepointSummary(i),o=e.scale_Value.invert(ft.pointer(t,s)[1]);ft.select("body").on("mousemove.test",(()=>{var i=e.scale_Value.invert(ft.pointer(t,s)[1]);a.setRangeFilter_Custom(Math.min(o,i),Math.max(o,i))})).on("mouseup.test",(()=>{e.browser.DOM.root.classed("noPointerEvents",!1),r.classList.remove("dragging"),ft.select("body").on("mousemove.test",null).on("mouseup.test",null)})),t.preventDefault()}}));return s.append("span").attr("class","clearFilterButton fa").tooltip(me.RemoveFilter).on("click",(e=>{var t=this.timeseriesAttrib.getTimepointSummary(e);t&&t.summaryFilter.clearFilter()})),s.append("span").attr("class","theTextText").html((e=>e._time_src)),s.append("span").attr("class","openTimepointSummary fa fa-external-link-square").tooltip("Create Time-Key<br>Histogram").on("click",(e=>{this.timeseriesAttrib.getTimepointSummary(e).block.addToPanel(this.browser.panels.left),this.browser.updateLayout()})),["min","max"].forEach((function(t){r.append("div").attr("class","filterRangeValue filterRangeValue_"+t).on("mousedown",(function(i,s){if(1===i.which){e.browser.DOM.root.classed("noPointerEvents",!0);var r=this.parentNode.parentNode.childNodes[2],a=this.parentNode;a.classList.add("dragging");var o=e.timeseriesAttrib.getTimepointSummary(s);ft.select("body").on("mousemove.range",(function(){var s=e.scale_Value.invert(ft.pointer(i,r)[1]);o.summaryFilter.active[t]=s,o.summaryFilter.setFiltered(!0),e.refreshFilterRanges()})).on("mouseup.range",(function(){a.classList.remove("dragging"),e.browser.DOM.root.attr("adjustWidth",null).classed("noPointerEvents",!1),ft.select("body").style("cursor","auto").on("mousemove.range",null).on("mouseup.range",null)})),i.preventDefault(),i.stopPropagation()}}))})),i}),(e=>e.style("transform",(e=>`translateX(${this.scale_Time(e._time)}px) translateZ(0)`))),(e=>e.transition().duration(0).delay(500).style("transform",(e=>`translateX(${this.scale_Time(e._time)}px) translateZ(0)`)).style("opacity",0).remove())).selectAll(".tickText").style("display",(e=>{var t=this.scale_Time(e._time);return t-i<s?"none":(i=t,null)})),this.refreshKeyLine()}}updateDotVisibility(){var e=this.browser.records.length-this.DOM.root.selectAll(".noTimeSeries, .filteredOut").nodes().length;this.browser.DOM.root.classed("noRecordDots",this.rd.curHeight/e<100||this.rd.curWidth/this.timeKeys_Active.length<30)}timeseriesWiden(){this.isMarginExpandable()&&(this.wideTimeScaleTimer=window.setTimeout((()=>{this.wideTimeScale=!0,this.refreshTimeRange()}),500))}timeseriesWidenOff(){this.wideTimeScaleTimer&&(window.clearTimeout(this.wideTimeScaleTimer),this.wideTimeScaleTimer=0,this.wideTimeScale&&!this.rd.timeseriesAnimInterval&&(this.wideTimeScale=!1,this.refreshTimeRange()))}stepTimeAnimation(e){this.wideTimeScale=!0;var t=this.timeseriesAttrib.timeKeys.length-1;return this.timeRange.max._index>=t?(this.setTimeRange({max:this.timeRange.min._index+1}),window.setTimeout((()=>this.rd.startTimeseriesAnimation(e)),this.animStepDelayMs),!0):(this.rd.timeseriesAnimInterval=window.setInterval((()=>{this.timeRange.max._index>=t?this.rd.stopTimeseriesAnimation():this.setTimeRange({max:this.timeRange.max._index+e})}),this.animStepDelayMs),!0)}stopTimeAnimation(){this.refreshTimeRange(),this.wideTimeScale=!1}updateAfterFilter(){this.updateRecordVisibility(),this.updateDotVisibility(),this.fitValueAxis.refresh(),this.ts_Type.is("Rank")?(this.timeseriesAttrib.computeRecordRanks(),this.refreshScaleValue()):this.ts_Type.is("Value")?!this.browser.isFiltered()||this.fitValueAxis.get()?this.refreshScaleValue():this.rd.refreshRecordVis():this.isTimeseriesChange()&&this.refreshScaleValue(),this.refreshLineOpacity()}addAnnotations(){this.rd.config.timeSeriesAnnotations&&this.DOM.ts_annotations.selectAll("div.annotation").data(this.rd.config.timeSeriesAnnotations.filter((e=>e._time<=this.timeRange.max._time)).filter((e=>e._time>=this.timeRange.min._time)),(e=>e._time)).join((e=>e.append("div").attr("class","annotation").call((e=>{e.append("div").attr("class","line"),e.append("div").attr("class","annotIcon fa fa-clock"),e.append("div").attr("class","textBox").call((e=>{e.append("div").attr("class","timeText").text((e=>e._time_src)),e.append("div").attr("class","freeText").text((e=>e._text))}))}))),(e=>e),(e=>e.remove())).style("left",(e=>this.scale_Time(e._time)+"px"))}refreshLineOpacity(){var e=Math.abs(this.scale_Value.range()[1]-this.scale_Value.range()[0])/this.browser.allRecordsAggr.recCnt("Active"),t=Math.max(.4,Math.min(1,e/25)),i=ft.schemeCategory10,s=2;s=e<50?2:e<70?3:e<100?4:5,this.DOM.kshfRecords.selectAll("path").style("opacity",(e=>(e.recordOrder%3+10)/11*t)).style("stroke",(e=>i[e.recordOrder%12])).style("stroke-width",s),this.DOM.kshfRecords.selectAll(".recordText_Dot").style("background-color",(e=>i[e.recordOrder%12]))}refreshLabelOverlaps(){var e;if(this.timeseriesAttrib){var t=this.scale_Time.domain()[1].getTime(),i=this.timeseriesAttrib.timeKeys.find((e=>e._time.getTime()===t))._time_src,s=new bt,r=(null===(e=this.timeSeriesChangeVsTimeKey.get())||void 0===e?void 0:e._time_src)||null;this.browser.records.forEach((e=>{var t;if(e._view._labelHidden=!0,e._view._labelPos=0,!e.filteredOut&&this.recordInView(e)){var s=null===(t=this.timeseriesAttrib.getRecordValue(e))||void 0===t?void 0:t._keyIndex,a=s[i];if(a){var o=this.scale_Value(a._value);if(null!==o&&isFinite(o)&&!isNaN(o)){e._view._labelHidden=!1;var l=this.isTimeseriesChange()?s[r]._value:0;e._view._labelPos=this.y_Generator(a,l)}}}ft.select(e.DOM.record).select("foreignObject").classed("hidden",e._view._labelHidden)}));Array.from(this.browser.records.filter((e=>!e._view._labelHidden))).sort(((e,t)=>e._view._labelPos-t._view._labelPos)).forEach((e=>{var t,i=ft.select(e.DOM.record).select("foreignObject"),r=s.intersectsWith(e._view._labelPos);if(r){let i=r._entity;s.usedList=s.usedList.filter((e=>e._entity!==i));var a=Math.max(e._view._labelPos-14,i._view._labelPos-7);s.isEmpty(a)&&(ft.select(i.DOM.record).select("foreignObject").attr("y",a-8),i._view._labelPos=a),s.insertUsed(i._view._labelPos,14,i);var o=Math.min(i._view._labelPos+14);s.isEmpty(o)&&o<=e._view._labelPos+10?e._view._labelPos=o:t=!0}i.classed("overlapping",t),i.attr("y",e._view._labelPos-8),t||s.insertUsed(e._view._labelPos,14,e)}))}}refreshTimeSeriesPlotType(){this.ts_Type&&this.timeseriesAttrib&&(this.DOM.root.attr("data-ts_Type",this.ts_Type),this.refreshYGenerator(),this.ts_Type.is("Rank")&&this.timeseriesAttrib.computeRecordRanks(),this.isTimeseriesChange()?(this.DOM.root.select(".MouseMode-filter").style("display","none"),"filter"===this.rd.visMouseMode&&(this.rd.visMouseMode="pan",this.DOM.root.attr("visMouseMode",this.rd.visMouseMode))):this.DOM.root.select(".MouseMode-filter").style("display",null),this.DOM.root.select(".recordAxis_X > .keyLine").style("display",this.isTimeseriesChange()?"block":null),this.refreshScaleValue())}refreshRecordVis(){var e;if(this.ts_Type&&this.timeseriesAttrib&&this.DOM.recordBase_Timeseries&&this.DOM.kshfRecords&&this.y_Generator&&this.timeseriesAttrib.aggr_initialized){var t,i=e=>this.scale_Time(e._time),s=this.scale_Time.domain(),r=e=>e._time>=s[0]&&e._time<=s[1],a=this.timeseriesAttrib.timeKeys,o=a[Math.max(this.timeRange.min._index-5,0)]._time,l=a[Math.min(this.timeRange.max._index+5,a.length-1)]._time,n=(null===(e=this.timeSeriesChangeVsTimeKey.get())||void 0===e?void 0:e._time_src)||"",h=ft.line().curve(this.ts_Type.is("Rank")?ft.curveLinear:ft.curveMonotoneX).x(i).y((e=>this.y_Generator(e,t))).defined((e=>{if(!(e=>e._time>=o&&e._time<=l)(e))return!1;var i=this.y_Generator(e,t);return null!=i&&isFinite(i)&&!isNaN(i)}));this.scale_Value.rangeRound([this.rd.curHeight-115,15]);var c=this.ts_timeKeysStep.is("limits"),d={};this.timeKeys_Active.forEach((e=>{d[e._time_src]=!0}));var u=this.DOM.kshfRecords.attr("transform",null).style("transform",null).classed("noTimeSeries",(e=>!this.recordInView(e))).each(((e,s,a)=>{var o;if(this.recordInView(e)&&!e.filteredOut){var l=this.timeseriesAttrib.getRecordValue(e);if(l){t=null===(o=l._timeseries_.find((e=>e._time_src===n)))||void 0===o?void 0:o._value;var h=l._timeseries_.filter(r);c&&(h=h.filter((e=>d[e._time_src]))),ft.select(a[s]).select(".dotGroup").selectAll(".timeSeriesDot").data(h,(e=>e._time.getTime())).join((e=>e.append("circle").attr("class","timeSeriesDot").attr("r",3)),(e=>e),(e=>e.remove())).each(((e,t,i)=>{e.DOM=i[t]})).attr("cx",i).attr("cy",(e=>this.y_Generator(e,t))).style("display",(e=>{var i=this.y_Generator(e,t);return null!=i&&isFinite(i)&&!isNaN(i)?null:"none"}))}}})).call((e=>{e.selectAll("foreignObject").attr("x",this.scale_Time.range()[1]+16).on("mouseenter",((e,t)=>this.rd.onRecordMouseOver(t))).on("mouseleave",((e,t)=>this.rd.onRecordMouseLeave(t)))})).selectAll("path").attr("fill","none"),p=e=>{var i,s;if(!e.filteredOut){var r=null===(i=this.timeseriesAttrib.getRecordValue(e))||void 0===i?void 0:i._timeseries_;if(r)return t=null===(s=r.find((e=>e._time_src===n)))||void 0===s?void 0:s._value,c&&(r=r.filter((e=>d[e._time_src]))),h(r)}};if(this.rd.timeseriesAnimInterval){var m=i;i=e=>this.scale_Time_prev(e._time),h.x(i),u.transition().duration(200).attr("d",p),i=m,h.x(i)}u.transition().duration(700).ease(ft.easePoly.exponent(3)).delay(0).attr("d",p),this.refreshLabelOverlaps(),this.refreshLineOpacity()}}refreshAttribUnitName(e){this.refreshTicks_AxisY()}}const At={select:a,pointer:_,geoPath:w,geoTransform:O,easePolyOut:B,easePoly:C,interpolate:V,hsl:D,arc:v};class Mt extends vt{extendRecordDOM(e){"Point"===this.geoAttrib.geoType?this.rd.config.mapUsePins?e.append("path").attr("class","glyph_Main").attr("d",ae.map.pinGlyphPath).attr("transform","scale(0.0001)"):this.extendRecordDOM_Point(e):e.append("path").attr("class","glyph_Main")}updateAfterFilter(e){this.updateRecordVisibility(),this.refreshRecordColors(),"Point"===this.geoAttrib.geoType&&this.refreshRecordVis()}refreshRecordSizes(){if("Point"===this.geoAttrib.geoType&&this.DOM.recordGroup){var e=this.DOM.recordGroup.selectAll(".kshfRecord > path").transition().duration(700).ease(At.easePolyOut.exponent(3));this.rd.config.mapUsePins?e.attr("transform",`scale(${this.rd.getMaxSizeScaleRange()/15})`):e.attr("d",(e=>this.rd.recordDrawArc(e)())),this.DOM.recordGroup.selectAll(".kshfRecord > .sizeValueText").html((e=>e.measure_Self)),this.refreshPointClusterVis()}}prepareAttribs(){return e(this,void 0,void 0,(function*(){return this.rd.codeBy.geo||(yield this.rd.setAttrib("geo",this.rd.config.geoBy||0)),!this.rd.codeBy.color&&this.rd.config.colorBy&&(yield this.rd.setAttrib("color",this.rd.config.colorBy)),!this.rd.codeBy.size&&this.rd.config.sizeBy&&(yield this.rd.setAttrib("size",this.rd.config.sizeBy)),Promise.resolve(!0)}))}initView(){this.initialized||this.zoomToFit(),"Point"===this.geoAttrib.geoType&&this.refreshPointClusters(),this.refreshPointDOM(),this.refreshRecordVis(),this.refreshRecordColors(),this.refreshRecordSizes(),this.rd.refreshColorLegend(),this.rd.refreshSizeLegend()}initView_DOM(){return e(this,void 0,void 0,(function*(){if(this.DOM.recordBase_Map)return this.DOM.recordGroup=this.DOM.recordMap_SVG.select(".recordGroup"),this.DOM.kshfRecords=this.DOM.recordGroup.selectAll(".kshfRecord"),this.DOM.kshfRecords_Path=this.DOM.recordGroup.selectAll(".kshfRecord > path.glyph_Main"),void this.leafletRecordMap.invalidateSize();window.L||(yield import("./vendor_mapping.min.js").then((function(e){return e.l})));var e=this;function t(){"Point"===this.geoAttrib.geoType&&(this.rd.config.mapUsePins?this.DOM.recordGroup.selectAll(".kshfRecord > path").attr("transform","scale(0.0001)"):this.DOM.recordGroup.selectAll(".kshfRecord > path").attr("d",Re.getCirclePath()))}this.DOM.recordBase_Map=this.rd.DOM.recordDisplayWrapper.append("div").attr("class","recordBase_Map"),this.mapConfig=Re.mergeConfig(ae.map,this.rd.config.mapConfig||{}),this.leafletRecordMap=L.map(this.DOM.recordBase_Map.node(),this.mapConfig.leafConfig).on("viewreset",(function(){this._zoomInit_&&(this._zoomInit_=null,e.rd.DOM.recordDisplayWrapper.classed("dragging",!1),e.refreshRecordVis())})).on("movestart",(function(){e.rd.DOM.recordDisplayWrapper.classed("dragging",!0),e.browser.DOM.root.classed("noPointerEvents",!0),t.call(e),this._zoomInit_=this.getZoom()})).on("moveend",(function(){e.rd.DOM.recordDisplayWrapper.classed("dragging",!1),e.browser.DOM.root.classed("noPointerEvents",!1),e.rd.refreshViz_Compare_All(),e.rd.refreshRecordVis(),this._zoomInit_=null})).on("zoomstart",(()=>{t.call(this),At.select(this.leafletRecordMap.getPane("mapPane")).classed("leaflet-zoom-anim",!0)})).on("zoomend",(()=>{At.select(this.leafletRecordMap.getPane("mapPane")).classed("leaflet-zoom-anim",!1)})),this.mapConfig.tileConfig.disabled||this.leafletRecordMap.addLayer(new L.TileLayer(this.mapConfig.tileTemplate,this.mapConfig.tileConfig)),this.leafletRecordMap.attributionControl.setPosition("topright"),this.recordGeoPath=At.geoPath().projection(At.geoTransform({point:function(t,i){var s=e.leafletRecordMap.latLngToLayerPoint(new L.latLng(i,t));this.stream.point(s.x,s.y)}})),this.recordGeoPath.pointRadius(this.rd.recordPointSize.get()),this.DOM.recordBase_Map.select(".leaflet-tile-pane"),this.DOM.recordMap_SVG=At.select(this.leafletRecordMap.getPanes().overlayPane).append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("class","recordMap_SVG");var i=this.DOM.recordMap_SVG.append("defs");i.append("filter").attr("id","pointDropShadow").attr("height","200%").attr("width","200%").call((e=>{e.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3),e.append("feOffset").attr("dx",2).attr("dy",2).attr("result","offsetblur"),e.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.5),e.append("feMerge").call((e=>{e.append("feMergeNode"),e.append("feMergeNode").attr("in","SourceGraphic")}))})),i.append("pattern").attr("id","diagonalHatch").attr("patternUnits","userSpaceOnUse").attr("width",4).attr("height",4).append("path").attr("d","M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2").attr("stroke","gray").attr("stroke-width",1),this.DOM.clusterGroup=this.DOM.recordMap_SVG.append("g").attr("class","leaflet-zoom-hide clusterGroup"),this.DOM.recordGroup=this.DOM.recordMap_SVG.append("g").attr("class","leaflet-zoom-hide recordGroup")}))}finishSetAttrib(t){return e(this,void 0,void 0,(function*(){"color"===t?this.refreshRecordColors():"geo"===t&&(this.rd.config.geo=this.geoAttrib.attribName,this.DOM.root.attr("data-geotype",this.geoAttrib.geoType),this.DOM.root.select(".mapView-UnmatchedData").classed("active",this.geoAttrib.noValueAggr.records.length>0),"Point"===this.geoAttrib.geoType&&(this.geoAttrib.setPointClusterRadius(this.rd.config.pointClusterRadius,this.leafletRecordMap),!this.rd.codeBy.size&&this.rd.config.sizeBy?yield this.rd.setAttrib("size",this.rd.config.sizeBy):this.rd.refreshAttribOptions("size"),this.rd.refreshAttribOptions("color"),yield this.geoAttrib.prepPointCluster(this.leafletRecordMap)))}))}refreshSelect_Compare(e=null,t=!1){if(this.isComparable()){if(this.rd.hasAggregates()){this.geoAttrib._aggrs.forEach((e=>{let t=0;e._glyphOrder={},this.browser.activeComparisons.slice().sort(((t,i)=>e.measure(i)-e.measure(t))).forEach(((i,s)=>{e._glyphOrder[i]=s,e.setOffset(i,t),t+=e.measure(i)}))}));const e=this.browser.stackedCompare.is(!1),t=this.browser.activeComparisonsCount;this.browser.activeComparisons.forEach((i=>{this.DOM["clusterGlyphs_"+i].style("stroke-width",(i=>e?i.cluster._radius/t:0)).transition().ease(At.easePoly.exponent(3)).duration(700).attrTween("d",((s,r,a)=>{const o=a[r],l=e?0:s.offset(i)/(s.measure("Active")||1),n=At.interpolate(o._currentPreviewAngle,s.ratioToActive(i));let h=s.cluster._radius;return e&&(h-=(s._glyphOrder[i]+.5)*(s.cluster._radius/t)),t=>{const i=n(t);return o._currentPreviewAngle=i,Re.getPieSVGPath(l,i,h-1,e)}}))}))}super.refreshSelect_Compare(e,t)}}constructor(e,t){super(e),this.zoomedBefore=!1}refreshQueryBox_Filter(e=null){if(this.rd.collapsed)return;let t,i,s=!1;if("undefined"==typeof L)throw Error("Leaflet not initialized");if(null===e){if(s=this.geoAttrib.isFiltered(),!s)return;t=this.leafletRecordMap.latLngToLayerPoint(this.geoAttrib.summaryFilter.bounds.getNorthWest()),i=this.leafletRecordMap.latLngToLayerPoint(this.geoAttrib.summaryFilter.bounds.getSouthEast())}else{if(e instanceof L.LatLngBounds)throw Error("Invalud value");t=this.leafletRecordMap.latLngToLayerPoint(e.getNorthWest()),i=this.leafletRecordMap.latLngToLayerPoint(e.getSouthEast())}let r=t.x,a=i.x,o=t.y,l=i.y;this.rd.DOM.recordDisplayWrapper.select(".recordBase_Map  .spatialQueryBox_Filter").classed("active",e||s).style("left",r+"px").style("top",o+"px").style("width",Math.abs(a-r)+"px").style("height",Math.abs(l-o)+"px")}refreshViewSize(e=500){this.rd.refreshColorLegendTicks(),setTimeout((()=>this.leafletRecordMap.invalidateSize()),e)}refreshAttribUnitName(e){this.rd.refreshColorLegendTicks()}zoomIn(){this.leafletRecordMap.zoomIn()}zoomOut(){this.leafletRecordMap.zoomOut()}zoomToFit(){if(!this.zoomedBefore&&this.rd.config.mapInitView){var e=this.rd.config.mapInitView;return void 0!==e[3]&&!1!==e[3]||(this.zoomedBefore=!0),void this.leafletRecordMap.setView(L.latLng(e[0],e[1]),e[2])}this.zoomToBounds(Re.addMarginToBounds(this.geoAttrib.getRecordBounds(!0)))}zoomToBounds(e){this.rd.DOM.recordDisplayWrapper.classed("dragging",!0),this.leafletRecordMap.fitBounds(e)}setMaxBounds(){this.rd.config.map_NoFitBounds||this.leafletRecordMap.setMaxBounds(Re.addMarginToBounds(this.geoAttrib.getRecordBounds(!1)))}translate_glyph(e){let t=this.leafletRecordMap.latLngToLayerPoint(new L.latLng(e[1],e[0]));return`translate(${t.x},${t.y})`}refreshPointClusters(){var e;this.geoAttrib&&"Point"===(null===(e=this.geoAttrib)||void 0===e?void 0:e.geoType)&&this.geoAttrib.PointCluster&&(this.geoAttrib.updateClusters(this.leafletRecordMap.getBounds(),this.leafletRecordMap.getZoom()),this.DOM.clusterGlyphs=this.DOM.clusterGroup.selectAll(".clusterGlyph").data(this.geoAttrib._aggrs).enter().append("g").attr("class","clusterGlyph aggrGlyph").each(((e,t,i)=>{e.setAggrGlyph(i[t])})).tooltip((e=>e.getTooltipHTML()),{theme:"dark kshf-tooltip kshf-record",placement:"right",animation:"fade",followCursor:!0,offset:[0,5]}).attr("transform",(e=>this.translate_glyph(e.cluster.geometry.coordinates))).on("click",((e,t)=>{if(e.shiftKey)return;let i=t.cluster.geometry.coordinates;this.leafletRecordMap.setZoomAround(new L.latLng(i[1],i[0]),this.leafletRecordMap.getZoom()+1)})).call((e=>{e.append("g").attr("class","measureGroup").call((e=>{["Active"].concat(ae.Compare_List).forEach((t=>{this.DOM["clusterGlyphs_"+t]=e.append("path").attr("class","measure_"+t).each(((e,t,i)=>{i[t]._currentPreviewAngle=0}))}))})),e.append("text").attr("class","sizeValueText").html((e=>""+e.Active.measure))})),this.DOM.clusterGlyphs_Active.attr("d",Re.getCirclePath()))}refreshPointDOM(){this.rd.refreshRecordDOM(),this.rd.updateRecordSizeScale(),this.rd.updateRecordColorScale()}refreshRecordVis(){var e,t,i;this.geoAttrib&&("Point"===this.geoAttrib.geoType?(this.refreshPointClusters(),this.refreshPointDOM(),null===(e=this.DOM.kshfRecords)||void 0===e||e.attr("transform",(e=>this.translate_glyph(this.geoAttrib.getRecordValue(e).geoFeat.coordinates))),null===(t=this.DOM.clusterGlyphs)||void 0===t||t.attr("transform",(e=>this.translate_glyph(e.cluster.geometry.coordinates)))):null===(i=this.DOM.kshfRecords_Path)||void 0===i||i.attr("d",(e=>this.recordGeoPath(this.geoAttrib.getRecordValue(e).geoFeat))))}refreshPointClusterVis(){if(!this.rd.hasAggregates())return;if(!this.rd.recordRadiusScale)return;let e=At.arc().innerRadius(0).startAngle(0).endAngle(2*Math.PI);this.DOM.clusterGlyphs.each((e=>{e.cluster._radius=this.rd.recordRadiusScale(e.Active.measure)})).classed("tinyCluster",(e=>e.cluster._radius<8)).classed("clampedCluster",(e=>e.cluster._radius>=ae.maxRecordPointSize)),this.DOM.clusterGlyphs_Active.transition().duration(700).ease(At.easePolyOut.exponent(3)).attr("d",(t=>e.outerRadius(t.cluster._radius)(null))),this.colorAttrib?this.DOM.clusterGlyphs_Active.each(((e,t,i)=>{let s=e.Active.measure,r=null!=s?this.rd.recordColorScale(s):"url(#diagonalHatch)",a=null!=s&&At.hsl(r).l<.6;i[t].style.fill=r,i[t].parentNode.parentNode.classList[a?"add":"remove"]("darkBg")})):(this.DOM.clusterGlyphs_Active.style("fill",null),this.DOM.clusterGlyphs.classed("darkBg",!1)),this.refreshSelect_Compare()}getRecordsForDOM(){let e=this.leafletRecordMap.getBounds();return this.browser.records.filter((t=>{var i,s=null===(i=this.geoAttrib.getRecordValue(t))||void 0===i?void 0:i.geoFeat;return!!s&&("Point"!==s.type||!s.coordinates||!t._view.inCluster&&e.contains(L.latLng(s.coordinates.slice().reverse())))}))}refreshRecordColors(){if(this.DOM.kshfRecords_Path){if(this.colorAttrib){if(!this.rd.recordColorScale)return;let e,t=!1,i=e=>!1;if(this.colorAttrib instanceof Fe){if(e=this.colorAttrib.template.func,t=this.colorAttrib.isValueScale_Log,this.colorAttrib.hasTimeSeriesParent()){let e=this.colorAttrib.timeseriesParent.template.func;i=function(t){let i=e.call(this,t);return!(!i||!i._timeseries_)&&0===i._timeseries_.length}}}else"_measure_"===this.colorAttrib?e=e=>e.measure_Self:console.log("IMPOSSIBLE");this.DOM.kshfRecords_Path.each(((s,r,a)=>{if(s.filteredOut)return;let o=a[r],l="url(#diagonalHatch)",n="#111111",h=!1,c=e.call(s.data,s);(""===c||null==c||"number"!=typeof c||t&&c<=0)&&(c=null),null!=c&&(l=this.rd.recordColorScale(c),h=At.hsl(l).l<.6,n=h?"#EEEEEE":"#111111"),s.isSelected()&&(n=null),o.style.fill=l,o.style.stroke=n,o.parentNode.classList[h?"add":"remove"]("darkBg"),o.classList[i.call(s.data,s)?"add":"remove"]("noData")}))}else this.DOM.kshfRecords_Path.style("fill",null).style("stroke",null).classed("noData",!1);this.refreshPointClusterVis()}}}const St={select:a,pointer:_,zoom:I,zoomTransform:E,zoomIdentity:F,line:f,curveNatural:G,curveCatmullRomOpen:z,easePolyOut:B};class Ct extends vt{prepareAttribs(){return e(this,void 0,void 0,(function*(){return this.scatterYAttrib||(yield this.rd.setAttrib("scatterY",this.rd.config.scatterYBy||(this.rd.codeBy.sort instanceof Ye?this.rd.codeBy.sort:0))),this.scatterXAttrib||(yield this.rd.setAttrib("scatterX",this.rd.config.scatterXBy||0)),!this.rd.codeBy.color&&this.rd.config.colorBy&&(yield this.rd.setAttrib("color",this.rd.config.colorBy)),!this.rd.codeBy.size&&this.rd.config.sizeBy&&(yield this.rd.setAttrib("size",this.rd.config.sizeBy)),Promise.resolve(!0)}))}constructor(t,i){super(t),this.configs={},this.scatterTransform={x:0,y:0,z:1},this.scatter_showTrails=new xe({cfgClass:"scatter_showTrails",cfgTitle:"Scatter Trails",iconXML:ae.custom_icons.trails,default:!0,parent:this,helparticle:"5e89138704286364bc97d51f",itemOptions:[{name:"Show",value:!0},{name:"Hide",value:!1}],forcedValue:()=>{var e,t;if(!(null===(e=this.scatterXAttrib)||void 0===e?void 0:e.hasTimeSeriesParent())||!(null===(t=this.scatterYAttrib)||void 0===t?void 0:t.hasTimeSeriesParent()))return!1}}),this.scatter_xAxisScale=new xe({parent:this,cfgClass:"scatter_xAxisScale",cfgTitle:"X Axis Scale",iconClass:"fa fa-arrows-h",default:"linear",helparticle:"5f137ac32c7d3a10cbaaf048",itemOptions:[{name:me.Linear+" "+me.LinearSequence,value:"linear"},{name:me.Log+" "+me.Log10Sequence,value:"log"}],noExport:!0,forcedValue:()=>{var e;if(!(null===(e=this.scatterXAttrib)||void 0===e?void 0:e.supportsLogScale()))return"linear"},onSet:t=>e(this,void 0,void 0,(function*(){this.scatterXAttrib&&(this.scatterXAttrib.hasTimeSeriesParent()?"auto"!==t&&(yield this.scatterXAttrib.timeseriesParent.valueScaleType.set(t)):yield this.scatterXAttrib.valueScaleType.set(t))}))}),this.scatter_yAxisScale=new xe({parent:this,cfgClass:"scatter_yAxisScale",cfgTitle:"Y Axis Scale",iconClass:"fa fa-arrows-v",default:"linear",helparticle:"5f137ac32c7d3a10cbaaf048",itemOptions:[{name:`${me.Linear} ${me.LinearSequence}`,value:"linear"},{name:`${me.Log} ${me.Log10Sequence}`,value:"log"}],noExport:!0,forcedValue:()=>{var e;if(!(null===(e=this.scatterYAttrib)||void 0===e?void 0:e.supportsLogScale()))return"linear"},onSet:t=>e(this,void 0,void 0,(function*(){this.scatterYAttrib&&(this.scatterYAttrib.hasTimeSeriesParent()?"auto"!==t&&(yield this.scatterYAttrib.timeseriesParent.valueScaleType.set(t)):yield this.scatterYAttrib.valueScaleType.set(t))}))}),["scatter_showTrails","scatter_xAxisScale","scatter_yAxisScale"].forEach((e=>{this[e].val=i[e],this.rd.configs[e]=this[e],this.rd.recordConfigPanel.insertConfigUI(this[e])})),this.scatterZoom=St.zoom().filter((()=>"pan"===this.rd.visMouseMode&&this.rd.curHeight>0)).scaleExtent([1,8]).on("start",(()=>{this.DOM.recordDisplayWrapper.classed("dragging",!0)})).on("end",(()=>{this.DOM.recordDisplayWrapper.classed("dragging",!1),this.refreshLabelOverlaps()})).on("zoom",(()=>{let e=St.zoomTransform(this.DOM.recordBase_Scatter.node());this.scatterTransform={x:e.x,y:e.y,z:e.k},this.DOM.recordGroup_Scatter.style("transform",`translate(${this.scatterTransform.x}px, ${this.scatterTransform.y}px) scale(${this.scatterTransform.z})`),this.refreshRecordVis()})),this.refreshZoomScaleExtent()}initView(){this.rd.refreshAttribOptions("scatterX"),this.rd.refreshAttribOptions("scatterY"),this.rd.refreshRecordDOM(),this.refreshScales(),this.zoomToFit(),this.refreshQueryBox_Filter(),this.rd.updateRecordSizeScale(),this.rd.updateRecordColorScale()}initView_DOM(){return e(this,void 0,void 0,(function*(){if(this.browser.DOM.root.node().style.setProperty("--width_scatter_margin_left",ae.width_scatter_margin_left+"px"),this.browser.DOM.root.node().style.setProperty("--height_scatter_margin_bottom",ae.height_scatter_margin_bottom+"px"),this.DOM.recordBase_Scatter)return this.DOM.recordGroup=this.DOM.recordBase_Scatter.select(".recordGroup"),this.DOM.kshfRecords=this.DOM.recordGroup_Scatter.selectAll(".kshfRecord"),this.DOM.kshfRecords_Path=this.DOM.recordGroup.selectAll(".kshfRecord > path.glyph_Main"),void(this.DOM.linkGroup=this.DOM.recordGroup_Scatter.select(".linkGroup"));this.DOM.recordBase_Scatter=this.DOM.recordDisplayWrapper.append("div").attr("class","recordBase_Scatter").call(this.scatterZoom),this.DOM.recordBase_Scatter.append("span").attr("class","ScatterControl-SwapAxis").tooltip(me.SwapAxis).on("mousedown",(e=>e.stopPropagation())).on("mouseup",(e=>e.stopPropagation())).on("dblclick",(e=>e.stopPropagation())).on("wheel",(e=>e.stopPropagation())).on("click",(e=>{this.swapAxis(),e.stopPropagation()})).append("i").attr("class","far fa-exchange"),["X","Y"].forEach((e=>{this.DOM["recordAxis_"+e]=this.DOM.recordBase_Scatter.append("div").attr("class","recordAxis recordAxis_"+e).html("<div class='tickGroup'></div><div class='onRecordLine'><div class='tickLine'></div><div class='tickText'></div></div>")})),this.DOM.recordGroup_Scatter=this.DOM.recordBase_Scatter.append("div").attr("class","recordGroup_Scatter_Wrapper").append("div").attr("class","recordGroup_Scatter"),["X","Y"].forEach((e=>{this.DOM["scatter"+e+"ControlGroup"]=this.DOM.recordBase_Scatter.append("div").attr("class","recordGroup_Scatter_"+e+"Axis_Options").on("mousedown",(e=>e.stopPropagation())).on("mouseup",(e=>e.stopPropagation())).on("dbclick",(e=>e.stopPropagation())).on("wheel",(e=>e.stopPropagation())).append("span").attr("class","scatter"+e+"ControlGroup attribControlGroup"),this.rd.initDOM_AttribSelect("X"===e?"scatterX":"scatterY")}));var e=this.DOM.recordGroup_Scatter.append("svg").attr("xmlns","http://www.w3.org/2000/svg");this.DOM.recordGroup=e.append("g").attr("class","recordGroup"),this.DOM.recordTrail=e.append("g").attr("class","recordTrail"),this.DOM.recordTrail_Path=this.DOM.recordTrail.append("path").attr("class","recordTrail_Path"),this.insertQueryBoxes(this.DOM.recordGroup_Scatter,((e,t)=>{1===e.which&&(this.DOM.recordDisplayWrapper.classed("dragging",!0).classed("drawSelecting",!0),St.select("body").on("mousemove",(e=>{var i=St.pointer(e,this.DOM.recordGroup_Scatter.node().parentNode).map(((e,t)=>this["scatterAxisScale_"+(t?"Y":"X")].invert(e)));"l"===t&&this.scatterXAttrib.setRangeFilter_Custom(i[0],this.scatterXAttrib.summaryFilter.active.maxV),"r"===t&&this.scatterXAttrib.setRangeFilter_Custom(this.scatterXAttrib.summaryFilter.active.minV,i[0]),"t"===t&&this.scatterYAttrib.setRangeFilter_Custom(this.scatterYAttrib.summaryFilter.active.minV,i[1]),"b"===t&&this.scatterYAttrib.setRangeFilter_Custom(i[1],this.scatterYAttrib.summaryFilter.active.minV),this.refreshQueryBox_Filter()})).on("mouseup",(()=>{this.DOM.recordDisplayWrapper.classed("dragging",!1).classed("drawSelecting",!1),St.select("body").on("mousemove",null).on("mouseup",null)})),e.preventDefault(),e.stopPropagation())}),(e=>{if(1===e.which){this.DOM.recordDisplayWrapper.classed("dragging",!0);var t=St.pointer(e,this.DOM.recordGroup_Scatter.node().parentNode),i=this.scatterAxisScale_X(this.scatterXAttrib.summaryFilter.active.minV),s=this.scatterAxisScale_X(this.scatterXAttrib.summaryFilter.active.maxV),r=this.scatterAxisScale_Y(this.scatterYAttrib.summaryFilter.active.minV),a=this.scatterAxisScale_Y(this.scatterYAttrib.summaryFilter.active.maxV);St.select("body").on("mousemove",(e=>{var o=St.pointer(e,this.DOM.recordGroup_Scatter.node().parentNode),l=t[0]-o[0],n=t[1]-o[1];this.scatterYAttrib.setRangeFilter_Custom(this.scatterAxisScale_Y.invert(r-n),this.scatterAxisScale_Y.invert(a-n)),this.scatterXAttrib.setRangeFilter_Custom(this.scatterAxisScale_X.invert(i-l),this.scatterAxisScale_X.invert(s-l)),this.refreshQueryBox_Filter()})).on("mouseup",(()=>{this.DOM.recordDisplayWrapper.classed("dragging",!1),St.select("body").on("mousemove",null).on("mouseup",null)})),e.preventDefault(),e.stopPropagation()}}),((e,t)=>{"Filter"===t?(this.scatterXAttrib.summaryFilter.clearFilter(),this.scatterYAttrib.summaryFilter.clearFilter()):(this.browser.clearSelect_Compare(t),this.displayQueryBox(t,!1)),e.currentTarget.tippy.hide()}))}))}refreshAttribScaleType(t){return e(this,void 0,void 0,(function*(){this.scatterXAttrib&&this.scatterYAttrib&&(this.scatterXAttrib!==t&&this.scatterXAttrib.timeseriesParent!==t||(yield this.scatter_xAxisScale.set(this.scatterXAttrib.valueScaleType.get()),this.refreshRecordVis()),this.scatterYAttrib!==t&&this.scatterYAttrib.timeseriesParent!==t||(yield this.scatter_yAxisScale.set(this.scatterYAttrib.valueScaleType.get()),this.refreshRecordVis()))}))}refreshAttribUnitName(e){this.refreshScatterTicks()}finishSetAttrib(t){return e(this,void 0,void 0,(function*(){"text"===t?(this.DOM.kshfRecords.selectAll("foreignObject .recordText").html((e=>this.textBriefAttrib.renderRecordValue(e))),this.refreshRecordBounds(),this.refreshLabelOverlaps()):"scatterX"===t||"scatterY"===t?("scatterX"===t&&this.scatter_xAxisScale.set(this.scatterXAttrib.valueScaleType.get()),"scatterY"===t&&this.scatter_yAxisScale.set(this.scatterYAttrib.valueScaleType.get()),this.refreshScales(),this.refreshLabelOverlaps(),this.refreshRecordVis()):"color"===t&&this.refreshRecordColors()}))}refreshViewSize(e=0){this.scatterXAttrib&&this.scatterYAttrib&&(this.refreshZoomScaleExtent(),this.refreshRecordVis(),this.rd.refreshColorLegendTicks())}get realWidth(){return this.rd.curWidth-ae.width_scatter_margin_left}get realHeight(){return this.rd.curHeight-ae.height_scatter_margin_bottom-(this.rd.hasTimeKey?ae.timeKeyHeight:0)}getScale(e){return Re.getD3Scale(e.isValueScale_Log).domain(e.getVizDomain()).clamp(!1)}refreshScales(){this.scatterXAttrib&&this.scatterYAttrib&&(this.rd.timeseriesAnimInterval||(this.scatterScaleX=this.getScale(this.scatterXAttrib).range([.05*this.realWidth,.9*this.realWidth]),this.scatterScaleY=this.getScale(this.scatterYAttrib).range([.9*this.realHeight,.05*this.realHeight])))}swapAxis(){var e=this.scatterXAttrib;this.rd.codeBy.scatterX=this.scatterYAttrib,this.rd.codeBy.scatterY=e,this.rd.refreshAttribOptions("scatterX"),this.rd.refreshAttribOptions("scatterY"),this.refreshScales(),this.refreshRecordVis()}zoomIn(){this.scatterZoom.scaleBy(this.DOM.recordBase_Scatter,2)}zoomOut(){this.scatterZoom.scaleBy(this.DOM.recordBase_Scatter,.5)}zoomToFit(){this.scatterZoom.transform(this.DOM.recordBase_Scatter,St.zoomIdentity)}refreshZoomScaleExtent(){this.scatterZoom.translateExtent([[0,0],[this.realWidth,this.realHeight]])}refreshLabelOverlaps(){if(this.initialized&&this.DOM.kshfRecords&&!this.rd.timeseriesAnimInterval){var e=this.browser.activeComparisons,t=this.browser.records.filter((t=>(t._view.hideTextLabel=!0,t.DOM.record&&t._view.textBounds&&t._view.isInScatterPlot&&t._view.isInRange&&t.isIncluded&&(0===e.length||t.isSelected())))),i=this.realWidth*this.realHeight/7e3,s=0;t.forEach(((e,r)=>{if(!(s>i)){delete e._view.hideTextLabel;var a=e._view.textBounds,o=a.width/this.scatterTransform.z,l=a.height/this.scatterTransform.z;e._view.viewBounds={width:o,height:l,left:e._view.x,right:e._view.x+o,top:e._view.y,bottom:e._view.y+l};for(var n=0;n<r;n++){var h=t[n];if(!h._view.hideTextLabel&&Re.intersectsDOMRect(e._view.viewBounds,h._view.viewBounds))return void(e._view.hideTextLabel=!0)}s++}})),this.DOM.kshfRecords.classed("hideTextLabel",(e=>e._view.hideTextLabel))}}refreshRecordSizes(){this.scatterXAttrib&&this.scatterYAttrib&&this.DOM.recordGroup&&(this.DOM.recordGroup.selectAll(".kshfRecord > path").transition().duration(700).ease(St.easePolyOut.exponent(3)).attr("d",(e=>this.rd.recordDrawArc(e)())),this.refreshSelect_Compare())}refreshRecordColors(){if(this.scatterXAttrib&&this.scatterYAttrib&&this.DOM.kshfRecords&&this.DOM.kshfRecords_Path){var e=null;if(this.colorAttrib instanceof Fe){var t=this.colorAttrib,i=this.colorAttrib.isValueScale_Log;e=e=>{if(!e.filteredOut){var s=t.getRecordValue(e);return isNaN(s)||null==s||i&&s<=0?"url(#diagonalHatch)":this.rd.recordColorScale(s)}}}this.DOM.kshfRecords_Path.style("fill",e)}}refreshSelect_Compare(e=null,t=!1){this.refreshLabelOverlaps(),super.refreshSelect_Compare(e,t)}refreshRecordVis(){if(this.initialized&&this.DOM.recordBase_Scatter&&this.DOM.kshfRecords&&this.rd.curHeight){this.refreshScatterTicks();var e=this.scatterAxisScale_X.domain(),t=this.scatterAxisScale_Y.domain();t.reverse();var i=(e,t)=>e>t[0]&&e<t[1];this.DOM.kshfRecords.each((s=>{s._view.wasInScatterPlot=s._view.isInScatterPlot||!1;var r=this.scatterXAttrib.getRecordValue(s),a=this.scatterYAttrib.getRecordValue(s);s._view.isInScatterPlot=null!=r&&null!=a,s._view.isInRange=i(r,e)&&i(a,t)})),this.DOM.kshfRecords.filter((e=>e._view.isInScatterPlot)).classed("noTransition",(e=>!e._view.wasInScatterPlot)).style("transform",(e=>(e._view.x=this.scatterScaleX(e.getValue(this.scatterXAttrib)),e._view.y=this.scatterScaleY(e.getValue(this.scatterYAttrib)),`translate(${e._view.x}px, ${e._view.y}px) scale(${1/this.scatterTransform.z})`))),this.DOM.kshfRecords.classed("hidden",(e=>!e._view.isInScatterPlot))}}refreshScatterTicks(){var e=-this.scatterTransform.x/this.scatterTransform.z,t=e+this.realWidth/this.scatterTransform.z,i=-this.scatterTransform.y/this.scatterTransform.z,s=i+this.realHeight/this.scatterTransform.z;this.scatterAxisScale_X=this.scatterScaleX.copy().range([0,this.realWidth]).domain([this.scatterScaleX.invert(e),this.scatterScaleX.invert(t)]),this.scatterAxisScale_Y=this.scatterScaleY.copy().range([0,this.realHeight]).domain([this.scatterScaleY.invert(i),this.scatterScaleY.invert(s)]),this.scatterAxisScale_X.base&&this.scatterAxisScale_X.base(10),this.scatterAxisScale_Y.base&&this.scatterAxisScale_Y.base(10);var r={X:60,Y:40};this.scatterXAttrib.unitName&&(r.X+=2+8*this.scatterXAttrib.unitName.length);var a=(e,t,i,s)=>{var a=Math.min(15,Math.floor(i/r[e])),o=t.ticks(a).filter((e=>s.hasFloat||e%1==0)),l=0;this.DOM["recordAxis_"+e].select(".tickGroup").selectAll(".hmTicks").data(o,(e=>e)).join((e=>e.append("div").attr("class","hmTicks").call((e=>{e.transition().delay(100).on("start",(function(){this.style.opacity=1})),e.append("div").attr("class","tickText"),e.append("div").attr("class","tickLine")}))),(e=>e),(e=>e.remove())).classed("lineAtZero",(e=>0===e)).style("transform",(i=>`translate${e}(${t(i)}px) translateZ(0)`)).classed("hideLabel",(i=>{var s=t(i);return!(s>=l)||(l=s+r[e]/2,!1)})).selectAll(".tickText").html((e=>s.printAbbr(e)))};a("X",this.scatterAxisScale_X,this.realWidth,this.scatterXAttrib),a("Y",this.scatterAxisScale_Y,this.realHeight,this.scatterYAttrib),this.refreshQueryBox_Filter()}updateAfterFilter(e){this.updateRecordVisibility(),this.refreshLabelOverlaps(),e&&this.refreshRecordVis(),this.refreshRecordColors()}extendRecordDOM(e){e.classed("noTransition",!0),this.extendRecordDOM_Point(e),e.append("foreignObject").attr("width","120").attr("height","1").append("xhtml:div").attr("xmlns","http://www.w3.org/1999/xhtml").attr("class","recordText")}displayQueryBox(e,t){this.initialized&&this.DOM.recordDisplayWrapper.select(".spatialQueryBox_"+e).style("display",t?"block":null)}refreshRecordBounds(){this.initialized&&(this.DOM.kshfRecords.classed("hideTextLabel",!1),this.DOM.kshfRecords.selectAll(".recordText").each(((e,t,i)=>{if(e.DOM.record){var s=i[t],r=s.getBoundingClientRect();s.parentNode.setAttribute("width",1.07*r.width),s.parentNode.setAttribute("height",r.height);var a=r;e.textBounds={width:a.width,height:a.height,left:a.left,right:a.right,top:a.top,bottom:a.bottom}}else delete e.textBounds})))}refreshQueryBox_Filter(e=null){if(!this.rd.collapsed){var t,i,s,r,a,o=!1;null===e?(o=this.scatterXAttrib.isFiltered()||this.scatterYAttrib.isFiltered(),this.scatterXAttrib.isFiltered()?(t=this.scatterXAttrib.summaryFilter.active[0],i=this.scatterXAttrib.summaryFilter.active[1],this.scatterXAttrib.stepTicks&&(t-=.5,i-=.5)):(0===(t=this.scatterXAttrib.rangeOrg[0])&&(t=-1e3),t=t>0?100*-t:100*t,0===(i=this.scatterXAttrib.rangeOrg[1])&&(i=1e3),i=i>0?100*i:100*-i),this.scatterYAttrib.isFiltered()?(s=this.scatterYAttrib.summaryFilter.active[1],r=this.scatterYAttrib.summaryFilter.active[0],this.scatterYAttrib.stepTicks&&(s-=.5,r-=.5)):(0===(s=this.scatterYAttrib.rangeOrg[1])&&(s=1e3),s=s>0?100*s:100*-s,0===(r=this.scatterYAttrib.rangeOrg[0])&&(r=-1e3),r=r>0?100*-r:100*r)):(e.left>e.right&&(a=e.left,e.left=e.right,e.right=a),e.top<e.bottom&&(a=e.top,e.top=e.bottom,e.bottom=a),t=e.left,i=e.right,s=e.top,r=e.bottom),t=this.scatterScaleX(t),isNaN(t)&&(t=-1e3),i=this.scatterScaleX(i),s=this.scatterScaleY(s),r=this.scatterScaleY(r),isNaN(r)&&(r=1e3),t-=3,i+=3,s-=3,r+=3,this.DOM.recordDisplayWrapper.select(".recordGroup_Scatter .spatialQueryBox_Filter").classed("active",!!e||o).style("left",t+"px").style("top",s+"px").style("width",Math.abs(i-t)+"px").style("height",Math.abs(r-s)+"px")}}onRecordMouseOver(e){if(e.moveDOMtoTop(),["X","Y"].forEach(((t,i)=>{var s=this["scatter"+t+"Attrib"],r=s.attribID,a=this["scatterAxisScale_"+t](e._valueCache[r]),o=this.DOM["recordAxis_"+t];o.select(".onRecordLine").style("transform","translate("+a*(i?0:1)+"px,"+a*(i?1:0)+"px)").style("opacity",1),o.select(".onRecordLine > .tickText").html(s.getFormattedValue(e._valueCache[r],!1))})),!this.scatter_showTrails.is(!1)&&this.scatterYAttrib.hasTimeSeriesParent()&&this.scatterXAttrib.hasTimeSeriesParent()){var t=this.scatterXAttrib.timeseriesParent.getRecordValue(e)._keyIndex,i=this.scatterYAttrib.timeseriesParent.getRecordValue(e)._keyIndex,s=[];for(let e in t)i[e]&&s.push({x:t[e]._value,y:i[e]._value});var r=St.line().curve(St.curveNatural||St.curveCatmullRomOpen).x((e=>this.scatterScaleX(e.x))).y((e=>this.scatterScaleY(e.y)));this.DOM.recordTrail.style("opacity",1),this.DOM.recordTrail_Path.style("stroke-width",2/this.scatterTransform.z+"px").attr("d",r(s)),this.DOM.recordTrail.selectAll("circle").data(s).join("circle").attr("r",3).style("transform",(e=>`translate(${this.scatterScaleX(e.x)}px,${this.scatterScaleY(e.y)}px) scale(${1/this.scatterTransform.z})`))}}onRecordMouseLeave(){var e;this.DOM.root.selectAll(".onRecordLine").style("opacity",null),null===(e=this.DOM.recordTrail)||void 0===e||e.style("opacity",0)}}const Dt={area:K,curveMonotoneX:b,easePoly:C};class wt extends We{constructor(e){super(e)}dragRange(e,t,i,s){}refreshViz_Active(){this.isVisible()&&this.DOM.aggrGlyphs&&(super.refreshViz_Active(),this.updateViz_Areas("Active",!this.attrib.stackedCompare&&this.browser.activeComparisonsCount>0))}refreshViz_Compare(e,t,i,s=[]){this.isVisible()&&this.DOM.aggrGlyphs&&(super.refreshViz_Compare(e,t,i,s),this.attrib.stackedCompare&&this.browser.addedCompare&&t===i-1&&this.DOM["measure_Area_"+e].attr("d",this.getVizArea(e,!0)),this.updateViz_Areas(e,!this.attrib.stackedCompare))}insertVizDOM(){this.DOM.timeSVG||(this.DOM.timeSVG=this.DOM.histogram.append("svg").attr("class","timeSVG").attr("xmlns","http://www.w3.org/2000/svg").style("margin-left",ae.width_HistBarGap/2+"px"),this.DOM.timeSVG.append("defs").selectAll("marker").data(ae.Active_Compare_List.map((e=>"kshfLineChartTip_"+e))).enter().append("marker").attr("id",(e=>e)).attr("patternUnits","userSpaceOnUse").attr("viewBox","0 0 20 20").attr("refX",10).attr("refY",10).attr("markerUnits","strokeWidth").attr("markerWidth",9).attr("markerHeight",9).attr("orient","auto").append("circle").attr("r",4).attr("cx",10).attr("cy",10),["Total","Active"].concat(Array.from(ae.Compare_List).reverse()).forEach((e=>{this.DOM["measure_Area_"+e]=this.DOM.timeSVG.append("path").attr("class","measure_Area_"+e+" measure_"+e).attr("marker-mid","url(#kshfLineChartTip_"+e+")").attr("marker-end","url(#kshfLineChartTip_"+e+")").attr("marker-start","url(#kshfLineChartTip_"+e+")")}))),ae.Total_Active_Compare_List.forEach((e=>{this.DOM["measure_Area_"+e].datum(this._aggrs).attr("d",Dt.area().curve(Dt.curveMonotoneX).x(this.attrib.timeAxis_XFunc).y0(this.height_hist-this.measureLineZero+2).y1(this.height_hist-this.measureLineZero+2))})),super.insertVizDOM()}getVizArea(e,t){if("Other"!==e){var i=Dt.area().curve(Dt.curveMonotoneX).x(this.attrib.timeAxis_XFunc).y((t=>this.height_hist-t.sumOffsetScale(e)));return t||i.y1((t=>this.height_hist-t.offset(e))),i}}updateViz_Areas(e,t){if("Other"!==e)return this.DOM["measure_Area_"+e].classed("asLine",t).transition().duration(this.browser.noAnim?0:800).ease(Dt.easePoly.exponent(3)).attr("d",this.getVizArea(e,t))}showValuePicker(e,t){if(void 0!==H){var i=!1,s=e.pikaday,r=W.now().offset,a=()=>{var e=this.attrib.summaryFilter.active,a=W.fromJSDate("min"===t?e.minV:e.maxV,{zone:"UTC"}).plus({minutes:-r}).toJSDate();i=!0,s.setDate(a)};if(!s){var o=this;e.pikaday=s=new window.Pikaday({field:e,firstDay:1,minDate:this.attrib.rangeOrg[0],maxDate:this.attrib.rangeOrg[1],onSelect:function(){if(i)i=!1;else{var e=this.getDate();e=W.fromJSDate(e,{zone:"UTC"}).plus({minutes:r}).toJSDate(),("min"===t&&e<o.attrib.summaryFilter.active.minV||"max"===t&&e>o.attrib.summaryFilter.active.maxV)&&o.zoomed.set(!1);var s=o.attrib.summaryFilter.active.minV,l=o.attrib.summaryFilter.active.minV;"min"===t&&(s=e),"max"===t&&(l=e),o.attrib.setRangeFilter_Custom(s,l),a()}}})}a(),s.show()}}getScaleNicing(){return this.width_histogram/(this.inDashboard?this.optimumBinWidth.get():10)*1}hasStaticHeight(){return this.showHistogram.is(!1)}zoomableStatus(){return this.attrib.stepTicks&&this.attrib.timeTyped.finestRes()===this.attrib.timeTyped.activeRes.type?this.zoomed.get()?"minus":"":"plus"}}const Ot={utcFormat:U};class Tt extends ke{get label(){if(null==this.minV||null==this.maxV)return"-";var e=W.fromJSDate(this.maxV,{zone:"UTC"}),t=W.fromJSDate(this.minV,{zone:"UTC"}),i=$.fromDateTimes(t,e).toDuration("days").toObject().days;if(Math.abs(i-365)<2&&1===e.month&&1===e.day)return Ot.utcFormat("%Y")(this.minV);if(Math.abs(i-30)<3&&1===t.day&&1===e.day)return Ot.utcFormat("%b %Y")(this.minV);var s=this.attrib.getFormattedValue(this.minV,!1),r=this.attrib.getFormattedValue(this.maxV,!1);return`${this.isMinLarger()?s:""} ... ${this.isMaxSmaller()?r:""}`}}const xt={scaleUtc:Y,utcFormat:U,utcSecond:j,utcMinute:X,utcHour:Z,utcDay:q,utcWeek:J,utcMonth:Q,utcYear:ee};class Vt extends Fe{initTimeTyped(){this.timeTyped.year=!1,this.timeTyped.month=!1,this.timeTyped.day=!1,this.timeTyped.hour=!1,this.timeTyped.minute=!1,this.timeTyped.second=!1;var e=null;this.records.forEach((t=>{var i=this.getRecordValue(t);i&&(0!==i.getUTCMonth()&&(this.timeTyped.month=!0),0!==i.getUTCHours()&&(this.timeTyped.hour=!0),0!==i.getUTCMinutes()&&(this.timeTyped.minute=!0),1!==i.getUTCDate()&&(this.timeTyped.day=!0),this.timeTyped.year||(null===e?e=i.getUTCFullYear():e!==i.getUTCFullYear()&&(this.timeTyped.year=!0)))}))}constructor(e,t,i){super(e,t,i,"timestamp","kshfSummary_Timestamp","far fa-calendar-day"),this._block=new wt(this),this.timeAxis_XFunc=e=>(this.valueScale(e.minV)+this.valueScale(e.maxV))/2,this.configs.showHistogram.cfgTitle="Line Chart",this.timeTyped={finestRes:function(){return this.second?"Second":this.minute?"Minute":this.hour?"Hour":this.day?"Day":this.month?"Month":this.year?"Year":void 0}}}createAggregate(e,t){return new Tt(this,e,t)}supportsRecordEncoding(e){return!this.isEmpty()&&("sort"===e||("text"===e||"textBrief"===e))}getFormattedValue(e){return e instanceof Date?this.intervalTickPrint(e):e}getValuePosX(e){var t=0;return this.stepTicks&&(t+=this.block.aggrWidth/2),this.valueScale(e)+t}getValueScaleObj(){return xt.scaleUtc()}refreshScaleType(){}fillValueCache(){this.records.forEach((e=>{var t=this.template.func.call(e.data,e);void 0===t&&(t=null),t instanceof Date||(t=null),e.setValue(this,t),null==t&&this.noValueAggr.addRecord(e)})),this.initTimeTyped()}pofffff(){this.updateScaleAndBins()}refreshValueScale(){super.refreshValueScale();let e=xt["utc"+this.timeTyped.finestRes()];if(this.intervalTicks.some((t=>e(t)<t))){let t=e;this.valueScale=this.getValueScaleObj().domain(this.rangeActive).range([0,this.block.width_histogram]).nice(e),this.intervalTicks=this.valueScale.ticks(t)}}updateTickPrintFunc(){const e=xt.utcFormat(":%S"),t=xt.utcFormat("%I:%M"),i=xt.utcFormat("%I %p"),s=xt.utcFormat("%a %d"),r=xt.utcFormat("%b %d"),a=xt.utcFormat("%b"),o=xt.utcFormat("%Y");this.intervalTickPrint=l=>(xt.utcMinute(l)<l?e:xt.utcHour(l)<l?t:xt.utcDay(l)<l?i:xt.utcMonth(l)<l?xt.utcWeek(l)<l?s:r:xt.utcYear(l)<l?a:o)(l)}}const Rt={select:a,pointer:_,scaleTime:S,scaleLinear:n,extent:l,arc:v};class kt extends vt{prepareAttribs(){return e(this,void 0,void 0,(function*(){return this.sortAttrib||(yield this.rd.setAttrib("sort",this.rd.config.sortBy||0)),Promise.resolve(null!==this.sortAttrib)}))}constructor(t,i){super(t),this._recordGroupScroll=null,this.animatedList=!1,this.list_showRank=new xe({cfgClass:"list_showRank",cfgTitle:"Ranking",iconXML:"⩔",default:!1,parent:this,helparticle:"5e88d84d04286364bc97d40f",tooltip:"The ranking column",itemOptions:[{name:"Hide",value:!1},{name:"Show",value:!0}],onSet:()=>{this.initialized&&this.refreshShowRank()}}),this.list_sortVizRange=new xe({cfgClass:"list_sortVizRange",cfgTitle:"Sorting Vis Axis",iconClass:"fa fa-long-arrow-right",default:"dynamic",parent:this,tooltip:"The viz scale used for sorting column",itemOptions:[{name:"Static",value:"static"},{name:"Dynamic",value:"dynamic"}],onSet:()=>{this.initialized&&this.refreshSortVizScale()}}),this.list_ViewType=new xe({cfgClass:"list_ViewType",cfgTitle:"List Type",iconClass:"fa fa-list",default:"List",parent:this,helparticle:"5f107e492c7d3a10cbaacc43",itemOptions:[{name:"List <i class='fa fa-bars'></i>",value:"List"},{name:"Grid <i class='fa fa-th'></i>",value:"Grid"}],onSet:t=>e(this,void 0,void 0,(function*(){var e,i;this.DOM.root.attr("data-list_ViewType",t),this.initialized&&(this.refreshWidthControls(),"List"===t?(yield null===(e=this.list_sortVizWidth)||void 0===e?void 0:e.reset(),yield null===(i=this.list_sparklineVizWidth)||void 0===i?void 0:i.reset()):this.refreshSparklineViz())}))}),this.list_sortInverse=new xe({cfgClass:"list_sortInverse",cfgTitle:"Sorting Order",iconClass:"fa fa-sort-amount-asc",default:!1,parent:this,helparticle:"5e87f08e2c7d3a7e9aea6081",itemOptions:[{name:"Large to small",value:!1},{name:"Small to large",value:!0}],onSet:()=>{var e;this.initialized&&(this.reverseOrder(),null===(e=this.DOM.root)||void 0===e||e.select(".recordReverseSortButton").classed("sortInverse",this.list_sortInverse.is(!0)))}}),this.list_sortColWidth=new xe({cfgClass:"list_sortColWidth",cfgTitle:"Sorting Value Width",iconClass:"fa fa-arrows-h",default:60,parent:this,helparticle:"5f107eb904286306f806ec35",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{_type:"_range_",minValue:40,maxValue:120},{name:"<i class='fa fa-plus'></i>",value:-199,_type:"plus"}],preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-5:-199===t&&(t=i._value+5),Math.max(40,Math.min(120,t))})),onSet:e=>{this.browser.DOM.root.node().style.setProperty("--list_sortColWidth",e+"px"),this.refreshSortColumnWidth()}}),this.list_sortVizWidth=new xe({cfgClass:"list_sortVizWidth",cfgTitle:"Sorting Bar Width",iconClass:"fa fa-arrows-h",default:80,parent:this,helparticle:"5e87f23c04286364bc97d0e3",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{name:"Off",value:0},{_type:"_range_",minValue:40,maxValue:400},{name:"<i class='fa fa-plus'></i>",value:-199,_type:"plus"}],forcedValue:e=>this.sortAttrib instanceof Vt?0:this.list_ViewType.is("Grid")&&0!==e._value?this.list_gridRecordWidth.get()-10:void 0,preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-5:-199===t&&(t=i._value+5),t<40?0:Math.min(400,t)})),onSet:e=>{this.initialized&&(this.browser.DOM.root.node().style.setProperty("--list_sortVizWidth",e+"px"),this.browser.DOM.root.classed("noAnim",!0),this.refreshSortVizWidth(),setTimeout((()=>this.browser.DOM.root.classed("noAnim",!1)),1e3))}}),this.list_sparklineVizWidth=new xe({cfgClass:"list_sparklineVizWidth",cfgTitle:"Sparkline Width",iconClass:"far fa-chart-line",default:120,parent:this,helparticle:"5e87f16904286364bc97d0e2",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{name:"Off",value:0},{_type:"_range_",minValue:50,maxValue:300},{name:"<i class='fa fa-plus'></i>",value:-199,_type:"plus"}],forcedValue:e=>{var t;return(null===(t=this.sortAttrib)||void 0===t?void 0:t.hasTimeSeriesParent())?this.list_ViewType.is("Grid")&&0!==e._value?this.list_gridRecordWidth.get()-10:void 0:0},preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-5:-199===t&&(t=i._value+5),t<50?0:Math.min(300,t)})),onSet:e=>{this.initialized&&(this.browser.DOM.root.node().style.setProperty("--list_sparklineVizWidth",e+"px"),this.refreshSparklineVizWidth())}}),this.list_gridRecordWidth=new xe({cfgClass:"list_gridRecordWidth",cfgTitle:"Grid Record Width",iconClass:"fa fa-arrows-h",default:200,parent:this,helparticle:"5f10800c04286306f806ee67",itemOptions:[{name:"<i class='fa fa-minus'></i>",value:-99,_type:"minus"},{_type:"_range_",minValue:100,maxValue:400},{name:"<i class='fa fa-plus'></i>",value:-199,_type:"plus"}],preSet:(t,i)=>e(this,void 0,void 0,(function*(){return-99===t?t=i._value-5:-199===t&&(t=i._value+5),Math.max(100,Math.min(500,t))})),onSet:e=>{this.initialized&&(this.browser.DOM.root.node().style.setProperty("--list_gridRecordWidth",e+"px"),this.refreshSparklineViz())}}),["list_ViewType","list_sortInverse","list_showRank","list_sortColWidth","list_sortVizWidth","list_sortVizRange","list_sparklineVizWidth","list_gridRecordWidth"].forEach((e=>{this[e].set(i[e]),this.rd.configs[e]=this[e],this.rd.recordConfigPanel.insertConfigUI(this[e])})),this.maxVisibleItems_Default=i.maxVisibleItems_Default||ae.maxVisibleItems_Default,this.maxVisibleRecords=this.maxVisibleItems_Default}initView(){this.rd.refreshAttribOptions("sort"),this.DOM.root.attr("data-list_ViewType",this.list_ViewType.get()),this.refreshSortColumnWidth(),this.refreshSortVizWidth(),this.refreshSparklineVizWidth(),this.DOM.kshfRecords=this.DOM.recordGroup_List.selectAll(".kshfRecord"),this.updateRecordSortScale(),this.refreshRecordVis()}initView_DOM(){return e(this,void 0,void 0,(function*(){var t=this.browser.DOM.root.node().style;if(t.setProperty("--list_sortColWidth",this.list_sortColWidth.get()+"px"),t.setProperty("--list_sortVizWidth",this.list_sortVizWidth.get()+"px"),t.setProperty("--list_sparklineVizWidth",this.list_sparklineVizWidth.get()+"px"),t.setProperty("--list_gridRecordWidth",this.list_gridRecordWidth.get()+"px"),this.DOM.recordGroup_List)return this.DOM.recordGroup=this.DOM.recordGroup_List.select(".recordGroup"),this.DOM.kshfRecords=this.DOM.recordGroup.selectAll(".kshfRecord"),void this.DOM.tableHeaderGroup.node().insertBefore(this.DOM.sortControlGroup.node(),this.DOM.tableConfigGap.node());this.DOM.recordGroup_List=this.rd.DOM.recordDisplayWrapper.append("div").attr("class","recordGroup_List"),this.DOM.tableHeaderGroup=this.DOM.recordGroup_List.append("div").attr("class","tableHeaderGroup"),this.DOM.tableHeaderGroup.append("div").attr("class","showRecordRank").append("span").html("Rank"),this.rd.DOM.sortControlGroup=this.DOM.tableHeaderGroup.append("span").attr("class","sortControlGroup attribControlGroup"),this.rd.initDOM_AttribSelect("sort"),this.rd.DOM.sortControlGroup.append("span").attr("class","recordReverseSortButton sortButton").classed("sortInverse",this.list_sortInverse.is(!0)).tooltip(me.ReverseOrder).on("click",(()=>e(this,void 0,void 0,(function*(){return yield this.list_sortInverse.set(!this.list_sortInverse.get())})))).append("span").attr("class","fa"),this.DOM.tableConfigGap=this.DOM.tableHeaderGroup.append("span").attr("class","gap");var i=()=>{this.maxVisibleRecords+=this.maxVisibleItems_Default,this.rd.refreshRecordDOM()};this.DOM.recordGroup=this.DOM.recordGroup_List.append("div").attr("class","recordGroup").on("scroll",(()=>{if(this.maxVisibleRecords<=this.browser.allRecordsAggr.recCnt("Active")){var e=this.DOM.recordGroup.node();if(!this._recordGroupScroll){var t=window.getComputedStyle(e);"hidden"===t.overflowY&&"scroll"===t.overflowX?this._recordGroupScroll="left-right":"hidden"===t.overflowX&&"scroll"===t.overflowY&&(this._recordGroupScroll="top-down")}"left-right"===this._recordGroupScroll&&e.scrollWidth-e.scrollLeft-e.offsetWidth<500&&i(),"top-down"===this._recordGroupScroll&&e.scrollHeight-e.scrollTop-e.offsetHeight<10&&i()}}));var s=(e,t)=>{if(1===e.which){var i=t.val-Rt.pointer(e,document.body)[0];this.browser.activateWidthDrag(e.currentTarget,e,(e=>{t.val=i+Rt.pointer(e,document.body)[0]}))}};this.DOM.adjustSortColumnWidth=this.DOM.recordGroup_List.append("div").attr("class","adjustSortColumnWidth dragWidthHandle").on("mousedown",(e=>s(e,this.list_sortColWidth))),this.DOM.adjustSortVizWidth=this.DOM.recordGroup_List.append("div").attr("class","adjustSortVizWidth dragWidthHandle").on("mousedown",(e=>s(e,this.list_sortVizWidth))),this.DOM.adjustSparklineVizWidth=this.DOM.recordGroup_List.append("div").attr("class","adjustSparklineVizWidth dragWidthHandle").on("mousedown",(e=>s(e,this.list_sparklineVizWidth))),this.refreshSortVizWidth(),this.refreshWidthControls()}))}extendRecordDOM(e){this.animatedList&&e.style("transform",`translateY(${this.maxVisibleRecords*this.animatedRecordHeight}px)`);var t=e.append("span").attr("class","recordRank").tooltip("-").on("mouseenter",((e,t)=>{e.currentTarget.setAttribute("title",Re.ordinal_suffix_of(t.recordRank+1))})).append("span");this.refreshRecordRanks(t),this.DOM.recordRanks=this.DOM.recordGroup.selectAll(".recordRank > span");var i=(e,t)=>{this.browser.recordDetailsPopup.updateRecordDetailPanel(t),this.sortAttrib instanceof Ye&&this.sortAttrib.timeKey&&this.browser.recordDetailsPopup.updateFocusedTimeKey(this.sortAttrib.timeKey)};e.append("div").attr("class","recordSparklineVizHost"),e.append("div").attr("class","recordSortValue").on("click",i),e.append("div").attr("class","recordSortVizHost").on("click",i).append("div").attr("class","recordSortViz"),this.DOM.recordSortValue=this.DOM.recordGroup.selectAll(".recordSortValue"),this.DOM.recordSortVizHost=this.DOM.recordGroup.selectAll(".recordSortVizHost"),this.DOM.recordSortViz=this.DOM.recordGroup.selectAll(".recordSortViz"),this.DOM.recordSparklineVizHost=this.DOM.recordGroup.selectAll(".recordSparklineVizHost"),this.refreshSortViz(e),this.refreshSparklineViz(),this.refreshSortingLabels(e),e.append("div").attr("class","content").html((e=>this.textAttrib.renderRecordValue(e))).on("click",i),e.append("svg").attr("class","compareBoxes").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("viewBox","-100 -100 200 200").call((e=>{ae.Compare_List.forEach((t=>{e.append("path").attr("class","glyph_"+t)}))})),this.DOM.recordGroup.selectAll(".kshfRecord").data(this.getRecordsForDOM(),(e=>e.id)).order()}finishSetAttrib(t){return e(this,void 0,void 0,(function*(){"sort"===t&&(this.sortRecords(),this.refreshSortVizWidth(),this.DOM.recordGroup_List&&(this.rd.refreshRecordDOM(),this.refreshRecordDOMOrder(),this.refreshRecordRanks(),this.refreshSortingLabels(),this.refreshSparklineViz(),this.rd.config.recordRefresh&&this.DOM.kshfRecords.each((e=>{this.rd.config.recordRefresh.call(e.data,e,this)})))),"text"===t&&this.DOM.kshfRecords.selectAll(".content").html((e=>this.textAttrib.renderRecordValue(e)))}))}reverseOrder(){this.browser.records.reverse();for(var e=this.browser.records,t=e.length,i=0;i<t;i++){var s=this.sortAttrib.getRecordValue(e[0]);if(null!=s)break;e.push(e.shift())}this.refreshRecordVis(),this.refreshRecordDOMOrder()}sortRecords(){var e=this.sortAttrib;if(e){var t=this.getSortFunc(e.template.func),i=this.list_sortInverse.is(!0);this.browser.records.sort(((s,r)=>{var a=e.getRecordValue(s),o=e.getRecordValue(r);if(null==a&&null!=o)return 1;if(null==o&&null!=a)return-1;if(null==o&&null==a)return 0;var l=t(a,o);return i?-l:l})),this.updateRecordRanks()}}getSortFunc(e){for(var t,i=0,s=0;3!==s&&i!==this.browser.records.length;i++){var r=this.browser.records[i],a=e.call(r.data,r);if(null!=a&&""!==a){var o;switch(typeof a){case"string":o=Re.sortFunc_List_String;break;case"number":default:o=Re.sortFunc_List_Number;break;case"object":o=a instanceof Date?Re.sortFunc_List_Date:Re.sortFunc_List_Number}o===t?s++:(t=o,s=0)}}return t}updateRecordRanks(){var e=0,t=-1,i=null,s=null;this.browser.records.forEach((r=>{var a=this.sortAttrib.getRecordValue(r);a instanceof Date&&(a=a.getTime()),r.recordRank=r.isIncluded?a===i?s:e:t,r.recordRank_Unique=r.isIncluded?e:t,r.isIncluded&&a!==i&&(i=a,s=r.recordRank),r.isIncluded?e++:t--})),this.maxVisibleRecords=this.maxVisibleItems_Default}refreshShowRank(){this.DOM.root.classed("showRank",this.list_showRank.is(!0)),this.refreshRecordRanks(),this.refreshWidthControls()}refreshRecordRanks(e=null){this.list_showRank.is(!1)||(null===e&&(e=this.DOM.recordRanks),e.text((e=>e.recordRank<0?"":e.recordRank+1)))}updateRecordVisibility(){this.DOM.kshfRecords.classed("rankBeyondListRange",(e=>e.recordRank<0||e.recordRank>=this.maxVisibleRecords))}getRecordsForDOM(){return this.browser.records.filter((e=>!e.filteredOut&&e.recordRank<this.maxVisibleRecords))}refreshWidthControls(){var e,t,i,s;if(this.rd.codeBy.sort){var r=this.list_showRank.is(!0)?ae.recordRankWidth:0,a=this.list_sortColWidth.get(),o=this.list_sortVizWidth.get(),l=this.list_sparklineVizWidth.get()?this.list_sparklineVizWidth.get()+8:0;null===(e=this.DOM.adjustSparklineVizWidth)||void 0===e||e.style("transform",`translateX(${r+l}px`),null===(t=this.DOM.adjustSortColumnWidth)||void 0===t||t.style("transform",`translateX(${r+l+a}px)`),null===(i=this.DOM.adjustSortVizWidth)||void 0===i||i.style("transform",`translateX(${r+l+a+o}px)`);var n=Math.max(150,Math.min(500,l+a+o+2));this.list_ViewType.is("Grid")&&(n=200),null===(s=this.DOM.sortControlGroup)||void 0===s||s.select(".choices").style("width",n+"px")}}refreshSortVizScale(){var e=this.sortAttrib;if(e instanceof Ye){if(this.listSortVizScale=Rt.scaleLinear().range([0,this.list_sortVizWidth.get()]),e.isPercentageUnit())this.listSortVizScale.domain([0,100]);else if(this.list_sortVizRange.is("dynamic")){let[e,t]=Rt.extent(this.browser.records,(e=>e.filteredOut?null:this.sortAttrib.getRecordValue(e)));this.listSortVizScale.domain([Math.min(0,e),Math.max(0,t)])}else this.list_sortVizRange.is("static")&&this.listSortVizScale.domain(this.sortAttrib.rangeOrg);this.refreshSortViz()}}refreshSelect_Compare(e=null,t=!1){if(this.isComparable()){var i=Rt.arc().innerRadius(10).outerRadius(100).padAngle(.15),s=this.DOM.kshfRecords.filter((i=>!!i.isIncluded&&(!!i.DOM.record&&(!e||i.isSelected(e)===t))));e&&(s=s.filter((i=>i.isSelected(e)!==t))),s.each((e=>{let t=e.activeComparisons.length||1,s=2*Math.PI/t,r=Rt.select(e.DOM.record);e.activeComparisons.forEach(((e,t)=>{r.select(".glyph_"+e).attr("d",i({startAngle:s*t,endAngle:s*(t+1)}))}))}))}}refreshSortColumnWidth(){this.refreshWidthControls()}refreshSortVizWidth(){this.refreshSortVizScale(),this.DOM.root.classed("showSortBars",this.list_sortVizWidth.get()>0),this.refreshWidthControls()}refreshSparklineVizWidth(){this.DOM.recordSparklineVizHost&&(this.DOM.recordSparklineVizHost.style("display",0===this.list_sparklineVizWidth.get()?"none":null),this.refreshSparklineViz(),this.refreshWidthControls())}refreshRecordVis(){this.updateRecordRanks(),this.rd.refreshRecordDOM(),this.animateList(),this.refreshRecordRanks(),this.refreshSortViz(),this.refreshSparklineViz()}refreshSortViz(e=null){var t=e?e.select(".recordSortViz"):this.DOM.recordSortViz;if(t&&0!==t.nodes().length)if(this.sortAttrib instanceof Ye){var i=this.listSortVizScale(0);t.style("transform",(e=>{var t=this.sortAttrib.getRecordValue(e);return`translate(${t>=0?i:this.listSortVizScale(t)}px, 0px) scale(${null==t?0:Math.abs(this.listSortVizScale(t)-i)},1)`}))}else t.style("width","0px").style("left",null)}refreshSparklineViz(){var t=this.sortAttrib;if(t&&t instanceof Ye&&t.hasTimeSeriesParent()&&this.DOM.recordSparklineVizHost&&(this.DOM.recordSparklineVizHost.style("display",0===this.list_sparklineVizWidth.get()?"none":null),0!==this.list_sparklineVizWidth.get())){var i=t.timeseriesParent,s=Rt.scaleTime().domain(i.timeSeriesScale_Time.domain()).range([0,this.list_sparklineVizWidth.get()]),r=Rt.scaleLinear().domain(i.timeSeriesScale_Value.domain()).rangeRound([27,3]),a=t.timeKey._time,o=(e,o,l)=>{var n=t.getRecordValue(e);if(null==n)return"translate(-1000,0)";var h=s(a),c=i.getRecordValue(e);r.domain(c.extent_Value_raw);var d=r(n);return l[o].classList[d>13?"add":"remove"]("upper"),`translate(${h},${d})`};this.DOM.recordSparklineVizHost.selectAll("*").remove();var l=this.DOM.recordSparklineVizHost.append("svg").attr("xmlns","http://www.w3.org/2000/svg").on("mouseleave",(e=>{Rt.select(e.currentTarget.children[1]).attr("transform",o)})).on("mousemove",(e=>{var t=s.invert(Rt.pointer(e,e.currentTarget)[0]),a=9999999999999,o=i.timeKeys[0];i.timeKeys.some((e=>{var i=Math.abs(+e._time-+t);return i>a||(a=i,o=e,!1)})),Rt.select(e.currentTarget.children[1]).attr("transform",((e,t,a)=>{var l=s(o._time),n=i.getRecordValue(e);r.domain(n.extent_Value_raw);var h=n._timeseries_.find((e=>e._time_src===o._time_src));let c=h?h._value:null;var d=r(c);if(null==d)return"translate(-100,-100)";var u=a[t];return d>13?u.classList.add("upper"):u.classList.remove("upper"),`translate(${l},${d})`})),Rt.select(e.currentTarget.children[1].children[1]).text(o._time_src)}));l.append("path").attr("class","timeline").attr("d",(e=>{var t=i.getRecordValue(e);if(t&&t.extent_Value_raw)return r.domain(t.extent_Value_raw),Re.getLineGenerator(s,r)(t._timeseries_)}));var n=l.append("g").attr("transform",o).on("click",(t=>e(this,void 0,void 0,(function*(){var e=s.invert(Rt.pointer(t,t.currentTarget.parentNode)[0]),r=9999999999999,a=i.timeKeys[0];i.timeKeys.some((t=>{var i=Math.abs(+t._time-+e);return i>r||(r=i,a=t,!1)})),yield this.rd.currentTimeKey.set(a)}))));n.append("circle").attr("class","activeDot").attr("r",3),n.append("text").attr("class","timekeyText").attr("y",15).text(t.timeKey._time_src)}}animateList(){this.animatedList&&(this.DOM.recordGroup_List.classed("animatedList",!0),this.DOM.kshfRecords.style("transform",(e=>`translateY(${e.recordRank_Unique*this.animatedRecordHeight}px)`)))}refreshRecordDOMOrder(){this.animatedList||(this.DOM.kshfRecords=this.DOM.recordGroup.selectAll(".kshfRecord").data(this.browser.records,(e=>e.id)).order()),Re.scrollToPos_do(this.DOM.recordGroup,0),this.animateList()}refreshSortingLabels(e=null){if(this.sortAttrib){var t=this.sortAttrib.sortLabel,i=e?e.selectAll(".recordSortValue"):this.DOM.recordSortValue;i&&i.html((e=>{var i=t.call(this,e);return""===i||null===i||"NaN"===i?"N/A":i}))}}updateAfterFilter(){this.DOM.recordGroup.node().scrollTop=0,this.list_sortVizRange.is("dynamic")&&this.refreshSortVizScale(),this.refreshRecordVis()}updateRecordSortScale(){var e;this.DOM.root.attr("sortAttribType",this.sortAttrib instanceof Ye?"numeric":"time"),this.DOM.root.classed("sortAttribOnTimeseries",this.sortAttrib instanceof Ye&&(null===(e=this.sortAttrib.timeseriesParent)||void 0===e?void 0:e.timeKeys.length)>1||null)}refreshAttribUnitName(e){(e===this.sortAttrib||this.sortAttrib instanceof Ye&&e===this.sortAttrib.timeseriesParent)&&this.refreshSortingLabels()}refreshViewSize(e){}}const Lt={select:a,scaleLinear:n,scaleSqrt:te,scaleThreshold:ie,scaleTime:S,max:d,extent:l,quantile:y,easePolyInOut:C,format:m,hsl:D,arc:v};class Pt{setView(t){return e(this,void 0,void 0,(function*(){if("none"!==t){if(!this.Views[t]){var e=this.browser.options.recordDisplay||{};"list"===t?this.Views[t]=new kt(this,e):"map"===t?this.Views[t]=new Mt(this,e):"scatter"===t?this.Views[t]=new Ct(this,e):"timeseries"===t&&(this.Views[t]=new yt(this,e))}if(this.View=this.Views[t],!this.codeBy.text){var i=this.browser.attribs.filter((e=>e instanceof mt));if(0===i.length)throw new Error("Data must have at least one categorical attribute.");var s=i[0];i.forEach((e=>{s._aggrs.length<e._aggrs.length&&(s=e)})),this.codeBy.text=s}this.recordConfigPanel.hide(),yield this.View.initView_DOM(),yield this.View.prepareAttribs(),this.refreshViewAsOptions(),this.View.initView(),this.View.initialized=!0,this.View.updateRecordVisibility(),this.refreshWidth(),this.View.refreshViewSize(10)}else this.View=null}))}constructor(t,i){if(this.codeBy={text:null,textBrief:null,sort:null,scatterX:null,scatterY:null,size:null,color:null,timeSeries:null,geo:null},this.invertedColorTheme=!1,this.recordColorStepTicks=!1,this.recordColorScale=null,this.recordColorScaleTicks=null,this.mapColorScalePos=null,this.timeKeys=[],this.timeKeySlider_PauseUpdate=!0,this.textFilter=null,this.recordFilter=null,this.collapsed=!1,this.DOM={},this.Views={},this.configs={},this.visMouseMode="pan",this.kshfRecords_Type="none",this.attribDropdowns={},this.timeseriesAnimInterval=0,this.skipRefreshRecordVis=!1,this.sparklineCounter=0,this.browser=t,this.recordFilter=new fe(this.browser),this.config=Object.assign({},i),!1!==this.config.mapUsePins&&(this.config.mapUsePins=!0),this.recordPointSize=new xe({cfgClass:"recordPointSize",cfgTitle:"Point Size",iconClass:"fa fa-dot",UI:{disabled:!0},default:ae.defaultRecordPointSize,parent:this,helparticle:"5e8907cf2c7d3a7e9aea6499",preSet:t=>e(this,void 0,void 0,(function*(){return Math.max(.5,Math.min(t,ae.maxRecordPointSize))})),onSet:()=>e(this,void 0,void 0,(function*(){this.recordPointSize&&this.updateRecordSizeScale()}))}),this.currentTimeKey=new xe({cfgClass:"currentTimeKey",cfgTitle:"Focused Time Key",iconClass:"fa fa-arrows-v",default:null,parent:this,UI:{disabled:!0},helparticle:"5b37053a2c7d3a0fa9a3a30c",onRefreshDOM:()=>{this.DOM.root&&(this.DOM.root.classed("hasTimeKey",this.hasTimeKey),this.currentTimeKey.get()&&this.DOM.timeAnimation&&this.hasTimeKey&&(this.DOM.timeAnimation.select(".rangeTick-min").text(this.timeKeys[0]._time_src),this.DOM.timeAnimation.select(".rangeTick-max").text(this.timeKeys[this.timeKeys.length-1]._time_src),this.DOM.timeAnimation.select(".rangeTick-cur").text(this.currentTimeKey.get()._time_src).style("left",100*this.currentTimeKey.get()._index/(this.timeKeys.length-1)+"%"),this.timeKeySlider_PauseUpdate=!0,this.timeKeySlider.updateOptions({range:{min:0,max:Math.max(1,this.timeKeys.length-1)}}),this.timeKeySlider.setHandle(0,this.currentTimeKey.get()._index,!1),this.timeKeySlider_PauseUpdate=!1,this.DOM.timeAnimation.select(".timeKeySelect").selectAll("option").data(this.timeKeys,(e=>e._time)).join((e=>e.append("option").text((e=>e._time_src))),(e=>e),(e=>e.remove())).attr("selected",(e=>e._time_src===this.currentTimeKey.get()._time_src||null))))},preSet:(t,i)=>e(this,void 0,void 0,(function*(){if("previous"===t&&i._value&&(t=this.timeKeys[i._value._index-1]),"next"===t&&i._value&&(t=this.timeKeys[i._value._index+1]),t&&t._time_src&&(t=this.timeKeys.find((e=>e._time_src===t._time_src))))return t})),onSet:t=>e(this,void 0,void 0,(function*(){var e;if(t){if(this.skipRefreshRecordVis=!0,["sort","scatterX","scatterY","color","size"].forEach((e=>{var i,s=this.codeBy[e];s instanceof Ye&&(null===(i=s.timeKey)||void 0===i?void 0:i._time_src)!==t._time_src&&this.setAttrib(e,s.timeseriesParent.getTimepointSummary({_time_src:t._time_src}))})),this.skipRefreshRecordVis=!1,this.refreshRecordVis(),null===(e=this.measureSummary)||void 0===e?void 0:e.hasTimeSeriesParent()){var i=this.measureSummary.timeseriesParent.getTimepointSummary(t);i&&(yield this.browser.measureSummary.set(i))}this.DOM.timeAnimation.select(".timeKeyPrev").classed("active",t._time_src!==this.timeKeys[0]._time_src),this.DOM.timeAnimation.select(".timeKeyNext").classed("active",t._time_src!==this.timeKeys[this.timeKeys.length-1]._time_src)}}))}),["currentTimeKey","recordPointSize"].forEach((e=>{this.configs[e]=this[e],this[e].val=i[e]})),i.timeSeriesAnnotations){var s=[];Object.keys(i.timeSeriesAnnotations).forEach((e=>{var t=i.timeSeriesAnnotations[e],r=W.fromFormat(t,W.DATE_SHORT,{zone:"UTC"});r.isValid&&s.push({_time:r.toJSDate(),_time_src:e,_text:t})})),this.config.timeSeriesAnnotations=s}i.timeseriesWidth=i.timeseriesWidth||400}get viewRecAs(){return this.browser.recordChartType.get()}initialize(){var t;return e(this,void 0,void 0,(function*(){var i=this.config;for(var s in this.DOM.root=this.browser.DOM.root.select(".recordDisplay").attr("visMouseMode",this.visMouseMode),this.DOM.root.append("div").attr("class","dropZone").on("mouseenter",(function(){this.classList.add("onReadyToDrop")})).on("mouseleave",(function(){this.classList.remove("onReadyToDrop")})).on("mouseup",(()=>e(this,void 0,void 0,(function*(){if("none"===this.viewRecAs){var e=this.browser.movedAttrib;e&&(e instanceof mt?(yield this.setAttrib("text",e),"none"===this.viewRecAs&&(yield this.browser.recordChartType.set("list"))):e instanceof rt?(yield this.setAttrib("timeSeries",e),yield this.browser.recordChartType.set("timeseries")):e instanceof tt?(yield this.setAttrib("geo",e),yield this.browser.recordChartType.set("map")):e instanceof Fe&&(yield this.setAttrib("sort",e),"none"===this.viewRecAs&&(yield this.browser.recordChartType.set("list"))),this.browser.updateLayout())}})))).call((e=>{e.append("div").attr("class","dropIcon fa fa-list-ul"),e.append("span").attr("class","dropZoneText").text(me["Add Record Panel"])})),this.initDOM_RecordDisplayHeader(),this.DOM.timeAnimation=this.DOM.root.append("div").attr("class","timeAnimation"),this.DOM.recordDisplayWrapper=this.DOM.root.append("div").attr("class","recordDisplayWrapper"),this.initDOM_CustomControls(),this.recordConfigPanel=new qe(this.DOM.root,"Record Chart Configuration","recordDisplayConfig",Object.values(this.configs),this.browser,this.DOM.recordDisplayConfigButton),yield this.setAttrib("text",i.textBy),this.codeBy.text||(yield this.setAttrib("text",this.browser.idSummaryName)),yield this.setAttrib("textBrief",i.textBriefBy),["sort","scatterX","scatterY","color","size","link","timeSeries"]){var r=i[s+"By"];r&&(yield this.setAttrib(s,r))}this.textFilter=new be(this.browser),i.colorTheme&&this.setRecordColorTheme(i.colorTheme),i.recordPointSize&&(yield this.recordPointSize.set(i.recordPointSize)),i.colorInvert&&this.invertColorTheme(!0),i.filter?this.recordFilter.importFilter(i.filter):this.recordFilter.clearFilter(),null!==(t=i.viewAs)&&void 0!==t||(i.viewAs="none"),i.viewAs!==this.viewRecAs&&(yield this.browser.recordChartType.set(i.viewAs)),i.collapsed?this.collapseRecordViewSummary(!0):this.collapseRecordViewSummary(!1)}))}refreshConfigs(){Object.values(this.configs).forEach((e=>e.refresh()))}setHeight(e){var t=this.curHeight;this.curHeight=e,"none"!==this.viewRecAs&&this.curHeight!==t&&this.View.refreshViewSize(0)}setWidth(e){var t=this.curWidth;this.curWidth=e,"none"!==this.viewRecAs&&this.curWidth!==t&&(this.refreshWidth(),this.View.refreshViewSize(0))}refreshWidth(){var e;null===(e=this.DOM.root)||void 0===e||e.classed("narrow",this.curWidth<500).classed("wide",this.curWidth>700).style("width",this.curWidth+"px")}getNumOfColorScaleBins(){return this.recordColorScale.range().length-2}get textAttrib_Brief(){return this.codeBy.textBrief||this.codeBy.text}get height_Header(){return this.DOM.recordDisplayHeader?this.DOM.recordDisplayHeader.node().offsetHeight:0}refreshCompareLegend(){if(this.DOM.colorCompareGroup&&(this.DOM.colorCompareGroup.classed("active",!!this.browser.comparedAttrib),this.browser.comparedAttrib&&this.browser.comparedAttrib.attribName)){var e="<div class='comparedSummaryName'>"+this.browser.comparedAttrib.attribNameHTML+"</div>";e+="<div class='compareBlocks'>",this.browser.activeComparisons.forEach((t=>{e+=`<div class='compareBlock'><span class='colorBox bg_${t}'></span> \n        <span class='theText'>${this.browser.selectedAggrs[t].label}</span></div>`})),this.browser.records.filter((e=>!e.isSelected()&&e.isIncluded)).length&&(e+=`<div class='compareBlock'><span class='colorBox bg_Active'></span> <span class='theText'>(${this.browser.otherNameInCompare})</span></div>`),e+="</div>",this.DOM.colorCompareGroup.html(e).classed("active",!0)}}getColorValue(e){return this.codeBy.color instanceof Ye?this.codeBy.color.getFormattedValue(e):e}refreshColorLegend(){var e;if(this.DOM.mapColorScaleGroup&&(this.DOM.root.select(".editColorTheme.fa-adjust").classed("rotatedY",this.invertedColorTheme),this.DOM.root.classed("usesColorAttrib",null!=this.codeBy.color),this.recordColorScale&&this.codeBy.color)){var t=this.recordColorScale.range();t=t.slice(1,t.length-1);var i=!1;"_measure_"===this.codeBy.color?(null===(e=this.measureSummary)||void 0===e?void 0:e.isValueScale_Log)&&(i=!0):this.codeBy.color.isValueScale_Log&&(i=!0),this.mapColorScalePos=Re.getD3Scale(i);var s=this.recordColorScale.domain();this.mapColorScalePos.domain([s[0],s[s.length-1]]).range([0,100]),this.DOM.mapColorScaleBins.selectAll(".mapColorThemeBin").remove(),this.DOM.mapColorScaleBins.selectAll(".mapColorThemeBin").data(t).enter().append("div").attr("class","mapColorThemeBin").tooltip((e=>{var t=this.recordColorScale.invertExtent(e);return this.recordColorStepTicks?t[0]:this.getColorValue(t[0])+" &mdash; "+this.getColorValue(t[1])}),{placement:"bottom"}).style("background-color",(e=>e)).style("transform",((e,t)=>{e=this.recordColorScale.invertExtent(e);var i=this.mapColorScalePos(e[0]),s=this.mapColorScalePos(e[1]);return`translateX(${i}%) scaleX(${Math.abs(s-i)/100})`})),this.refreshColorLegendTicks()}}refreshColorLegendTicks(){if(!this.codeBy.color)return;if(!this.recordColorScaleTicks)return;var e=this.DOM.mapColorScaleLabels.node().offsetWidth,t=-200,i=30;let s=null;if("_measure_"===this.codeBy.color){var r=!this.browser.measureFunc_Count&&this.measureSummary;r&&(s=r,i+=6*r.unitName.length)}else s=this.codeBy.color,i+=6*this.codeBy.color.unitName.length;var a=this.recordColorScaleTicks.slice(),o=0;this.recordColorStepTicks&&(a.pop(),o=50/a.length),this.DOM.mapColorScaleLabels.selectAll(".mapColorScaleLabel").remove(),this.DOM.mapColorScaleLabels.selectAll(".mapColorScaleLabel").data(a).enter().append("div").attr("class","mapColorScaleLabel").style("left",(e=>o+this.mapColorScalePos(e)+"%")).classed("hidden",(s=>{var r=e*this.mapColorScalePos(s)/100,a=r-t>i;return a&&(t=r),!a})).call((e=>{e.append("div").attr("class","tickLabel").html((e=>{return""+(t=e,s?s.printAbbr(t):t);var t}))}))}invertColorTheme(e=null){this.invertedColorTheme=null==e?!this.invertedColorTheme:e,this.updateRecordColorScale()}setRecordColorTheme(e){this.browser.activeColorTheme=e,this.updateRecordColorScale()}initDOM_RecordDisplayHeader(){this.DOM.recordDisplayHeader=this.DOM.root.append("div").attr("class","recordDisplayHeader"),this.DOM.removeRecordPanelButton=this.DOM.recordDisplayHeader.append("div").attr("class","removeRecordPanelButton far fa-times-circle").tooltip(me.RemoveRecordPanel,{placement:"bottom"}).on("click",(()=>e(this,void 0,void 0,(function*(){return yield this.browser.recordChartType.set("none")})))),this.DOM.recordDisplayHeader.append("div").attr("class","buttonRecordViewExpand far fa-expand-alt").tooltip(me.OpenSummary,{placement:"bottom"}).on("click",(()=>this.collapseRecordViewSummary(!1))),this.DOM.recordDisplayHeader.append("div").attr("class","buttonRecordViewCollapse far fa-compress-alt").tooltip(me.CollapseSummary,{placement:"bottom"}).on("click",(()=>this.collapseRecordViewSummary(!0))),this.initDOM_GlobalTextSearch(),this.DOM.recordDisplayHeader.append("div").attr("class","recordName recordDisplayName").html(this.browser.recordName),this.DOM.recordDisplayConfigButton=this.DOM.recordDisplayHeader.append("span").attr("class","recordDisplayConfigButton fal fa-cog").tooltip(me.Configure).on("click",(e=>{this.recordConfigPanel.showAtPos(e.target.offsetLeft+25,e.target.offsetTop+25)})),this.DOM.recordDisplayHeader.append("span").attr("class","recordDisplay_ViewGroup").selectAll("span.fa").data([{v:"list",t:me.ListButton,i:"<span class='far fa-list-ul'></span>"},{v:"map",t:me.MapButton,i:"<span class='fal fa-globe'></span>"},{v:"node",t:me.NodeButton,i:"<span class='far fa-share-alt'></span>"},{v:"timeseries",t:me.TimeSeriesButton,i:"<span class='far fa-chart-line'></span>"},{v:"scatter",t:me.ScatterButton,i:"<span class='far fa-chart-scatter'></span>"}]).enter().append("span").attr("class",(e=>"recordDisplay_ViewAs_"+e.v+" disabled")).tooltip((e=>me.RecordViewTypeTooltip(e.t)),{placement:"bottom"}).on("click",((t,i)=>e(this,void 0,void 0,(function*(){return yield this.browser.recordChartType.set(i.v)})))).html((e=>e.i+"<span class='ViewTitle'>"+e.t+"</span>"))}initDOM_GlobalTextSearch(){this.DOM.recordTextSearch=this.DOM.recordDisplayHeader.append("span").attr("class","recordTextSearch textSearchBox"),this.DOM.recordTextSearch.append("span").attr("class","far fa-search"),this.DOM.recordTextSearch.append("span").attr("class","fa fa-times-circle").tooltip(me.RemoveFilter).on("click",(()=>this.textFilter.clearFilter())),this.DOM.recordTextSearch.append("input").attr("type","text").attr("class","textSearchInput").tooltip(me.TextSearchForRecords).on("keydown",(e=>e.stopPropagation())).on("keypress",(e=>e.stopPropagation())).on("keyup",(e=>{var t=e.currentTarget;if("Enter"===e.key)return t.tippy.hide(),t.timer&&clearTimeout(t.timer),t.timer=null,this.textFilter.queryString=t.value,""===this.textFilter.queryString?void this.textFilter.clearFilter():(this.browser.clearSelect_Compare(),void this.textFilter.setFiltered());e.stopPropagation()}))}getMaxSizeScaleRange(){if("_measure_"===this.codeBy.size&&this.isPointMap())return Math.max(10,Math.min(this.recordPointSize.get(),this.codeBy.geo.pointClusterRadius/2));if(this.codeBy.size instanceof Fe)return this.recordPointSize.get();throw Error("Unexpected status")}getMaxSizeDomainRange(){if("_measure_"===this.codeBy.size&&this.isPointMap())return Lt.max(this.codeBy.geo._aggrs,(e=>e.measure("Active")))||1;if(this.codeBy.size instanceof Fe)return this.codeBy.size.valueScale.domain()[1];throw Error("Unexpected status")}updateRecordSizeScale(){var e,t=Math.max(this.recordPointSize.get(),4);this.drawArc=Lt.arc().outerRadius(t).innerRadius(0).startAngle(0).endAngle(2*Math.PI);var i=e=>this.drawArc.outerRadius(this.recordRadiusScale(e));if(null===this.codeBy.size)this.recordRadiusScale=()=>t,this.recordDrawArc=()=>this.drawArc;else if(this.recordRadiusScale=Lt.scaleSqrt().clamp(!1).range([0,2*this.getMaxSizeScaleRange()]).domain([0,this.getMaxSizeDomainRange()]),"_measure_"===this.codeBy.size&&this.isPointMap())this.recordDrawArc=e=>i(e.measure_Self);else if(this.codeBy.size instanceof Fe){var s=this.codeBy.size;this.recordDrawArc=e=>{var t=s.template.func.call(e.data,e);return(isNaN(t)||null==t||s.isValueScale_Log&&t<=0)&&(t=1e-4),i(t)}}this.refreshSizeLegend(),null===(e=this.View)||void 0===e||e.refreshRecordSizes()}initDOM_CustomControls(){if(!this.DOM.visViewControl){var t,i=this;t=this.DOM.recordDisplayWrapper.append("span").attr("class","mapGlyphColorSetting"),this.DOM.mapGlyphColorSetting=t;var s=this.DOM.mapGlyphColorSetting.append("div").attr("class","attribGroup sizeGroup").classed("active",null!=this.codeBy.size);this.DOM.mapGlyphColorSetting.append("div").attr("class","attribGap"),this.DOM.colorCompareGroup=this.DOM.mapGlyphColorSetting.append("div").attr("class","colorCompareGroup attribGroup");var r=this.DOM.mapGlyphColorSetting.append("div").attr("class","attribGroup colorGroup").classed("active",null!=this.codeBy.color);this.DOM.sizeControlGroup=s.append("div").attr("class","sizeControlGroup attribControlGroup"),s.append("div").attr("class","dotSizes").call((t=>{t.append("i").attr("class","dotSize dotSize-expand-alt far fa-plus").tooltip(me.Larger,{placement:"top"}).on("click",(()=>e(this,void 0,void 0,(function*(){yield this.recordPointSize.set(this.recordPointSize.get()*Math.sqrt(2))})))),t.append("i").attr("class","dotSize dotSize-compress-alt far fa-minus").tooltip(me.Smaller,{placement:"top"}).on("click",(()=>e(this,void 0,void 0,(function*(){yield this.recordPointSize.set(this.recordPointSize.get()/Math.sqrt(2))}))))})),this.DOM.sizeLegendGroup=s.append("div").attr("class","attribLegendGroup sizeLegendGroup"),this.DOM.sizeControlGroup.append("span").attr("class","header").text(me.Size+" "),this.initDOM_AttribSelect("size"),this.DOM.colorControlGroup=r.append("div").attr("class","colorControlGroup attribControlGroup"),this.DOM.colorControlGroup.append("span").attr("class","header").text(me.Color+" "),this.initDOM_AttribSelect("color"),this.DOM.mapColorScaleGroup=r.append("div").attr("class","attribLegendGroup mapColorScaleGroup"),r.append("div").attr("class","editColorTheme fa fa-paint-brush").tooltip(me.ChangeColorTheme,{placement:"left"}).on("click",(t=>{var s=function(e){var t=i.browser.activeColorTheme,s=i.browser.colorTheme[t];i.browser.colorTheme[t]=this.value;let r=i.browser.colorTheme.getDiscrete(9);i.browser.colorTheme[t]=s,i.invertedColorTheme&&(r=r.reverse()),Lt.select(e).append("div").attr("class","colorLegend").selectAll(".colorLegendBox").data(r).enter().append("span").attr("class","colorLegendBox").style("background-color",(e=>e))};ye.popupMenu(t,{name:"Color Theme",items:[{id:"colorThemeInverse",name:"Invert",iconClass:"far fa-adjust",active:this.invertedColorTheme,do:()=>this.invertColorTheme()},{id:"colorScaleScale",name:"BinScale",iconClass:"far fa-arrows-h",when:()=>this.codeBy.color&&this.codeBy.color instanceof Ye&&this.codeBy.color.supportsLogScale(),do:(t,i)=>e(this,void 0,void 0,(function*(){var e=this.codeBy.color;e&&(e.timeseriesParent?yield e.timeseriesParent.valueScaleType.set(i):yield e.valueScaleType.set(i))})),options:[{name:"Linear",value:"linear",active:this.codeBy.color instanceof Ye&&this.codeBy.color.isValueScale_Linear},{name:"Log",value:"log",active:this.codeBy.color instanceof Ye&&!this.codeBy.color.isValueScale_Linear}]},{id:"colorThemeSwitch",name:"Switch (Seq. ↔ Div.)",iconClass:"far fa-exchange",do:()=>this.setRecordColorTheme("sequential"===this.browser.activeColorTheme?"diverging":"sequential")},{id:"colorThemeSequential",name:"Sequential",iconClass:"far fa-long-arrow-right",do:(e,t)=>{this.browser.colorTheme.sequential=t,this.setRecordColorTheme("sequential")},options:[{name:"Greys",value:"Greys",onName:s},{name:"Blues",value:"Blues",onName:s},{name:"Green-Blue",value:"GnBu",onName:s},{name:"Yellow-Green-Blue",value:"YlGnBu",onName:s},{name:"Greens",value:"Greens",onName:s},{name:"Yellow-Green",value:"YlGn",onName:s},{name:"Blue-Green",value:"BuGn",onName:s},{name:"Purple-Blue-Green",value:"PuBuGn",onName:s},{name:"Purple-Blue",value:"PuBu",onName:s},{name:"Purples",value:"Purples",onName:s},{name:"Blue-Purple",value:"BuPu",onName:s},{name:"Purple-Red",value:"PuRd",onName:s},{name:"Oranges",value:"Oranges",onName:s},{name:"Orange-Red",value:"OrRd",onName:s},{name:"Yellow-Orange-Red",value:"YlOrRd",onName:s},{name:"Yellow-Orange-Brown",value:"YlOrBr",onName:s},{name:"Inferno",value:"Inferno",onName:s},{name:"Magma",value:"Magma",onName:s},{name:"Plasma",value:"Plasma",onName:s},{name:"Cividis",value:"Cividis",onName:s},{name:"Viridis",value:"Viridis",onName:s},{name:"Warm",value:"Warm",onName:s},{name:"Cool",value:"Cool",onName:s}]},{id:"colorThemeDiverging",name:"Diverging",iconClass:"far fa-arrows-h",do:(e,t)=>{this.browser.colorTheme.diverging=t,this.setRecordColorTheme("diverging")},options:[{name:"Spectral",value:"Spectral",onName:s},{name:"Brown-Green",value:"BrBG",onName:s},{name:"Purple-Green",value:"PRGn",onName:s},{name:"Pink-Yellow-Green",value:"PiYG",onName:s},{name:"Purple-Orange",value:"PuOr",onName:s},{name:"Red-Blue",value:"RdBu",onName:s},{name:"Red-Gray",value:"RdGy",onName:s},{name:"Red-Yellow-Blue",value:"RdYlBu",onName:s},{name:"Red-Yellow-Green",value:"RdYlGn",onName:s}]}]},null,{placement:"top"})})),this.DOM.mapColorHighlightedValue=this.DOM.mapColorScaleGroup.append("div").attr("class","mapColorHighlightedValue fa fa-caret-down"),this.DOM.mapColorScaleBins=this.DOM.mapColorScaleGroup.append("div").attr("class","mapColorScaleBins"),this.DOM.mapColorScaleLabels=this.DOM.mapColorScaleGroup.append("div").attr("class","mapColorScaleLabels");var a=this.DOM.timeAnimation.append("span").attr("class","detailPlay attribDetailPlay");a.append("i").attr("class","fa fa-play-circle").tooltip(me.AutoPlay).on("click",(e=>this.startTimeseriesAnimation(e.shiftKey?5:1))).on("mouseover",(()=>{this.View instanceof yt&&this.View.timeseriesWiden()})).on("mouseout",(()=>{this.View instanceof yt&&this.View.timeseriesWidenOff()})),a.append("i").attr("class","fa fa-pause-circle").tooltip(me.StopAutoPlay).on("click",(()=>this.stopTimeseriesAnimation())),this.DOM.timeAnimation.append("div").attr("class","timeKeyStep timeKeyPrev").tooltip(me.Previous).on("click",(()=>this.currentTimeKey.set(this.timeKeys[this.currentTimeKey.get()._index-1]))).append("span").attr("class","fa fa-caret-left"),this.DOM.timeAnimation.append("select").attr("class","timeKeySelect").on("change",(t=>e(this,void 0,void 0,(function*(){return yield this.currentTimeKey.set(t.currentTarget.selectedOptions[0].__data__)})))),this.DOM.timeAnimation.append("div").attr("class","timeKeyStep timeKeyNext").tooltip(me.Next).on("click",(()=>e(this,void 0,void 0,(function*(){return yield this.currentTimeKey.set(this.timeKeys[this.currentTimeKey.get()._index+1])})))).append("span").attr("class","fa fa-caret-right"),this.DOM.timeAnimation.append("div").attr("class","timeKeyRange").call((t=>{var i,s;t.append("span").attr("class","rangeTick-min").text("min");var r=t.append("div").attr("class","attribDetailRange");u.create(r.node(),{connect:!0,step:1,behaviour:"tap-drag",range:{min:0,max:this.hasTimeKey?this.timeKeys.length-1:100},start:null!==(s=null===(i=this.currentTimeKey.get())||void 0===i?void 0:i._index)&&void 0!==s?s:0}),r.append("span").attr("class","rangeTick-cur"),this.timeKeySlider=r.node().noUiSlider;this.timeKeySlider.on("set",(t=>e(this,void 0,void 0,(function*(){if(!this.timeKeySlider_PauseUpdate){var e=this.DOM.timeAnimation.selectAll(".timeKeySelect > option").nodes()[Math.round(1*t)];e&&(this.timeKeySlider_PauseUpdate=!0,yield this.currentTimeKey.set(e.__data__),this.timeKeySlider_PauseUpdate=!1)}})))),this.DOM.timeseriesRange=t.append("div").attr("class","timeseriesRange"),t.append("span").attr("class","rangeTick-max")})),this.DOM.timeAnimationClearRange=this.DOM.timeAnimation.append("span").attr("class","clearRange fa fa-times").tooltip(me.Reset),this.currentTimeKey.refresh(),this.DOM.visViewControl=this.DOM.recordDisplayWrapper.append("span").attr("class","visViewControl"),this.DOM.visViewControl.append("span").attr("class","ChartControlGroup ViewControlGroup").call((e=>{e.append("span").attr("class","ChartControlGroupTitle").html(me.Zoom),e.append("span").attr("class","visViewControlButton far fa-plus").tooltip(me.ZoomIn).on("click",(()=>this.View.zoomIn())),e.append("span").attr("class","visViewControlButton far fa-minus").tooltip(me.ZoomOut).on("click",(()=>this.View.zoomOut())),e.append("span").attr("class","visViewControlButton far fa-expand-arrows-alt").tooltip(me.ZoomToFit).on("click",(()=>this.View.zoomToFit()))})),this.DOM.visViewControl.append("div").attr("class","visViewControlButton mapView-UnmatchedData").tooltip(me.MissingLocations).text("∅").on("click",(()=>{ye.alert("The following records do not appear on the map.<br><br>"+this.codeBy.geo.noValueAggr.records.map((e=>e._id)).join(", ")+("Point"!==this.codeBy.geo.geoType?"<br><br><span style='font-size: 0.9em; color: gray; font-weight: 300'>Please see the list of standard region names <a style='color: gray; text-decoration: underline;' href='https://docs.google.com/spreadsheets/d/1DKNXwsJy6_Mdy3ofwbBIZeBGrxSItYOJXNZgLyu0IM4' target='_blank'>here</a>.<br>If the place names above are misspelled, please update your data source.<span>":""))}))}}refreshTimeKeys(){this.timeKeys=[],["sort","scatterX","scatterY","color","size"].forEach((e=>{var t=this.codeBy[e];if(t instanceof Ye&&t.hasTimeSeriesParent()){var i=Array.from(t.timeseriesParent.timeKeys);0===this.timeKeys.length?this.timeKeys=i:this.timeKeys=this.timeKeys.filter((e=>i.find((t=>t._time_src===e._time_src))))}})),this.timeKeys=this.timeKeys.sort(((e,t)=>e._time.getTime()-t._time.getTime())),this.timeKeys.forEach(((e,t)=>{e._index=t,delete e._histogram})),this.currentTimeKey.refresh()}get hasTimeKey(){return this.timeKeys.length>1}filterStatusUpdated(e){var t;e instanceof Ye&&("scatter"!==this.viewRecAs||this.codeBy.scatterX!==e&&this.codeBy.scatterY!==e||null===(t=this.View)||void 0===t||t.refreshQueryBox_Filter(null),e.timeseriesParent===this.codeBy.timeSeries&&this.View instanceof yt&&this.View.refreshFilterRanges())}collapseRecordViewSummary(e){this.collapsed=e,this.DOM.root.classed("collapsed",this.collapsed),this.browser.finalized&&this.browser.updateLayout_Height()}refreshViz_Compare_All(){this.DOM.root.selectAll("[class*='spatialQueryBox_Compare']").classed("active",(e=>this.browser.vizActive(e)&&this.browser.selectedAggrs[e].bounds))}refreshViewAsOptions(){var e=0;["list","map","timeseries","scatter"].forEach((t=>{var i=this.browser.recordChartType.itemOptions.find((e=>e.value===t)),s=!i.activeWhen||!i.activeWhen();e+=s?0:1,this.DOM.recordDisplayHeader.select(".recordDisplay_ViewAs_"+t).classed("disabled",s).classed("active",t.toLowerCase()==this.viewRecAs)})),this.DOM.recordDisplayHeader.select(".recordDisplay_ViewGroup").classed("disabled",e<=1)}refreshAttribOptions(e){this.attribDropdowns[e]&&this.attribDropdowns[e].refresh()}initDOM_AttribSelect(e){this.attribDropdowns[e]=new Xe(e,this),this.refreshAttribOptions(e)}getAttribOptions_UI(e){var t,i=this.browser.attribs.filter((t=>t.supportsRecordEncoding(e)&&!t.hasTimeSeriesParent()));if(["scatterX","scatterY"].includes(e)){var s="scatterX"===e?this.codeBy.scatterY:this.codeBy.scatterX;s&&(s.hasTimeSeriesParent()&&(s=s.parent),i=i.filter((e=>e.attribID!=s.attribID)))}return"sort"===e&&0===i.length?((t="id"===this.browser.idSummaryName?this.browser.createAttrib("Sort by id",(function(){return 1*this.id})):this.browser.createAttrib("Sort (random)",(function(){return Math.random()})))._metricFuncs=[],t.initializeAggregates(),this.getAttribOptions_UI("sort")):(i.sort(((e,t)=>Re.sortFunc_List_String(e.attribName,t.attribName))),["color","size"].includes(e)&&i.unshift(null),i)}startTimeseriesAnimation(e=1){var t;this.timeseriesAnimInterval&&this.stopTimeseriesAnimation(),(null===(t=this.View)||void 0===t?void 0:t.stepTimeAnimation(e))&&this.DOM.root.classed("animatingTime",!0)}stopTimeseriesAnimation(){var e;this.DOM.root.classed("animatingTime",!1),null===(e=this.View)||void 0===e||e.stopTimeAnimation(),this.View.refreshLabelOverlaps(),this.timeseriesAnimInterval&&(window.clearInterval(this.timeseriesAnimInterval),this.timeseriesAnimInterval=0)}isPointMap(){var e;return"map"===this.viewRecAs&&"Point"===(null===(e=this.codeBy.geo)||void 0===e?void 0:e.geoType)}hasAggregates(){return this.isPointMap()&&this.DOM.clusterGlyphs&&this.codeBy.geo.pointClusterRadius>0&&this.codeBy.geo._aggrs.length>0}setAttrib(t,i,s=!1){var r,a,o,l;return e(this,void 0,void 0,(function*(){let e=null;var n;("number"==typeof i?e=this.getAttribOptions_UI(t)[i]:"function"==typeof i?e=this.browser.createAttrib("_Records",i,"categorical"):"string"==typeof i?"_measure_"!==i&&(e=this.browser.createAttrib(i)):i&&(e=i),["sort","scatterX","scatterY","size","color"].includes(t))&&(e instanceof Ye&&e.timeseriesParent&&(n=e.timeKey._time_src,e=e.timeseriesParent),e instanceof rt&&(n=(null===(r=this.currentTimeKey.get())||void 0===r?void 0:r._time_src)||n,e=e.getTimepointSummary(e.timeKeys.find((e=>e._time_src===n))||e.timeKeys[e.timeKeys.length-1])));var h=null;if("text"===t){if(!(e instanceof mt))return;this.codeBy.text=e}else if("textBrief"===t){if(!(e instanceof mt))return;this.codeBy.textBrief=e}else if("sort"===t){if(!(e instanceof Fe))return;this.codeBy.sort instanceof Ye&&(h=this.codeBy.sort.timeseriesParent),this.codeBy.sort=e}else if("scatterX"===t){if(!(e instanceof Ye))return;this.codeBy.scatterX&&(h=this.codeBy.scatterX.timeseriesParent),this.codeBy.scatterX=e}else if("scatterY"===t){if(!(e instanceof Ye))return;this.codeBy.scatterY&&(h=this.codeBy.scatterY.timeseriesParent),this.codeBy.scatterY=e}else if("size"===t)if(h=this.codeBy.size instanceof Ye?this.codeBy.size.timeseriesParent:null,"_measure_"===i)this.codeBy.size=i;else if(e instanceof Ye)this.codeBy.size=e;else{if(null!==i)return;this.codeBy.size=null}else if("color"===t)if(h=this.codeBy.color instanceof Ye?this.codeBy.color.timeseriesParent:null,"_measure_"===i)this.codeBy.color=i;else if(e instanceof Ye)this.codeBy.color=e;else{if(null!==i)return;this.codeBy.color=null}else if("timeSeries"===t){if(!(e instanceof rt))return;this.codeBy.timeSeries=e}else{if("geo"!==t)return;if(!(e instanceof tt))return;this.codeBy.geo=e,yield this.codeBy.geo.loadGeo()}s&&this.stopTimeseriesAnimation();var c=!1;if("timeSeries"!==t&&e instanceof Ye&&e.timeseriesParent&&h!==e.timeseriesParent&&(c=!0),c&&(this.refreshTimeKeys(),e instanceof Ye&&(yield this.currentTimeKey.set(e.timeKey))),this.DOM.root){if(e instanceof Oe&&e.initializeAggregates(),"text"===t)this.DOM.recordTextSearch.attr("active",!0).select("input").attr("placeholder",null===(a=this.textAttrib_Brief)||void 0===a?void 0:a.attribName),this.config.onDOM&&this.DOM.kshfRecords.each((e=>{this.config.onDOM.call(e.data,e)}));else if("textBrief"===t)this.DOM.recordTextSearch.attr("active",!0).select("input").attr("placeholder",this.textAttrib_Brief.attribName);else if("color"===t)this.updateRecordColorScale();else if("size"===t){if(this.codeBy.size instanceof Ye&&("scatter"===this.viewRecAs||"map"===this.viewRecAs&&"Point"===(null===(o=this.codeBy.geo)||void 0===o?void 0:o.geoType))){var d=this.codeBy.size.template.func,u=this.codeBy.size.isValueScale_Log,p=e=>{var t=d.call(e.data,e);return isNaN(t)||null==t||u&&t<=0?-1:t};this.sortRecordDomTimer&&clearTimeout(this.sortRecordDomTimer),this.sortRecordDomTimer=window.setTimeout((()=>{this.DOM.kshfRecords=this.DOM.recordGroup.selectAll(".kshfRecord").sort(((e,t)=>p(t)-p(e))),this.View.refreshLabelOverlaps()}),1e3)}this.updateRecordSizeScale(),this.refreshSizeLegend()}yield null===(l=this.View)||void 0===l?void 0:l.finishSetAttrib(t),this.refreshAttribOptions(t)}}))}getMaxPointSize(){return this.codeBy.size instanceof Ye?this.codeBy.size.timeseriesParent?Lt.max(this.codeBy.size.timeseriesParent.timeSeriesScale_Value.domain()):this.codeBy.size.rangeActive[1]:1}sanitizeTicks(e,t,i){if(e.domain){var s=e.copy().nice(i);e=s.ticks(i);var r=s.domain();e[0]>r[0]&&e.unshift(r[0]),e[e.length-1]<r[1]&&e.push([r[1]])}return"_measure_"!==t&&t.hasFloat||(e=e.map((e=>Math.round(e)))),e.filter(((t,i)=>0==i||t!==e[i-1]))}refreshSizeLegend(){if(null!=this.DOM.root){this.DOM.root.classed("usesSizeAttrib",e);var e=null!=this.codeBy.size&&("scatter"===this.viewRecAs||"map"===this.viewRecAs&&"Point"===this.codeBy.geo.geoType);if(e&&this.DOM.sizeLegendGroup){var t;if("map"===this.viewRecAs){if(t=this.recordRadiusScale.domain()[1],isNaN(t))return void this.DOM.root.classed("usesSizeAttrib",!1)}else t=this.getMaxPointSize();var i=[.2,.4,.6,.8,1];this.recordPointSize.get()>25&&(i=[.1,.4,.7,1]);var s,r=this.sanitizeTicks(i.map((e=>t*e*e)),this.codeBy.size,10);if(r=r.filter((e=>0!==e)),this.codeBy.size instanceof Ye){let e=this.codeBy.size;s=t=>e.getFormattedValue(t)}else s=Lt.format("~s");t=r[r.length-1],r=r.map((e=>({size:2*this.recordRadiusScale(e),val:e}))),this.DOM.sizeLegendGroup.selectAll("div").remove(),this.DOM.sizeLegendGroup.selectAll("div").data(r).join((e=>e.append("div").attr("class","sizeGlyph").call((e=>e.append("span").attr("class","glyphWrapper").append("span").attr("class","theGlyph").style("width",(e=>e.size+"px")).style("height",(e=>e.size+"px")))).call((e=>e.append("span").attr("class","glyphLabel").html((e=>s(e.val)))))))}}}linkedTimeKey(){if(null==this.codeBy.scatterY)return!1;if(null==this.codeBy.scatterX)return!1;var e=this.codeBy.scatterY.timeseriesParent,t=this.codeBy.scatterX.timeseriesParent;return!(!t||!e)&&(e.attribName!==t.attribName&&e.timeKeys.length===t.timeKeys.length&&this.codeBy.scatterY.timeKey!==this.codeBy.scatterX.timeKey)}flipSelected(e,t){t||(t=this.browser.Compare_Highlight),this.DOM.kshfRecords.each((i=>i.flipSelected(e,t)))}refreshRecordVis(){this.DOM.recordGroup&&(this.skipRefreshRecordVis||this.kshfRecords_Type===this.viewRecAs&&this.View&&this.View.refreshRecordVis())}isSummaryUsedInRecordChart(e){return{list:["sort"],map:["color","size"],scatter:["scatterX","scatterY","color","size"],timeseries:["timeSeries"],none:[]}[this.viewRecAs].some((t=>{var i=this[t+"Attrib"];return i&&(e===i||e===i.parentSummary)}))}refreshAttribScaleType(t){var i;return e(this,void 0,void 0,(function*(){this.codeBy.color instanceof Oe&&(this.codeBy.color!==t&&this.codeBy.color.timeseriesParent!==t||this.updateRecordColorScale()),yield null===(i=this.View)||void 0===i?void 0:i.refreshAttribScaleType(t)}))}getMaxMeasureValue(e=null){var t=this.browser.records.reduce(((e,t)=>(t.isIncluded&&!t._view.inCluster&&t.measure_Self&&e.push(t.measure_Self),e)),[]);return this.codeBy.geo&&(t=this.codeBy.geo._aggrs.reduce(((e,t)=>(e.push(t.measure("Active")),e)),t)),t.sort(((e,t)=>t-e)),e?Lt.quantile(t,e):t[0]}get measureSummary(){return this.browser.measureSummary.get()}updateRecordColorScale(){if(!this.codeBy.color)return this.recordColorScale=null,this.recordColorScaleTicks=null,this.recordColorStepTicks=null,void this.refreshColorLegend();var e,t;"_measure_"===this.codeBy.color?(t=[1,this.getMaxMeasureValue()],e=this.measureSummary):(t=this.codeBy.color.valueScale.domain(),e=this.codeBy.color);const i=Re.getD3Scale(null==e?void 0:e.isValueScale_Log).domain(t);for(var s=10;this.recordColorScaleTicks=this.sanitizeTicks(i,null!=e?e:"_measure_",s),!(this.recordColorScaleTicks.length<=10);)s--;this.recordColorStepTicks=!1,(!e||!e.hasFloat)&&Re.isStepTicks(this.recordColorScaleTicks)&&this.recordColorScaleTicks.length<10&&(this.recordColorStepTicks=!0,this.recordColorScaleTicks.push(this.recordColorScaleTicks[this.recordColorScaleTicks.length-1]+1));var r=Math.max(Math.min(this.recordColorScaleTicks.length-1,9),1),a=this.browser.colorTheme.getDiscrete(r);this.invertedColorTheme&&a.reverse(),a=[Lt.hsl(a[0]).brighter(.1).formatHex()].concat(a).concat(Lt.hsl([a[a.length-1]]).darker(.1).formatHex()),this.recordColorScale=Lt.scaleThreshold().domain(this.recordColorScaleTicks).range(a),this.refreshColorLegend()}onRecordMouseOver(e){if(e.highlightRecord(),this.setDimmed(!0),this.View.onRecordMouseOver(e),this.codeBy.color&&("map"===this.viewRecAs||"scatter"===this.viewRecAs)){var t;t="_measure_"===this.codeBy.color?e.measure_Self:this.codeBy.color.getRecordValue(e);var i=0;this.recordColorStepTicks&&(i=50/(this.recordColorScaleTicks.length-1)),this.DOM.mapColorHighlightedValue.style("opacity",null===t?null:1).style("left",i+this.mapColorScalePos(t)+"%")}}onRecordMouseLeave(e){this.setDimmed(!1),e&&(e.unhighlightRecord(),this.View.onRecordMouseLeave(e),!this.codeBy.color||"map"!==this.viewRecAs&&"scatter"!==this.viewRecAs||this.DOM.mapColorHighlightedValue.style("opacity",null))}refreshTextAttrib(){}getRecordTitle(e){var t=`<span class='mapItemName'>${this.textAttrib_Brief.renderRecordValue(e)}</span>`,i="";if(this.browser.comparedAttrib){let t=this.browser.comparedAttrib,s="Active";ae.Compare_List.forEach((t=>{e.isSelected(t)&&(s=t)})),i=`<div class='recordColorInfo'>\n        <span class='mapTooltipLabel'>${t.attribName}</span>\n        <div class='mapTooltipValue'><span class='colorBox bg_${s}'></span>${t.getRecordValue(e)}</div>\n        </div>`}if(!this.codeBy.color)return t+i;var s,r,a=this.codeBy.color;if("_measure_"===a||!a.hasTimeSeriesParent())return"_measure_"===a?(r=me.measureText(this.browser),s=e.measure_Self):(r=a.attribName,s=a.getFormattedValue(a.template.func.call(e.data,e))),t+i+"<div class='recordColorInfo'>"+`<span class='mapTooltipLabel'>${r}</span>: `+`<span class='mapTooltipValue'>${s}</span></div>`;var o=a,l=a.template.func.call(e.data,e),n=a.timeseriesParent,h=n.getRecordValue(e),c=h._timeseries_;if(0===c.length)return t+i+"<div class='recordColorInfo'> - "+`<span class='timeseriesName blockName'>${n.attribNameHTML}</span></div>`;for(;void 0===c[0]._value;)c=c.slice(1);for(;void 0===c[c.length-1]._value;)c=c.slice(0,c.length-1);var d,u=Lt.scaleTime().domain(Lt.extent(c,(e=>e._time))).range([0,150]),[p,m]=Lt.extent(c,(e=>e._value));p===m&&(d=p,p-=1e-4,m+=1e-4),n.hasFlippedDomain()&&([m,p]=[p,m]);var g=Lt.scaleLinear().domain([p,m]).rangeRound([40,0]),v="",f=null;null!=l&&(f=n.timeKeys.filter((e=>e._time_src===o.timeKey._time_src))[0],v=`<g transform='translate(${u(f._time)} ${g(l)})'><circle class='activeValueDot' r='4' fill='${this.recordColorScale(l)}'/><text class='activeValueText' y='-5'>${a.printAbbr(l,!0)}</text></g>`);var b=this.browser.colorTheme.getContinuous(),_=this.mapColorScalePos.copy().range(this.invertedColorTheme?[1,0]:[0,1]);if(this.sparklineCounter++,[c[0],c[c.length-1]].forEach((e=>{v+=`<g transform='translate(${u(e._time)} 40)'><text class='limitText activeValueTime' y='16'>${e._time_src}</text></g>`})),!d){var y=f&&f._index>n.timeKeys.length/2;[m,p].forEach((e=>{v+="<g transform='translate("+(y?0:150)+" "+g(e)+")'><text class='limitText activeRangeText' x='"+(y?"-":"")+"3' y='5' style='text-anchor: "+(y?"end":"start")+";'>"+n.printAbbr(e,!0)+"</text></g>"}))}var A=d?b(_(m)):"";return t+i+`<div class='sparklineWrapper'>\n        <svg class='tooltipSparkline' xmlns='http://www.w3.org/2000/svg'>\n          <defs>\n            <clipPath id='SparklineClipPath${this.sparklineCounter}'>\n              <rect x='-20' y='-25' height='100' class='sparkLineClipPath'></rect>\n            </clipPath>\n          </defs>\n          <g>\n            <path class='timeline' d='${Re.getLineGenerator(u,g)(c)}' stroke='${A}' />\n            ${v}\n          </g>\n        </svg>\n      </div>\n      <span class='timeseriesName blockName'>${n.attribNameHTML}</span>`}refreshRecordDOM(){var e,t,i,s=["map","node","scatter","timeseries"].includes(this.viewRecAs);this.DOM.recordGroup.selectAll(".kshfRecord").data(this.View.getRecordsForDOM(),(e=>e.id)).join((e=>0===e.nodes().length?e:e.append({map:"g",node:"g",scatter:"g",timeseries:"g",list:"div"}[this.viewRecAs]).attr("class",(e=>"kshfRecord kshfRecord_#"+(""+e.id).replace(/\s/g,"_"))).tooltip((e=>this.getRecordTitle(e)),{theme:"dark kshf-tooltip kshf-record",placement:"right",animation:"fade",followCursor:"map"===this.viewRecAs,offset:[0,"map"===this.viewRecAs?10:0],onShown:e=>{Lt.select(e.popper).select(".sparkLineClipPath").attr("width",2).transition().duration(1e3).delay(0).ease(Lt.easePolyInOut).attr("width",200)}}).on("mouseenter",((e,t)=>{if("timeseries"!==this.viewRecAs){var i=e.currentTarget;i.highlightTimeout&&clearTimeout(i.highlightTimeout),i.highlightTimeout=window.setTimeout((()=>{clearTimeout(i.highlightTimeout),this.onRecordMouseOver(t)}),this.browser.movingMouseDelay)}})).on("mouseleave",((e,t)=>{if("timeseries"!==this.viewRecAs){var i=e.currentTarget;i.highlightTimeout&&window.clearTimeout(i.highlightTimeout),this.onRecordMouseLeave(t)}})).on("mousedown",(e=>{s&&(e.currentTarget._mousemove=!1,e.stopPropagation(),e.preventDefault())})).on("mousemove",(e=>{s&&(e.currentTarget._mousemove=!0)})).on("click",((e,t)=>{if(s){var i=e.currentTarget;i._mousemove||(this.browser.recordDetailsPopup.updateRecordDetailPanel(t),"map"===this.viewRecAs&&this.codeBy.color instanceof Ye&&this.browser.recordDetailsPopup.updateFocusedTimeKey(this.codeBy.color.timeKey),i.highlightTimeout&&window.clearTimeout(i.highlightTimeout),i.tippy.state.visible&&i.tippy.hide(),this.onRecordMouseLeave(t))}})).call((e=>{this.View.extendRecordDOM(e)}))),(e=>null),(e=>e.each((e=>e.assignDOM(null))).remove())),this.DOM.kshfRecords=this.DOM.recordGroup.selectAll(".kshfRecord").each(((e,t,i)=>{var s=i[t];e.assignDOM(s),"list"===this.viewRecAs||"timeseries"===this.viewRecAs?s.tippy.disable():s.tippy.enable()})),s&&(this.DOM.kshfRecords_Path=this.DOM.recordGroup.selectAll(".kshfRecord > path.glyph_Main")),this.View instanceof Mt?this.View.setMaxBounds():this.View instanceof Ct&&(this.View.finishSetAttrib("size"),null===(e=this.View)||void 0===e||e.refreshRecordColors()),null===(t=this.View)||void 0===t||t.refreshSelect_Compare(),null===(i=this.View)||void 0===i||i.updateRecordVisibility(),this.refreshTextAttrib(),this.kshfRecords_Type=this.viewRecAs}refreshAfterHighlight(e){this.setDimmed(e),this.View.refreshLabelOverlaps()}setDimmed(e){var t;null===(t=this.DOM.root)||void 0===t||t.classed("dimmed",e)}updateAfterFilter(e){"none"!==this.viewRecAs&&(this.refreshCompareLegend(),this.View.updateAfterFilter(e))}getRecordGeoAttributes(){return this.browser.attribs.filter((e=>e instanceof tt))}exportConfig(){var e,t={viewAs:this.viewRecAs,collapsed:this.collapsed,colorInvert:this.invertColorTheme,filter:this.recordFilter.isFiltered?this.recordFilter.exportFilter():void 0};return["sort","scatterX","scatterY","color","size","link","timeSeries","geo","text","textBrief"].forEach((i=>{var s=this[i+"Attrib"];if(s){if("_measure_"===s)e="_measure_";else{if(!(s instanceof Oe))return;e=s.template.str||s.attribName,s.hasTimeSeriesParent()&&(e=s.template.str)}t[i+"By"]=e}})),Object.values(this.configs).forEach((e=>e.exportConfigTo(t))),t}importConfig(t){return e(this,void 0,void 0,(function*(){null!=t&&(yield this.browser.recordChartType.set(t.viewAs),t.colorTheme&&this.setRecordColorTheme(t.colorTheme),t.colorInvert&&this.invertColorTheme(!0),t.recordPointSize&&(yield this.recordPointSize.set(t.recordPointSize)),t.collapsed?this.collapseRecordViewSummary(!0):this.collapseRecordViewSummary(!1))}))}}class Nt{getFeature(e){return this.features[e]}constructor(e,t,i){this._geoLoaded=!1,this.features={},this.name=e,this.fileName=t+"?ma",i=i||{},this.featureCb=i.featureCb,this.alternatives=i.alternatives||{},this.defaultIndexedProps=["id","ISO3166-2","ISO3166-1"],i.indexedProps&&(Array.isArray(i.indexedProps)||(i.indexedProps=[i.indexedProps]),this.defaultIndexedProps=this.defaultIndexedProps.concat(i.indexedProps)),this._processAlternatives()}get geoLoaded(){return this._geoLoaded}_processAlternatives(){for(var e in this.alternatives){var t=this.alternatives[e];if("expand"===e)for(var i in this.features)t.forEach((e=>{var t=i.replace(e.from,e.to||"");t===i||this.features[t]||(this.features[t]=this.features[i],e.replace&&delete this.features[i])}));else Array.isArray(t)&&t.filter((e=>"string"==typeof e)).forEach((t=>{this.features[t]=this.features[t]||this.features[e]||null}))}}loadGeo(){return e(this,void 0,void 0,(function*(){return!!this._geoLoaded||fetch(this.fileName,{credentials:"same-origin"}).then((e=>e.json())).then((t=>e(this,void 0,void 0,(function*(){return t.objects?(yield import("./vendor_mapping.min.js").then((function(e){return e.t})),window.topojson.feature(t,t.objects.regions)):t})))).then((e=>{e.features.forEach((e=>{if(e.properties.alltags){for(var t in e.properties.alltags)e.properties[t]=e.properties.alltags[t];delete e.properties.alltags}this.featureCb&&(e=this.featureCb(e)),e.properties.id=e.properties.id||e.id,this.defaultIndexedProps.concat(Object.keys(e.properties).filter((e=>e.toUpperCase().includes("NAME")&&!e.toUpperCase().includes("FIX")))).forEach((t=>{var i=e.properties[t];i&&(i=""+i,this.features[i.toUpperCase()]=e,i.includes("-")&&(this.features[i.replace(/-/g," ").toUpperCase()]=e))}))})),this._geoLoaded=!0,this._processAlternatives()}))}))}}var Bt={id:"cat_addMap",name:"Add map",iconClass:"far fa-globe",when:e=>e instanceof mt&&!e.catGeo,do:(t,i,s)=>e(void 0,void 0,void 0,(function*(){var e="Map_"+(s=s.slice("World"===s[1]?1:2)).map((e=>e.replace(/ /g,"").replace(/-/g,""))).join("_")+"_"+i.level;yield t.setCatGeo_(e+"[UPPERCASE(*)]")})),options:[{name:"World",options:[{name:"Country",value:{level:"Adm2",indexedProps:["ISO3166-1:alpha2","ISO3166-1:alpha3","ISO3166-1:numeric"],alternatives:{"BOSNIA AND HERZEGOVINA":["BOSNIA-HERZEGOVINA"],BRUNEI:["BRUNEI DARUSSALAM"],BOLIVIA:["BOLIVARIAN REPUBLIC OF VENEZUELA","BOLIVIA, PLURINATIONAL STATE OF"],BAHAMAS:["BAHAMAS, THE","THE BAHAMAS"],"DEMOCRATIC REPUBLIC OF THE CONGO":["CONGO, DEM. REP.","CONGO, THE DEMOCRATIC REPUBLIC OF THE","CONGO, DEMOCRATIC REPUBLIC"],CONGO:["CONGO, REP.","CONGO, REPUBLIC OF"],"CÔTE D'IVOIRE":["COTE D'IVOIRE","IVORY COAST"],CHINA:["CHINA, PEOPLE'S REPUBLIC OF"],"CABO VERDE":["CAPE VERGE"],EGYPT:["EGYPT, ARAB REP."],"SAHRAWI ARAB DEMOCRATIC REPUBLIC":["WESTERN SAHARA","Saharawi","Sahrawi Republic"],MICRONESIA:["MICRONESIA, FEDERATED STATES OF","MICRONESIA, FED. STS."],"UNITED KINGDOM OF GREAT BRITAIN AND NORTHERN IRELAND":["UNITED KINGDOM","BRITAIN"],GAMBIA:["GAMBIA, THE","THE GAMBIA"],IRAN:["IRAN, ISLAMIC REPUBLIC OF","IRAN, ISLAMIC REP."],KOSOVO:["XKX","XXK"],KYRGYZSTAN:["KYRGYZ REPUBLIC"],"SAINT KITTS AND NEVIS":["ST. KITTS AND NEVIS"],"NORTH KOREA":["KOREA, DEMOCRATIC PEOPLE'S REPUBLIC OF","KOREA, NORTH"],"SOUTH KOREA":["KOREA, REPUBLIC OF","KOREA, REP.","KOREA, SOUTH"],"LAO PEOPLE'S DEMOCRATIC REPUBLIC":["LAOS","LAO PDR"],"SAINT LUCIA":["ST. LUCIA"],MOLDOVA:["MOLDOVA, REPUBLIC OF"],MACEDONIA:["MACEDONIA, THE FORMER YUGOSLAV REPUBLIC OF","NORTH MACEDONIA","REPUBLIC OF MACEDONIA","MACEDONIA, FYR"],MYANMAR:["BURMA"],"PALESTINIAN TERRITORIES":["PALESTINE","PALESTINE, STATE OF","WEST BANK AND GAZA"],REUNION:["RÉUNION"],"RUSSIAN FEDERATION":["RUSSIA"],SLOVAKIA:["SLOVAK REPUBLIC"],"SOUTH SUDAN":["REPUBLIC OF SOUTH SUDAN"],"SÃO TOMÉ AND PRÍNCIPE":["SAO TOME AND PRINCIPE"],"SYRIAN ARAB REPUBLIC":["SYRIA"],ESWATINI:["SWAZILAND"],TAIWAN:["TAIWAN, PROVINCE OF CHINA","TAIWAN (POC)"],TANZANIA:["TANZANIA, UNITED REPUBLIC OF"],"UNITED STATES OF AMERICA":["USA","UNITED STATES"],VATIKAN:["HOLY SEE (VATIKAN)","HOLY SEE"],"SAINT VINCENT AND THE GRENADINES":["ST. VINCENT AND GRENADINES","ST. VINCENT AND THE GRENADINES"],VIETNAM:["VIET NAM"],YEMEN:["YEMEN, REP.","REPUBLIC OF YEMEN","YEMEN, REPUBLIC OF"],VENEZUELA:["BOLIVARIAN REPUBLIC OF VENEZUELA","VENEZUELA, RB"]},featureCb:e=>{var t,i=9;switch(e.properties["ISO3166-1"]){case"RU":case"NZ":case"FJ":t=e=>e<0,i=360;break;case"US":t=e=>e>0,i=-360}return t&&e.geometry.coordinates.forEach(((s,r)=>{s.forEach(((s,a)=>{s.forEach(((s,o)=>{t(s[0])&&(e.geometry.coordinates[r][a][o][0]=s[0]+=i)}))}))})),e}}}]},{name:"Central America and the Caribbean",options:[{name:"Belize",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Costa Rica",options:[{name:"Province",value:{level:"Adm4"}},{name:"Canton",value:{level:"Adm6"}}]},{name:"Cuba",options:[{name:"Province",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Dominican Republic",options:[{name:"Province",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"El Salvador",options:[{name:"Department",value:{level:"Adm4"}}]},{name:"Guatemala",options:[{name:"Department",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Haiti",options:[{name:"Department",value:{level:"Adm4"}},{name:"Arrondissement",value:{level:"Adm5"}}]},{name:"Honduras",options:[{name:"Department",value:{level:"Adm4"}}]},{name:"Jamaica",options:[{name:"Parish",value:{level:"Adm6"}}]},{name:"Nicaragua",options:[{name:"Department",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Panama",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Puerto Rico",options:[{name:"Municipality",value:{level:"Adm6"}}]}]},{name:"Central Asia",options:[{name:"Armenia",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Azerbaijan",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Cyprus",options:[{name:"District",value:{level:"Adm6"}}]},{name:"Georgia",options:[{name:"Region",value:{level:"Adm4"}},{name:"Municipality / District",value:{level:"Adm6"}}]},{name:"Kazakhstan",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Kyrgyzstan",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Russia",options:[{name:"Oblast",value:{level:"Adm4"}}]},{name:"Tajikistan",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Turkmenistan",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Uzbekistan",options:[{name:"Region",value:{level:"Adm4"}}]}]},{name:"East Asia and Pacific",options:[{name:"Australia",options:[{name:"State",value:{level:"Adm4"}},{name:"LGA",value:{level:"Adm6"}}]},{name:"Brunei",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Cambodia",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"China",options:[{name:"Province",value:{level:"Adm4"}},{name:"Cities",value:{level:"Adm5"}}]},{name:"Indonesia",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Japan",options:[{name:"Prefecture",value:{level:"Adm4"}},{name:"Subprefecture",value:{level:"Adm6"}}]},{name:"Laos",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Malaysia",options:[{name:"State_Territory",value:{level:"Adm4"}}]},{name:"Mongolia",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Myanmar",options:[{name:"Region / State",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"New Zealand",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"North Korea",options:[{name:"Province",value:{level:"Adm4"}},{name:"City",value:{level:"Adm6"}}]},{name:"Papua New Guinea",options:[{name:"Region",value:{level:"Adm3"}},{name:"Province",value:{level:"Adm4"}}]},{name:"Philippines",options:[{name:"Region",value:{level:"Adm3"}},{name:"Province",value:{level:"Adm4"}}]},{name:"Singapore",options:[{name:"CDC",value:{level:"Adm6"}}]},{name:"South Korea",options:[{name:"Province",value:{level:"Adm4"}},{name:"City",value:{level:"Adm6"}}]},{name:"Thailand",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Vietnam",options:[{name:"Province",value:{level:"Adm4"}},{name:"City",value:{level:"Adm6"}}]}]},{name:"Europe",options:[{name:"Albania",options:[{name:"Counties",value:{level:"Adm6"}},{name:"Municipality",value:{level:"Adm7"}}]},{name:"Austria",options:[{name:"State",value:{level:"Adm4"}},{name:"District &amp; S. Cities",value:{level:"Adm6"}}]},{name:"Belarus",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Belgium",options:[{name:"Regions",value:{level:"Adm4"}},{name:"Province",value:{level:"Adm6"}}]},{name:"Bosnia-Herzegovina",options:[{name:"District",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Bulgaria",options:[{name:"Province",value:{level:"Adm6"}},{name:"Municipality",value:{level:"Adm8"}}]},{name:"Croatia",options:[{name:"County",value:{level:"Adm6"}},{name:"Municipality",value:{level:"Adm7"}}]},{name:"Czech Republic",options:[{name:"Regions",value:{level:"Adm6"}},{name:"District",value:{level:"Adm7"}}]},{name:"Denmark",options:[{name:"Regions",value:{level:"Adm4"}}]},{name:"Estonia",options:[{name:"County",value:{level:"Adm6"}},{name:"Municipality",value:{level:"Adm7"}}]},{name:"Finland",options:[{name:"Region",value:{level:"Adm6"}},{name:"Subregion",value:{level:"Adm7"}}]},{name:"France",options:[{name:"Region",value:{level:"Adm4"}},{name:"Department",value:{level:"Adm6"}}]},{name:"Germany",options:[{name:"State",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6",indexedProps:"de:regionalschluessel",alternatives:{expand:[{from:/LANDKREIS /g}]}}}]},{name:"Greece",options:[{name:"Region",value:{level:"Adm5"}},{name:"Regional Unit",value:{level:"Adm6"}}]},{name:"Hungary",options:[{name:"County",value:{level:"Adm6"}},{name:"District",value:{level:"Adm7"}}]},{name:"Iceland",options:[{name:"Region",value:{level:"Adm5"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Ireland",options:[{name:"County",value:{level:"Adm6"}},{name:"District",value:{level:"Adm8"}}]},{name:"Italy",options:[{name:"Region",value:{level:"Adm4"}},{name:"Province",value:{level:"Adm6"}}]},{name:"Kosovo",options:[{name:"District",value:{level:"Adm4",alternatives:{PRISHTINA:["PRISHTINË","PRISTINA"],PEJA:["PEĆ","PEJE","PEJË"],GJAKOVA:["GJAKOVË"],expand:[{from:/ \(\d+\)/g,replace:!0},{from:"District of ",replace:!0},{from:"Region of ",replace:!0}]}}},{name:"Municipality",value:{level:"Adm6",alternatives:{"DEÇAN":["DEČANI"],DRAGASH:["DRAGAŠ"],FERIZAJ:["UROŠEVAC"],"FUSHË KOSOVË":["KOSOVO POLJE"],"GJAKOVË":["GJAKOVA","ĐAKOVICA"],GJILAN:["GNJILANE"],GLLOGOVC:["DRENAS","GLOGOVAC","GLLOGOC"],"GRACANICË":["GRAČANICA","GRAÇANICË","GRACANICA"],"HANI I ELEZIT":["ELEZ HAN"],ISTOG:["BURIM","ISTOK"],"KAÇANIK":["KAČANIK"],KAMENICA:["DARDANË","KOSOVSKA KAMENICA","KAMENICË"],KLINA:["KLINË"],KLOKOT:["KLLOKOT","KLLOKOTI"],LEPOSAVIQ:["LEPOSAVIĆ"],LIPJAN:["LIPLJAN"],"MALISHEVË":["MALIŠEVO"],"MAMUSHË":["MAMUŠA","MAMUSH"],MITROVICA:["MITROVICË","KOSOVSKA MITROVICA"],"MITROVICA E VERIUT":["MITROVICA VERIORE","NORTH MITROVICA","SEVERNA KOSOVSKA MITROVICA","SEVERNA MITROVICA"],"NOVO BRDO":["NOVOBËRDË","NOVOBERDE"],OBILIQ:["KASTRIOT","OBILIĆ","OBILIC"],PARTESH:["PARTEŠ","PARTES"],"PEJË":["PEĆ"],"PODUJEVË":["BESIANË","PODUJEVO"],"PRISHTINË":["PRISHTINA","PRISHTINE","PRISTINA","PRIŠTINA"],RAHOVEC:["ORAHOVAC"],RANILLUG:["RANILUG","RANILLUK"],"SHTËRPCE":["SHTËRPCË","ŠTRPCE"],SHTIME:["ŠTIMLJE"],SKENDERAJ:["SKËNDERAJ","SRBICA"],"SUHA REKË":["SUHAREKË","THERANDË","SUVA REKA"],VITI:["VITINA","VITIA"],VUSHTRRI:["VUČITRN"],"ZUBIN POTOK":["ZUBIN POTOKU","ZUBİN POTOK"],"ZVEÇAN":["ZVEČAN"],expand:[{from:/ \(\d+\)/g,replace:!0},{from:"Municipality of ",replace:!0},{from:"Region of ",replace:!0}]}}}]},{name:"Latvia",options:[{name:"Municipality",value:{level:"Adm6"}}]},{name:"Lithuania",options:[{name:"County",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm5"}}]},{name:"Macedonia",options:[{name:"Region",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm7",alternatives:{expand:[{from:/MUNICIPALITY OF /g}]}}}]},{name:"Moldova",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Montenegro",options:[{name:"Municipality",value:{level:"Adm4"}}]},{name:"Netherlands",options:[{name:"State",value:{level:"Adm3"}},{name:"Province",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm8"}}]},{name:"Norway",options:[{name:"County",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm7"}}]},{name:"Poland",options:[{name:"Province",value:{level:"Adm4"}},{name:"County",value:{level:"Adm6"}}]},{name:"Portugal",options:[{name:"District",value:{level:"Adm6"}},{name:"Municipality",value:{level:"Adm7"}}]},{name:"Romania",options:[{name:"County",value:{level:"Adm4"}}]},{name:"Serbia",options:[{name:"District",value:{level:"Adm6"}},{name:"Municipality_City",value:{level:"Adm8"}}]},{name:"Slovakia",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm8"}}]},{name:"Slovenia",options:[{name:"Region",value:{level:"Adm5"}},{name:"Municipality",value:{level:"Adm8"}}]},{name:"Spain",options:[{name:"Autonomous Community",value:{level:"Adm4"}},{name:"Province",value:{level:"Adm6"}}]},{name:"Sweden",options:[{name:"County",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm7"}}]},{name:"Switzerland",options:[{name:"Canton",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Turkey",options:[{name:"Region",value:{level:"Adm3"}},{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Ukraine",options:[{name:"Region",value:{level:"Adm4"}},{name:"Raion",value:{level:"Adm6"}}]},{name:"United Kingdom",options:[{name:"Country",value:{level:"Adm4"}},{name:"County / Unitary authorities",value:{level:"Adm6"}}]}]},{name:"Middle East and North Africa",options:[{name:"Algeria",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Bahrain",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Egypt",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Iraq",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Iran",options:[{name:"Province",value:{level:"Adm4"}},{name:"County",value:{level:"Adm6"}}]},{name:"Israel",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Jordan",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Kuwait",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Lebanon",options:[{name:"Governorate",value:{level:"Adm3"}},{name:"District",value:{level:"Adm4"}}]},{name:"Libya",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Morocco",options:[{name:"Region",value:{level:"Adm4"}},{name:"Profecture / Province",value:{level:"Adm5"}}]},{name:"Oman",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Palestine",options:[{name:"Territory",value:{level:"Adm3"}},{name:"Governorate",value:{level:"Adm5"}}]},{name:"Qatar",options:[{name:"Municipality",value:{level:"Adm4"}}]},{name:"Saudi Arabia",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Syria",options:[{name:"Governorate",value:{level:"Adm4",indexedProps:["PCODE"]}}]},{name:"Tunisia",options:[{name:"Governorate",value:{level:"Adm4"}},{name:"Delegation",value:{level:"Adm5"}}]},{name:"United Arab Emirates",options:[{name:"Emirate",value:{level:"Adm4"}}]},{name:"Yemen",options:[{name:"Governorate",value:{level:"Adm4",alternatives:{expand:[{from:/ GOVERNORATE/g}]}}}]}]},{name:"North Ameria",options:[{name:"Canada",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Mexico",options:[{name:"State",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"United States",options:[{name:"States",value:{level:"Adm4",indexedProps:["ISO3166_2"],alternatives:{expand:[{from:"US-",replace:!0}],ALABAMA:[1,"01"],ALASKA:[2,"02"],ARIZONA:[4,"04"],ARKANSAS:[5,"05"],CALIFORNIA:[6,"06"],COLORADO:[8,"08"],CONNECTICUT:[9,"09"],DELAWARE:[10],"DISTRICT OF COLUMBIA":[11],FLORIDA:[12],GEORGIA:[13],HAWAII:[15],IDAHO:[16],ILLINOIS:[17],INDIANA:[18],IOWA:[19],KANSAS:[20],KENTUCKY:[21],LOUISIANA:[22],MAINE:[23],MARYLAND:[24],MASSACHUSETTS:[25],MICHIGAN:[26],MINNESOTA:[27],MISSISSIPPI:[28],MISSOURI:[29],MONTANA:[30],NEBRASKA:[31],NEVADA:[32],"NEW HAMPSHIRE":[33],"NEW JERSEY":[34],"NEW MEXICO":[35],"NEW YORK":[36],"NORTH CAROLINA":[37],"NORTH DAKOTA":[38],OHIO:[39],OKLAHOMA:[40],OREGON:[41],PENNSYLVANIA:[42],"RHODE ISLAND":[44],"SOUTH CAROLINA":[45],"SOUTH DAKOTA":[46],TENNESSEE:[47],TEXAS:[48],UTAH:[49],VERMONT:[50],VIRGINIA:[51],WASHINGTON:[53],"WEST VIRGINIA":[54],WISCONSIN:[55],WYOMING:[56],"AMERICAN SAMOA":[60],GUAM:[14,66],"NORTHERN MARIANA ISLANDS":[69],"PUERTO RICO":[72],"VIRGIN ISLANDS":[78]},featureCb:e=>{var t=null,i=9;switch(e.properties.name){case 2:case"AK":case"Alaska":case"Northern Mariana Islands":case"Guam":t=e=>e>0,i=-360}return t&&(e.geometry.coordinates[0][0][0][0]?e.geometry.coordinates.forEach(((s,r)=>{s.forEach(((s,a)=>{s.forEach(((s,o)=>{t(s[0])&&(e.geometry.coordinates[r][a][o][0]=s[0]+=i)}))}))})):e.geometry.coordinates.forEach(((s,r)=>{s.forEach(((s,a)=>{t(s[0])&&(e.geometry.coordinates[r][a][0]=s[0]+=i)}))}))),e}}},{name:"Counties",value:{level:"Adm6",indexedProps:["GEO_ID"],alternatives:{expand:[{from:"0500000US",replace:!0}]}}},{name:"Congressional Districts",options:[{name:"115th",value:{level:"CD115",featureCb:e=>{var t=null,i=9;if("AK"===e.properties.id.substr(0,2))t=e=>e>0,i=-360;return t&&e.geometry.coordinates.forEach(((s,r)=>{s.forEach(((s,a)=>{s.forEach(((s,o)=>{t(s[0])&&(e.geometry.coordinates[r][a][o][0]=s[0]+=i)}))}))})),e}}},{name:"115th-Hexagon",value:{level:"CD115HEX",indexedProps:["GEO_ID"],featureCb:e=>(e.properties.GEO_ID=e.properties.STATEAB+"-"+e.properties.CDLABEL.padStart(2,"0"),e)}}]},{name:"DC",options:[{name:"Wards (2012)",value:{level:"Wards2012",indexedProps:["WARD"]}},{name:"ANCs (2013)",value:{level:"ANC2013",indexedProps:["ANC_ID"]}},{name:"Neighborhoods",value:{level:"Neighborhoods",indexedProps:["subhood"]}}]}]}]},{name:"South America",options:[{name:"Argentina",options:[{name:"Province",value:{level:"Adm4"}},{name:"Department",value:{level:"Adm5"}}]},{name:"Bolivia",options:[{name:"Department",value:{level:"Adm4"}},{name:"Province",value:{level:"Adm6"}}]},{name:"Brazil",options:[{name:"State",value:{level:"Adm4"}}]},{name:"Chile",options:[{name:"Regions",value:{level:"Adm4"}},{name:"Province",value:{level:"Adm6"}}]},{name:"Colombia",options:[{name:"Department",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Ecuador",options:[{name:"Province",value:{level:"Adm4"}},{name:"Cantons",value:{level:"Adm6"}}]},{name:"Guyana",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Paraguay",options:[{name:"Department",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm8"}}]},{name:"Peru",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Suriname",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Uruguay",options:[{name:"Department",value:{level:"Adm4"}}]},{name:"Venezuela",options:[{name:"State",value:{level:"Adm4"}}]}]},{name:"South Asia",options:[{name:"Afghanistan",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Bangladesh",options:[{name:"Divisions",value:{level:"Adm4",indexedProps:"Division"}},{name:"District",value:{level:"Adm5",indexedProps:"District",alternatives:{NETRAKONA:["NETROKONA"],BRAHAMANBARIA:["BRAHMANBARIA"],NAWABGANJ:["CHAPAI NAWABGANJ"]}}},{name:"Upazilas",value:{level:"Adm6",indexedProps:"Upazila",alternatives:{NETRAKONA:["NETROKONA"],BRAHAMANBARIA:["BRAHMANBARIA"],NAWABGANJ:["CHAPAI NAWABGANJ"]}}}]},{name:"Bhutan",options:[{name:"District",value:{level:"Adm4"}},{name:"Gewogs",value:{level:"Adm6"}}]},{name:"India",options:[{name:"State_Union_Territory",value:{level:"Adm4"}},{name:"District",value:{level:"Adm5"}}]},{name:"Nepal",options:[{name:"Region",value:{level:"Adm4"}},{name:"Zone",value:{level:"Adm5"}},{name:"District",value:{level:"Adm6"}}]},{name:"Pakistan",options:[{name:"Province",value:{level:"Adm3"}}]},{name:"Sri Lanka",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm5"}}]}]},{name:"Sub-Saharan Africa",options:[{name:"Angola",options:[{name:"Province",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"Benin",options:[{name:"Department",value:{level:"Adm4"}},{name:"Communes",value:{level:"Adm6"}}]},{name:"Botswana",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Burkina Faso",options:[{name:"Regions",value:{level:"Adm4"}},{name:"Province",value:{level:"Adm5"}}]},{name:"Burundi",options:[{name:"Provices",value:{level:"Adm4"}}]},{name:"Cameroon",options:[{name:"Regions",value:{level:"Adm4"}},{name:"Department",value:{level:"Adm6"}}]},{name:"Central African Republic",options:[{name:"Prefectures",value:{level:"Adm4"}}]},{name:"Chad",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Congo",options:[{name:"Department",value:{level:"Adm4"}}]},{name:"Djibouti",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"DR-Congo",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Eritrea",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Ethiopia",options:[{name:"Region",value:{level:"Adm4"}},{name:"Zone",value:{level:"Adm5"}}]},{name:"Gabon",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Ghana",options:[{name:"Governorate",value:{level:"Adm4"}}]},{name:"Gambia",options:[{name:"Regions",value:{level:"Adm4"}},{name:"LGAs",value:{level:"Adm5"}}]},{name:"Guinea",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Ivory Coast",options:[{name:"District",value:{level:"Adm4"}},{name:"Region",value:{level:"Adm5"}}]},{name:"Kenya",options:[{name:"County",value:{level:"Adm4"}}]},{name:"Lesotho",options:[{name:"District",value:{level:"Adm5"}}]},{name:"Liberia",options:[{name:"County",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Madagascar",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Malawi",options:[{name:"Region",value:{level:"Adm3"}},{name:"District",value:{level:"Adm4"}}]},{name:"Mali",options:[{name:"Region",value:{level:"Adm4"}},{name:"Cercle",value:{level:"Adm6"}}]},{name:"Mauritania",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Mozambique",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Namibia",options:[{name:"Region",value:{level:"Adm4"}}]},{name:"Niger",options:[{name:"Region",value:{level:"Adm4"}},{name:"Department",value:{level:"Adm6"}}]},{name:"Nigeria",options:[{name:"State",value:{level:"Adm4"}},{name:"LGA",value:{level:"Adm6"}}]},{name:"Rwanda",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Senegal",options:[{name:"Region",value:{level:"Adm3"}}]},{name:"Somalia",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Sierra Leone",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm5"}}]},{name:"South Africa",options:[{name:"Province",value:{level:"Adm4"}},{name:"Municipality",value:{level:"Adm6"}}]},{name:"South Sudan",options:[{name:"State",value:{level:"Adm4"}},{name:"County",value:{level:"Adm6",indexedProps:["ADM2_EN","ADM2_PCODE"]}}]},{name:"Sudan",options:[{name:"State",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]},{name:"Swaziland",options:[{name:"District",value:{level:"Adm4"}},{name:"Inkhundla",value:{level:"Adm6"}}]},{name:"Tanzania",options:[{name:"Region",value:{level:"Adm4"}},{name:"District",value:{level:"Adm5"}}]},{name:"Togo",options:[{name:"Region",value:{level:"Adm4"}},{name:"Prefecture",value:{level:"Adm6"}}]},{name:"Uganda",options:[{name:"District",value:{level:"Adm4"}}]},{name:"Zambia",options:[{name:"Province",value:{level:"Adm4"}}]},{name:"Zimbabwe",options:[{name:"Province",value:{level:"Adm4"}},{name:"District",value:{level:"Adm6"}}]}]}]},It=!1;function Et(){function e(t,i){if(t.value){var s=t.value.level;"World"!==i[0]&&"Custom"!==i[0]&&(i=i.slice(1));var r=`Map_${i.map((e=>e.replace(/ /g,"").replace(/-/g,""))).join("_")}_${s}`;ae.maps.set(r,new Nt(r,`${ae.geoFileDir}${i.concat(s).join("/")}.${ae.geoFileExt}`,t.value))}else t.options&&(i=i.concat([t.name]),t.options.forEach((t=>e(t,i))))}It||(Bt.options.forEach((t=>e(t,[]))),It=!0)}class Ft{constructor(e,t){this.DOM=null,this.browser=e,this.selectType=t}showCrumb(e,t){var i,s;this.selectType=e,this.timeoutHide&&window.clearTimeout(this.timeoutHide);let r=t instanceof ve?t.attrib:null;if(!this.DOM){var a="Filter"===this.selectType?this.browser.DOM.breadCrumbs_Filter:this.browser.DOM.breadCrumbs_Compare;this.DOM=a.append("span").html("<span class='breadCrumbIcon'><i class='fa fa-filter'></i><i class='far fa-times'></i></span><span class='crumbText'><span class='crumbHeader blockName'></span><span class='crumbDetails'></span></span>").each(((e,t,i)=>{if("Filter"===this.selectType){let e=i[t];var s=e.parentNode.childNodes.length;s>1&&e.parentNode.insertBefore(e,e.parentNode.childNodes[s-2])}})).on("mouseenter",(()=>{"Filter"!==this.selectType&&this.browser.refreshAllMeasureLabels(this.selectType)})).on("mouseleave",(()=>{"Filter"===this.selectType&&this.browser.refreshAllMeasureLabels("Active")})).on("click",(()=>{"Filter"===this.selectType?t.clearFilter():(this.browser.clearSelect_Compare(this.selectType,!0,!0),this.browser.refreshAllMeasureLabels("Active"))})),this.DOM.style("opacity",0).transition().style("opacity",1)}if(this.DOM.attr("class","breadCrumb crumbMode_"+this.selectType).attr("data-summaryID",null!==(i=null==r?void 0:r.attribID)&&void 0!==i?i:null).tooltip((()=>me["Filter"===this.selectType?"RemoveFilter":"Unlock"])),"Filter"===this.selectType){this.browser.DOM.breadCrumbs_Filter.node().appendChild(this.DOM.node());var o=this.DOM.select(".crumbHeader");r?r.addDOMBlockName(o):o.html(t.title),this.DOM.select(".crumbDetails").html(t.filterView_Detail())}else this.DOM.select(".crumbDetails").html((null===(s=this.browser.selectedAggrs[this.selectType])||void 0===s?void 0:s.label)||"");this.browser.checkAndAdjustBreadcrumbs()}removeCrumb(){this.DOM&&(this.timeoutHide&&window.clearTimeout(this.timeoutHide),this.timeoutHide=window.setTimeout((()=>{this.timeoutHide=0,this.DOM.style("opacity",0).transition().delay(300).remove().on("end",(()=>{var e;null===(e=this.DOM.node().tippy)||void 0===e||e.hide(),this.browser.checkAndAdjustBreadcrumbs(),this.DOM=null}))}),"Filter"===this.selectType||this.browser.lockedCompare[this.selectType]?0:1e3))}}var Gt={AttribPanel:{name:"Options",items:[{id:"CollapseAll",name:"Collapse All",iconClass:"fa fa-caret-up",do:e=>e.collapseAttribListGroups(!0)},{id:"ExpandAll",name:"Expand All",iconClass:"fa fa-caret-down",do:e=>e.collapseAttribListGroups(!1)},{id:"SetAttribPanelWidth",name:"Set panel width",iconClass:"far fa-arrows-h",do:e=>{var t=ye.prompt("Enter width in pixels (between 200 and 400)",e.attribPanelWidth);t&&e.setAttribPanelWidth(t)}}]},Attrib_Grouping:{name:"Settings",items:[{id:"createTimeseries",name:"Create Timeseries",iconClass:"far fa-chart-line",when:()=>!0,do:(e,t)=>{if("prompt()"!==t||(t=ye.prompt("Enter time index format"))){var i=ae.browser,s=e.parents.slice();s.push(e.name);var r=s.join("->");i.onLoad[r]=`${r}->\${DATETIME(${t})}`;var a=i.exportConfig();a.summaries=a.summaries.filter((e=>{var t,s=i.attribWithName(e.name);return!!s&&(!!(null===(t=s.block)||void 0===t?void 0:t.inDashboard)||r!==s.template.pathStr)})),i=ae.reloadWithNewConfig(i,a)}},options:[{name:"YYYY",sampleValue:"2019",value:"%Y"},{name:"YYYY-MM",sampleValue:"2019-12",value:"%Y-%m"},{name:"YYYY-MM-DD",sampleValue:"2019-12-30",value:"%Y-%m-%d"},{name:"MM/DD/YYYY",sampleValue:"12/30/2019",value:"%m/%d/%Y"},{name:"MM/DD/YY",sampleValue:"12/30/16",value:"%m/%d/%y"},{name:"YYYY-MM-DD",sampleValue:"2019-12-30",value:"%Y-%m-%d"},{name:"<i>Custom</i>",value:"prompt()"}]}]},Attribute:{name:"Settings",items:[{id:"renameAttrib",name:"Rename",iconClass:"far fa-pencil",helparticle:"5ea92f902c7d3a5ea54a1c35",when:e=>!e.hasTimeSeriesParent(),do:e=>{var t=ye.prompt("Please enter the new attribute name.",e.attribName);t&&(e.attribName=t)}},{id:"setDescription",name:"Set description",iconClass:"fa fa-info",helparticle:"5ea8b8dc2c7d3a5ea54a18ad",when:e=>!e.hasTimeSeriesParent(),do:e=>{var t=ye.prompt("Please enter a short description for this attribute.",e.description?e.description:"");null!=t&&(e.description=t)}},{id:"setUnitName",name:"Set unit-name",iconClass:"far fa-ellipsis-h",helparticle:"5e88f31404286364bc97d467",when:e=>("timeseries"===e.type||"numeric"===e.type)&&!e.hasTimeSeriesParent(),do:e=>{var t=ye.prompt("Please enter the unit name",e.unitName||"");null!=t&&(e.unitName=t)}},{id:"convertDataType",name:"Convert data type",iconClass:"fa fa-wrench",options:[{id:"cat_splitCat",name:"Multi-Cat. (Split by)",iconClass:"far fa-tags",helparticle:"5e88d4172c7d3a7e9aea63ac",when:e=>e instanceof mt&&!e.isMultiValued,do:(e,t)=>{("prompt()"!==t||(t=ye.prompt("Enter split format")))&&(e.browser.onLoad.main[e.template.str]=`SPLIT(${t})`,window.dashboard=ae.reloadWithNewConfig(e.browser,e.browser.exportConfig()))},options:[{name:"Space",iconXML:"_",value:"\\s+",hint:"Any whitespace"},{name:"Comma",iconXML:",",value:"\\s*,\\s*"},{name:"Semicolumn",iconXML:";",value:"\\s*;\\s*"},{name:"Vertical-bar",iconXML:"|",value:"\\s*\\|\\s*"},{name:"Plus",iconXML:"+",value:"\\s*\\+\\s*"},{name:"Star",iconXML:"*",value:"\\s*\\*\\s*"},{name:"Custom",iconXML:"?",value:"prompt()"}]},{id:"convertToCategorical",name:"Categorical",iconClass:"fa fa-tag",helparticle:"5e890d9104286364bc97d4ff",when:e=>e instanceof Ye&&!e.timeseriesParent,do:e=>{ye.confirm(`Do you want to convert <i>${e.attribName}</i> to categorical data?`,"Convert").then((()=>{e.browser.onLoad.main[e.template.str]="STR()";var t=e.browser.exportConfig();t.summaries.filter((t=>t.name===e.attribName)).forEach((e=>{e.type="categorical"})),t.metric&&t.metric.summary===e.attribName&&delete t.metric,window.dashboard=ae.reloadWithNewConfig(e.browser,t)}),(()=>{}))}},{id:"num_convertToTimestamp",name:"Timestamp",iconClass:"far fa-calendar-alt",helparticle:"5e88ec2c04286364bc97d44b",when:e=>e instanceof Ye&&!e.timeseriesParent,do:(e,t)=>{if("prompt()"!==t||(t=ye.prompt("Enter datetime format, using https://github.com/d3/d3-time-format#locale_format"))){e.browser.onLoad.main[e.template.str]=`DATETIME(${t})`;var i=e.browser.exportConfig();i.summaries.filter((t=>t.name===e.attribName)).forEach((e=>{delete e.type,delete e.showPercentiles,delete e.skipZero})),window.dashboard=ae.reloadWithNewConfig(e.browser,i)}},options:[{name:"YYYY",sampleValue:"2019",value:"%Y"},{name:"Serial/Sheet date",sampleValue:"42010.2",value:"%sn"},{name:"UNIX epoch-sec",sampleValue:"1499310012",value:"%s"},{name:"UNIX epoch-ms",sampleValue:"1499310012000",value:"%Q"},{name:"<i>Custom</i>",sampleValue:"?",value:"prompt()"}]},{id:"cat_convertToTimestamp",name:"Timestamp",iconClass:"far fa-calendar",helparticle:"5e88ec2304286364bc97d44a",when:e=>e instanceof mt&&!e.isMultiValued&&!e.catGeo,do:(e,t)=>{if("prompt()"!==t||(t=ye.prompt("Enter datetime format, using https://github.com/d3/d3-time-format#locale_format"))){e.browser.onLoad.main[e.template.str]=`DATETIME(${t})`;var i=e.browser.exportConfig();i.summaries.filter((t=>t.name===e.attribName)).forEach((e=>{delete e.type,delete e.catLabel,delete e.catSortBy,delete e.catGeo,delete e.barHeight,delete e.showSetMatrix})),window.dashboard=ae.reloadWithNewConfig(e.browser,i)}},options:[{name:"YYYY",sampleValue:"2019",value:"%Y"},{name:"MM/DD/YYYY",sampleValue:"12/30/2019",value:"%m/%d/%Y"},{name:"DD/MM/YYYY",sampleValue:"30/12/2019",value:"%d/%m/%Y"},{name:"MM/DD/YY",sampleValue:"12/30/16",value:"%m/%d/%y"},{name:"YYYY-MM-DD",sampleValue:"2019-12-30",value:"%Y-%m-%d"},{name:"MM/DD/YYYY hh:mm",sampleValue:"12/30/2019 13:10",value:"%m/%d/%Y %H:%M"},{name:"DD/MM/YYYY hh:mm",sampleValue:"30/12/2019 13:10",value:"%d/%m/%Y %H:%M"},{name:"Date-Time-Z",sampleValue:"2018-07-02T16:24:36Z",value:"%Y-%m-%dT%H:%M:%S%Z"},{name:"<i>Custom</i>",value:"prompt()"}]}]},Bt,{id:"extractTimeKey",name:"Extract time key",iconClass:"far fa-calendar-day",when:e=>e instanceof rt,options:e=>e.timeKeys.filter((t=>!e.timeKeyAttribs[t._time_src])).map((e=>({name:e._time_src,value:e}))),do:(e,t)=>{e.getTimepointSummary(t).block.addToPanel(e.browser.panels.left),e.browser.updateLayout()}},{id:"deriveMenuOpt",name:"Generate",iconClass:"fa fa-share",when:e=>e.template.str,options:[{id:"deriveChangeOverTime",name:"Change over time",when:e=>e instanceof rt&&!e.parent&&(!e.derivatives["TimeseriesChange-%"]||!e.derivatives["TimeseriesChange-#"]),do:(e,t)=>{e.createDerivedAttrib(`Change(${t})`,`${e.attribName} - ${"%"===t?"Percent":"Absolute"} Change`)},options:e=>{var t=[];return e.derivatives["TimeseriesChange-%"]||t.push({name:"% Percent change",value:"%"}),e.derivatives["TimeseriesChange-#"]||t.push({name:"# Absolute change",value:"#"}),t}},{id:"time_deriveComponent",name:"Time unit",iconClass:"far fa-calendar",when:e=>e instanceof Vt,do:(e,t)=>e.createDerivedAttrib(t),options:[{id:"time_deriveYear",name:"Year",when:e=>e.timeTyped.year&&!e.derivatives.Year,value:"Year()"},{id:"time_deriveMonth",name:"Month",when:e=>e.timeTyped.month&&!e.derivatives.Month,value:"Month()"},{id:"time_deriveDayOfMonth",name:"Day of Month",when:e=>e.timeTyped.day&&!e.derivatives.DayOfMonth,value:"DayOfMonth()"},{id:"time_deriveWeekday",name:"Weekday",when:e=>e.timeTyped.day&&!e.derivatives.WeekDay,value:"WeekDay()"},{id:"time_deriveHour",name:"Hour",when:e=>e.timeTyped.hour&&!e.derivatives.Hour,value:"Hour()"}]},{id:"cat_deriveDegree",name:"Degree (# of)",iconClass:"far fa-hashtag",when:e=>e instanceof mt&&e.isMultiValued&&!e.derivatives.Degree,do:e=>e.createDerivedAttrib("Degree()")}]},{id:"num_keepPositive",name:"Keep positive (>0) values",iconClass:"fa fa-plus",when:e=>e instanceof Ye&&e.rangeOrg[0]<=0,do:e=>{ye.confirm(`Do you want to remove zero-values from <i>${e.attribName}</i>?`,"Remove").then((()=>{e.browser.onLoad.main[e.template.str]="POSITIVE()",window.dashboard=ae.reloadWithNewConfig(e.browser,e.browser.exportConfig())}),(()=>{}))}},{id:"CompareSelectionControl",name:"Comparable",iconClass:"fa fa-clone",do:(e,t)=>e.isComparable.set(t),options:[{name:"Enable",value:!0,iconClass:"far fa-check",active:e=>e.isComparable.is(!0)},{name:"Disable",value:!1,iconClass:"far fa-times",active:e=>!e.isComparable.is(!0)}]},{id:"aggregateFunctions",name:"Aggregation",iconClass:"fa fa-cubes",helparticle:"5e8944dd04286364bc97d5f0",when:e=>e.canHaveMetricFuncs&&!e.hasTimeSeriesParent(),options:[{name:"Average",do:(e,t)=>{t?e.addSupportedMetricFunc("Avg"):e.removeSupportedMetricFunc("Avg")},options:[{name:"Enabled",value:!0,iconClass:"far fa-check",active:e=>e.supportedMetricFuncs.includes("Avg")},{name:"Disabled",value:!1,iconClass:"far fa-times",active:e=>!e.supportedMetricFuncs.includes("Avg")}]},{name:"Sum",do:(e,t)=>{t?e.addSupportedMetricFunc("Sum"):e.removeSupportedMetricFunc("Sum")},options:[{name:"Enabled",value:!0,iconClass:"far fa-check",active:e=>e.supportedMetricFuncs.includes("Sum")},{name:"Disabled",value:!1,iconClass:"far fa-times",active:e=>!e.supportedMetricFuncs.includes("Sum")}]}]},{id:"removeMap",name:"Remove map",iconClass:"far fa-undo",when:e=>e instanceof mt&&null!==e.catGeo,do:e=>e.removeCatGeo()},{id:"removeDerive",name:"Remove derivation",iconClass:"far fa-undo",when:e=>e.template.special,do:e=>e.destroy()},{id:"removeRecordGeo",name:"Remove record geography",iconClass:"far fa-undo",when:e=>e instanceof tt,do:e=>{e.destroy(),window.dashboard=ae.reloadWithNewConfig(e.browser,e.browser.exportConfig())}},{id:"removeModification",name:"Remove modification",iconClass:"far fa-undo",when:e=>!!e.browser.onLoad.main[e.template.str],do:e=>{var t=e.template.str;ye.confirm(`Do you want to delete the modification ${e.browser.onLoad.main[t]} ?`,me.Delete).then((()=>{delete e.browser.onLoad.main[t],window.dashboard=ae.reloadWithNewConfig(e.browser,e.browser.exportConfig())}))}},{id:"setAsRecordID",name:"Set as record ID",iconClass:"far fa-fingerprint",when:e=>e.attribName!==e.browser.idSummaryName&&(e._aggrs&&e._aggrs.length===e.browser.records.length&&!e.template.special),do:e=>{if(e.template.str){var t=e.browser.exportConfig();t.source[0].id=e.template.str,t.summaries=t.summaries.filter((t=>t.name!==e.browser.idSummaryName)),window.dashboard=ae.reloadWithNewConfig(e.browser,t)}else ye.alert("Not supported. [756]")}}]}};const zt={select:a,pointer:_,min:c,max:d};class Ht{hasBlocks(){return this.attribs.length>0}isEmpty(){return 0===this.attribs.length}get blocks(){return this.attribs.map((e=>e.block))}get attribs_Categorical(){return this.attribs.filter((e=>e instanceof mt))}constructor(e,t,i){this.attribs=[],this._width_CatBars=0,this._width_CatMeasureLabel=10,this._width_CatText=175,this.heightRemaining=0,this._syncedMeasureExtent=[0,1],this.browser=e,this._name=t,this.DOM={root:i.append("div").attr("class","panel panel_"+this.name).classed("panel_side","left"===this.name||"right"===this.name).classed("hasBlocks",!1)},this.initDOM_AdjustWidth(),this.addDOM_DropZone(),this.refreshBlocksDropZonesOrder();let s=this.browser.width_Canvas;"bottom"!==this.name&&(s/=3),this.setWidth(s)}get name(){return this._name}welcomesNewBlock(){return this.isEmpty()||this.blocks.length<Math.floor(this.height/150)||this.heightRemaining>0}get width_CatText(){return this._width_CatText}get width_CatLabel(){return this.width_CatText-(this.browser.stackedCompare.is(!0)&&!this.hiddenCatBars()?0:this.width_CatMeasureLabel)}get width_CatMeasureLabel(){return this._width_CatMeasureLabel}get width_Real_withGap(){return 0===this.width_Real?0:"left"===this.name||"right"===this.name?this.hasBlocks()?this.width_Real+ae.width_PanelGap:0:this.width_Real}get width_Real(){return"middle"===this.name?this.browser.width_Canvas-this.browser.panels.left.width_Real_withGap-this.browser.panels.right.width_Real_withGap:"bottom"===this.name?this.browser.width_Canvas:this.isEmpty()?0:this.isCollapsed()?this.DOM.root.node().offsetWidth:this.width_CatText+this.width_CatBars+ae.width_ScrollBar}set width_CatText(e){if((e=Math.max(ae.width_CatLabelMin,e))===this.width_CatText)return;let t=this.width_CatText-e;this._width_CatText=e,this.attribs_Categorical.forEach((e=>e.block.refreshLabelWidth())),this.width_CatBars=this.width_CatBars+t}get width_CatBars(){return this._width_CatBars}set width_CatBars(e){e=Math.max(e,0),this._width_CatBars=e,this.DOM.root.classed("hideCatBars",!!this.hiddenCatBars()),this.refreshWidth()}setWidth(e){this.width_CatBars=e-this.width_CatText-ae.width_ScrollBar}refreshWidth(){this.DOM.root.style("width",this.width_Real+"px"),this.attribs.forEach((e=>e.block.refreshWidth()))}updateWidth_CatMeasureLabels(){this._width_CatMeasureLabel=this.calcWidth_MeasureLabel(),this.attribs_Categorical.forEach((e=>e.block.refreshLabelWidth()))}hiddenCatBars(){return this.width_CatBars<=20}initDOM_AdjustWidth(){"middle"!==this.name&&"bottom"!==this.name&&this.DOM.root.append("span").attr("class","panelAdjustWidth").tooltip(me["Adjust Panel Width"]).on("mousedown",(e=>{if(1===e.which){var t=zt.pointer(e,document.body)[0],i=this.width_CatBars;this.browser.activateWidthDrag(e.currentTarget,e,(e=>{var s=zt.pointer(e,document.body)[0]-t;"right"===this.name&&(s*=-1),this.width_CatBars=i+s,this.browser.updateMiddlePanelWidth(),this.browser.updateLayout_Height()}))}})).on("click",(e=>{e.stopPropagation(),e.preventDefault()}))}calcWidth_MeasureLabel(){var e,t,i;if(this.isEmpty())return 0;if(this.browser.percentBreakdown)t=99,i=0;else if(t=zt.max(this.attribs,(e=>e.getPeakAggr(zt.max,"Active"))),i=zt.max(this.attribs,(e=>e.getPeakAggr(zt.min,"Active"))),0===t&&0===i)return 0;for(var s=2,r=1;t>9;)r++,t=Math.floor(t/10);if(this.browser.hasIntOnlyMeasure()||(r+=2,s+=8),r>4&&(r=3,s+=3,s+=10),s+=6.5*r,this.browser.percentBreakdown)ae.percentDecimal?s+=24:s+=13;else{var a=null===(e=this.browser.measureSummary.get())||void 0===e?void 0:e.unitName;a&&(s+=2+7*a.length)}return i<0&&(s+=5),s}addBlock(e,t){e.panel=this;var i=this.DOM.root.selectAll(".dropZone").nodes()[t];if(e.DOM.root&&i)e.DOM.root.style("display",""),this.DOM.root.node().insertBefore(e.DOM.root.node(),i);else if(!e.initDOM(i))return;this.DOM.root.classed("hasBlocks",!0);var s=-1;this.attribs.forEach(((t,i)=>{t.block===e&&(s=i)})),-1===s?(t>=this.attribs.length?this.attribs.push(e.attrib):this.attribs.splice(t,0,e.attrib),this.updateWidth_CatMeasureLabels(),e instanceof ot&&(e.refreshLabelWidth(),"map"===e.viewType&&e.catViewAs("map"))):(this.attribs.splice(s,1),this.attribs.splice(t,0,e.attrib)),1===this.attribs.length&&this.refreshWidth(),this.refreshCollapsed(),this.addDOM_DropZone(e.DOM.root.node()),this.addRemove_Finalize()}removeBlock(e){e.panel=void 0;var t=this.DOM.root.selectAll(".dropZone").nodes()[e.orderInPanel];t.parentNode.removeChild(t),this.attribs.splice(e.orderInPanel,1),this.updateWidth_CatMeasureLabels(),this.DOM.root.classed("hasBlocks",this.hasBlocks()),this.hasBlocks()||this.refreshCollapsed(),this.addRemove_Finalize()}addRemove_Finalize(){this.refreshBlocksDropZonesOrder(),"bottom"===this.name&&this.browser.DOM.panel_Wrapper.classed("panel_bottom_empty",!this.hasBlocks()),this.refreshSharedMeasureExtent(),this.attribs.forEach((e=>e.updateChartScale_Measure()))}refreshBlocksDropZonesOrder(){this.attribs.forEach(((e,t)=>{e.block.orderInPanel=t})),this.DOM.root.selectAll(".dropZone").each((function(e,t){this.__data__=t}))}addDOM_DropZone(e=null){let t;t=e?this.DOM.root.insert("div",(()=>e)):this.DOM.root.append("div"),t.attr("class","dropZone").on("mouseenter",(function(){this.classList.add("onHover"),this.children[0].classList.add("onReadyToDrop")})).on("mouseleave",(function(){this.classList.remove("onHover"),this.children[0].classList.remove("onReadyToDrop")})).on("mouseup",(e=>{var t=this.browser.movedAttrib;t&&(t.block.panel&&(t.block.DOM.root.node().nextSibling.style.display="",t.block.DOM.root.node().previousSibling.style.display=""),t.block.addToPanel(this,e.currentTarget.__data__),this.browser.updateLayout())})).call((e=>{e.append("div").attr("class","dropIcon fa fa-chart-bar"),e.append("div").attr("class","dropZoneText").text(me["Drop Chart"])}))}setHeightAndLayout(e){this.height=e,this.heightRemaining=e;var t=!1,i=!1;this.blocks.forEach((e=>{e.dueForLayout=!0}));var s=this.attribs.length,r=e=>{e.dueForLayout&&(this.heightRemaining-=e.height_withMargin,setTimeout((()=>{var t=e.DOM.root.node().getBoundingClientRect().top,i="onBottom";t>300&&(i="onTop"),(t<300||this.width_Real<400)&&("left"===this.name?i="onRight":"right"===this.name&&(i="onLeft")),e.DOM.root.select(".summaryConfig").classed("onBottom","onBottom"===i).classed("onTop","onTop"===i).classed("onRight","onRight"===i).classed("onLeft","onLeft"===i)}),1e3),delete e.dueForLayout,s--)};for(this.blocks.filter((e=>!e.isVisible()||e.hasStaticHeight())).forEach((e=>r(e)));0!==s;){var a=s;if(this.blocks.filter((e=>e.dueForLayout)).forEach((e=>{if(t&&"content"==e.attrib.type)return e.height_RangeMin<this.heightRemaining?e.setHeight(this.heightRemaining):e.setCollapsed(!0),void r(e);if(!0===i&&e.height_RangeMax>e.getHeight())return this.heightRemaining+=e.getHeight(),e.setHeight(this.heightRemaining),void(this.heightRemaining-=e.getHeight());if(0!==s){var a=Math.floor(this.heightRemaining/s);a>=e.height_RangeMax?(e.setHeight(e.height_RangeMax),r(e)):t&&(a>=e.height_RangeMin?(e.setHeight(a),r(e)):"content"!==e.attrib.type&&(e.setCollapsed(!0),r(e)))}})),t=a===s,!0===i)break;0===s&&(i=!0)}"left"!==this.name&&"right"!==this.name||this.refreshCollapsed(),"bottom"!==this.name&&"middle"!==this.name||(this.height=this.height-this.heightRemaining,this.heightRemaining=0),this.attribs.forEach(((e,t)=>{e.block.DOM.root.style("margin-bottom",t===this.attribs.length-1?"0":null)}))}collapseAllSummaries(e){this.attribs.forEach((t=>t.block.setCollapsed(t!==e))),this.browser.updateLayout_Height()}isCollapsed(){return this.hasBlocks()&&this.attribs.every((e=>e.block.collapsed))}refreshCollapsed(){let e=this.DOM.root.classed("collapsed"),t=this.isCollapsed();this.DOM.root.classed("collapsed",t),this.refreshWidth(),e!==t&&this.browser.updateLayout()}refreshSharedMeasureExtent(){let e=this.attribs.filter((e=>e instanceof mt&&e.block.isView_List||e instanceof Fe&&e.block.showHistogram.is(!0))).map((e=>e.measureExtent_Self));this._syncedMeasureExtent=[zt.min(e,(e=>e[0])),zt.max(e,(e=>e[1]))]}get syncedMeasureExtent(){return this._syncedMeasureExtent}exportConfig(){return{catBarWidth:"bottom"!==this.name&&this.width_CatBars,catLabelWidth:this.width_CatText}}importConfig(e){e&&(e.catLabelWidth&&(this.width_CatText=e.catLabelWidth),e.catBarWidth&&"bottom"!==this.name&&(this.width_CatBars=e.catBarWidth))}}class Wt{accepts(e){return e.fileExt}defaultFetchConfig(){return{credentials:"same-origin",method:"GET"}}load(t){return e(this,void 0,void 0,(function*(){return t.isCSV&&t.stream?t.parseData_CSV(t.sourceURL):fetch(t.sourceURL,Object.assign({},this.defaultFetchConfig(),t.fetchConfig)).then((e=>e.text())).then((e=>e.error?Promise.reject(e.error):t.parseData(e)))}))}}class Kt{constructor(){}accepts(e){return"GoogleSheets"===e.type}load(t){return e(this,void 0,void 0,(function*(){yield import("https://apis.google.com/js/platform.js");var e=window.gapi;return yield new Promise(((t,i)=>{e.load("client",(()=>{e.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],apiKey:ae.gapi.gKey,clientId:ae.gapi.clientId,scope:"profile email"}).then((()=>{console.log("✓ gapi.client.init"),t(!0)}),(e=>{console.log(e),i()}))}))})),e.client.setToken(null),new Promise(((i,s)=>{e.client.sheets.spreadsheets.values.get({spreadsheetId:t.gdocId,range:t.name+"!"+(t.range?t.range:"1:300000"),valueRenderOption:"UNFORMATTED_VALUE",dateTimeRenderOption:"SERIAL_NUMBER"}).then((e=>{!e.result&&e.data&&(e.result={values:e.data.data.values});for(var s=e.result.values[0],r=s.filter((e=>e===t.id)).length>0,a=1;a<e.result.values.length;a++){for(var o={},l=0;l<s.length;l++)o[s[l]]=e.result.values[a][l];r||(o[t.id]=""+(a-1)),t.createRecord(o)}t.processHeaderHierarchy(s),i(!0)}),(e=>{s(e)}))}))}))}}var $t=[];class Ut{getRecord(e){return this._byKey[e]}get isLoaded(){return this._isLoaded}load(){return e(this,void 0,void 0,(function*(){if(!this._isLoaded){if(this.onLoad)return this._isLoaded=this.onLoad(),this._isLoaded?void 0:Promise.reject("Cannot load data via custom loader");for(const e of $t){if(e.accepts(this))if(yield e.load(this))return this.postLoad&&this.postLoad(),void(this._isLoaded=!0)}return Promise.reject("Cannot find data loader")}}))}createRecord(e){var t=new Ie(e,this.id);this.records.push(t),this._byKey[t.id]=t}static registerLoader(e){$t.push(e)}constructor(e){var t;if(this.records=[],this._byKey={},this.onLoad=null,this.postLoad=null,this._isLoaded=!1,this.header=!0,this.fastMode=!1,this.dynamicTyping=!0,this.download=!1,this.stream=!1,e instanceof File)return this.type="file",this.name=e.name,void(this.file=e);for(var i in"string"==typeof e&&(e={name:e}),e=Object.assign({},e))this[i]=e[i];this.gdocId&&(this.type="GoogleSheets"),this.id=null!==(t=this.id)&&void 0!==t?t:"id",ae.tables.set(this.name,this)}get fileExt(){return this.fileType?"."+this.fileType.toLowerCase():""}get isCSV(){return".csv"===this.fileExt||".tsv"===this.fileExt}get isGoogleFile(){return"GoogleDrive"===this.dirPath||"https://drive.google.com/file/d/"===this.dirPath}get sourceURL(){return this.fullURL?this.fullURL:this.isGoogleFile?`https://www.googleapis.com/drive/v3/files/${this.name}?alt=media&key=${ae.gapi.gKey}`:(this.dirPath||"")+this.name+this.fileExt}get linkToData(){return this.gdocId?"https://docs.google.com/spreadsheets/d/"+this.gdocId:this.sourceURL}parseData(t){return e(this,void 0,void 0,(function*(){return this.isCSV?yield this.parseData_CSV(t):yield this.parseData_JSON(t)}))}parseData_JSON(t){return e(this,void 0,void 0,(function*(){"string"==typeof t&&(t=JSON.parse(t));var e=this.id;return t.forEach(((t,i)=>{void 0===t[e]&&(t[e]=""+i),this.createRecord(t)})),!0}))}parseData_CSV(t){return e(this,void 0,void 0,(function*(){let e=window.Papa;return e||(yield import("./papaparse.min.js"),e=window.Papa),new Promise(((i,s)=>{let r=0;e.parse(t,{header:!1!==this.header,fastMode:void 0!==this.fastMode&&this.fastMode,dynamicTyping:void 0===this.dynamicTyping||this.dynamicTyping,download:!0===this.stream,chunk:e=>{e.data.forEach((e=>{void 0===e[this.id]&&(e[this.id]=""+r++),this.createRecord(e)}))},complete:()=>{this.processHeaderHierarchy(),null==i||i(!0)},error:e=>{console.log(e),null==s||s("CSV parsing error.")}})}))}))}processHeaderHierarchy(e=null){e||(e=Object.keys(this.records[0].data)),e.forEach((e=>{if("string"==typeof e){var t=e.split("->");if(1!==t.length){var i=(t=t.map((e=>e.trim()))).pop();this.records.forEach((s=>{var r=s.data,a=r[e];null!=a&&(t.forEach((e=>{r=r[e]=r[e]||{}})),r[i]=a),delete s.data[e]}))}}}))}}class Yt extends ze{constructor(e){super(e),this.height_content=0,this.height_max=1e4,this.height_min=100,this.curStep=-1,this.onStep=null}hasStaticHeight(){return!1}get height_Content(){return this.isVisible()?this.height_content:0}get height_RangeMin(){return this.attrib.isEmpty()?this.height_Header:this.height_min}get height_RangeMax(){return this.attrib.isEmpty()?this.height_Header:this.height_max}setHeight(e){this.height_content=Math.min(e,this.height_max)-this.height_Header}refreshWidth(){}onCollapse(){this.collapsed||this.displayStep(0)}initDOM(e){if(this.attrib.isEmpty())return!1;if(this.DOM.inited)return!0;if(this.insertRoot(e),this.setCollapsed(this.collapsed),this.DOM.contentWrapper=this.DOM.wrapper.append("div").attr("class","contentWrapper"),this.DOM.contentBlock=this.DOM.contentWrapper.append("div").attr("class","contentBlock"),this.attrib.isMultiStep()){var t=this.DOM.contentWrapper.append("div").attr("class","stepControls");t.append("div").attr("class","stepDots").selectAll("div").data([...Array(this.attrib.content.length).keys()]).enter().append("div").attr("class","stepDot").html("●").tooltip(me["Jump to step"]).on("click",((e,t)=>this.displayStep(t))),t.append("div").attr("class","dismissButton").html(me.Close).on("click",(()=>this.setCollapsedAndLayout(!0))),t.append("div").attr("class","stepControlGap"),this.DOM.stepPrev=t.append("div").attr("class","stepButton stepPrev").html("<i class='fa fa-angle-double-left'></i>"+me.Previous).on("click",(()=>this.displayStep(this.curStep-1))),this.DOM.stepNext=t.append("div").attr("class","stepButton stepNext").html(me.Next+"<i class='fa fa-angle-double-right'></i>").on("click",(()=>this.displayStep(this.curStep+1))),this.DOM.stepClose=t.append("div").attr("class","stepButton stepClose").html(me.Close+"<i class='fa fa-compress-alt'></i>").on("click",(()=>this.setCollapsedAndLayout(!0)))}return this.DOM.inited=!0,this.displayStep(0),!0}displayStep(e){if(this.DOM.inited&&0!=this.attrib.content.length&&(e=Math.min(Math.max(0,e),this.attrib.content.length-1),this.curStep!==e)){this.curStep=e;var t=this.attrib.content[e];"string"==typeof t?(this.DOM.contentBlock.html(t),this.DOM.contentWrapper.classed("fullIframe",!1)):t.youtube&&(this.DOM.contentBlock.html(`<iframe src='https://www.youtube-nocookie.com/embed/${t.youtube}?controls=0frameborder=0 allow="autoplay; encrypted-media; picture-in-picture"`),this.DOM.contentWrapper.classed("fullIframe",!0)),this.onStep&&this.onStep.call(this),this.DOM.contentBlock.node().scrollTop=0,this.DOM.contentWrapper.classed("firstStep",0===this.curStep).classed("lastStep",this.curStep===this.attrib.content.length-1),this.DOM.contentWrapper.selectAll(".stepDot").classed("active",(e=>this.curStep===e))}}refreshViz_Axis(){}refreshViz_Active(){}refreshViz_Compare(e,t,i,s){}chartAxis_Measure_TickSkip(){}updateAfterFilter(e){}}class jt extends Oe{get block(){return this._block}get content(){return this._content}constructor(e,t){super(e,t,null,"content","kshfBlock_Content","fa fa-file-alt"),this._content=[],this._block=new Yt(this)}isEmpty(){var e;return!((null===(e=this._content)||void 0===e?void 0:e.length)>0)}isMultiStep(){var e;return(null===(e=this._content)||void 0===e?void 0:e.length)>1}applyConfig(t){const i=Object.create(null,{applyConfig:{get:()=>super.applyConfig}});return e(this,void 0,void 0,(function*(){i.applyConfig.call(this,t),this.setContent(t.content),this.block.height_max=t.maxHeight,this.block.height_min=t.minHeight,this.block.onStep=t.onStep}))}setContent(e=[]){var t;this._content=e,null===(t=this.block)||void 0===t||t.displayStep(0)}initializeAggregates(){}updateChartScale_Measure(){}get measureRangeMax(){throw new Error("Not supported")}}const Xt={select:a,max:d,scaleLinear:n};class Zt{constructor(e){this.recordDetailAttribs=[],this.browser=e,this.browser.options.recordDetailAttribs&&(this.recordDetailAttribs=Array.from(this.browser.options.recordDetailAttribs))}get DOM(){return this.browser.DOM}initDOM(){var e=this.DOM.overlay_wrapper.append("div").attr("class","overlay_content overlay_recordDetails");e.append("div").attr("class","overlay_Header"),e.append("div").attr("class","overlay_Close fa fa-window-close").tooltip(me.Close,{placement:"bottom"}).on("click",(()=>this.closeRecordDetailPanel())),e.append("div").attr("class","filterOutRecord fa fa-filter").tooltip(me["Filter out"],{placement:"bottom"}).on("click",(()=>{this.browser.recordDisplay.recordFilter.removeRecord(this.recordInDetail),this.DOM.overlay_wrapper.attr("show","none")})),this.DOM.overlay_recordDetails_content=e.append("div").attr("class","content")}prepareRecordDetailColumns(){this.browser.attribs.forEach((e=>{e.hasTimeSeriesParent()||"_Records"!==e.attribName&&(e.initializeAggregates(),this.recordDetailAttribs.push(e.attribName))})),this.recordDetailAttribs.sort(((e,t)=>{var i=this.browser.attribWithName(e),s=this.browser.attribWithName(t);if(!i)return-1;if(!s)return 1;var r=Re.getAttribTypeOrder(i.type)-Re.getAttribTypeOrder(s.type);return r||Re.sortFunc_List_String(i.attribName,s.attribName)}))}updateRecordDetailPanel_Header(e){var t=this.browser.attribWithName(this.browser.idSummaryName);t.initializeAggregates();var i=this.DOM.overlay_wrapper.select(".overlay_recordDetails > .overlay_Header");i.html(""),i.append("span").attr("class","idSummaryName").html(t.attribName);var s=this.browser.records.length>=2500,r=i.append("span").attr("class","idContentWrapper").classed("disabled",s);r.append("span").attr("class","theText").html(t.getRecordValue(e)),s||(r.append("select").on("change",(e=>{this.updateRecordDetailPanel(e.currentTarget.selectedOptions[0].__data__[0])})),r.select("select").selectAll("option").remove(),r.select("select").selectAll("option").data(this.browser.records.map((e=>[e,t.getRecordValue(e)])).sort(((e,t)=>Re.sortFunc_List_String(e[1],t[1])))).enter().append("option").attr("selected",(t=>t[0].id===e.id||null)).html((e=>e[1])))}closeRecordDetailPanel(){var e;this.recordInDetail&&(this.recordInDetail=null,null===(e=this.browser.options.onRecordClose)||void 0===e||e.call(this),this.DOM.overlay_wrapper.attr("show","none"))}updateRecordDetailPanel(e){var t;if(null!=e)if(this.recordInDetail=e,this.DOM.overlay_wrapper.attr("show","recordDetails").classed("easyDismiss",!0),this.updateRecordDetailPanel_Header(e),this.browser.options.onRecordView)this.DOM.overlay_recordDetails_content.html(this.browser.options.onRecordView.call(e.data,e));else{0===this.recordDetailAttribs.length&&this.prepareRecordDetailColumns(),this.recordDetailAttribs_Hidden=[],this.browser.attribs.forEach((t=>{t.initializeAggregates(),t.hasTimeSeriesParent()||this.recordDetailAttribs.indexOf(t.attribName)>=0||null!=t.getRecordValue(e)&&this.recordDetailAttribs_Hidden.push(t.attribName)}));var i={name:"Edit order",items:[{name:"▲ Move up",do:t=>{var i=t.summaryName,s=this.recordDetailAttribs.indexOf(i);-1!=s&&0!==s&&(this.recordDetailAttribs.splice(s,1),this.recordDetailAttribs.splice(s-1,0,i),this.updateRecordDetailPanel(e))}},{name:"▼ Move down",do:t=>{var i=t.summaryName,s=this.recordDetailAttribs.indexOf(i);-1!=s&&s!==this.recordDetailAttribs.length-1&&(this.recordDetailAttribs.splice(s,1),this.recordDetailAttribs.splice(s+1,0,i),this.updateRecordDetailPanel(e))}},{name:"Remove",iconClass:"fa fa-minus-square",do:t=>{this.recordDetailAttribs=this.recordDetailAttribs.filter((e=>e!==t.attribName)),this.updateRecordDetailPanel(e)}},{name:"Add below",iconClass:"fa fa-plus-square",when:()=>this.recordDetailAttribs_Hidden.length>0,do:(t,i)=>{var s=this.recordDetailAttribs.indexOf(t.attribName);-1!==s&&(this.recordDetailAttribs.splice(s+1,0,i),this.recordDetailAttribs_Hidden=this.recordDetailAttribs_Hidden.filter((e=>e!==i)),this.updateRecordDetailPanel(e))},options:this.recordDetailAttribs_Hidden.map((e=>({name:e,value:e})))}]},s={_basic:[],_timeseries:[]};this.recordDetailAttribs.forEach((t=>{if(t!==this.browser.idSummaryName){var i=this.browser.attribWithName(t);if(i){var r=i.getRecordValue(e);if(null!=r&&0!==r.length){var a="timeseries"===i.type?s._timeseries:s._basic;i.pathName.forEach((e=>{if(!a.some((t=>!(t instanceof Oe)&&(t.path===e&&(a=t.items,!0))))){var t={path:e,items:[]};a.push(t),a=t.items}})),a.push(i)}}}})),["_basic","_timeseries"].forEach((e=>{var t=e=>e.filter((i=>i.path?(i.items=t(i.items),!0):!e.some(((e,t)=>!(e instanceof Oe)&&(e.path===i.printName&&(e.items.unshift(i),!0))))));s[e]=t(s[e])}));var r=e=>e.reduce(((e,t)=>t.path?1+Xt.max(t.items,(e=>e.items?r(e.items):1)):e),0),a=r(s._timeseries);this.DOM.overlay_recordDetails_content.html("");var o=this.DOM.overlay_recordDetails_content.append("table").attr("class","recordAttribTable"),l=(t,s,r)=>{var o=t.selectAll("tr.nonexistent").data(s).enter().append("tr"),n=r[r.length-1]||"",h=e=>{e.append("div").attr("class","attribHierarchyWrapper").call((t=>{t.filter((e=>!e.printName||e.printName===n)).append("span").attr("class","hrchyItem collapseArrow").on("click",(()=>e.node().parentNode.parentNode.classList.toggle("collapsed"))).append("span").attr("class","fa fa-caret-down").tooltip("Show/Hide components"),t.selectAll("span.extendLine").data((e=>Array.from(r).filter((t=>t!=e.printName)))).enter().append("span").attr("class","hrchyItem extendLine")}))},c=e=>{e.append("td").attr("class","recAttribName").call((e=>{e.filter((e=>e.description)).append("span").attr("class","summaryDescription far fa-info-circle").tooltip((e=>e.description),{placement:"bottom"}),e.append("span").attr("class","TheName").style("font-size",Math.pow(1.1,a-r.length)+"em").html((e=>e.printName.trim())),e.append("span").attr("class","modifyAttribPos fa fa-bars").on("click",((e,t)=>ye.popupMenu(e,i,t))),h(e)}))};o.filter((e=>!(e instanceof rt))).attr("class","attribRow basicAttrib").classed("groupTitle",(e=>e.printName===n)).attr("summaryID",(e=>e.attribID)).each(((t,i,s)=>{if(t instanceof Oe){var r=Xt.select(s[i]);t.initializeAggregates(),c(r);var a=r.append("td").attr("class","recAttribVal").attr("colspan",5);t.renderRecordValue(e,a)}})),o.filter((e=>e instanceof rt)).attr("class","attribRow timeseriesAttrib").classed("groupTitle",(e=>e.printName===n)).attr("summaryID",(e=>e.attribID)).call((t=>{c(t),t.append("td").attr("class","recTimeKeyValue").call((e=>{e.append("div").attr("class","ValueText"),e.filter((e=>e.isComparable.val)).append("div").attr("class","ValueBar").append("div").attr("class","TheBar")})),t.append("td").attr("class","recTimeKeyChange").tooltip("",{placement:"bottom"}).html("<i class='fa fa-angle-right'></i>"),t.append("td").attr("class","recTimeKeyRank"),t.append("td").attr("class","recAttribVal").each(((t,i,s)=>{t.renderRecordValue(e,Xt.select(s[i]),this.recordDetailTimeKeys)}))})),o.filter((e=>!(e instanceof Oe))).attr("class","groupedTableWrapper").append("td").append("table").append("tbody").attr("class","groupedTable collapsed").each(((e,t,i)=>{var s=Xt.select(i[t]);if(e.items[0].printName!==e.path){var o=s.append("tr").attr("class","groupTitle");o.append("td").attr("class","recAttribName").call((t=>{t.append("span").attr("class","TheName").style("font-size",Math.pow(1.1,a-r.length)+"em").on("click",(()=>s.node().classList.toggle("collapsed"))).html(e.path.trim()),h(t)})),o.append("td").attr("class","groupNameGap")}l(s,e.items,r.concat([e.path]))}))};if(l(o.append("tbody").attr("class","basicAttribs"),s._basic,[]),s._timeseries.length>0){o.append("tr").style("height","0.5em").style("grid-column","1 / span 5");var n=o.append("tbody").attr("class","timeseriesAttribs");this.recordDetailTimeKeys=e.getTimeKeys(),this.browser.recordDisplay.config.timeseriesWidth=Math.min(70*(this.recordDetailTimeKeys.length-1),400),(h=n.append("tr")).append("td");var h,c=h.append("td").attr("colspan",3).attr("class","timeKeySelect");c.append("i").attr("class","prevTimeKey fa fa-caret-left").tooltip(me.Previous).on("click",(()=>this.updateFocusedTimeKey(this.timeKey_Step("previous")))),c.append("select").on("change",(e=>this.updateFocusedTimeKey(e.currentTarget.selectedOptions[0].__data__))).selectAll("option").data(this.recordDetailTimeKeys,(e=>e._time)).enter().append("option").text((e=>e._time_src)),c.append("i").attr("class","nextTimeKey fa fa-caret-right").tooltip(me.Next).on("click",(()=>this.updateFocusedTimeKey(this.timeKey_Step("next")))),h.append("td").attr("class","timeseriesEditView"),(h=n.append("tr").attr("class","columnHead")).append("td"),h.append("td").attr("class","columnHead_Value").text("Value"),h.append("td").attr("class","columnHead_Change").text("Change"),h.append("td").attr("class","columnHead_Rank").text("Rank"),h.append("td").attr("class","columnHead_TimeTrends").text("Time Trends"),l(n,s._timeseries,[]),this.updateFocusedTimeKey(this.recordDetailTimeKeys[0])}null===(t=this.browser.updateRecordDetailPanel_custom)||void 0===t||t.call(this,e)}else this.closeRecordDetailPanel()}updateFocusedTimeKey(e){var t;if(this.recordInDetail&&e){var i=e._time_src,s=this.getTimeKey_Index(e);if(!(s<0)){this.timeKeyInDetail=e;var r=s>=this.recordDetailTimeKeys.length-1?null:this.recordDetailTimeKeys[s+1];Xt.select(".timeKeySelect > .nextTimeKey").classed("active",0!==s),Xt.select(".timeKeySelect > .prevTimeKey").classed("active",s!==this.recordDetailTimeKeys.length-1);var a=this.DOM.overlay_recordDetails_content.select("table.recordAttribTable");a.selectAll(".timeseriesAttribs tr:first-child > td > select > option").data([e],(e=>e._time)).node().selected=!0,a.selectAll(".timeseriesAttribs .recTimeKeyValue").each((e=>e.computeRecordRanks())),a.selectAll(".timeseriesAttribs .recTimeKeyValue > .ValueText").html((e=>{var t=e.getRecordValue(this.recordInDetail);if(!t)return"-";let s=t._keyIndex[i];return s?e.getFormattedValue(s._value):"-"}));var o=Xt.scaleLinear().domain([0,100]).range([0,100]).clamp(!0);a.selectAll(".timeseriesAttribs .recTimeKeyValue > .ValueBar > .TheBar").style("width",(e=>{var t=e.getRecordValue(this.recordInDetail);if(!t)return null;var s=t._keyIndex[i];return s?"%"===e.unitName?o(s._value)+"%":o(100*e.timeSeriesScale_Value(s._value))+"%":null})),a.selectAll(".timeseriesAttribs .recTimeKeyChange").attr("data-status",((e,t,s)=>{s[t];var a=null,o="-",l="noValue",n=e.getRecordValue(this.recordInDetail);if(!n||n.isEmpty())return s[t].tippy.setContent("No data"),"";if(r){var h=n._keyIndex[r._time_src],c=n._keyIndex[i];h&&c&&(a=c._value-h._value),e.hasFlippedDomain()&&(a*=-1)}if(null!==a){let t=e.timeSeriesScale_Value.domain(),s=Math.abs(t[1]-t[0])/50;l=a>s?"improve":a<-s?"decline":"steady",o=`<b>Change from<br>${r._time_src} to ${i}</b>:<br>`+e.getFormattedValue(a)}return s[t].tippy.setContent(o),l})),a.selectAll(".timeseriesAttribs .recTimeKeyRank").html(((e,t,s)=>{var r=s[t];r.__NumRecords=0;var a=e.getRecordValue(this.recordInDetail);if(!a||a.isEmpty())return"-";let o=a._keyIndex[i];return o&&0!=o._rank?(r.__NumRecords=this.browser.records.reduce(((t,s)=>{if(s.filteredOut)return t;var r=e.getRecordValue(s);if(!r||r.isEmpty())return t;return null==r._keyIndex[i]?t:t+1}),0),`<span class='rankValue'>${o._rank}</span><span class='rankOutOf'>${r.__NumRecords}</span>`):"-"})).tooltip("").on("mouseover",(e=>{var t=e.currentTarget;t.tippy.setContent("Ranking among "+t.__NumRecords+(this.browser.isFiltered()?" filtered ":" ")+this.browser.recordName)}));var l=a.selectAll(".recordTimeseriesDot"),n=e=>{l.classed("currentKey",(t=>t._time.getTime()===e._time.getTime()))};a.selectAll(".recordTimeseriesDot").classed("currentKey",(t=>t._time.getTime()===e._time.getTime())).on("mouseover",((e,t)=>n(t))).on("mouseout",(()=>n(e))),n(e),null===(t=this.updateFocusedTimeKey_custom)||void 0===t||t.call(this)}}}getTimeKey_Index(e){return this.recordDetailTimeKeys.findIndex((t=>t._time.getTime()==e._time.getTime()))}timeKey_Step(e){if("next"!==e&&"previous"!==e)return null;var t=this.getTimeKey_Index(this.timeKeyInDetail);return t<0?null:this.recordDetailTimeKeys[t+("next"===e?-1:1)]||null}exportConfig(){var e;return{recordInDetail:null===(e=this.recordInDetail)||void 0===e?void 0:e.id,recordDetailAttribs:this.recordDetailAttribs?Array.from(this.recordDetailAttribs):void 0}}}const qt=Object.assign({select:a,pointer:_,rgb:k,max:d,scaleLinear:n},se);function Jt(e,t,i){var s=e.split("->"),r=s[s.length-1],a=e=>{for(var t=0;t<s.length-1;t++)if(null==(e=e[s[t]]))return;return e};if("DELETE()"===t)return void i.forEach((e=>{var t=a(e.data);t&&delete t[r]}));let o=null;const l=RegExp(/(.+)->\$\{(.+)\}/).exec(t),n=RegExp("DATETIME\\((.+)\\)").exec(t),h=RegExp("MULTIVAL\\((.+)\\)").exec(t),c=RegExp("SPLIT\\((.+)\\)").exec(t),d=RegExp("LAT_LONG\\((.+),(.+)\\)").exec(t);if("STR()"===t)o=e=>null==e?null:""+e;else if("JSON()"===t)o=e=>null==e?null:JSON.parse(e);else if("POSITIVE()"===t)o=e=>e&&"number"==typeof e&&e>0?e:null;else if(!l&&n&&n.length>1){var u=Re.getTimeParseFunc(n[1]);o=e=>null==e?null:u(e)}else if(c&&c.length>1){var p=RegExp(c[1]);o=e=>{if(null==e)return null;if("number"==typeof e)return[""+e];if(Array.isArray(e)){if(1!==e.length)return e;e=e[0]}return e.split(p).map((e=>e.trim())).filter((e=>""!==e))}}else if(h&&h.length>1){const e=h[1].split(RegExp("\\s*;\\s*")).map((e=>e.trim())).filter((e=>""!==e));e.length>=2&&(o=(t,i)=>{let s=[];return e.forEach((e=>{i[e]&&(s.push(i[e]),delete i[e])})),s})}else if(l&&l.length>1){var m=RegExp("DATETIME\\((.+)\\)").exec(l[2]);if((null==m?void 0:m.length)>1){var g=Re.getTimeParseFunc(m[1]),v=null,f=RegExp("::(.+)").exec(l[2]);f&&f.length>1&&(v=f[1]),o=e=>{if(null==e)return null;let t=new Ce;for(var i in e){var s=e[i];if("number"==typeof s){var r=g(i.trim());null!=r&&t.addTimeData({_time:r,_time_src:i,_value:v?s[v]:s})}}return t}}}if(o)i.forEach((e=>{let t=a(e.data);if(null!=t)try{t[r]=o(t[r],e.data)}catch(e){console.log("onLoad _transform error: "+e)}}));else if(d&&d.length>1){const e=d[1],t=d[2];i.forEach((i=>{var s=a(i.data);if(s){var o=i.data[e],l=i.data[t];o&&l&&"number"==typeof o&&"number"==typeof l&&(s[r]={type:"Point",coordinates:[l,o]}),delete i.data[e],delete i.data[t]}}))}else;}class Qt{get attribsInDashboard(){return this.attribs.filter((e=>{var t;return null===(t=e.block)||void 0===t?void 0:t.inDashboard}))}get blocks(){return this.attribsInDashboard.map((e=>e.block))}attribWithName(e){return this.attribs.find((t=>{var i;return e===(null==t?void 0:t.attribName)||e===(null===(i=null==t?void 0:t.template)||void 0===i?void 0:i.str)}))||null}get _attribs(){var e={};return this.attribs.forEach((t=>{e[t.attribName]=t,t.template.str&&(e[t.template.str]=t)})),e}constructor(t){this.records=[],this.recordName="",this.idSummaryName=null,this.primaryTableName=null,this.recordDisplay=null,this.allRecordsAggr=null,this.allAggregates=[],this.configs={},this.DOM={},this.panels={},this.flexAggrs={},this.addedCompare=!1,this.attribs=[],this.attribCounter=0,this.attribs_by_group={},this.finalized=!1,this.activeColorTheme="sequential",this.preventAxisScaleTransition=!0,this.onLoad={callback:null,main:{}},this.onModeChange=null,this.dataTypeDescrs=[{name:"Categorical",icon:"far fa-font",member:e=>e instanceof mt,active:!1},{name:"MultiValued",icon:"far fa-tags",member:e=>e instanceof mt&&e.isMultiValued,active:!1},{name:"Numeric",icon:"far fa-hashtag",member:e=>e instanceof Ye,active:!1},{name:"Timestamp",icon:"far fa-calendar-day",member:e=>e instanceof Vt,active:!1},{name:"Timeseries",icon:"far fa-chart-line",member:e=>e instanceof rt,active:!1},{name:"Location",icon:"far fa-map-marker",member:e=>e instanceof tt||e instanceof mt&&e.hasMap(),active:!1},{name:"Unique",icon:"far fa-fingerprint",member:e=>e instanceof mt&&e.uniqueCategories(),active:!1},{name:"Function",icon:"fal fa-function",member:e=>!e.template.str,active:!1},{name:"Content",icon:"fa fa-file-alt",member:e=>e instanceof jt,active:!1}],this.needToRefreshLayout=!1,this.blockWithOpenConfig=null,this.noAnim=!1,this.panel_warningBox=null,this.mouseSpeed=0,this.creditsInserted=!1,this._attribPanelWidth=ae.width_AttribPanelDefault,this.attribTextQuery=null,this.isFullscreen=!1,this._loadedTableCount=0,this._totalTableCount=0,this.chartsLoaded=!1,this.movedAttrib=null,this.showDropZones=!1,this.filters=[],this.filterCounter=0,this.skipSortingSummary=null,this.enableAnalytics=!1,this.lockedCompare={},this.selectedAggrs={},this.crumbs={},this.selectTimeouts={},this.filters_wrap_letItWrap=!1,this.options=t,ae.loadResources(),this.domID=this.options.domID||ae.defaultDOM,ae.Compare_List.forEach((e=>{this.lockedCompare[e]=!1,this.selectedAggrs[e]=null,this.crumbs[e]=new Ft(this,e)})),this.measureFunc=new xe({parent:this,cfgTitle:"Measure Function",cfgClass:"measureFunc",iconClass:"fa fa-cubes",UISeperator:{title:"Analytics"},default:"Count",tooltip:"The metric that aggregates values in each category / range.",helparticle:"5e9516452c7d3a7e9aeae06e",itemOptions:[{name:"measure_Count",value:"Count"},{name:"measure_Sum",value:"Sum",activeWhen:()=>this.getMeasurableSummaries("Sum").length>0},{name:"measure_Avg",value:"Avg",activeWhen:()=>this.getMeasurableSummaries("Avg").length>0}],onRefreshDOM:e=>{this.DOM.metricFuncText.select(".measureFuncText").html(me["measure_"+e.get()]),this.addMeasureOptions_Func(this.DOM.metricFuncText.select(".measureFuncOptions"))},preSet:t=>e(this,void 0,void 0,(function*(){var e,i;if("Count"===t)return t;if(!(null===(e=this.measureSummary)||void 0===e?void 0:e.get())){let e=this.getMeasurableSummaries(t)[0];if(!e)throw Error(`No numeric data attribute supports ${t} measure function.`);yield null===(i=this.measureSummary)||void 0===i?void 0:i.set(e)}return t})),onSet:()=>e(this,void 0,void 0,(function*(){yield this.refreshMeasureMetric()}))}),this.measureSummary=new xe({parent:this,cfgTitle:"Measure Attribute",cfgClass:"measureSummary",iconClass:"far fa-cube",default:null,helparticle:"5e9516452c7d3a7e9aeae06e",onDOM:e=>{var t=e.root.select(".configItem_Options");e.mainSelect=t.append("select").attr("class","mainSelect"),e.timeKeys=t.append("select").attr("class","timeKeys").on("input",(e=>{var t=e.currentTarget.selectedOptions[0].__data__;this.measureSummary.set(this.measureSummary.get().timeseriesParent.getTimepointSummary(t))}))},onRefreshDOM:e=>{if(e.get()){var t=this.measureSummary.get();this.addMeasureOptions_Summaries(e.DOM.mainSelect),this.addMeasureOptions_Summaries(this.DOM.metricFuncText.select("select.measureSummary"));var i=t.timeseriesParent;e.DOM.timeKeys.classed("hide",!i),this.DOM.metricFuncText.select(".timeKeys.metricOptionWrapper").classed("hide",!i),this.DOM.metricFuncText.select(".measureSummaryName").html((i?t.timeseriesParent:t).attribNameHTML),i&&(this.addMeasureOptions_Keys(e.DOM.timeKeys),this.addMeasureOptions_Keys(this.DOM.metricFuncText.select("select.timeKeys")),this.DOM.metricFuncText.select(".timeKeyText").html(t.timeKey._time_src))}},preSet:t=>e(this,void 0,void 0,(function*(){var e,i=t;if("string"==typeof i&&((i=this.attribWithName(t))||(i=this.createAttrib(t))),i instanceof rt){i.initializeAggregates();var s=(null===(e=this.measureSummary.get())||void 0===e?void 0:e.timeKey)||this.recordDisplay.currentTimeKey.get()||i.timeKeys[i.timeKeys.length-1];i=i.getTimepointSummary(s)}if(i&&i instanceof Ye)return i.initializeAggregates(),i})),onSet:t=>e(this,void 0,void 0,(function*(){t&&!this.measureFunc_Count&&(yield this.refreshMeasureMetric())}))}),this.breakdownMode=new xe({parent:this,cfgTitle:"Breakdown",cfgClass:"breakdownMode",iconClass:"far fa-percent",default:"absolute",helparticle:"5e89445604286364bc97d5eb",tooltip:"How to compute and compare data groups",itemOptions:[{name:"# Absolute",value:"absolute"},{name:"% of Compared",value:"dependent"},{name:"% of Groups",value:"relative"},{name:"% of All",value:"total"}],forcedValue:()=>{if(!this.measureWithPositiveValues())return"absolute"},preSet:t=>e(this,void 0,void 0,(function*(){if("absolute"!==t&&this.measureFunc_Avg)throw Error(`You cannot analyze data by ${me.DialogComparisonSelection} when<br>\n            using <i>average</i> as aggregation function for <i>${this.measureSummary.get().attribName}</i>.`);if("absolute"!==t&&this.measureSumWithNegativeValues())throw Error(me.DialogCompareForRelative);return t})),onSet:t=>e(this,void 0,void 0,(function*(){this.preventAxisScaleTransition=!0,this.addedCompare=!1;for(let e of this.attribsInDashboard)yield e.axisScaleType.set("relative"===t?"full":"fit"),e.refreshChartScale_Measure();yield this.refreshAnalytics(),this.preventAxisScaleTransition=!1}))}),this.stackedCompare=new xe({parent:this,cfgTitle:"GroupView",cfgClass:"stackedCompare",iconClass:"CompareModeIcon",UISeperator:{title:"Visualization"},default:!0,helparticle:"5e88ff692c7d3a7e9aea6475",tooltip:"The comparison view mode<br><br>\n        <b>Side-by-side</b>: Compare on shared baseline<br><br>\n        <b>Stacked</b>: Compare on stacked baseline",itemOptions:[{name:"SideBySide",value:!1},{name:"Stacked",value:!0}],onDOM:e=>{e.root.select(".CompareModeIcon").selectAll("div").data([0,1,2]).enter().append("div").attr("class","CompareModeIcon-block")},forcedValue:()=>{if(this.dependentBreakdown)return!1;if(this.relativeBreakdown)return!!this.comparedAttrib&&!this.isComparedSummaryMultiValued();if(this.totalBreakdown){if(!this.comparedAttrib)return!1;if(this.isComparedSummaryMultiValued())return!1}return(!this.comparedAttrib||!this.isComparedSummaryMultiValued())&&(!!this.measureWithPositiveValues()&&void 0)},preSet:t=>e(this,void 0,void 0,(function*(){if(!0===t||!1===t){if(t&&this.comparedAttrib&&this.isComparedSummaryMultiValued())throw me.DialogStackedMultiValue(this.comparedAttrib.attribName);if(!t&&this.comparedAttrib&&!this.isComparedSummaryMultiValued()&&this.relativeBreakdown)throw me.DialogSideBySideSingleValue(this.comparedAttrib.attribName);if(t&&this.measureFunc_Avg)throw me.DialogStackedCharts+" cannot be used with <i>average</i> measure function.";if(t&&this.dependentBreakdown)throw me.DialogStackedCharts+" cannot be used with "+me.DialogDependentBreakdown;if(t&&this.measureSumWithNegativeValues())throw me.DialogStackedCharts+" cannot be used with measuring totals with negative values.";return t}})),onSet:()=>e(this,void 0,void 0,(function*(){this.attribsInDashboard.forEach((e=>e.refreshChartScale_Measure())),yield this.refreshAnalytics()}))}),this.showWholeAggr=new xe({parent:this,cfgTitle:"Whole Distribution",cfgClass:"showWholeAggr",iconClass:"fa fa-square",default:!0,tooltip:"When you have two or more compare selections, \n                you can choose to show the whole value of the aggreagates.",helparticle:"5e893d7a2c7d3a7e9aea656f",itemOptions:[{name:"Show",value:!0},{name:"Hide",value:!1}],forcedValue:()=>{if(0===this.activeComparisonsCount)return!0;if(this.dependentBreakdown)return!1;if(this.relativeBreakdown)return!!this.comparedAttrib&&!this.isComparedSummaryMultiValued();if(this.totalBreakdown)return!!this.comparedAttrib&&void 0;if(this.stackedCompare.is(!0)&&this.activeComparisons.reduce(((e,t)=>this.selectedAggrs[t]?e+this.selectedAggrs[t][t].measure:e),0)===this.allRecordsAggr.measure("Active"))return!1;return!!this.measureWithPositiveValues()&&void 0},onSet:()=>e(this,void 0,void 0,(function*(){return yield this.refreshAnalytics()}))}),this.filteringMode=new xe({parent:this,cfgTitle:"Filtering",cfgClass:"filteringMode",iconClass:"fal fa-filter",UISeperator:{title:"Selections"},default:"chained",tooltip:"<b>Combined</b> allows combining multiple filters together<br><br>\n        <b>Single</b> forces to have at most one active filter.",helparticle:"5e88eff404286364bc97d459",itemOptions:[{name:"Chained",value:"chained"},{name:"Single",value:"single"}],preSet:t=>e(this,void 0,void 0,(function*(){return"combined"===(t=t.toLowerCase())&&(t="chained"),t})),onSet:e=>{"single"===e&&this.numOfActiveFilters>1&&this.clearFilters_All(this.filters.find((e=>e.isFiltered)))}}),this.mouseOverCompare=new xe({parent:this,cfgTitle:"Hover Highlight",cfgClass:"mouseOverCompare",iconClass:"fal fa-mouse-pointer",default:!0,helparticle:"5e8905c52c7d3a7e9aea6489",itemOptions:[{name:"Enabled",value:!0},{name:"Disabled",value:!1}]}),this.recordChartType=new xe({parent:this,cfgTitle:"Record Chart Type",cfgClass:"recordChartType",iconClass:"fal fa-bullseye",UISeperator:{title:"Record Chart"},default:"none",helparticle:"5eadcca72c7d3a5ea54a59e9",noExport:!0,itemOptions:[{name:"None",value:"none"},{name:"ListButton",value:"list",activeWhen:()=>!0},{name:"MapButton",value:"map",activeWhen:()=>{var e;return(null===(e=this.recordDisplay)||void 0===e?void 0:e.getRecordGeoAttributes().length)>0}},{name:"TimeSeriesButton",value:"timeseries",activeWhen:()=>{var e,t;return!((null===(e=this.records)||void 0===e?void 0:e.length)<2)&&(null===(t=this.recordDisplay)||void 0===t?void 0:t.getAttribOptions_UI("timeSeries").length)>0}},{name:"ScatterButton",value:"scatter",activeWhen:()=>{var e,t;return!((null===(e=this.records)||void 0===e?void 0:e.length)<5)&&(null===(t=this.recordDisplay)||void 0===t?void 0:t.getAttribOptions_UI("scatterX").length)>1}}],preSet:t=>e(this,void 0,void 0,(function*(){if(this.records&&this.recordDisplay){if(this.records.length>5e3&&!["list","none"].includes(t)&&(yield ye.confirm(`<div style='text-align:center;''>There are more than 2,000 records.<br>The ${t} chart will be crowded and potentially slow.<br><Br>Are you sure you want to change to ${t} chart?</div>`,"Change chart type")),"map"===t)if(!this.recordDisplay.config.geo)if(!this.recordDisplay.getRecordGeoAttributes()[0])throw"Geo attribute not found";return t}})),onSet:t=>e(this,void 0,void 0,(function*(){var e,i;try{if(!this.recordDisplay)return;if("map"===t&&!this.recordDisplay.config.geo){var s=this.recordDisplay.getRecordGeoAttributes()[0];if(!s)throw"Geo attribute not found";this.recordDisplay.config.geo=s.attribName}null===(e=this.DOM.root)||void 0===e||e.attr("recordChartType",t),yield this.recordDisplay.setView(t),this.refreshIsEmpty(),this.updateLayout_Height()}catch(e){console.log(e),null===(i=this.recordChartType)||void 0===i||i.undoChange()}}))}),this.dashboardMode=new xe({parent:this,cfgTitle:"Dashboard Mode",cfgClass:"dashboardMode",iconClass:"fa fa-wrench",UI:{disabled:!0},default:"Explore",helparticle:"5e8943d504286364bc97d5e6",itemOptions:[{name:"Explore",value:"Explore"},{name:"Author",value:"Author"},{name:"Adjust",value:"Adjust"},{name:"Capture",value:"Capture"},{name:"Save",value:"Save"}],preSet:t=>e(this,void 0,void 0,(function*(){return"Print"===t?"Capture":t})),onSet:(t,i)=>e(this,void 0,void 0,(function*(){var e;this.finalized&&(this.setNoAnim(!0),"Author"===t&&this.refreshAttribList(),this.panels.bottom.setWidth(this.width_Canvas),this.panels.bottom.refreshWidth(),this.updateLayout(),this.updateMiddlePanelWidth(),setTimeout((()=>this.setNoAnim(!1)),500),null===(e=this.onModeChange)||void 0===e||e.call(this)),yield i.refresh()})),onRefreshDOM:e=>{this.DOM.panel_Footer&&(this.DOM.panel_Footer.selectAll(".dashSelectMode").classed("active",(t=>e.is(t.name))),this.DOM.root.attr("data-dashboardMode",e.get()))}}),["measureFunc","measureSummary","breakdownMode","stackedCompare","showWholeAggr","filteringMode","mouseOverCompare","recordChartType"].forEach((e=>{this.configs[e]=this[e]}));var i=this;if(this.colorTheme={browser:this,sequential:"YlGnBu",diverging:"Spectral",getDiscrete(e=9){let t=i.activeColorTheme,s=qt["scheme"+this[t]];if(s&&s[e])return s[e].slice();s=qt["interpolate"+this[t]];var r=[];if(1===e)r.push(qt.rgb(s(.8)).hex());else if(2===e)r.push(qt.rgb(s(.8)).hex()),r.push(qt.rgb(s(.2)).hex());else for(let t=0;t<e;++t)r.push(qt.rgb(s(t/(e-1))).hex());return r.reverse()},getContinuous(){return qt["interpolate"+this[i.activeColorTheme]]},exportConfig(){var e={};return"YlGnBu"!==this.sequential&&(e.sequential=this.sequential),"Spectral"!==this.diverging&&(e.diverging=this.diverging),e}},this.allRecordsAggr=new Ae(null),this.allAggregates.push(this.allRecordsAggr),ae.browsers[this.getDashboardID()]=this,ae.browser=this,this.options.onLoad)for(var s in this.options.onLoad.callback&&(this.options.onLoad.callback instanceof Function?this.onLoad.callback=this.options.onLoad.callback:delete this.options.onLoad),this.options.onLoad)this.onLoad.main[s]=this.options.onLoad[s];let r=null;this.DOM.root=qt.select(this.domID).classed("kshf",!0).classed("noAnim",!0).attr("data-dashboardMode",this.dashboardMode.get()).attr("recordChartType","none").on("mousemove",(e=>{if(r){var t=e.timeStamp-r.timeStamp;if(0!==t){var i=Math.abs(e.x-r.x),s=Math.abs(e.y-r.y);this.mouseSpeed=Math.min((i+s)/t,2),r=e}}else r=e})),"1.00"!=this.dashZoomLevel&&this.attemptToFixBrowserZoomLevel(this.dashZoomLevel),this.updateWidth_Total(),this.recordName=this.options.recordName||"";for(var a=this.DOM.root.node();a.hasChildNodes();)a.removeChild(a.lastChild);this.DOM.pointerBlock=this.DOM.root.append("div").attr("class","pointerBlock"),this.DOM.attribDragBox=this.DOM.root.append("div").attr("class","attribDragBox"),this.insertDOM_WarningBox(),this.recordDetailsPopup=new Zt(this),this.insertDOM_Panel_Overlay(),this.insertDOM_AttribPanel(),this.DOM.panel_Wrapper=this.DOM.root.append("div").attr("class","panel_Wrapper").classed("emptyDashboard",!0).classed("panel_bottom_empty",!0),this.insertDOM_PanelBasic(),this.dashboardConfigPanel=new qe(this.DOM.panel_Wrapper,"DashboardAnalyticsConfig","DashboardAnalyticsConfig",Object.values(this.configs),this,this.DOM.metricFuncSelectButton),this.panels.left=new Ht(this,"left",this.DOM.panel_Wrapper),this.panels.right=new Ht(this,"right",this.DOM.panel_Wrapper),this.DOM.middleColumn=this.DOM.panel_Wrapper.append("div").attr("class","middleColumn"),this.panels.middle=new Ht(this,"middle",this.DOM.middleColumn),this.DOM.middleColumn.append("div").attr("class","recordDisplay"),this.panels.bottom=new Ht(this,"bottom",this.DOM.panel_Wrapper),this.DOM.panelEmpty=this.DOM.panel_Wrapper.append("div").attr("class","panelEmpty").append("div").attr("class","actionInfo").html(me.EmptyDashboardNotice),this.insertDOM_Panel_Footer(),this.DOM.root.selectAll(".panel").on("mouseleave",(()=>{setTimeout((()=>{this.needToRefreshLayout&&(this.updateLayout_Height(),this.needToRefreshLayout=!1)}),1500)})),this.loadDataSources()}refreshConfigs(){Object.values(this.configs).forEach((e=>e.refresh())),this.attribsInDashboard.forEach((e=>e.refreshConfigs())),this.refreshAnalytics()}activateWidthDrag(e,t,i){e.classList.add("dragging"),this.setNoAnim(!0),this.DOM.root.style("cursor","ew-resize").on("mousemove.temp",i).on("mouseup.temp",(()=>{e.classList.remove("dragging"),this.setNoAnim(!1)})),t.preventDefault()}closeConfigPanels(){var e,t;null===(t=null===(e=this.blockWithOpenConfig)||void 0===e?void 0:e.DOM)||void 0===t||t.root.classed("showConfig",!1),this.blockWithOpenConfig=void 0,this.dashboardConfigPanel.hide(),this.recordDisplay.recordConfigPanel.hide()}setNoAnim(e){this.finalized&&(this.noAnim=e,this.DOM.root.classed("noAnim",this.noAnim),this.DOM.pointerBlock.attr("active",this.noAnim?"":null),this.noAnim||this.DOM.root.style("cursor",null).on("mousemove.temp",null).on("mouseup.temp",null))}refreshIsEmpty(){this.DOM.panel_Wrapper.classed("emptyDashboard",0===this.attribsInDashboard.length&&this.recordChartType.is("none"))}getAttribTypeFromFunc(e){var t=null;return this.records.some((i=>{var s=e.call(i.data,i);if(null==s||""==s)return!1;var r=typeof s;return"object"===r&&s._timeseries_?t="timeseries":"object"===r&&s.coordinates?t="recordGeo":"number"===r?t="numeric":s instanceof Date?t="timestamp":("string"===r||"boolean"===r||Array.isArray(s))&&(t="categorical"),!!t})),t}createAttrib(e,t=void 0,i=void 0){if(e){if(this.attribWithName(e))return this.attribWithName(e);var s;if("content"===i)s=new jt(this,e);else{null==t&&(t=e);var r=new De(t,this);if((i=null!=i?i:r.blockType)||(i=this.getAttribTypeFromFunc(r.func)),!i)return void console.log(`Summary data type could not be detected for: ${e}`);"categorical"===i?s=new mt(this,e,r):"timeseries"===i?s=new rt(this,e,r):"recordGeo"===i?s=new tt(this,e,r):"timestamp"===i?s=new Vt(this,e,r):"numeric"===i&&(s=new Ye(this,e,r))}return this.insertAttribIntoGroupIndex(s),s}}destroyAttrib(e){var t,i;null===(t=null==e?void 0:e.block)||void 0===t||t.removeFromPanel();var s=-1;this.attribs.forEach(((t,i)=>{t===e&&(s=i)})),-1!==s&&(this.attribs.splice(s,1),null===(i=this.recordDisplay)||void 0===i||i.refreshAttribOptions("sort"),this.removeAttribFromGroupIndex(e),this.refreshAttribList())}insertAttribIntoGroupIndex(e){var t=this.attribs_by_group;e.groupPath.forEach(((e,i,s)=>{t[e]||(t[e]={name:e,item:e,parents:s.slice(0,i),sub:{}}),t=t[e].sub}));var i=e.printName;t[i]||(t[i]={name:i,parents:e.groupPath,sub:{}}),t[i].item=e}removeAttribFromGroupIndex(e){var t,i=this.attribs_by_group;e.groupPath.forEach((e=>{i=i&&i[e]&&i[e].sub})),i&&delete i[e.printName],null===(t=null==e?void 0:e.block)||void 0===t||delete t.DOM.nugget,this.removeEmptySubs()}removeEmptySubs(){!function e(t){for(let[i,s]of Object.entries(t)){let r=s;"string"==typeof r.item&&0===Object.entries(r.sub).length?delete t[i]:e(r.sub)}}(this.attribs_by_group)}setRecordName(e){this.recordName=e,this.DOM.root.selectAll(".recordName").html(this.recordName)}setDescription(e){this.options.description=e,this.DOM.browserDescription.select(".customDescription").style("display",e?"inline-block":null),this.DOM.browserDescription.select(".customDescriptionText").html(e)}updateWidth_Total(){this.divWidth=this.DOM.root.node().clientWidth}getWidth_Total(){return this.divWidth}get width_Canvas(){return this.divWidth-(this.authorMode?this._attribPanelWidth:0)-2*ae.width_PanelGap}get height_PanelHeader(){var e=parseInt(this.DOM.panel_DataStatus.style("height"));return isNaN(e)?0:e}get height_PanelFooter(){var e=parseInt(this.DOM.panel_Footer.style("height"));return isNaN(e)?0:e}getDashboardID(){return window.location.pathname+this.domID}insertDOM_WarningBox(){this.panel_warningBox=this.DOM.root.append("div").attr("class","warningBox_wrapper");var e=this.panel_warningBox.append("span").attr("class","warningBox");this.DOM.warningText=e.append("span").attr("class","warningText"),e.append("span").attr("class","dismiss fa fa-times").tooltip(me.Close).on("click",(()=>this.hideWarning()))}showWarning(e){this.panel_warningBox.classed("active",!0),this.DOM.warningText.html(e),setTimeout((()=>this.hideWarning()),5e3)}hideWarning(){this.panel_warningBox&&this.panel_warningBox.classed("active",null)}get movingMouseDelay(){return this.mouseSpeed<.2?0:500*this.mouseSpeed}getMeasurableSummaries(e){return this.attribs.filter((t=>t.supportedMetricFuncs.includes(e)&&!t.isEmpty()&&!t.hasTimeSeriesParent())).sort(((e,t)=>Re.sortFunc_List_String(e.attribName,t.attribName)))}addMeasureOptions_Summaries(t){t.on("change",(t=>e(this,void 0,void 0,(function*(){return yield this.measureSummary.set(t.currentTarget.selectedOptions[0].__data__)})))).selectAll("option").remove(),this.measureFunc.is("Count")||t.selectAll("option").data(this.getMeasurableSummaries(this.measureFunc.get())).enter().append("option").attr("selected",(e=>{var t;return e.attribID===(null===(t=this.measureSummary.get())||void 0===t?void 0:t.attribID)||null})).html((e=>e.attribName))}addMeasureOptions_Keys(e){e.selectAll("option").remove(),e.selectAll("option").data(this.measureSummary.get().timeseriesParent.timeKeys.slice().reverse()).enter().append("option").attr("value",(e=>e._time_src)).attr("selected",(e=>e._time_src===this.measureSummary.get().timeKey._time_src?"true":null)).html((e=>e._time_src))}addMeasureOptions_Func(t){t.on("change",(t=>e(this,void 0,void 0,(function*(){return yield this.measureFunc.set(t.currentTarget.selectedOptions[0].__data__.v)})))).selectAll("option").remove();var i=[{v:"Count",l:me.measure_Count,active:!0}];["Sum","Avg"].forEach((e=>{i.push({v:e,l:me["measure_"+e],active:this.getMeasurableSummaries(e).length>0})})),t.selectAll("option").data(i).enter().append("option").attr("disabled",(e=>!e.active||null)).attr("selected",(e=>e.v===this.measureFunc.get()||null)).html((e=>e.l))}insertDOM_Panel_DatasetInfo(){this.DOM.datasource=this.DOM.browserDescription.append("a").attr("class","fal fa-table datasource").attr("target","_blank").tooltip(me.OpenDataSource),this.DOM.browserDescription.append("div").attr("class","DataPrivacy").html('<span class="DataPrivacy-Public">Public data</span><span class="DataPrivacy-Private">Private data</span>');var e=this.DOM.browserDescription.append("span").attr("class","customDescription");e.append("span").attr("class","customDescriptionButton").tooltip("Edit").on("click",(()=>{var e=ye.prompt("Provide a short description or credit for the dataset",this.options.description);if(""!==e){if(e){var t=ye.prompt("Provide the link for credit","");t&&("http"!==t.substr(0,4)&&(t="http://"+t),e="<a target='_blank' rel='noopener noreferrer' href='"+t+"'>"+e+"</a>"),this.setDescription(e)}}else this.setDescription(null)})).html("<i class='fa fa-info-circle'></i> "),e.append("span").attr("class","customDescriptionText"),this.setDescription(this.options.description)}insertDOM_Panel_Footer(){var t;this.DOM.panel_Footer=this.DOM.root.append("div").attr("class","panel_Footer"),(t=this.DOM.panel_Footer.append("div").attr("class","dashboardModeSelect")).append("div").attr("class","dashboardModeSelectTitle").attr("data-helparticle","5e8943d504286364bc97d5e6").html(me.Mode),ye.createHelpScoutLinks(t,!0),t.selectAll("div.dashSelectMode").data([{name:"Explore",class:"far fa-compass"},{name:"Author",class:"far fa-pen-fancy"},{name:"Adjust",class:"far fa-sliders-h"},{name:"Capture",class:"far fa-draw-square"},{name:"Save",class:"far fa-bookmark"}]).enter().append("div").attr("class",(e=>`dashSelectMode dashSelectMode-${e.name}`)).classed("active",(e=>this.dashboardMode.is(e.name))).on("click",((t,i)=>e(this,void 0,void 0,(function*(){return yield this.dashboardMode.set(i.name)})))).tooltip((e=>me[`${e.name} Mode`])).call((e=>{e.append("div").attr("class",(e=>e.class)),e.append("div").attr("class","theText").html((e=>me[e.name]))})),this.DOM.browserDescription=this.DOM.panel_Footer.append("span").attr("class","browserDescription"),(t=this.DOM.panel_Footer.append("span").attr("class","logoHost").tooltip(me.ShowInfoCredits).on("click",(()=>{this.showCredits(),this.DOM.overlay_wrapper.attr("show","infobox").classed("easyDismiss",!0)})).html("<span class='keshifSVG'>Keshif<img></span>\n        <span class='theDataMadeExplorable'>Data Made Explorable</span>\n        ")).select("svg").style("width","20px").style("width","18px").style("height","19px")}insertDOM_PanelBasic(){var i=this;this.DOM.panel_DataStatus=this.DOM.root.append("div").attr("class","panel_DataStatus"),this.DOM.metricFuncSelectButton=this.DOM.panel_DataStatus.append("span").attr("class","metricFuncSelectButton basicIcon fal fa-cog").tooltip(me.DashboardAnalyticsConfig).on("click",(()=>this.dashboardConfigPanel.showAtPos(8,8))),this.DOM.recordInfo=this.DOM.panel_DataStatus.append("span").attr("class","recordInfo"),this.DOM.activeRecordMeasure=this.DOM.recordInfo.append("span").attr("class","activeRecordMeasure"),this.DOM.metricFuncText=this.DOM.recordInfo.append("span").attr("class","metricFuncText"),this.DOM.metricFuncText.html(`<span class='measureFunc metricOptionWrapper'><span class='measureFuncText metricOptionWrapper_Text'></span><select class='measureFuncOptions metricOptionWrapper_Opts'></select></span><span class='timeKeys metricOptionWrapper'><i class='fal fa-calendar'></i><span class='timeKeyText metricOptionWrapper_Text'></span><select class='timeKeys metricOptionWrapper_Opts'></select></span><span class='measureSummary metricOptionWrapper'><span class='measureSummaryName metricOptionWrapper_Text'></span><select class='measureSummary metricOptionWrapper_Opts'></select></span><span class='Of_NumberRecord'>${me.Of_NumberRecord}</span>`),this.DOM.metricFuncText.select("select.timeKeys").on("input",(t=>e(this,void 0,void 0,(function*(){yield this.measureSummary.set(this.measureSummary.get().timeseriesParent.getTimepointSummary(t.currentTarget.selectedOptions[0].__data__))})))),this.DOM.recordName=this.DOM.recordInfo.append("span").attr("class","recordName").tooltip("").on("mouseenter",(function(e){this.tippy.setContent(this.isContentEditable?"OK":me.EditTitle),e.stopPropagation(),e.preventDefault()})).on("focus",(function(){this.tippy.hide(),this._initValue=t.sanitize(this.innerHTML)})).on("blur",(function(){this.tippy.hide(),this.contentEditable=!1})).on("keyup",(e=>e.stopPropagation())).on("keypress",(e=>e.stopPropagation())).on("keydown",(function(e){if(27===e.keyCode)return this.blur(),void(this.innerHTML=t.sanitize(this._initValue));13===e.keyCode&&(i.setRecordName(this.textContent),this.blur()),e.stopPropagation()})).on("click",(function(){this.isContentEditable?(this.contentEditable=!1,i.setRecordName(t.sanitize(this.innerHTML))):(this.contentEditable=!0,this.focus())}));var s=this.DOM.panel_DataStatus.append("span").attr("class","iconGroup dashboardSettings");this.DOM.panel_Basic_In=this.DOM.panel_DataStatus.append("div").attr("class","panel_Basic_In"),this.DOM.panel_DataStatus.append("div").attr("class","iconGroup rightSideIcons").call((e=>{e.append("div").attr("class","viewFullscreen basicIcon far fa-expand-arrows-alt").tooltip(me.ShowFullscreen).on("click",(()=>this.showFullscreen())),"1.00"!==this.dashZoomLevel&&e.append("div").attr("class","basicIcon fa fa-window-restore").tooltip(me["Reset Zoom Level"]).on("click",(()=>this.attemptToFixBrowserZoomLevel("1.00",!0))),e.append("div").attr("class","showHelpIn basicIcon fal fa-question-circle").tooltip(me.Help).on("click",(()=>ye.helpUI()))})),s.append("span").attr("class","dashboardSetting breakdownModeIcon far fa-percent").tooltip("",{onShow:e=>{e.reference.tippy.setContent(`<div>${me.Breakdown}</div>\n          <b>${this.breakdownMode}</b><br>\n          <i>${me["Click to change"]}</i>`)}}).on("click",(t=>{ye.popupMenu(t,{name:"Breakdown",items:[{id:"absoluteBreakdown",name:"Absolute",iconClass:"far fa-hashtag",helparticle:"5e8944682c7d3a7e9aea659a",active:this.breakdownMode.is("absolute"),do:()=>e(this,void 0,void 0,(function*(){return yield this.breakdownMode.set("absolute")}))},{id:"percentBreakdown",name:"Percentage",iconClass:"far fa-percent",expanded:!0,options:[{id:"dependentBreakdown",name:"% of Compared",helparticle:"5e8944812c7d3a7e9aea659b",active:this.breakdownMode.is("dependent"),do:()=>e(this,void 0,void 0,(function*(){return yield this.breakdownMode.set("dependent")}))},{id:"relativeBreakdown",name:"% of Groups",helparticle:"5e8944932c7d3a7e9aea659c",active:this.breakdownMode.is("relative"),do:()=>e(this,void 0,void 0,(function*(){return yield this.breakdownMode.set("relative")}))},{id:"totalBreakdown",name:"% of All",helparticle:"5e94ff6904286364bc984a7a",active:this.breakdownMode.is("total"),do:()=>e(this,void 0,void 0,(function*(){return yield this.breakdownMode.set("total")}))}]}]},this,{placement:"bottom-start"})})),s.append("span").attr("class","dashboardSetting lockCrumbMode").tooltip("",{onShow:e=>{e.reference.tippy.setContent(`<div>${me["Group View"]}</div> <b>${this.stackedCompare}</b><br> <i>${me["Click to change"]}</i>`)}}).on("click",(()=>e(this,void 0,void 0,(function*(){return yield this.stackedCompare.set(!this.stackedCompare.get())})))).append("div").attr("class","CompareModeIcon").selectAll("div").data([0,1,2]).enter().append("div").attr("class","CompareModeIcon-block"),this.DOM.breadCrumbs_Filter=this.DOM.panel_Basic_In.append("div").attr("class","breadCrumbs breadCrumbs_Filter").call((e=>{e.append("div").attr("class","breadCrumbHeader").tooltip(me.RemoveAllFilters).text(me.Filters).on("click",(()=>this.clearFilters_All())),e.append("div").attr("class","breadCrumbCollapseControl far fa-angle-double-right").tooltip("",{onTrigger:t=>{t.reference.tippy.setContent(me[(e.node().classList.contains("collapsed")?"Show":"Hide")+" Filters"])}}).on("click",(()=>{var t=e.node().classList;t.toggle("collapsed"),t.contains("collapsed")||(this.filters_wrap_letItWrap=!0)}))})),this.DOM.breadCrumbs_Compare=this.DOM.panel_Basic_In.append("div").attr("class","breadCrumbs breadCrumbs_Compare").call((e=>{e.append("span").attr("class","breadCrumbHeader").tooltip(me.Unlock).text(me.Compare).on("click",(()=>this.clearSelect_Compare(this.activeComparisons,!0,!0))).append("span").attr("class","lockCrumbSummary blockName")}))}applyConfig(t){return e(this,void 0,void 0,(function*(){ae.Panel_List.forEach((e=>this.panels[e].importConfig(Object.assign(Object.assign({},t.panels[e]),t.panels.default)))),t.summaries=t.summaries||[];for(let e of t.summaries)yield this.applyBlockConfig(e);if(t.recordName&&this.recordName!==t.recordName&&this.setRecordName(t.recordName),t.metric){var e=this.attribWithName(t.metric.summary);e instanceof Ye&&(yield this.measureSummary.set(e),yield this.measureFunc.set(t.metric.type))}else yield this.measureFunc.set("Count");yield this.breakdownMode.set(t.breakdownMode),yield this.stackedCompare.set(t.stackedCompare),yield this.filteringMode.set(t.filteringMode),yield this.showWholeAggr.set(t.showWholeAggr),yield this.mouseOverCompare.set(t.mouseOverCompare),yield this.recordDisplay.importConfig(t.recordDisplay),this.records.forEach((e=>e.refreshFilterCache())),this.updateRecordCount_Active(),this.updateAfterFilter(),this.updateLayout()}))}insertDOM_Panel_Overlay(){this.DOM.overlay_wrapper=this.DOM.root.append("div").attr("class","overlay_wrapper"),this.DOM.overlay_wrapper.append("div").attr("class","fullBackground").on("click",(e=>{e.currentTarget.parentNode.classList.contains("easyDismiss")&&(this.DOM.overlay_wrapper.attr("show","none"),this.recordDetailsPopup.closeRecordDetailPanel(),ye._removeModal(this.DOM.overlay_wrapper))})),this.DOM.loadingBox=this.DOM.overlay_wrapper.append("div").attr("class","overlay_content overlay_loading"),this.DOM.loadingBox.append("span").attr("class","spinner").selectAll(".spinner_x").data([1,2,3,4,5]).enter().append("span").attr("class",(e=>"spinner_x spinner_"+e));var e=this.DOM.loadingBox.append("div").attr("class","status_text");e.append("span").attr("class","status_text_sub info").html(me.LoadingData),e.append("span").attr("class","status_text_sub dynamic"),this.DOM.overlay_infobox=this.DOM.overlay_wrapper.append("div").attr("class","overlay_content overlay_infobox"),this.DOM.overlay_infobox.append("div").attr("class","overlay_Close fa fa-times fa-times-circle").tooltip(me.Close).on("click",(()=>this.DOM.overlay_wrapper.attr("show","none"))),this.recordDetailsPopup.initDOM(),this.DOM.overlay_wrapper.append("div").attr("class","overlay_content overlay_help")}showCredits(){this.creditsInserted||(this.DOM.overlay_infobox.append("div").attr("class","creditsBox").html("<div style=\"text-align: center;\">\n  <a target='_blank' href='https://keshif.me'><img class='kshfLogo'></a>\n</div>\n<div>\n  <a class='creditsLink' target='_blank' href='https://keshif.me/Terms'>Terms of Use</a>\n  <a class='creditsLink' target='_blank' href='https://keshif.me/Privacy'>Privacy Policy</a>\n  <a class='creditsLink' target='_blank' href='https://keshif.me/License'>Other Licenses</a>\n</div>\n<div class='copyright'>© Keshif, LLC 203. All rights reserved.</div>\n"),this.creditsInserted=!0)}helper_AddSidePanelGroup(t,i,s){this.DOM[t]=this.DOM.authoringPanel.append("div").attr("class","sidePanelGroup "+t);var r=this.DOM[t].append("div").attr("class","sidePanelGroupHeader");return r.append("span").html(i),r.select(".fa").tooltip(s),r.append("span").attr("class","closeAttribPanel fa fa-window-close").tooltip(me.Close).on("click",(()=>e(this,void 0,void 0,(function*(){return yield this.dashboardMode.set("Explore")})))),this.DOM[t].append("div").attr("class","sidePanelGroupContent")}refreshAttibFilterState(){this.DOM.dataTypeFilters.classed("active",(e=>e.active));var e,t=this.dataTypeDescrs.some((e=>e.active)),i=i=>{var s=e(Object.values(i.sub));if(s>0)return!1;if("string"==typeof i.item)return 0===s;if((i=i.item,this.attribTextQuery)&&-1===(i.attribName+(i.description?" "+i.description:"")).toLowerCase().indexOf(this.attribTextQuery))return!0;return!!t&&!this.dataTypeDescrs.some((e=>e.active&&e.member(i)))};e=e=>{var t=0;return e.forEach((e=>{var s=i(e);qt.select(e.DOM).classed("filtered",s),s||t++})),t},this.removeEmptySubs(),e(Object.values(this.attribs_by_group))}refreshAttibButtonState(){this.DOM.dataTypeFilters.classed("hidden",(e=>this.attribs.every((t=>{var i;return!(null===(i=null==t?void 0:t.block)||void 0===i?void 0:i.hasNugget)||!e.member(t)}))))}get attribPanelWidth(){return this._attribPanelWidth}setAttribPanelWidth(e){"number"!=typeof(e=Number(e))||isNaN(e)||(e=Math.max(Math.min(e,400),200))!==this._attribPanelWidth&&(this._attribPanelWidth=e,this.DOM.authoringPanel.style("width",this._attribPanelWidth+"px"),this.updateLayout())}insertDOM_AttribPanel(){this.DOM.authoringPanel=this.DOM.root.append("div").attr("class","authoringPanel"),this.DOM.authoringPanel.style("width",this._attribPanelWidth+"px");var e=this.helper_AddSidePanelGroup("attributePanel",`<i class='panelIcon fal fa-cube'></i> ${me.Attributes}`,"<b>Author</b> your dashboard<br> using dataset attributes");e.append("div").attr("class","panelAdjustWidth").tooltip(me["Adjust Panel Width"]).on("mousedown",(e=>{if(1===e.which){var t=this._attribPanelWidth-qt.pointer(e,document.body)[0];this.activateWidthDrag(e.currentTarget,e,(e=>{this.setAttribPanelWidth(t+qt.pointer(e,document.body)[0])}))}})).on("click",(e=>{e.stopPropagation(),e.preventDefault()}));var t,i=e.append("div").attr("class","attributePanelFilters");this.DOM.dataTypeFilters=i.append("div").attr("class","dataTypeFilters").selectAll("div").data(this.dataTypeDescrs).enter().append("div").each((e=>{e.active=!1})).attr("class",(e=>"filterTypeButton "+e.icon)).html((e=>e.iconDiv)).tooltip((e=>me[e.name+"Attribute"]),{placement:"bottom"}).on("click",((e,t)=>{t.active=!t.active,this.refreshAttibFilterState()})),i.append("div").attr("class","filterTypeButton attribTextSearchIcon far fa-search").on("click",(e=>{e.currentTarget.classList.toggle("active"),t.node().classList.toggle("active"),this.DOM.attribTextSearch.select("input").node().focus()})),i.append("div").attr("class","filterTypeButton attribListConfiguration fal fa-cog").tooltip(me.Configure,{placement:"bottom"}).on("click",(e=>ye.popupMenu(e,Gt.AttribPanel,this))),t=e.append("div").attr("class","attributePanelControl"),this.DOM.attribTextSearch=t.append("span").attr("class","textSearchBox attribTextSearch"),this.DOM.attribTextSearch.append("input").attr("class","textSearchInput").attr("type","text").attr("placeholder",me.Search).on("keydown",(e=>e.stopPropagation())).on("keypress",(e=>e.stopPropagation())).on("keyup",(e=>e.stopPropagation())).on("input",(e=>{var t=e.currentTarget;t.timer&&clearTimeout(t.timer),this.attribTextQuery=t.value.toLowerCase(),this.DOM.attribTextSearch.classed("showClear",""!==this.attribTextQuery),t.timer=setTimeout((()=>this.refreshAttibFilterState()),250)})),this.DOM.attribTextSearch.append("span").attr("class","fa fa-times-circle").tooltip(me.ClearTextSearch).on("click",(()=>{this.attribTextQuery="",this.DOM.attribTextSearch.classed("showClear",!1).select("input").property("value",""),this.refreshAttibFilterState()})),this.DOM.attributeList=e.append("div").attr("class","attributeList"),this.DOM.boostButton=e.append("div").attr("class","boostButton").html("<i class='fal fa-rocket-launch'></i> Boost").tooltip("Auto-boost dashboard").on("click",(()=>this.runMagic()))}collapseAttribListGroups(e=!0){this.DOM.root.selectAll(".AttribListItem.hasSubItems").nodes().forEach((t=>{t.classList[e?"add":"remove"]("collapsed")}))}refreshAttribList(){if(this.finalized){var e=(e,i)=>e.each(((e,s,r)=>{t(qt.select(r[s]).select(".subItems"),e.sub,i+1)})),t=(t,i,s)=>{i=Object.values(i).sort(((e,t)=>{var i=Object.keys(e.sub).length>0&&"string"==typeof e.item,s=Object.keys(t.sub).length>0&&"string"==typeof t.item;if(i!==s)return+s-+i;var r=Re.getAttribTypeOrder(e.item.type)-Re.getAttribTypeOrder(t.item.type);return r||Re.sortFunc_List_String(e.name,t.name)})),t.selectAll("div.AttribListItem-Level"+s).remove(),t.selectAll("div.AttribListItem-Level"+s).data(i,(e=>e.name+"_"+typeof e.item)).join((t=>{var i=t.append("div").attr("class","AttribListItem AttribListItem-Level"+s).classed("hasSubItems",(e=>Object.entries(e.sub).length>0)).classed("collapsed",!0);return i.append("div").attr("class","nugget").classed("inDashboard",(e=>{var t,i;return null===(i=null===(t=e.item)||void 0===t?void 0:t.block)||void 0===i?void 0:i.inDashboard})).classed("condensedText",(e=>{var t;return(null===(t=e.name)||void 0===t?void 0:t.length)>30})).each(((e,t,i)=>{var s,r;e.DOM=i[t];var a="string"==typeof e.item;let o=qt.select(i[t]);o.on("click",(e=>{1===e.which&&i[t].parentNode.classList.toggle("collapsed")})),o.append("div").attr("class","groupControl").tooltip(me["Open/Close"]).on("click",(e=>{e.stopPropagation(),e.preventDefault(),i[t].parentNode.classList.toggle("collapsed")})).append("div").attr("class","fa fa-caret-down"),o.append("span").attr("class","nuggetIcon").append("div").attr("class",a?"fa fa-circle":null===(s=e.item)||void 0===s?void 0:s.nuggetClassName),o.append("span").attr("class","summaryName").html(e.name).tooltip(me.EditTitle);var l=o.append("div").attr("class","iconWrapper").on("dblclick",(e=>{e.stopPropagation(),e.preventDefault()}));if(!a){let t=e.item;t.attribName===this.idSummaryName&&l.append("div").attr("class","summaryRecordIDIcon far fa-fingerprint").tooltip(me["Record ID"],{placement:"bottom"}),"categorical"===t.type&&l.append("div").attr("class","summaryMultiCat far fa-tags").tooltip(me.MultiValued,{placement:"bottom"}),l.append("div").attr("class","summaryDescription far fa-info-circle").classed("active",!!t.description).tooltip(t.description,{placement:"bottom"}).on("click",(function(){this.tippy.show()})),null===(r=t.block)||void 0===r||r.refreshNugget(o)}l.append("div").attr("class","showDeriveMenu fa fa-ellipsis-v").tooltip(me.Settings,{placement:"bottom"}).on("mousedown",(e=>e.stopPropagation())).on("click",(t=>{t.currentTarget.parentNode.parentNode.classList.add("popupVisible"),a?ye.popupMenu(t,Gt.Attrib_Grouping,e):(e.item.initializeAggregates(),ye.popupMenu(t,Gt.Attribute,e.item)),t.stopPropagation(),t.preventDefault()}))})),i.append("div").attr("class","subItems"),e(i,s),i}),(t=>e(t,s)),(e=>e.remove())).order()};this.removeEmptySubs(),t(this.DOM.attributeList,this.attribs_by_group,0),this.refreshAttibButtonState()}}showFullscreen(){this.isFullscreen=!this.isFullscreen;var e=this.DOM.root.node();this.isFullscreen?e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}set loadedTableCount(e){var t;this._loadedTableCount=e,null===(t=this.DOM.root)||void 0===t||t.select(".status_text_sub").text(`(${this._loadedTableCount} / ${this._totalTableCount})`)}get loadedTableCount(){return this._loadedTableCount}loadDataSources(){this.DOM.overlay_wrapper.attr("show","loading"),Ut.registerLoader(new Wt),Ut.registerLoader(new Kt),this.insertDOM_Panel_DatasetInfo();var t=[];if(this.options.source){let i=this.options.source;Array.isArray(i)||(i=[i]),this.loadedTableCount=0,this._totalTableCount=i.length,t=i.map(((t,i)=>e(this,void 0,void 0,(function*(){var e=new Ut(t);return yield e.load(),this._loadedTableCount++,0===i&&(this.primaryTableName=e.name,this.idSummaryName=e.id||"id",e.linkToData&&this.DOM.datasource.style("display","inline-block").attr("href",e.linkToData)),!0}))))}Promise.all(t).then((()=>{var t;this.primaryTableName?(this.records=(null===(t=ae.tables.get(this.primaryTableName))||void 0===t?void 0:t.records)||[],this.records.forEach(((e,t)=>{e.recordOrder=t})),this.setRecordName(this.recordName||this.primaryTableName),this.DOM.overlay_wrapper.select("div.status_text .info").text(me.CreatingBrowser),this.DOM.overlay_wrapper.select("div.status_text .dynamic").text(""),window.setTimeout((()=>e(this,void 0,void 0,(function*(){return this._loadCharts()}))),20)):ye.alert("Cannot load dashboard. Please define primaryTableName.")})).catch((e=>{console.log(e),ye.alert("Error in loading data.<br><br> Error: "+e)}))}prepBlockConfig(e){e.showPercentile&&(e.showPercentiles=e.showPercentile),e.intervalScale&&(e.valueScaleType=e.intervalScale),e.scaleType&&(e.valueScaleType=e.scaleType),e.minAggrValue&&(e.minAggrSize=e.minAggrValue),!1===e.supportsCompareLock&&(e.isComparable=!1),e.type||(e.catLabel||e.catTooltip||e.catSortBy||e.catGeo||e.barHeight||e.showSetMatrix?e.type="categorical":e.showPercentile||e.skipZero?e.type="numeric":e.recordGeo?e.type="recordGeo":e.content&&(e.type="content"))}applyBlockConfig(t){var i;return e(this,void 0,void 0,(function*(){if(0!==Object.keys(t).length&&!t.skipConfig){this.prepBlockConfig(t);var e=this.attribWithName(t.name),s=null;"string"==typeof t.value&&"recordGeo"!==t.type&&(s=this.attribWithName(t.value)),!e&&s?(e=s).attribName=t.name:(e&&t.value&&t.value!==t.name&&e.template.str!==t.value&&e.destroy(),e=this.createAttrib(t.name,t.value,t.type)),t.type&&t.type!==e.type&&(e.destroy(),t.value=t.value||t.name,"string"==typeof t.value?(e=this.createAttrib(t.value,null,t.type)).attribName=t.name:"function"==typeof t.value&&(e=this.createAttrib(t.name,t.value,t.type))),e&&(yield e.applyConfig(t),e.isEmpty()&&(e instanceof mt||e instanceof Fe)?e.destroy():t.panel&&(null===(i=e.block)||void 0===i||i.addToPanel(this.panels[t.panel],void 0,!0)))}}))}runMagic(){var e,t,i,s=this.exportConfig(),r=[],a=Object.keys(this.records[0].data),o=a.some((e=>{t=e;var i=e.toUpperCase();return["LAT","LATITUDE"].includes(i)})),l=a.some((e=>{i=e;var t=e.toUpperCase();return["LON","LONGITUDE","LNG","LONG"].includes(t)}));o&&l&&!this.options.onLoad._POINT&&r.push({i:'<i class="far fa-map-marker"></i>',q:`(<b>${t}</b>, <b>${i}</b>) is the point location.`,a:()=>{this.options.onLoad._POINT=`LAT_LONG(${t},${i})`,s.summaries=s.summaries.filter((e=>e.name!==t&&e.name!==i)),s.recordDisplay.geo||(s.recordDisplay.geo="_POINT"),"none"===s.recordDisplay.viewAs&&(s.recordDisplay.viewAs="map")}});var n=this.attribs.filter((e=>e instanceof Vt));n.forEach((e=>{[{typed:"month",derivative:"Month"},{typed:"day",derivative:"DayOfMonth"},{typed:"day",derivative:"WeekDay"},{typed:"hour",derivative:"Hour"}].forEach((t=>{e.timeTyped[t.typed]&&!e.derivatives[t.derivative]&&r.push({i:'<i class="far fa-calendar-day"></i>',q:`Derive ${t.derivative} of <b>${e.attribName}</b>`,a:()=>{s.summaries.push({name:e.attribName+"->"+t.derivative,value:e.template.str+"->"+t.derivative+"()",panel:"none"})}})}))}));var h={};this.records.slice(0,10).forEach((e=>{for(var t in e.data)h[t]=h[t]||[],h[t].push(e.data[t])})),a.forEach((e=>{h[e].some((t=>null!=t&&"object"==typeof t&&!Array.isArray(t)&&(!!Object.entries(t).every((([e,t])=>!isNaN(Number(e))&&null!==t&&!isNaN(Number(t))))&&(r.push({i:'<i class="fa fa-chart-line"></i>',q:`<b>${e}</b> is timeseries by year/order.`,a:()=>{this.options.onLoad[e]=e+"->${DATETIME(%Y)}",s.summaries=s.summaries.filter((t=>{if("none"!==t.panel)return!0;var i=new De(t.name,this);return!(i&&i.pathStr===e)}))}}),!0))))}));var c=e=>{var t=e.attribName;return"ZIP"===t.toUpperCase()||"ZIPCODE"===t.toUpperCase()};this.attribs.forEach((e=>{e instanceof Ye&&c(e)&&r.push({i:'<i class="far fa-map-marker"></i>',q:`<b>${e.attribName}</b> is zipcode.`,a:()=>{this.options.onLoad[e.template.str]="STR()",s.summaries=s.summaries.filter((t=>t.name!==e.attribName)),e.destroy()}})}));var d=[{filter:e=>e instanceof Ye&&e.aggr_initialized&&!e.unitName&&e.rangeOrg[0]>=18264&&e.rangeOrg[1]<=54789&&!c(e),i:"hashtag",convert:"DATETIME(%sn)",message:" is a spreadsheet date field?"},{filter:e=>e instanceof Ye&&e.aggr_initialized&&!e.unitName&&e.rangeOrg[0]>=1950&&e.rangeOrg[1]<=2050&&!c(e),convert:"DATETIME(%Y)",message:" stores year values?"}];this.attribs.forEach((e=>{d.some((t=>(t.filter(e)&&r.push({i:'<i class="fa fa-calendar-day"></i>',q:e.attribName+t.message,a:()=>{this.options.onLoad[e.template.str]=t.convert,s.summaries.filter((t=>t.name===e.attribName)).forEach((e=>delete e.type))}}),!1)))})),this.attribs.forEach((e=>{if(e instanceof mt&&!e.isEmpty()){var t="";e._aggrs.forEach((e=>{t+=e.id})),[{char:",",convert:"SPLIT(\\s*,\\s*)"},{char:";",convert:"SPLIT(\\s*;\\s*)"},{char:"|",convert:"SPLIT(\\s*\\|\\s*)"},{char:"+",convert:"SPLIT(\\s*\\+\\s*)"}].forEach((i=>{t.split(i.char).length-1<=t.length/20||r.push({i:'<i class="far fa-tags"></i>',q:`<b>${e.attribName}</b> has multiple categories split by <b>${i.char}</b>`,a:()=>{this.options.onLoad[e.template.str]=i.convert}})}))}}));var u=null;if("id"===this.idSummaryName){let e=this.attribs.filter((e=>{if(e instanceof mt&&e.uniqueCategories()&&e.template.str&&"id"!==e.template.str){var t="";return e._aggrs.forEach((e=>{t+=e.id})),e.___temp=t.length,!0}return!1}));e.sort(((e,t)=>e.___temp-t.___temp));var p=e[0];p&&r.push({i:"<i class='far fa-fingerprint'></i>",q:`<b>${p.attribNameHTML}</b> is the unique fingerprint (ID) of the ${this.recordName}`,a:()=>{s.source.tables[0].id=p.template.str,this.attribWithName("id")&&this.attribWithName("id").destroy(),s.summaries=s.summaries.filter((e=>"id"!==e.name))}}),u=e[1]||e[0]}if(!this.recordDisplay.codeBy.text){if(!u){let e=this.attribs.filter((e=>!("categorical"!==e.type||!e.template.str||"id"===e.template.str||!e._aggrs)&&(e.___temp=e._aggrs.length,!0))).sort(((e,t)=>t.___temp-e.___temp));u=e[0]}u&&r.push({i:'<i class="fa fa-font"></i>',q:`<b>${u.summaryName}</b> can be used as record text.`,a:()=>{s.recordDisplay.textBy=u.summaryName,"none"===s.recordDisplay.viewAs&&(s.recordDisplay.viewAs="list")}})}if(n.length>0&&n.length<3&&this.panels.bottom.isEmpty()){let t=n[0];(null===(e=t.block)||void 0===e?void 0:e.inDashboard)||r.push({i:'<i class="fa fa-th"></i>',q:`Place <b>${t.attribName}</b> on dashboard bottom`,a:()=>{s.summaries.forEach((e=>{e.name===t.attribName&&(e.panel="bottom")}))}})}this.attribs.forEach((e=>{delete e.___temp})),0===r.length?ye.alert(me.Boost_NoSuggestions):(r.forEach((e=>{void 0===e.change&&(e.change=!0)})),ye.autoChanges(r).then((e=>{var t=!1;e.forEach((e=>{e.change&&(e.a(),t=!0)})),t?(ae.tables.delete(this.primaryTableName),window.dashboard=new Qt(s)):this.DOM.boostButton&&this.DOM.boostButton.classed("animate",!1)}),(()=>{this.DOM.boostButton&&this.DOM.boostButton.classed("animate",!1)})))}_loadCharts(){var t,i,s;return e(this,void 0,void 0,(function*(){if(!this.chartsLoaded)if(this.DOM.root.classed("dataLoaded",!0),0!==this.records.length){for(var e in this.onLoad.main)Jt(e,this.onLoad.main[e],this.records);null===(t=this.onLoad.callback)||void 0===t||t.call(this),Et(),this.options.panels||(this.options.panels={}),this.options.panels.default||(this.options.panels.default={}),null==this.options.panels.default.catBarWidth&&(this.options.panels.default.catBarWidth=(()=>{var e=this.divWidth;return["left","middle","right"].forEach((t=>{this.panels[t].isEmpty()||(e-=this.panels[t].width_Real-this.panels[t].width_CatBars)})),Math.floor(e/8)})()),["left","middle","right"].forEach((e=>{let t=this.options[e+"PanelLabelWidth"];t&&(this.options.panels[e]||(this.options.panels[e]={}),this.options.panels[e].catLabelWidth=t)})),yield this.breakdownMode.set(this.options.breakdownMode),yield this.stackedCompare.set(this.options.stackedCompare),yield this.filteringMode.set(this.options.filteringMode),yield this.showWholeAggr.set(this.options.showWholeAggr),yield this.mouseOverCompare.set(this.options.mouseOverCompare),this.records.forEach((e=>this.allRecordsAggr.addRecord(e))),this.options.attribPanelWidth&&this.setAttribPanelWidth(this.options.attribPanelWidth),this.options.colorTheme&&(this.colorTheme=Object.assign(this.colorTheme,this.options.colorTheme)),ae.Panel_List.forEach((e=>this.panels[e].importConfig(this.options.panels[e])));var r={};this.records.slice(0,ae.autoDetect_RowCount).forEach((e=>n(e.data,r)));var a=(e,t,i=!1)=>{for(var s in t)if("string"==typeof s){var r=t[s];if(null!=r&&r._timeseries_){let t=this.createAttrib(e+s);t&&t.initializeAggregates()}else if(null==r||"object"!=typeof r||r instanceof Date||Array.isArray(r)||r.geometry||r.coordinates){if(!i){let t=this.createAttrib(e+s);t&&t.initializeAggregates()}}else a(e+s+"->",r)}};if(a("",r),this.recordDisplay=new Pt(this,this.options.recordDisplay||{}),this.options.metric){var o=this.options.metric;"string"==typeof o&&(o={type:"Sum",summary:o});let e=this.attribWithName(o.summary);e instanceof Ye&&(yield this.measureSummary.set(e),yield this.measureFunc.set(o.type))}this.options.summaries=this.options.summaries||[];for(let e of this.options.summaries)yield this.applyBlockConfig(e);if(yield this.recordDisplay.initialize(),this.panels.bottom.refreshWidth(),this.updateMiddlePanelWidth(),this.records.forEach((e=>e.refreshFilterCache())),this.updateRecordCount_Active(),this.updateAfterFilter(),this.options.selections&&!this.options.selections.auto){var l=this.attribWithName(this.options.selections.summary);ae.Compare_List.forEach((e=>{var t,i=this.options.selections[e];i&&(l&&(l.initializeAggregates(),l instanceof mt?t=l.getAggrWithLabel(i.id):l instanceof Ye&&(this.flexAggrs[e]=new Le(l,i.min,i.max),t=this.flexAggrs[e]),t&&this.setSelect_Compare(t,e,!1)&&this.lockSelect_Compare(!1)))}))}if(this.enableAnalytics=!0,this.refreshConfigs(),this.options.selections&&this.options.selections.auto&&(null===(i=this.attribWithName(this.options.selections.summary))||void 0===i||i.autoCompare()),this.checkBrowserZoomLevel(),0===this.DOM.overlay_wrapper.selectAll(".overlay_modal").nodes().length&&this.DOM.overlay_wrapper.attr("show","none"),yield this.dashboardMode.set(this.options.dashboardMode),null===(s=this.options.onReady)||void 0===s||s.call(this),this.finalized=!0,this.authorMode&&this.refreshAttribList(),this.updateLayout(),setTimeout((()=>this.setNoAnim(!1)),1e3),this.chartsLoaded=!0,this.options.recordInDetail){let e=ae.tables.get(this.primaryTableName).getRecord(this.options.recordInDetail);this.recordDetailsPopup.updateRecordDetailPanel(e)}}else ye.alert(`Dataset (${this.recordName}) includes no records.`);function n(e,t){if(e)for(var i in e){var s=e[i];null!=s&&(null==s||"object"!=typeof s||s instanceof Date||Array.isArray(s)||s._timeseries_||s.geometry||s.coordinates?t[i]=s:(t[i]=t[i]||{},n(s,t[i])))}}}))}unregisterBodyCallbacks(){qt.select("body").on("mousemove.layout",null).on("mouseup.layout",null).on("keydown.layout",null)}prepareDropZones(e,t){this.movedAttrib=e,this.showDropZones=!0,this.DOM.root.classed("showDropZone",!0).attr("dropSource",t),this.DOM.attribDragBox.style("display","block").html(e.attribName)}clearDropZones(){this.movedAttrib=null,this.showDropZones=!1,this.unregisterBodyCallbacks(),this.DOM.root.classed("showDropZone",!1).attr("dropattrtype",null).attr("dropSource",null),this.DOM.attribDragBox.style("display","none")}autoAddAttib(t){var i,s;if(!(null===(i=null==t?void 0:t.block)||void 0===i?void 0:i.inDashboard))if(t instanceof rt)this.recordDisplay.setAttrib("timeSeries",t).then((()=>e(this,void 0,void 0,(function*(){return yield this.recordChartType.set("timeseries")}))));else if(t instanceof tt)this.recordDisplay.setAttrib("geo",t).then((()=>e(this,void 0,void 0,(function*(){return yield this.recordChartType.set("map")}))));else if(t instanceof mt&&t.uniqueCategories())this.recordDisplay.setAttrib("text",t).then((()=>e(this,void 0,void 0,(function*(){return yield this.recordChartType.set("list")}))));else{var r={timestamp:"bottom",categorical:"left",numeric:"right"}[t.type]||"left";this.panels[r].welcomesNewBlock()||(r="middle"),null===(s=null==t?void 0:t.block)||void 0===s||s.addToPanel(this.panels[r])}}getGlobalActiveMeasure(){if(0===this.allRecordsAggr.recCnt("Active"))return me["No [Record]"];var e=this.allRecordsAggr.measure("Active").toLocaleString();return this.getMeasureFormattedValue(e)}updateRecordCount_Active(){this.DOM.activeRecordMeasure.html(this.getGlobalActiveMeasure())}get numOfActiveFilters(){return this.filters.filter((e=>e.isFiltered)).length}isFiltered(){return this.numOfActiveFilters>0}getFilteredSummaryText(){return 0===this.numOfActiveFilters?"":this.numOfActiveFilters>1?"filtered":this.filters.find((e=>e.isFiltered)).getRichText_flipped()}refresh_filterClearAll(){this.DOM.breadCrumbs_Filter.classed("isActive",this.isFiltered())}clearFilters_All(e=null){0!==this.numOfActiveFilters&&(1===this.numOfActiveFilters&&this.filters.filter((e=>e.isFiltered))[0]===e||(this.skipSortingSummary&&(this.skipSortingSummary.dirtySort=!1),this.filters.forEach((t=>t!==e&&t.clearFilter(!1))),this.records.forEach((e=>e.filteredOut&&e.refreshFilterCache())),this.updateRecordCount_Active(),this.updateAfterFilter(!0),setTimeout((()=>this.updateLayout_Height()),1e3)))}updateAfterFilter(e=!1){ae.browser=this,ae.Compare_List.forEach((e=>{var t=this.selectedAggrs[e];t&&this.refresh_Compare_Measures(t,e)})),this.refreshPanelsSyncedMeasureExtend(),this.blocks.forEach((e=>e.updateAfterFilter(!0))),this.recordDisplay.updateAfterFilter(e),this.updateWidth_CatMeasureLabels(),this.refreshAllMeasureLabels(),this.refresh_filterClearAll(),this.filteringMode.refresh(),this.needToRefreshLayout=!0}refreshAnalytics(){var e,t,i;this.enableAnalytics&&(null===(t=null===(e=this.DOM)||void 0===e?void 0:e.root)||void 0===t||t.classed("stackedCompare",this.stackedCompare.is(!0)).classed("stackedChart",this.stackedChart).classed("showWholeAggr",this.showWholeAggr.is(!0)).attr("breakdownMode",this.breakdownMode.get()).attr("measureFunc",this.measureFunc.get()),this.updateWidth_CatMeasureLabels(),this.stackedCompare.is(!0)&&this.attribs.forEach((e=>{e.measureScale_Log&&e.measureScaleType.set("linear")})),this.refreshPanelsSyncedMeasureExtend(),this.attribsInDashboard.forEach((e=>{e.updateChartScale_Measure(!0),e.block.refreshViz_All(),e.block.refreshMeasureDescrLabel(),e instanceof mt&&e.catOrder_Dynamic&&"Active"!==e.catSortBy&&e.block.updateCatSorting()})),null===(i=this.recordDisplay.View)||void 0===i||i.refreshSelect_Compare(),this.refreshAllMeasureLabels())}get stackedChart(){return!this.stackedCompare.is(!1)&&(this.activeComparisonsCount>=1||0!==this.activeComparisonsCount&&this.lockedCompare[this.activeComparisons[0]])}get exploreMode(){return this.dashboardMode.is("Explore")}get adjustMode(){return this.dashboardMode.is("Adjust")}get authorMode(){return this.dashboardMode.is("Author")}get captureMode(){return this.dashboardMode.is("Capture")}get saveMode(){return this.dashboardMode.is("Save")}get measureFunc_Count(){return this.measureFunc.is("Count")}get measureFunc_Avg(){return this.measureFunc.is("Avg")}get measureFunc_Sum(){return this.measureFunc.is("Sum")}get singleFiltering(){return this.filteringMode.is("single")}get chainedFiltering(){return this.filteringMode.is("chained")}get absoluteBreakdown(){return this.breakdownMode.is("absolute")}get percentBreakdown(){return"absolute"!=this.breakdownMode.get()}get relativeBreakdown(){return this.breakdownMode.is("relative")}get dependentBreakdown(){return this.breakdownMode.is("dependent")}get totalBreakdown(){return this.breakdownMode.is("total")}refreshPanelsSyncedMeasureExtend(){Object.values(this.panels).forEach((e=>e.refreshSharedMeasureExtent()))}refreshAllMeasureLabels(e=null,t=!1){if(!e)return this.refreshAllMeasureLabels("Active",!0),void this.activeComparisons.forEach((e=>this.refreshAllMeasureLabels(e,!0)));this.blocks.forEach((i=>{i.refreshMeasureLabelText(e),i instanceof ot&&!t&&i.isView_Map&&i.refreshViz(e)}))}updateWidth_CatMeasureLabels(){ae.Panel_List.forEach((e=>this.panels[e].updateWidth_CatMeasureLabels()))}vizActive(e){return null!==this.selectedAggrs[e]}get lockedAttrib(){var e=ae.Compare_List.find((e=>this.lockedCompare[e]));return e?this.selectedAggrs[e].attrib:null}get comparedAttrib(){var e=ae.Compare_List.find((e=>this.selectedAggrs[e]));return e?this.selectedAggrs[e].attrib:null}can_setSelect_Compare(e){return!this.comparedAttrib||this.comparedAttrib===e.attrib}refresh_Compare_Measures(e,t){this.resetAllAggrMeasures(t),e.records.forEach((e=>e.addToAggrMeasure(t)))}get activeComparisonsCount(){return this.activeComparisons.length}get activeComparisons(){return ae.Compare_List.filter((e=>this.vizActive(e)))}isCompared(){return this.activeComparisonsCount>0}get Compare_Highlight(){return ae.Compare_List.find((e=>{if(!this.lockedCompare[e])return e}))}get otherNameInCompare(){if(this.comparedAttrib){if("categorical"===this.comparedAttrib.type){var e=this.comparedAttrib._aggrs.filter((e=>!e.compared));if(1===e.length&&0===this.comparedAttrib.noValueAggr.recCnt("Total"))return e[0].label}return me.Other}}createNewCrumb(){let e=this.Compare_Highlight;var t=this.crumbs[e]||new Ft(this,e);return this.crumbs[e]=new Ft(this,e),t}isComparedSummaryMultiValued(){var e=this.comparedAttrib;return e instanceof mt&&e.isMultiValued}get flexAggr_Highlight(){return this.flexAggrs[ae.Compare_List.find((e=>!this.vizActive(e)))]}set flexAggr_Highlight(e){this.flexAggrs[ae.Compare_List.find((e=>!this.vizActive(e)))]=e}refreshViz_Compare_All(){this.recordDisplay.refreshViz_Compare_All(),this.blocks.forEach((e=>e.refreshViz_Compare_All()))}refreshComparedSummary(){var e;this.comparedAttrib&&(this.comparedAttrib.addDOMBlockName(this.DOM.breadCrumbs_Compare.select(".lockCrumbSummary")),null===(e=this.comparedAttrib.block.DOM.root)||void 0===e||e.classed("comparedSummary",!0))}lockSelect_Compare(e=!0){var t,i,s,r,a=this.Compare_Highlight;return!!a&&(!!this.vizActive(a)&&(!this.lockedCompare[a]&&(!!this.selectedAggrs[a]&&(!(null===(t=this.selectedAggrs[a].attrib)||void 0===t?void 0:t.isComparable.is(!1))&&(this.selectedAggrs[a].lockSelection(),this.lockedCompare[a]=!0,null===(r=null===(s=null===(i=this.lockedAttrib)||void 0===i?void 0:i.block)||void 0===s?void 0:s.DOM.root)||void 0===r||r.classed("lockedAttrib",!0),e&&this.refreshAnalytics(),!0)))))}setSelect_Compare(e,t=null,i=!0){var s;if(!e)return!1;if(t||(t=this.Compare_Highlight),!t)return!1;if(this.selectTimeouts[t]&&(window.clearTimeout(this.selectTimeouts[t]),this.clearSelect_Compare(t,!1,!0),delete this.selectTimeouts[t]),this.comparedAttrib&&e.attrib&&this.comparedAttrib!==e.attrib)return!1;if(e!==this.flexAggr_Highlight){if(this.vizActive(t))return t;if(e.compared)return t}return this.addedCompare=!0,this.DOM.root.classed("select"+t,!0).classed("comparedMultiValue",this.isComparedSummaryMultiValued()),this.DOM.breadCrumbs_Compare.classed("isActive",!0),this.selectedAggrs[t]=e,this.selectedAggrs[t].selectCompare(t),this.crumbs[t].showCrumb(t,null===(s=e.attrib)||void 0===s?void 0:s.summaryFilter),this.refreshComparedSummary(),e.attrib instanceof Fe&&e.attrib.block.refreshIntervalSlider([t]),this.blocks.forEach((e=>{e instanceof ot&&e.isView_Dropdown&&e.dropdown_refreshCategories()})),i&&this.refreshConfigs(),t}clearSelect_Compare(e=this.Compare_Highlight,t=!0,i=!1){if(e){if(!i&&!Array.isArray(e))return this.selectTimeouts[e]&&window.clearTimeout(this.selectTimeouts[e]),void(this.selectTimeouts[e]=window.setTimeout((()=>{this.clearSelect_Compare(e,t,!0),delete this.selectTimeouts[e]}),750));var s=this.comparedAttrib,r=this.lockedAttrib,a=()=>{var e,i,a;this.recordDisplay.refreshCompareLegend(),this.blocks.forEach((e=>{e instanceof ot&&e.isView_Dropdown&&e.dropdown_refreshCategories()})),this.comparedAttrib!==s&&(null===(e=s.block.DOM.root)||void 0===e||e.classed("comparedSummary",!1)),this.lockedAttrib!==r&&(null===(a=null===(i=r.block)||void 0===i?void 0:i.DOM.root)||void 0===a||a.classed("lockedAttrib",!1)),t&&this.refreshConfigs()};if(Array.isArray(e))return e.forEach((e=>this.clearSelect_Compare(e,!1,i))),void a();if("string"==typeof e&&this.vizActive(e)){if(this.addedCompare=!1,this.crumbs[e].removeCrumb(),this.lockedCompare[e]=!1,this.selectedAggrs[e]){let t=this.selectedAggrs[e].attrib;t instanceof Fe&&t.block.refreshIntervalSlider([e]),this.selectedAggrs[e].clearCompare(e),this.selectedAggrs[e]=null}this.DOM.root.classed("select"+e,this.vizActive(e)),this.DOM.breadCrumbs_Compare.classed("isActive",0!==this.activeComparisonsCount),this.resetAllAggrMeasures(e),t&&a()}}}resetAllAggrMeasures(e){this.allAggregates.forEach((t=>t.resetMeasure(e)))}hasIntOnlyMeasure(){return this.measureFunc_Count||this.measureFunc_Sum&&!this.measureSummary.get().hasFloat}measureSumWithNegativeValues(){return this.measureFunc_Sum&&this.measureSummary.get().hasNegativeValues()}measureWithPositiveValues(){var e;return!!this.measureFunc_Count||!this.measureFunc_Avg&&(null===(e=this.measureSummary.get())||void 0===e?void 0:e.hasNegativeValues())}refreshMeasureMetric(){var t;return e(this,void 0,void 0,(function*(){if(!this.records)return;let e=null===(t=this.measureSummary)||void 0===t?void 0:t.get();e&&(this.records.forEach(this.measureFunc_Count?e=>{e.measure_Self=1}:t=>{t.measure_Self=e.getRecordValue(t)}),this.allAggregates.forEach((e=>e.resetAggregateMeasures())),this.blocks.forEach((e=>e.updateAfterFilter(!1))),this.recordDisplay.refreshRecordVis(),this.updateRecordCount_Active(),this.refreshAnalytics(),e.hasTimeSeriesParent()&&(yield this.recordDisplay.currentTimeKey.set(e.timeKey)))}))}get dashZoomLevel(){var e="1.00";try{e=window.localStorage.getItem("kshfZoom")||"1.00"}catch(e){}return e}attemptToFixBrowserZoomLevel(e="1.00",t=!1){this.DOM.root.style("zoom",e);try{window.localStorage.setItem("kshfZoom",e)}catch(e){}t&&window.location.reload()}detectPageZoom(){var e=window.outerWidth,t=window.innerWidth;if(window.parent)try{e=window.parent.outerWidth,t=window.parent.innerWidth}catch(e){console.log("page detect zoom exception: "+e);let t=new URL(document.location).searchParams;return t&&t.get("pageZoom")&&Number(t.get("pageZoom"))||1}var i=1;return t!==e&&(i=t/e),i}checkBrowserZoomLevel(){var e=this.detectPageZoom();Math.abs(e-parseFloat(this.dashZoomLevel))<.01||setTimeout((()=>{this.showWarning(me.ZoomLevelWarning),this.DOM.warningText.select(".attemptToFix").on("click",(()=>this.attemptToFixBrowserZoomLevel(e.toFixed(2),!0))),this.DOM.warningText.selectAll(".dismiss").on("click",(()=>this.hideWarning()))}),1e3)}updateLayout(){!0===this.finalized&&(this.updateWidth_Total(),this.updateLayout_Height(),this.updateMiddlePanelWidth(),this.panels.bottom.refreshWidth())}checkAndAdjustBreadcrumbs(){this.filters_wrap_letItWrap||this.isBreadcrumbAreaWrapped()&&(this.DOM.breadCrumbs_Filter.classed("collapsed",!0),this.filters_wrap_letItWrap=!0)}isBreadcrumbAreaWrapped(){if(this.DOM.breadCrumbs_Filter.node().classList.contains("collapsed"))return!1;var e=null,t=null;return this.DOM.panel_Basic_In.selectAll(".breadCrumb").nodes().some((i=>null!=e&&i.offsetTop>e+.7*t||(t=i.offsetHeight,e=i.offsetTop,!1)))}updateLayout_Height(){if(!this.recordDisplay)return;var e=this.DOM.root.nodes()[0].offsetHeight-this.height_PanelHeader-this.height_PanelFooter-2*ae.width_PanelGap,t=e;(this.panels.left.hasBlocks()||this.panels.right.hasBlocks()||this.panels.middle.hasBlocks()||"none"!==this.recordChartType.get())&&(t*=.5),this.panels.bottom.setHeightAndLayout(t);var i=e-this.panels.bottom.height;this.panels.left.setHeightAndLayout(i),this.panels.right.setHeightAndLayout(i);var s=i;if("none"!==this.recordChartType.get()&&(s-=this.recordDisplay.collapsed?this.recordDisplay.height_Header+4:200,s-=ae.width_PanelGap),this.panels.middle.setHeightAndLayout(s),this.blocks.forEach((e=>e.refreshHeight())),!this.recordDisplay.collapsed&&"none"!==this.recordChartType.get()){var r=i-this.recordDisplay.height_Header-this.panels.middle.height;this.showDropZones&&this.panels.middle.isEmpty()&&(r*=.5),this.recordDisplay.setHeight(r)}}updateMiddlePanelWidth(){var e=this.width_Canvas-this.panels.left.width_Real_withGap-this.panels.right.width_Real_withGap;this.panels.middle.setWidth(e),this.panels.middle.refreshWidth(),this.blocks.filter((e=>"setpair"===e.attrib.type)).forEach((e=>e.refreshWidth())),this.recordDisplay&&this.recordDisplay.setWidth(e)}getPercentageValue(e,t,i=null,s=null){return"absolute"===(i=i||this.breakdownMode.get())?e:"relative"===i&&s?this.isCompared()?0===s.Active.measure?0:100*e/s.Active.measure:100*e/this.allRecordsAggr.Active.measure:"dependent"===i?100*e/this.allRecordsAggr[t].measure:"total"===i?100*e/this.allRecordsAggr.Active.measure:void 0}getChartValue(e,t){return this.getPercentageValue(e.measure(t),t,null,e)}getMeasureValue(e,t="Active",i=null,s=[]){var r=e.measure(t);return"Active"===t&&s&&s.forEach((t=>{r-=e.measure(t)})),this.getPercentageValue(r,t,i,e)}getMeasureFormattedValue(e,t=!1){return"Count"!==this.measureFunc.get()?this.measureSummary.get().getFormattedValue(e,t):e}getValueLabel(e,t=!1,i=1,s=null){if(s=null!=s?s:this.percentBreakdown)return 100!==e&&0!==e&&(e=e.toFixed(i)),e+(t?"%":"<span class='unitName'>%</span>");if(this.measureFunc_Count)return Re.formatForItemCount(e);const r=this.measureSummary.get();return!this.measureFunc_Sum||r.hasNegativeValues()||r.hasFloat?e<=-1e3||e>=1e3?Re.formatForItemCount(e,r.unitName):(this.measureFunc_Avg&&(e=e.toFixed(i)),this.measureSummary.get().getFormattedValue(e)):Re.formatForItemCount(e,r.unitName)}exportData(){var e=[],t=e=>{for(let s in e){var i=e[s];if("object"==typeof i&&null!=i){"_timeseries_"===s&&delete e[s],i._timeseries_&&delete i._timeseries_;for(let e in i)""===i[e]&&delete i[e],"object"==typeof i[e]&&t(i[e])}}};return this.records.forEach((i=>{if(i.filteredOut)return;let s=Object.assign({},i.data);t(s),e.push(s)})),e}exportConfig(){var e={domID:this.domID!==ae.defaultDOM?this.domID:void 0,recordName:this.recordName,source:Object.assign({},this.options.source),description:this.options.description||void 0,attribPanelWidth:this.attribPanelWidth!==ae.width_AttribPanelDefault?this.attribPanelWidth:void 0,summaries:[],panels:{},recordDisplay:this.recordDisplay.exportConfig(),colorTheme:this.colorTheme.exportConfig()};Object.values(this.configs).forEach((t=>t.exportConfigTo(e))),!this.measureFunc_Count&&this.measureSummary.get()&&(e.metric={type:this.measureFunc.get(),summary:this.measureSummary.get().template.str});var t=t=>{if(t.isExportable()){var i=t.exportConfig();Re.removeEmptyKeys(i),e.summaries.push(i)}};Object.values(this.panels).forEach((e=>e.blocks.forEach((e=>t(e.attrib))))),this.attribs.filter((e=>{var t;return!(null===(t=null==e?void 0:e.block)||void 0===t?void 0:t.inDashboard)})).forEach(t);for(let[t,i]of Object.entries(this.panels))i.hasBlocks()&&(e.panels[t]=i.exportConfig());var i=this.comparedAttrib;i&&(e.selections={summary:i.attribName},ae.Compare_List.forEach((t=>{this.selectedAggrs[t]&&this.selectedAggrs[t].locked&&(e.selections[t]=this.selectedAggrs[t].exportAggregateInfo())})));let s=t=>{Object.keys(e[t]).length||delete e[t]};return s("panels"),s("colorTheme"),Re.removeEmptyKeys(e),e}}export{Ae as Aggregate,lt as Aggregate_Category,ke as Aggregate_Interval,Le as Aggregate_Interval_Numeric,Me as Aggregate_NoValue,et as Aggregate_PointCluster,nt as Aggregate_SetPair,Oe as Attrib,mt as Attrib_Categorical,jt as Attrib_Content,Fe as Attrib_Interval,Ye as Attrib_Numeric,tt as Attrib_RecordGeo,dt as Attrib_Set,rt as Attrib_Timeseries,Vt as Attrib_Timestamp,ae as Base,ze as Block,ot as Block_Categorical,Yt as Block_Content,We as Block_Interval,$e as Block_Numeric,ct as Block_Set,wt as Block_Timestamp,Qt as Browser,xe as Config,Te as ConfigS,Ut as DataTable,ve as Filter,ge as Filter_Base,ut as Filter_Categorical,Pe as Filter_Interval,Ne as Filter_Numeric,fe as Filter_Record,be as Filter_Text,Be as Filter_Timestamp,pe as LoadLanguage,Nt as MapData,Ie as Record,Pt as RecordDisplay,vt as RecordView,kt as RecordView_List,Mt as RecordView_Map,Ct as RecordView_Scatter,yt as RecordView_Timeseries,Re as Util,me as i18n,de as i18n_EN};
